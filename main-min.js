"use strict";const SEMESTER_SECTION_SEPARATOR="|",INSTRUCTOR=1,ADMIN=2,$=document.querySelector.bind(document);function makeFirstElementChild(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function pad0(e,t=2){return e.toString().padStart(t,"0")}function getDateTime(){let e=new Date;return[e.getFullYear()+"-"+pad0(e.getMonth()+1)+"-"+pad0(e.getDate()),pad0(e.getHours())+":"+pad0(e.getMinutes())]}async function getLocation(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}var userDoc;function signOut(){auth.signOut(),googleAPIsignOut()}window.addEventListener("load",(async function(){window.history.pushState(null,"LectureSeats",location.origin+this.location.pathname),onAuth((async function(e){if(e){if(localStorage.email=e.email,$("#firebaseui-auth-container").classList.add("hidden"),mainDiv.classList.remove("hidden"),$("#user").classList.remove("hidden"),$("#userDisplayName").innerText=e.displayName,$("#userPhoto").src=e.photoURL,(userDoc=await db.findOne("users",e.email))?.error)return void toast("Something went wrong.","Error",-1);if(null===userDoc){userDoc={n:e.displayName};let t=await db.insertOne("users",userDoc,e.email);if(t.error)return void toast(t.error.code,"Error",-1)}else if(!userDoc.n){let t=await db.updateOne("users",e.email,{n:e.displayName});t.error&&toast(t.error.code,"Error",-1)}let t;nameInput.value=nameInput.lastValue=userDoc.n||e.displayName,1&userDoc.r&&($("#roomsBtn").classList.remove("hidden"),$("#allSectionsBtn").classList.remove("hidden")),2&userDoc.r&&($("#roomsBtn").classList.remove("hidden"),$("#allSectionsBtn").classList.remove("hidden"));let n=$("#semesterSelect");if(1==n.children.length){let e=await getSemesters();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),showEnrolledAndTeachingSections(a))}localStorage.minutesToCollectAttendance&&(minutesToCollectAttendance.innerText=localStorage.minutesToCollectAttendance),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&(showGetAttendance(),takingAttendance())}else $("#firebaseui-auth-container").classList.remove("hidden"),mainDiv.classList.add("hidden"),$("#user").classList.add("hidden")}),(e=>toast(e,"Error: "+e,-1)))}));const mainDiv=$("#main");function showInMain(e){navAllowed&&(window.location.hash=e)}function navigateBack(){navAllowed&&history.back()}window.onhashchange=function(e){navAllowed?makeFirstElementChild(mainDiv,$(location.hash||"#sections")):"#_"!==location.hash&&(location.hash="#_")};var navAllowed=!0;function loadingScreen(e){e?($("fieldset").setAttribute("disabled",!0),$("#loading").classList.remove("hidden"),navAllowed=!1):($("fieldset").removeAttribute("disabled"),$("#loading").classList.add("hidden"),navAllowed=!0)}window.addEventListener("popstate",(e=>{"#getAttendance"!==location.hash&&"#QRcode"!==location.hash&&localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&(showGetAttendance(),takingAttendance())}));var allSections={},allRooms=[],allSemesters=["2023Fall","2024Winter","2024Spring"];async function getSemesters(){return["2023Fall","2024Winter","2024Spring"]}async function getSections(e){if(e&&!allSections[e]){if(allSections[e]=await db.findOne("sections",e),allSections[e].error)return void toast("Something went wrong.\nTry to reload.","Error",-1);null===allSections[e]&&(allSections[e]={})}return allSections[e]}async function getSection(e,t){let n=await getSections(e);if(n)return n[t]}async function getRooms(e){return allRooms?.length||(allRooms=await db.find("rooms")),allRooms}function showMarkAttendance(e,t){showInMain("markAttendance"),$("#markAttendanceSectionId").innerText=e,$("#markAttendanceSectionId")._sectionDoc=t,$("#markAttendanceClassCodeInput").value="",$("#markAttendanceSeatCodeInput").value="",selfieUndo.click(),selfieImg.src=userDoc.img||auth.currentUser.photoURL||"user512.png",showMarkedAttendances(t)}function showMarkedAttendances(e){let t=$("#attendanceMarked");if(e.attended?.length){t.innerHTML="Attendance marked:";for(let n of e.attended){let e=t.appendChild(document.createElement("div"));e.innerText=n[1],n[0]||e.setAttribute("failed",!0)}mainDiv.scrollTop=0}else t.innerHTML=""}async function checkInfoAndMarkAttendance(){let e=$("#markAttendanceClassCodeInput").value;if(e){loadingScreen(!0);let t=$("#markAttendanceSectionId"),n=localStorage.semesterSelected+"|"+t.innerText,a=t._sectionDoc,o=$("#markAttendanceSeatCodeInput").value,i=null,s=getDateTime();if(selfieBlob){await verifyAuthToken()||await signInToGoogleAPI(!0);let e=await getFolderId(n,a.i);i=await uploadFile("selfie-"+s.join("-").replace(":","-")+".jpg",selfieBlob,e)}await markAttendance(n,e,o,i,s[0],s[1])?(loadingScreen(!1),a.attended||(a.attended=[]),a.attended.push([1,(new Date).toLocaleString(void 0,{timeZoneName:"short"})]),showMarkAttendance(t.innerText,a),toast("Your attendance was marked.","Success!",1)):(loadingScreen(!1),a.attended||(a.attended=[]),a.attended.push([0,(new Date).toLocaleString(void 0,{timeZoneName:"short"})]),showMarkedAttendances(a),toast("Please make sure the instructor is taking attendance, and that your attendance passcode is correct.","Your attendance was NOT marked.",-1))}else toast("Please enter a valid attendance passcode.")}async function markAttendance(e,t,n,a,o,i){let s=auth.currentUser.email.split("@")[0].replaceAll(".","_"),r=await getLocation(),l={d:o,t:i,a:t};return n&&(l.s=n),r.latitude&&(l.l=r.latitude+","+r.longitude+"~"+r.accuracy),a&&(l.p=a),!(await db.updateOne("attend",e,{_a:t,[s]:db.arrayUnion(l)})).error}function openQRreader(e){showInMain("QRreader");var t=new Html5QrcodeScanner("QRreaderVideo",{fps:10,qrbox:250});function n(){t.clear(),navigateBack(),$("#QRReaderBackButton").removeEventListener("click",n)}t.render((function(t,a){document.getElementById(e).value=t,n()})),$("#QRReaderBackButton").addEventListener("click",n)}function markAttendanceQRcodeButtonClick(e){openQRreader("markAttendanceClassCodeInput")}function markAttendanceQRseatButtonClick(e){openQRreader("markAttendanceSeatCodeInput")}$("#markAttendanceRemoveButton").addEventListener("click",(async e=>{if(confirm("Are you sure you would like to remove this section from the list of sections you are enrolled in?")){let e=$("#markAttendanceSectionId").innerText;(await db.updateOne("users",auth.currentUser.email,{[localStorage.semesterSelected]:db.arrayRemove(e)})).error?toast("Something went wrong. Please try again.","Error",-1):(userDoc[localStorage.semesterSelected]=userDoc[localStorage.semesterSelected].filter((t=>t!==e)),showEnrolledAndTeachingSections(localStorage.semesterSelected),navigateBack())}})),$("#markAttendanceButton").addEventListener("click",checkInfoAndMarkAttendance);var selfieBlob=null;const selfieBtn=$("#selfieBtn"),selfieImg=$("#selfieImg"),selfieCanvas=$("#selfieCanvas"),selfieVideo=$("#selfieVideo"),selfieUndo=$("#selfieUndo");async function photoClick(){selfieBtn.innerText.endsWith("...")?(selfieBtn.innerHTML='<span class="material-symbols-outlined">camera</span> Snap Photo',selfieImg.classList.add("hidden"),selfieCanvas.classList.add("hidden"),selfieUndo.classList.add("hidden"),selfieVideo.classList.remove("hidden"),startCamera(selfieVideo,200)):(selfieBtn.innerHTML='<span class="material-symbols-outlined">photo_camera</span> Take a Selfie...',selfieImg.classList.add("hidden"),selfieVideo.classList.add("hidden"),selfieCanvas.classList.remove("hidden"),selfieUndo.classList.remove("hidden"),selfieBlob=await takePhoto(selfieVideo,selfieCanvas,200))}selfieBtn.onclick=selfieImg.onclick=selfieVideo.onclick=selfieCanvas.onclick=photoClick,selfieUndo.addEventListener("click",(e=>{stopCamera(),selfieUndo.classList.add("hidden"),selfieImg.classList.remove("hidden"),selfieVideo.classList.add("hidden"),selfieCanvas.classList.add("hidden"),selfieBlob=null}));const getAttendanceClassCodeInput=$("#getAttendanceClassCodeInput"),collectAttendanceBtn=$("#collectAttendanceBtn"),minutesToCollectAttendance=$("#minutesToCollectAttendance");async function showGetAttendance(e){showInMain("getAttendance"),e||(e=localStorage.takingAttendance);let t=await getSection(localStorage.semesterSelected,e);$("#getAttendanceSectionId").innerText=e,$("#getAttendanceCrossListIds").innerHTML=t.x?"<span>"+t.x.join("</span> <span>")+"</span>":"",$("#getAttendanceSectionInfo").innerText=t.pattern+"\n"+t.room+"\n"+t.i.join("\n"),$("#getAttendanceEditBtn").onclick=t=>{editSection(e)},localStorage.attendanceCode?getAttendanceClassCodeInput.value=localStorage.attendanceCode:randomAttendanceClassCodeClick()}function randomAttendanceClassCodeClick(){getAttendanceClassCodeInput.value=Math.random().toString().substring(2)}function createQRClick(){const e=$("#QRcode");$("#collectingAttendanceDiv");let t=getAttendanceClassCodeInput.value;t!==e.getAttribute("title")&&(e.innerHTML="",new QRCode(e,t),e.appendChild(document.createElement("div")).id="QRcodeTime"),showInMain("QRcode")}var attendanceTimer;async function collectAttendanceBtnClick(){if("Start"===collectAttendanceBtn.innerText){if(!parseFloat(minutesToCollectAttendance.innerText)||parseFloat(minutesToCollectAttendance.innerText)<1)return void alert("Please enter a numeric value greater than 1 for minutes attendance is to be collected.");if(!getAttendanceClassCodeInput.value)return void alert("Please enter a passcode for taking attendance.");localStorage.minutesToCollectAttendance=minutesToCollectAttendance.innerText;let e=$("#getAttendanceSectionId").innerText,t=await getSection(localStorage.semesterSelected,e);if(t.a=md5(getAttendanceClassCodeInput.value).toUpperCase(),t.e=db.now()+60*parseFloat(minutesToCollectAttendance.innerText),localStorage.attendanceCode=getAttendanceClassCodeInput.value,localStorage.takingAttendance=e,localStorage.attendanceEndtime=t.e,takingAttendance(),db.upsertOne("attend",localStorage.semesterSelected+"|"+e,{s:localStorage.semesterSelected,id:e,i:t.i,a:t.a,e:t.e}),t?.x?.length)for(let e of t.x)db.upsertOne("attend",localStorage.semesterSelected+"|"+e,{s:localStorage.semesterSelected,id:e,i:t.i,a:t.a,e:t.e})}else stopTakingAttendance()}function takingAttendance(){collectAttendanceBtn.innerText="Stop",getAttendanceClassCodeInput.setAttribute("disabled",!0),$("#getAttendance .back").setAttribute("disabled",!0),$("#collectingAttendance").innerText="Collecting",$("#createQRCodeBtn").classList.remove("hidden"),$("#randomAttendanceClassCodeBtn").classList.add("hidden"),minutesToCollectAttendance.removeAttribute("contenteditable"),clearInterval(attendanceTimer),attendanceTimer=setInterval(updateAttendanceTime,1e3)}function updateAttendanceTime(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)stopTakingAttendance();else{let t=Math.floor(e/60),n=e-60*t;minutesToCollectAttendance.innerText=t+":"+pad0(n);let a=$("#QRcodeTime");a&&(a.innerText=minutesToCollectAttendance.innerText)}}async function stopTakingAttendance(){showInMain("getAttendance");let e=$("#getAttendanceSectionId").innerText,t=await getSection(localStorage.semesterSelected,e);if(db.updateOne("attend",localStorage.semesterSelected+"|"+e,{a:db.deleteField(),e:db.deleteField()}),t?.x?.length)for(let e of t.x)db.upsertOne("attend",localStorage.semesterSelected+"|"+e,{a:db.deleteField(),e:db.deleteField()});clearInterval(attendanceTimer),collectAttendanceBtn.innerText="Start",getAttendanceClassCodeInput.removeAttribute("disabled"),$("#getAttendance .back").removeAttribute("disabled"),$("#collectingAttendance").innerText="Collect",$("#createQRCodeBtn").classList.add("hidden"),$("#randomAttendanceClassCodeBtn").classList.remove("hidden"),minutesToCollectAttendance.setAttribute("contenteditable","true"),minutesToCollectAttendance.innerText=localStorage.minutesToCollectAttendance||"75.0",delete localStorage.takingAttendance,delete localStorage.attendanceCode,delete localStorage.attendanceEndtime}minutesToCollectAttendance.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t+".0")}else"ArrowUp"===e.key&&(e.target.innerText=(parseInt(e.target.innerText)||0)+1+".0")}));const CREATE_SECTION_BUTTON_TEXT="Create New Section";async function deleteSection(e,t){if(confirm("Are you sure you want to delete section "+t+" for "+e+"?\n\nWARNING: All attendance data for this section and any cross-listed sections will be deleted.")){(await db.updateOne("sections",e,null)).error?alert("Error: Cannot delete section."):(delete(await getSections(e))[t],showEnrolledAndTeachingSections(e),navigateBack())}}async function createNewSection(){let e;$("#sectionSubmitBtn").innerText="Create New Section",showInMain("addInstructorSection");let t=$("#sectionSemesterSelect");if(t.removeAttribute("disabled"),1==t.children.length){let n=await getSemesters();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}let n=$("#sectionRoomSelect");if(1==n.children.length){let t=await getRooms();for(let a of t)e=n.appendChild(document.createElement("option")),e.id=e.value=a.id,e.innerText=a.building+" - "+a.room}$("#sectionInstructorInput").value||($("#sectionInstructorInput").value=auth.currentUser.email),$("#sectionIdInput").removeAttribute("disabled")}async function editSection(e){$("#sectionSubmitBtn").innerText="Save Section",showInMain("addInstructorSection");let t,n=await getSection(localStorage.semesterSelected,e),a=$("#sectionSemesterSelect");if(a.setAttribute("disabled",!0),1==a.children.length){let e=await getSemesters();for(let n of e)t=a.appendChild(document.createElement("option")),t.id=t.value=t.innerText=n,n==localStorage.semesterSelected&&t.setAttribute("selected",!0)}let o=$("#sectionRoomSelect");if(1==o.children.length){let e=await getRooms();for(let a of e)t=o.appendChild(document.createElement("option")),t.id=t.value=a.id,t.innerText=a.building+" - "+a.room,a.id==n.room&&t.setAttribute("selected",!0)}$("#sectionIdInput").setAttribute("disabled",!0),$("#sectionIdInput").value=e,$("#sectionPatternInput").value=n.pattern,$("#sectionCrosslistInput").value=n?.x?.join("\n")||"",$("#sectionInstructorInput").value=n?.i?.join("\n")||""}function makeSectionCard(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard",t.a&&t.e&&t.e>db.now()&&o.classList.add("acceptingAttendance");var i=o.appendChild(document.createElement("div"));return i.class="cardTitle",i.innerText=e,a&&t.x&&(i.innerText+="\n"+t.x.join("\n")),(i=o.appendChild(document.createElement("div"))).innerText=t.pattern,(i=o.appendChild(document.createElement("div"))).innerText=t.room,t?.i?.forEach((e=>{(i=o.appendChild(document.createElement("div"))).innerText=e})),o.addEventListener("click",n),o}async function getAttendanceCardClick(e){showGetAttendance(e.currentTarget.id)}function markAttendanceCardClick(e){showMarkAttendance(e.currentTarget.id,e.currentTarget._sectionDoc)}async function addSectionToStudentClick(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne("users",auth.currentUser.email,{[localStorage.semesterSelected]:db.arrayUnion(t)})).error?alert("Something went wrong."):(userDoc[localStorage.semesterSelected]||(userDoc[localStorage.semesterSelected]=[]),userDoc[localStorage.semesterSelected].push(t),addSectionCard(t,n,$("#studentSections"),markAttendanceCardClick),navigateBack())}function addSectionCard(e,t,n,a,o){var i=makeSectionCard(e,t,a,o);n.insertBefore(i,n.lastElementChild)}async function showAvailableStudentSections(){showInMain("selectStudentSection");var e=await getSections(localStorage.semesterSelected),t=$("#availableStudentSections");t.innerHTML="";for(let n in e){let a=e[n];if(userDoc[localStorage.semesterSelected]?.includes(n)||addSectionCard(n,a,t,addSectionToStudentClick),a?.x?.length)for(let e of a.x)e&&!userDoc[localStorage.semesterSelected]?.includes(e)&&addSectionCard(e,a,t,addSectionToStudentClick)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")}async function showEnrolledAndTeachingSections(e){var t=$("#studentSections"),n=$("#instructorSections");if(!e)return t.classList.add("hidden"),void n.classList.add("hidden");t.classList.remove("hidden"),1&userDoc.r&&n.classList.remove("hidden");var a=await getSections(e);for(let e=t.childElementCount-1;e--;)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let i=a[o];if(userDoc[e]?.includes(o)&&addSectionCard(o,i,t,markAttendanceCardClick),i?.x?.length)for(let n of i.x)userDoc[e]?.includes(n)&&addSectionCard(n,i,t,markAttendanceCardClick);!n.classList.contains("hidden")&&i?.i?.includes(auth.currentUser.email)&&addSectionCard(o,i,n,getAttendanceCardClick,!0)}}$("#sectionSubmitBtn").addEventListener("click",(async e=>{let t="Create New Section"===$("#sectionSubmitBtn").innerText,n=$("#sectionSemesterSelect").value,a=$("#sectionIdInput").value,o={pattern:$("#sectionPatternInput").value,room:$("#sectionRoomSelect").value,i:$("#sectionInstructorInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),x:$("#sectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e))};if(!n)return void alert("Please select semester.");if(!a)return void alert("Please enter section id.");if(t&&await getSection(n,a))return void alert("Section "+a+" already exists.");if(!o.pattern)return void alert("Please enter section day/time pattern.");if(!o.room)return void alert("Please select a room.");if(!o.i)return void alert("Please enter section instructor(s).");let i=await getSections(n);for(let e in i)if(e!==a){let t=i[e];if(t.pattern===o.pattern&&t.room===o.room)return void alert(t.room+" is booked at this time by section "+e+".\n\nIf these sections are cross-listed, please edit information for "+e+" to indicate this, rather than creating a new section.")}(await db.updateOne("sections",n,{[a]:o})).error?alert("Error: Cannot add section."):(i[a]=o,addSectionCard(a,o,$("#instructorSections")),navigateBack())})),$("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,showEnrolledAndTeachingSections(e.target.value)}));const nameInput=$("#nameInput"),saveNameBtn=$("#saveNameBtn");nameInput.addEventListener("input",(e=>{nameInput.lastValue!==nameInput.value?saveNameBtn.classList.remove("hidden"):saveNameBtn.classList.add("hidden")})),saveNameBtn.addEventListener("click",(async e=>{saveNameBtn.setAttribute("disabled","true"),(await db.updateOne("users",auth.currentUser.email,{n:nameInput.value})).error||(saveNameBtn.classList.add("hidden"),nameInput.lastValue=nameInput.value),saveNameBtn.removeAttribute("disabled")}));const toastDiv=$("#toast"),toastMsg=$("#toastMessage");function toast(e,t,n){if(n&&toastDiv.style.setProperty("--toast-accent",n>0?"#4f6":"#f64"),toastMsg.innerHTML=t?t+"\n\n":"","object"==typeof e)for(let t in e)e[t]&&(toastMsg.innerHTML+=t+" : "+e[t]+"\n");else toastMsg.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",closeToast),window.addEventListener("keydown",closeToast),window.addEventListener("popstate",closeToast),mainDiv.addEventListener("scroll",closeToast),toastDiv.classList.remove("hidden"),toastDiv.classList.add("slide-up")}),200)}function closeToast(){window.removeEventListener("mousedown",closeToast),window.removeEventListener("keydown",closeToast),window.removeEventListener("popstate",closeToast),mainDiv.removeEventListener("scroll",closeToast),toastDiv.classList.add("hidden"),toastDiv.classList.remove("slide-up")}const themeToggle=$("#theme-switch");function toggleDarkMode(){setTheme(themeToggle.innerText.startsWith("dark"))}function setTheme(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),themeToggle.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),themeToggle.innerText="dark_mode")}function changeFontSize(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}setTheme(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);