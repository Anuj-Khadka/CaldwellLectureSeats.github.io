"use strict";const APP_LAST_UPDATE="2024-03-17",APP_TITLE="LectureSeats",APP_VERSION="v0.2."+"2024-03-17".replace(/-/g,"")+" (beta)";function showError(e){document.getElementById("main").style.display="none",document.getElementById("signin").style.display="none",document.getElementById("error").classList.remove("hidden"),document.getElementById("error").style.display="block",document.getElementById("errorDetails").innerHTML=`\n    <b>Error details:</b><br>\n    <pre>${e.stack||e}</pre>\n  `}!function(){try{const I="@caldwell.edu",k=[40.83352325048076,-74.27245652688725,"Caldwell University, 120 Bloomfield Avenue, Caldwell, NJ 07006"],x="2024Spring",B="( 100 * P + 50 * L ) / N",R=" ",$="|",N=1,O=2,_=6e5,P="user-icon.png",D=2,M=1,U=0,q=-1,H=3500,j=200,F="users",W="attend",G="sections",Y="rooms",V="a",J="c",Q="u",z="d",Z="m",X="e",K="n",ee="f",te="p",ne="s",ae="l",oe="nt",ie="rl",re="r",le="rn",se="rm",de="bl",ce="cm",ue="x",me="t",fe="pt",ge="g",he="gl",pe="gv",Se="rq",ve="i",we="in",be="v",ye="b",Ce="Section",Le="Email",Te="Username",Ae="Name",Ee="Last Name",Ie="Attendance-Grade",ke="On-time",xe="Late",Be="Absent",Re=[Le,Te,Ee,Ae,Ce,Ie,ke,xe,Be],$e=[Ee,Ae,Te,Ce,Ie,Be,xe,ke,Le],Ne=Re.length,Oe=[{P:10,L:0,E:0,A:0},{P:8,L:2,E:0,A:0},{P:8,L:0,E:0,A:2},{P:4,L:2,E:2,A:2},{P:0,L:0,E:0,A:10}],_e="abcdefghijklmnopqrstuvwxyz",Pe=(e,t)=>e+$+t,De=e=>e.split($),Me=e=>e?e.replace(/\s/g,"").toUpperCase():"",Ue=document.querySelector.bind(document),qe=document.querySelectorAll.bind(document),He=e=>e?.constructor===Boolean,je=e=>e?.constructor===Number&&!isNaN(e),Fe=e=>e?.constructor===String,We=e=>e?.constructor===Object,Ge=e=>e?.constructor===Array;function Ye(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(let n in e){let a=e[n];if("object"==typeof a){if(JSON.stringify(a)!==JSON.stringify(t[n]))return!1}else if(a!==t[n])return!1}return!0}function Ve(e){return e.map((e=>({r:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({r:e})=>e))}function Je(e){return Math.floor(Math.random()*e)}function Qe(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function ze(e){(Fe(e)?document.getElementById(e):e).classList.add("hidden")}function Ze(e){(Fe(e)?document.getElementById(e):e).classList.remove("hidden")}function Xe(e){(Fe(e)?document.getElementById(e):e).classList.toggle("hidden")}function Ke(e,t){Ge(e)||(e=[e]),Ge(t)||(t=[t]),e.forEach(Ze),t.forEach(ze)}function et(e,t,n={}){t?.length&&e.sort(((t,a)=>{let o,i;for(let r of y.sortStack){if(o=n[t[r]]||t[r],i=n[a[r]]||a[r],o>i)return e.sortDesc[r]?-1:1;if(i>o)return e.sortDesc[r]?1:-1}}))}function tt(e){return e.split("\n").map((e=>e.split("\t")))}function nt(e,t=2){return e.toString().padStart(t,"0")}function at(e,t){let n;n=e?new Date(e?.constructor===db.Timestamp?1e3*e.seconds:e):new Date;let a=n.getFullYear()+"-"+nt(n.getMonth()+1)+"-"+nt(n.getDate()),o=nt(n.getHours())+":"+nt(n.getMinutes());return t?a+t+o:[a,o]}async function ot(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}function it(e){e.style.animation="",e.offsetWidth,e.style.animation="spin 0.5s",setTimeout((()=>e.style.animation=""),500)}var e=[];function rt(t,n,a){a?(e=a).indx=0:e.indx=(e.indx+(t||1+Je(e.length-1)))%e.length,n&&(e.target=n),e.target&&(e.target.src=e[e.indx])}var t,n,a=0,o=0;function lt(e){let t=e.target.getBoundingClientRect();a=t.x-e.clientX,o=t.y-e.clientY,window.addEventListener("mousemove",st,!0)}function st(e){t.style.position="fixed",t.style.top=e.clientY+o+"px",t.style.left=e.clientX+a+"px"}function dt(e){let t,n,a,o,i=!1;e.addEventListener("mousedown",(r=>{i=!0,e.classList.add("dragging"),t=r.pageX-e.offsetLeft,n=r.pageY-e.offsetTop,a=e.scrollLeft,o=e.scrollTop})),e.addEventListener("mouseleave",(t=>{i&&(i=!1,e.classList.remove("dragging"))})),e.addEventListener("mouseup",(t=>{i&&(Math.round(a)===Math.round(e.scrollLeft)&&Math.round(o)===Math.round(e.scrollTop)||(t.preventDefault(),t.stopPropagation(),window.addEventListener("click",(e=>{e.stopPropagation()}),{capture:!0,once:!0})),i=!1,e.classList.remove("dragging"))})),e.addEventListener("mousemove",(r=>{i&&(r.preventDefault(),r.stopPropagation(),e.scrollLeft=a-3*(r.pageX-e.offsetLeft-t),e.scrollTop=o-3*(r.pageY-e.offsetTop-n))}))}window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",st,!0),n&&n(t.style.left,t.style.top)}),!1);const ct=1/(6378137*Math.PI/180);function ut(e,t){return e*ct/Math.cos(t*Math.PI/180)}function mt(e,t,n,a,o){let i=L.map(e,{});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(i);let r=a*ct;let l=ut(a,t);i.fitBounds([[t-r,n-l],[t+r,n+l]]);let s=L.circle([t,n],{radius:a}).addTo(i);o&&i.on("moveend",(e=>{let t=i.getCenter();t=[t.lat,t.lng],o(t),s.setLatLng(t)}))}var i,r={};function ft(e,t){let n=e+","+t;if(n in r)return r[n];let[a,o]=e,[i,l]=t;const s=a*Math.PI/180,d=i*Math.PI/180,c=(i-a)*Math.PI/180,u=(l-o)*Math.PI/180,m=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s)*Math.cos(d)*Math.sin(u/2)*Math.sin(u/2);let f=6371e3*(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)));return r[n]=f,f}async function gt(e,t){let n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`);if(n.ok)return(await n.json()).display_name}function ht(e){return(e=e.trim()).split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}function pt(e){return e.replaceAll(R,".")+I}function St(e){try{return e.split("@")[0].replaceAll(".",R)}catch(e){}}function vt(e){return e?.target&&(e=e.target.value),e.search(/(^(?!(__)))(?!.*(\.\.))(^([a-zA-Z0-9-_.]+)$)/)>=0}function wt(e,t){let n=e.value.search(/(^(?!(__)))(^([a-zA-Z0-9-_]+)$)/)>=0;return n||(e.value=e.value.replace(/[^A-Za-z0-9-_]+/g,"").replace(/^_+/,"_"),t&&Zo(t+" can only contain letters, numbers, dashes, and underscores.\nCannot start with two underscores.")),n}async function bt(){delete window.loadPath,await auth.signOut(),location.reload()}async function yt(e){if(e){if(Ke([$t,"user"],"signin"),Ue("#userDisplayName").innerText=e.email,!auth.currentUser.emailVerified&&!e.email.startsWith("_test_"))return Ue("#emailVerificationEmail").innerText=e.email,localStorage.verificationEmailSent?Ue("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent:await Ct(),void Dt("emailVerification","Please verify your email address before proceeding.");if(delete localStorage.verificationEmailSent,(i=await db.getDoc(F,e.email))?.error)return void Pt("dbError");if(null===i){i={};let t=await db.insertOne(F,e.email,i);if(t.error)return void Ko("Could not add user to database.\n\n"+t.error.code)}let t;i[K]&&i[ee]||Dt("profile","Please enter your last name and your preferred name and save."),i[X]||(i[X]={}),localStorage.semesterSelected&&!i[X][localStorage.semesterSelected]&&(i[X][localStorage.semesterSelected]={}),Ho.value=Ho.lastValue=i[K]||"",jo.value=jo.lastValue=i[ee]||"",i[ie]&O&&(Ze("allSectionsBtn"),Ze("manageUsersBtn")),(i[ie]&N||i[ie]&O)&&Ze("roomsBtn"),localStorage.markAttendanceSectionId?an():localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&await kn();let n=Ue("#semesterSelect");if(1==n.children.length){let e=await qt();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),Mo(a))}}else if(i=null,delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,Ke("signin",[$t,"user"]),Ue("#signInSendEmailInput").value=Ue("#signInEmailInput").value=localStorage.email||"",isSignInWithEmailLink(auth,window.loadPath||"")){delete localStorage.signInLinkSent;let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-action-code"===e?.error?Ko("This sign-in link has expired.\nPlease enter your username and click the [Send sign-in link] button to receive a new link."):"auth/invalid-email"===e?.error?(localStorage.email="",_t("signinConfirmEmail")):e?.error&&Ko("Could not sign in.\n\n"+e.error)}else localStorage.email&&localStorage.signInLinkSent&&At()}async function Ct(){try{await sendEmailVerification(window.auth.currentUser),localStorage.verificationEmailSent=at(null," at "),Ue("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent,Zo("Email verification link was sent to "+auth.currentUser.email)}catch(e){"auth/too-many-requests"===e.code?Ko("Cannot send another email yet.\nPlease wait a few minutes before retrying."):Ko("Could not send email.\n"+e.code)}}function Lt(){localStorage.email&&localStorage.signInLinkSent?At():_t("signinSendEmail")}function Tt(){delete localStorage.signInLinkSent,_t("signinSendEmail")}function At(){Ue("#signinLinkSent > div:first-child").innerHTML=`We sent an email with a sign-in link to ${localStorage.email}${I} on ${localStorage.signInLinkSent}.<p>The email subject should be "Sign in to LectureSeats".<p>Please go to your email and click on the sign-in link.`,_t("signinLinkSent")}async function Et(){if(!vt(Ue("#signInSendEmailInput").value))return void Ko("Invalid email address.");if(localStorage.email=Ue("#signInSendEmailInput").value=Ue("#signInSendEmailInput").value.trim().toLowerCase(),!localStorage.email)return void Zo("Please enter your username.");let e=await sendEmailLink(localStorage.email);"auth/invalid-email"===e?.error?(Ko(`${localStorage.email}${I} is not a valid email address.`),localStorage.email=""):e?.error?Ko(`Could not send sign-in email to ${localStorage.email}${I}.\n\n${e.error}`):(localStorage.signInLinkSent=at(null," at "),At())}async function It(){if(localStorage.email=Ue("#signInConfirmEmailInput").value.trim(),!localStorage.email)return void Zo("Please enter your username and click the [Sign in] button.");let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-email"===e?.error?(Ko(`Email ${localStorage.email}${I} does not match the email address to which the link was sent.`),localStorage.email=""):e?.error&&Ko("Could not sign in.\n\n"+e.error)}function kt(e,t){switch(e.code){case"auth/email-already-in-use":Ko(`Email address ${Ue("#signInEmailInput").value}${I} already in use.`);break;case"auth/invalid-email":Ko(`Email address ${Ue("#signInEmailInput").value}${I} is invalid.`);break;case"auth/operation-not-allowed":Ko("Error during sign up.");break;case"auth/user-not-found":Ko(`User ${Ue("#signInEmailInput").value}${I} not found.`+(t?"":"\nDid you mean to click the Register button?"));break;case"auth/wrong-password":Ko("Wrong password.");break;case"auth/missing-password":Ko("No password provided.");break;case"auth/weak-password":Ko("Password is not strong enough. Add additional characters including special characters and numbers.");break;default:Ko("Unable to perform action.\n"+e.message);break}}function xt(){Ue("#signInEmailInput").value=Ue("#signInEmailInput").value.trim().toLowerCase(),localStorage.email=Ue("#signInEmailInput").value,signIn(Ue("#signInEmailInput").value,Ue("#signInPasswordInput").value).catch(kt)}function Bt(){vt(Ue("#signInEmailInput").value)?(Ue("#signInEmailInput").value=Ue("#signInEmailInput").value.trim().toLowerCase(),signUp(Ue("#signInEmailInput").value,Ue("#signInPasswordInput").value).then((e=>{})).catch(kt)):Ko("Invalid email address.")}async function Rt(){Ue("#signInEmailInput").value=Ue("#signInEmailInput").value.trim().toLowerCase(),vt(Ue("#signInEmailInput").value)?Ue("#signInEmailInput").value?await Vo(`Would you like to send an email with a password-reset link to ${Ue("#signInEmailInput").value}${I}?`)&&passwordReset(Ue("#signInEmailInput").value).then((()=>{Zo("Password reset email sent.","",1)})).catch((e=>kt(e,!0))):Zo("You must enter your email address to reset your password."):Ko("Invalid email address.")}window.addEventListener("load",(async function(){if(!window.onAuth)return void showError("Could not load firebase.mjs");if(navigator.userAgent.includes("Firefox"))return Ke("error",[$t,"signin"]),void(Ue("#error").innerHTML="Sorry, this app does not work on Firefox.<p>Please use Chrome, Edge, or Safari for best experience.");let e;setInterval((()=>{e&&navigator.onLine?(Nt(),Pt("sections"),e=!1):e||this.navigator.onLine||(Dt("offlineError"),e=!0)}),500),setTimeout((()=>location.reload()),864e5),document.title=APP_TITLE,qe(".domainName").forEach((e=>e.innerText=I)),Ue("#versionInfo").innerText=`LectureSeats ${APP_VERSION}\n\nApplication last updated on: 2024-03-17.\n`,window.loadPath=window.location.href;let t=new URLSearchParams(location.search);if(window.history.pushState(null,APP_TITLE,location.origin+this.location.pathname),t.has("s")){let[e,n]=De(t.get("s"));localStorage.semesterSelected=e,localStorage.markAttendanceSectionId=n}else localStorage.semesterSelected||(localStorage.semesterSelected=x);t.has("c")&&(localStorage.markAttendanceCode=t.get("c")),onAuth(yt,(e=>Ko("Authentication error.\n\n"+e)))}));const $t=Ue("#main");var l,s=!0;function Nt(){s=!0,l=null}function Ot(e){s=!1,l=e}function _t(e){Qe(Ue("#signin"),Ue("#"+e))}function Pt(e){s?(window.location.hash.slice(1)===e&&(window.location.hash=""),window.location.hash=e):l&&Zo(l)}function Dt(e,t){Qe($t,Ue("#"+e)),Ot(t)}function Mt(){s&&history.back()}function Ut(e){e?(Ze("loading"),Ot()):(ze("loading"),Nt())}window.onhashchange=function(e){s?(Qe($t,Ue(location.hash||"#sections")),$t.scrollTop=0):"#_"!==location.hash&&(location.hash="#_")},window.addEventListener("keydown",(e=>{"Escape"===e.key&&(Ue("#infoScreen").classList.contains("hidden")?Mt():ze("infoScreen"))})),window.addEventListener("popstate",(e=>{ze("infoScreen")}));var d={},c={},u={},m={},f={};async function qt(){return["2023Fall","2024Winter","2024Spring","2024Summer","2024Fall"]}function Ht(e){return e=Object.fromEntries((e||"").split("").reduce(((e,t,n)=>(n%2?e[e.length-1].push(t):e.push([t]))&&e),[])),{[ae]:e[ae]?parseInt(e[ae]):-1,[te]:e[te]?parseInt(e[te]):-1,[ne]:e[ne]?parseInt(e[ne]):-1}}function jt(e){let t="";return e[ae]>=0&&(t+=ae+e[ae]),e[te]>=0&&(t+=te+e[te]),e[ne]>=0&&(t+=ne+e[ne]),t}async function Ft(e){if(e&&!d[e])if(d[e]=await db.getDoc(G,e),null===d[e])d[e]={};else{if(d[e].error)return void Ko("Something went wrong.\n\nTry to reload.");for(let t in d[e]){let n=d[e][t],a=Ht(n[Se]);Object.assign(n,a)}}return d[e]}async function Wt(e,t){let n=await Ft(e);if(n[t])return n[t].id=t,n[t]}async function Gt(e){return!e&&c._gotAllRooms||((c=await db.find(Y))._gotAllRooms=!0),c}async function Yt(e){return e in c||(c[e]=await db.getDoc(Y,e)),c[e]}async function Vt(e){return tt((await Yt(e))[se].toUpperCase())}async function Jt(e,t,n){Ge(t)||(t=[t]);var a=[];for(var o of(a._docs=[],a._sectionIds=[],t)){let t=Pe(e,o);if(n||!u[t])if(u[t]=await db.getDoc(W,t),null===u[t])u[t]={};else{if(u[t].error)return void Ko("Something went wrong.\n\nPlease try again.");for(let e in u[t])e.length>1&&(u[t][e][Le]=pt(e),u[t][e][Te]=e,u[t][e][Ce]=o,Object.entries(u[t][e][V]).forEach((([e,t])=>{t.code=e})))}a.push(...Object.entries(u[t]).filter((([e,t])=>e.length>1)).map((([e,t])=>t))),a._docs.push(u[t])}return a._sectionIds=t,a}async function Qt(e,t){if(!e)return{};if(Ge(e))return Object.assign(...await Promise.all(e.map((e=>Qt(e,t)))));e=t?t===K||t===ee?ht(e):e:e.toLowerCase();let n=t?t+":"+e:e,a=f[n];return a?Object.fromEntries(a.map((e=>[e,m[e]]))):t&&t!==K&&t!==ee||(a=Object.entries(f).filter((e=>n.startsWith(e[0]))).map((e=>e[1]))[0],!a)?(a=t?t===K||t===ee?await db.find(F,db.orderBy(t),...db.startsWith(t,e)):await db.find(F,db.orderBy(t),db.where(t,"==",e)):await db.find(F,db.orderBy(db.documentId()),...db.startsWith(db.documentId(),e)),a.error||(Object.assign(m,a),f[n]=Object.keys(a)),a):(a=a.map((e=>[e,m[e]])),Object.fromEntries(a.filter((n=>t?n[1][t].startsWith(e):n[0].startsWith(e)))))}async function zt(e){let t={},n=[];for(let a of e)a in m?t[a]=m[a]:n.push(a);if(!n.length)return t;for(let e=0;e<n.length;e+=30){let a=await db.find(F,db.where(db.documentId(),"in",n.slice(e,e+30)));if(a.error)return a;Object.assign(t,a),Object.assign(m,a)}return t}async function Zt(e){let t=m[e];if(t)return t;let n=await db.getDoc(F,e);return n?.error||n&&(m[e]=n),n}function Xt(e){let t={},n=Object.assign({},...Object.values(u));for(let a of e){let e=St(a);e in n&&(t[a]={[ee]:n[e][ee],[K]:n[e][K]})}return t}function Kt(e,t="",n=""){if(!e[K]&&!e[ee])return"";let a;return a=e[K]&&e[ee]?e[K].split(" ").includes(e[ee])?e[K]:e[ee]+", "+e[K]:e[K]||e[ee],t+a+n}const en=Ue("#markAttendanceSectionId"),tn=Ue("#markAttendanceClassCodeInput"),nn=Ue("#markAttendanceLocation");async function an(e,t){try{if(Pt("markAttendance"),!e){if(e=localStorage.markAttendanceSectionId,delete localStorage.markAttendanceSectionId,(t=await Wt(localStorage.semesterSelected,e))[ue]?.length){let n=[e].concat(t[ue]),a=n.filter((e=>e in i[X][localStorage.semesterSelected]));if(a.length)e=a[0];else{e=(await Vo("Please choose which section you are enrolled in.",{},n)).clicked}}i[X][localStorage.semesterSelected][e]||(i[X][localStorage.semesterSelected][e]={})}const n=St(auth.currentUser.email);t[ye]&&t[ye][n]?en._sectionDoc=Object.assign({},t,Ht(t[ye][n])):en._sectionDoc=t,en.innerText=e,Ue("#markAttendanceRemoveButtonSectionId").innerText=e,Ue("#markAttendanceSectionInfo").innerText=Ro(en._sectionDoc),tn.value=localStorage.markAttendanceCode||"",delete localStorage.markAttendanceCode,en._sectionDoc[ne]<0?ze("markAttendanceSeatContainer"):(Ze("markAttendanceSeatContainer"),en._sectionDoc[ne]>0?Ue('label[for="markAttendanceSeatCodeInput"]').classList.add("required"):Ue('label[for="markAttendanceSeatCodeInput"]').classList.remove("required"),Ue("#markAttendanceSeatCodeInput").value=""),en._sectionDoc[te]<0?ze("markAttendancePhotoContainer"):(Ke(["markAttendancePhotoContainer","defaultSelfieImg","addPhotoBtn"],[bn,yn,"snapPhotoBtn","switchPhotoBtn"]),en._sectionDoc[te]>0?Ue('label[for="selfieCanvas"]').classList.add("required"):Ue('label[for="selfieCanvas"]').classList.remove("required")),en._sectionDoc[ae]<0?ze("markAttendanceLocationContainer"):(Ze("markAttendanceLocationContainer"),en._sectionDoc[ae]>0?Ue('label[for="markAttendanceLocation"]').classList.add("required"):Ue('label[for="markAttendanceLocation"]').classList.remove("required")),sn(localStorage.semesterSelected,e),ln()}catch(e){Ko("Something went wrong:\n"+e.stack)}}async function on(e,t){return!t||((e=Me(e))?(await Vt(t)).flat().indexOf(e)>=0:void 0)}async function rn(){if(it(Ue("#locationMissingBtn")),it(Ue("#locationMissingBtn2")),(await ot()).error){let e=en._sectionDoc[ae];Zo("Please make sure your location permissions are enabled and try again.\nNote: You may need to reload this page after enabling your camera.\n\n"+si,"Unable to get location",e>1?-1:e>0?-.5:0)}ln()}async function ln(){try{const e=Ue("#markAttendanceRequirementsList");e.innerHTML="";let t=!1;if(tn.value||(e.appendChild(document.createElement("li")).innerText="Attendance passcode",t=!0),en._sectionDoc[ae]>-1&&!nn.value){let n=await ot();n.error?(ze(nn),en._sectionDoc[ae]>0?(Ke("markAttendanceLocationOffButRequired","markAttendanceLocationOff"),e.appendChild(document.createElement("li")).innerText="Location",en._sectionDoc[ae]>1&&(t=!0)):Ke("markAttendanceLocationOff","markAttendanceLocationOffButRequired")):(nn.value=n,Ke(nn,["markAttendanceLocationOffButRequired","markAttendanceLocationOff"]))}if(en._sectionDoc[ne]>0&&!await on(Ue("#markAttendanceSeatCodeInput").value,en._sectionDoc[re])&&(e.appendChild(document.createElement("li")).innerText="Valid seat code",en._sectionDoc[ne]>1&&(t=!0)),en._sectionDoc[te]>-1){let n=p?.size&&v&&(new Date).getTime()-v<_;en._sectionDoc[te]>0&&!n&&(Ke("defaultSelfieImg",[bn,yn]),p=v=null,e.appendChild(document.createElement("li")).innerText="New photo",en._sectionDoc[te]>1&&(t=!0))}e.innerHTML?Ze("markAttendanceRequirements"):ze("markAttendanceRequirements"),t?Ue("#markAttendanceButton").setAttribute("disabled",!0):Ue("#markAttendanceButton").removeAttribute("disabled")}catch(e){Ko("Something went wrong validating attendance info:\n"+e.stack)}}function sn(e,t){const n=Ue("#attendanceMarked");let a=Object.entries(i[X][e][t]).sort(((e,t)=>e[1][z]-t[1][z]));if(a?.length){const e=en._sectionDoc[z];n.innerHTML="";let t=n.appendChild(document.createElement("summary")),o=n.appendChild(document.createElement("small")),i=0,r=0,l=0,s=0;for(let[t,n]of a){let a=at(n[z]),d=o.appendChild(document.createElement("div")),c=a[0]+" ";if(n[Q]===M)c+="absent",d.setAttribute("absent",!0),r++;else if(n[Q]===D)c+="absence excused",d.setAttribute("excused",!0),l++;else if(n[Q]===q)c+=a[1]+" failed to mark attendance",d.setAttribute("absent",!0);else{c+=a[1];let o=Math.floor((n[z]-e[t])/60);o>=en._sectionDoc[he]?(d.setAttribute("late",!0),c+=` (${o}min late)`,s++):i++}n[oe]&&(c+=" <small>("+n[oe]+")</small>"),d.innerHTML=c}if(t.innerHTML="",en._sectionDoc[pe]){let e=executeEquation(en._sectionDoc[ge],{P:i,A:r,L:s,E:l}),n=executeEquation(en._sectionDoc[ge],{P:i+r+s+l,A:0,L:0,E:0});t.innerHTML+=`Current attendance grade: ${e.toFixed(1)} out of ${n.toFixed(1)}<br>`}t.innerHTML+=`Attendance record: <lnk>${i} present, ${s} late, ${r} absent, ${l} excused</lnk>`,$t.scrollTop=0}else n.innerHTML=""}async function dn(){try{if(nn.value=null,await ln(),Ue("#markAttendanceButton").getAttribute("disabled"))Zo("Missing some of the required fields.","",-1);else{if(markAttendanceRequirementsList.innerHTML&&!await Vo(`Your instructor requests the following information that you have not supplied:\n${markAttendanceRequirementsList.innerHTML}\n\nAre you sure you would like to mark attendance as is?\n\nPress Cancel to go back and add all of the required information.\nPress OK to mark your attendance without the requested information.`))return;let e=tn.value,t=en.innerText,n=localStorage.semesterSelected;if(e in i[X][n][t]&&!i[X][n][t][e][Q])return void Zo("You are already marked present, no need to do it again.");Ut(!0);let a=Ue("#markAttendanceSeatCodeInput").value,o=nn.value;o&&(o=[o.latitude,o.longitude,Math.round(o.accuracy)]);let r=await mn(n,t,e,a,p,o);r?.error?(sn(n,t),Zo(r.error,"Your attendance was NOT marked.",-1)):r?.warning?(sn(n,t),Xo(r.warning)):(sn(n,t),Zo("Your attendance was marked.","Success!",1)),Ut(!1)}}catch(e){Ko("Something went wrong trying to mark attendance:\n"+e.stack)}}function cn(e,t,n,a){return[e,t,n,a+".jpg"].join("/")}function un(e,t,n){return[e,t,n].join("/")}async function mn(e,t,n,a,o,r){const l=St(auth.currentUser.email);let s={[z]:db.serverTimestamp()},d={[`${l}.${K}`]:i[K],[`${l}.${ee}`]:i[ee],[`${l}.${V}.${n}`]:s};o?.size&&(S=cn(l,e,t,n),s[te]=!0,d[`${l}.${te}`]=S),a&&(s[ne]=a),r&&(s[ae]=r);let c=await db.updateOne(W,Pe(e,t),d);if(c?.error)return i[X][e][t][n]={[z]:db.Timestamp.now(),[Q]:q},{error:"Please make sure the instructor is taking attendance, and that your attendance passcode is correct."};let u="",m=[];return o?.size&&(c=await uploadFile(S,o),c?.error&&(u+="- we were unable to save your photo\n",m.push("photo not saved"))),c=await db.updateOne(F,auth.currentUser.email,{[X+"."+e+"."+t+"."+n]:{[z]:db.serverTimestamp()}}),c?.error&&(u+="- we were unable to save your attendance receipt\n",m.push("missing receipt")),i[X][e][t][n]={[z]:db.Timestamp.now(),[oe]:m.length?m.join(", "):""},u?{warning:"Your attendance was marked (the instructor knows you attended).\nHOWEVER:\n"+u}:void 0}async function fn(){let e="Are you sure you would like to remove this section from the list of sections you are enrolled in?";if(Ue("#attendanceMarked").innerHTML&&(e+="\n\nWARNING: This action will delete all of your attendance receipts for this section."),await Vo(e)){let e=en.innerText;(await db.updateOne(F,auth.currentUser.email,{[X+"."+localStorage.semesterSelected+"."+e]:db.deleteField()})).error?Ko("Something went wrong. Please try again."):(delete i[X][localStorage.semesterSelected][e],Mo(localStorage.semesterSelected),Mt())}}const gn=new ZXing.BrowserMultiFormatReader;var g,h;async function hn(e){Pt("QRreader"),g=await getVideoStream(!1),h=e,vn(),window.addEventListener("popstate",pn,{once:!0})}function pn(){gn.reset(),window.removeEventListener("popstate",pn)}function Sn(e,t){if(e){let t;if(pn(),Mt(),e.text?.startsWith("http")&&(t=new URLSearchParams(e.text.split("?")[1])),h)t?.has("c")&&(e.text=t.get("c")),document.getElementById(h).value=e.text,ln();else if(t?.has("s")){let[e,n]=De(t.get("s"));localStorage.semesterSelected!==e&&(localStorage.semesterSelected=e,Mo(e)),localStorage.markAttendanceSectionId=n,localStorage.markAttendanceCode=t.get("c"),setTimeout(an,50)}}!t||t instanceof ZXing.NotFoundException||Ko("Could not complete QR scan.\n"+t)}async function vn(){gn.decodeFromStream(g,"QRreaderVideo",Sn)}async function wn(){g=await switchCameraStream(g),gn.reset(),vn()}var p=null,S=null,v=null;const bn=Ue("#selfieCanvas"),yn=Ue("#selfieVideo");async function Cn(){try{await startCamera(yn,j),window.addEventListener("popstate",stopCamera,{once:!0}),Ke([yn,"snapPhotoBtn","switchPhotoBtn"],["defaultSelfieImg",bn,"addPhotoBtn"])}catch(e){Ko("Unable to start camera.\nPlease make sure your camera permissions are enabled and try again.\nNote: You may need to reload this page after enabling your camera.\n\n"+li)}}async function Ln(){Ke([bn,"addPhotoBtn"],[yn,"snapPhotoBtn","switchPhotoBtn"]),takePhoto(yn,bn,j),p=await canvasToBlob(bn),v=(new Date).getTime(),ln()}const Tn=Ue("#getAttendanceSectionId"),An=Ue("#getAttendanceClassCodeInput"),En=Ue("#collectAttendanceBtn"),In=Ue("#minutesToCollectAttendance");async function kn(e,t){if(Pt("getAttendance"),!e){let n=De(localStorage.takingAttendance);localStorage.semesterSelected=n[0],e=n[1],t=await Wt(localStorage.semesterSelected,e)}if(Tn.innerText=e,Tn._sectionDoc=t,Ue("#getAttendanceCrossListIds").innerHTML=t[ue]?"<span>"+t[ue].join("</span> <span>")+"</span>":"",Ue("#attendanceRoomSectionId").innerHTML=Ue("#attendanceTableSectionId").innerHTML=`<div><span>${Tn.innerText} ${Ue("#getAttendanceCrossListIds").innerText}</span></div>`,Ue("#getAttendanceSectionInfo").innerText=Ro(t,!0),Ue("#getAttendanceEditBtn").setAttribute("onclick",""),Ue("#getAttendanceEditBtn").onclick=n=>{Qa(e,t)},ze("currentAttendanceStatus"),await na(!0,!1),b.length){let n=Object.fromEntries(b.attendanceCodesAndTimes);if(!t[z]||!Ye(t[z],n)){(await db.updateOne(G,localStorage.semesterSelected,{[`${e}.${z}`]:n})).error?Xo("Could not update datetime records for this section."):t[z]=n}}if(b._docs[0][J]&&b._docs[0][z].seconds+60*b._docs[0][Z]>db.now())localStorage.takingAttendance=Pe(localStorage.semesterSelected,e),An.value=b._docs[0][J],localStorage.minutesToCollectAttendance=b._docs[0][Z],localStorage.attendanceEndtime=b._docs[0][z].seconds+60*b._docs[0][Z],Mn(),Ze("getAttendanceControls"),Hn();else{localStorage.takingAttendance===Pe(localStorage.semesterSelected,e)?(delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,Ze("getAttendanceControls")):localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&(ze("getAttendanceControls"),ze("QRcodeContainer"));let t=b.attendanceCodesAndTimes&&b.attendanceCodesAndTimes[b.attendanceCodesAndTimes.length-1];t&&at(t[1])[0]===at()[0]?(An.value=t[0],Hn(!1)):xn()}In.innerText=localStorage.minutesToCollectAttendance||75}function xn(){An.value=_e[Je(26)]+Math.random().toString().substring(2,6)}function Bn(){let e=new URL(window.location);e.hash=e.search="",e.searchParams.append("s",Pe(localStorage.semesterSelected,Tn.innerText)),navigator.clipboard.writeText(e.href),Zo("URL link for this section copied to clipboard.")}function Rn(){let e=new URL(window.location);e.hash=e.search="",e.searchParams.append("s",Pe(localStorage.semesterSelected,Tn.innerText)),e.searchParams.append("c",An.value),navigator.clipboard.writeText(e.href),Zo("URL link for this attendance copied to clipboard.")}function $n(){let e=location.protocol+"//"+location.host+location.pathname+"?c="+An.value+"&s="+Pe(localStorage.semesterSelected,Tn.innerText);window.open(`qrcode.html?${e}`,"LectureSeats QR Code","width=300,height=300,top=100,left=600")}In.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t)}else"ArrowUp"===e.key?e.target.innerText=(parseInt(e.target.innerText)||0)+1:isNaN(parseInt(e.key))&&!["Backspace","Delete","ArrowLeft","ArrowRight"].includes(e.key)&&e.preventDefault()}));const Nn=new ZXing.BrowserQRCodeSvgWriter;function On(e=null){const a=Ue("#QRcodeContainer");let o=location.protocol+"//"+location.host+location.pathname+"?c="+An.value+"&s="+Pe(localStorage.semesterSelected,Tn.innerText);if(o!==a.url){a.url=o,Ue("#QRcode").innerHTML="",Nn.writeToDom("#QRcode",o,300,300);let e=Ue("#QRcode > svg");e.removeAttribute("width"),e.removeAttribute("height"),e.setAttribute("viewBox","0 0 300 300"),t=a,n=(e,t)=>localStorage.qrPos=[e,t],e.addEventListener("mousedown",lt,!1),Pn.observe(a),localStorage.qrPos&&([a.style.left,a.style.top]=localStorage.qrPos.split(",")),localStorage.qrSize&&([a.style.width,a.style.height]=localStorage.qrSize.split(","))}null===e?Xe("QRcodeContainer"):e?Ze("QRcodeContainer"):ze("QRcodeContainer")}let _n;const Pn=new ResizeObserver((e=>{let t=e[0].contentRect;t.width,t.height&&(clearTimeout(_n),_n=setTimeout((()=>localStorage.qrSize=[t.width,t.height]),1e3))}));async function Dn(){if("Start"===En.innerText){let e=parseInt(In.innerText);if(isNaN(e)||e<1)return void Zo("Please enter a numeric value greater than or equal to 1 for the minutes attendance is to be collected.");if(e>180&&!await Vo(`WARNING: You are attempting to open attendance collection for ${Math.floor(e/60)}+ hours.\nAre you sure you wish to continue?`))return;if(!An.value)return void Zo("Please enter a passcode for taking attendance.");{wt(An),Fn();let e=b.attendanceCodesAndTimes.find((e=>e[0]===An.value));if(e){let t=at()[0];if(at(e[1])[0]!==t)return void Ko(`Cannot use attendance passcode ${An.value}.\nThis passcode has already been used to take attendance on ${e[1].split(" ").join(" at ")}.`);if(!await Vo(`You were collecting attendance earlier today using the same passcode.\n\nWould you like to continue taking the same attendance?\n\n<li>To continue collecting attendance for passcode ${An.value}, click Continue.</li>\n<li>To take a new attendance, click Cancel, change the value for Attendance passcode, and click the Start button again.</li>`,{},["Continue","Cancel"]))return}}Ut(!0);let t=Tn.innerText,n=Tn._sectionDoc,a=db.now()+60*e,o={[J]:An.value,[z]:db.serverTimestamp(),[Z]:e};o[ve]=n[ve];let i=await db.upsertOne(W,Pe(localStorage.semesterSelected,t),o);if(i?.error)return Ko("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Ut(!1);if(n[ue]?.length)for(let e of n[ue])if(i=await db.upsertOne(W,Pe(localStorage.semesterSelected,e),o),i?.error)return Ko("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Ut(!1);b._docs.forEach((e=>{o[z]={seconds:db.now()},Object.assign(e,o)})),localStorage.minutesToCollectAttendance=e,localStorage.takingAttendance=Pe(localStorage.semesterSelected,t),localStorage.attendanceEndtime=a,Mn()}else qn();Ut(!1)}var w;function Mn(){En.innerText="Stop",An.setAttribute("disabled",!0),Ue("#collectingAttendance").innerText="Collecting",Ke(["createQRCodeBtn","createURLBtn","attendanceCollectionStatus"],"randomAttendanceClassCodeBtn"),On(!0),Ue("#attendanceCollectionStatus>div").innerText=Tn.innerText+" "+Ue("#getAttendanceCrossListIds").innerText.trim(),In.removeAttribute("contenteditable"),Hn(!1),clearInterval(w),w=setInterval(Un,1e3)}function Un(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)qn(!1);else{let t=Math.floor(e/60),n=e-60*t;In.innerText=t+":"+nt(n),Ue("#attendanceCollectionStatus>span").innerText=In.innerText}}async function qn(e=!0,t=!0){if(e){let e=Tn.innerText,t=Tn._sectionDoc,n=[],a=db.updateOne(W,Pe(localStorage.semesterSelected,e),{[J]:db.deleteField()});if(a.error&&n.push(e),t[ue]?.length)for(let e of t[ue])a=db.updateOne(W,Pe(localStorage.semesterSelected,e),{[J]:db.deleteField()}),a.error&&n.push(e);if(n.length)return void Ko("Error updating database for the following sections:\n"+n)}clearInterval(w),w=void 0,En.innerText="Start",An.removeAttribute("disabled"),Ue("#collectingAttendance").innerText="Collect",Ke("randomAttendanceClassCodeBtn",["QRcodeContainer","createQRCodeBtn","createURLBtn","attendanceCollectionStatus"]),In.setAttribute("contenteditable","true"),In.innerText=localStorage.minutesToCollectAttendance||"75",b._docs.forEach((e=>delete e[J])),delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,t&&Hn(!0)}async function Hn(e=!0){Ze("currentAttendanceStatus"),e&&(await jn(!0),void 0!==w&&(!b._docs[0][J]||!(b._docs[0][z].seconds+60*b._docs[0][Z])>db.now())&&qn(!1,!1)),Ue("#currentAttendanceStatus > span").innerHTML=`Today's attendance for passcode ${An.value}:\n${b.filter((e=>e[V][An.value]&&!e[V][An.value][Q])).length} of ${b.length} marked present\n<small>(last checked ${(new Date).toLocaleTimeString()}</small>)`}var b={};async function jn(e){let t=Tn.innerText,n=Tn._sectionDoc,a=[t].concat(n[ue]||[]);(b=await Jt(localStorage.semesterSelected,a,e)).length?(Ke("showStudentsOptions","showStudentsAddBtn"),b.filter((e=>e[te])).length?Ze("learnNamesBtn"):ze("learnNamesBtn")):Ke("showStudentsAddBtn","showStudentsOptions")}function Fn(){if(!b.attendanceCodesAndTimes){var e={};b.map((e=>Object.values(e[V]))).flat().forEach((t=>{let n=t[z],a=e[t.code];(!a||a>n)&&(e[t.code]=n)})),b.attendanceCodesAndTimes=Object.entries(e).sort(((e,t)=>e[1]-t[1]))}}async function Wn(){let e=Tn.innerText,t=Tn._sectionDoc;if(t[ue]?.length){let n=[e].concat(t[ue]);if(n.push("Cancel"),e=(await Vo("Please select a section for adding a student",{},n)).clicked,!e)return}To((t=>{Mt(),setTimeout(Vn,100,t,e)}),`Find user records by using the filters below.\nClick on any user record to add that user to section ${e}.`)}async function Gn(){let e=Tn.innerText,t=Tn._sectionDoc;if(t[ue]?.length){let n=[e].concat(t[ue]);if(n.push("Cancel"),e=(await Vo("Please select a section for adding a student",{},n)).clicked,!e)return}ko((t=>{Mt(),setTimeout(Jn,100,t,e)}),`Add students to section\n${e}`)}async function Yn(e,t,n){const a=t[Ce],o=t[Le];let i=await Zt(o);if(await Vo(`Are you sure you would like to move ${o}${Kt(i," (",")")} from section ${a} to section ${n}?`)){const r=localStorage.semesterSelected;if(!(await Jt(r,n))._docs[0][ve]){let e=await db.insertOne(W,Pe(r,n),{[ve]:Tn._sectionDoc[ve]});if(e.error)return void Ko(`Could not create attendance record for section ${n}.\n${e.error}`)}let l=[],s={[K]:i[K],[ee]:i[ee],[V]:t[V]};if(t[te]){Ut(1);let o=await moveFiles(un(e,r,a),un(e,r,n));if(Ut(0),o.error)return void Ko("Attendance record was not moved to new section:\n\nCould not move student photos to new section.\n"+o.error);let i=t[te].split("/");i[2]=n,s[te]=i.join("/")}l.push({collection:W,id:Pe(r,n),data:{[e]:s}}),l.push({collection:W,id:Pe(r,a),data:{[e]:db.deleteField()}}),l.push({collection:F,id:o,data:{[X+"."+r+"."+n]:i[X][r][a]||{},[X+"."+r+"."+a]:db.deleteField()}});let d=await db.updateBatch(...l);if(d?.error){let o;return t[te]&&(Ut(1),o=await moveFiles(un(e,r,n),un(e,r,a)),Ut(0)),void Ko(o?.error?"Student photos were moved to new section, but the rest of attendance data could not be moved.\n"+d.error+"\n\nCould not move photos back to original section.\n"+o.error:"Attendance record could not be moved to new section.\n"+d.error)}!i[X][r][n]&&i[X][r][a]&&(i[X][r][n]=i[X][r][a],delete i[X][r][a]),u[Pe(r,n)][e]=t,t[Ce]=n,delete u[Pe(r,a)][e],Zo(`Student ${o}${Kt(i," (",")")} was successfully moved from section ${a} to section ${n}.`,"",1)}}async function Vn(e,t){const n=St(e);let a=await Zt(e);if(!a)return void Ko(`Student with the email ${e} was not found.`);let o=b.filter((e=>e[Te]===n))[0];if(o)o[Ce]===t?Ko(`Student with the email ${e} is already in section ${t}.`):(await Yn(n,o,t),na());else{if(await Vo(`Are you sure you would like to add ${e}${Kt(a," (",")")} to section ${t}?`)){const o=localStorage.semesterSelected;if(!(await Jt(o,t))._docs[0][ve]){let e=await db.insertOne(W,Pe(o,t),{[ve]:Tn._sectionDoc[ve]});if(e.error)return void Ko(`Could not create attendance record for section ${t}.\n${e.error}`)}a[X]||(a[X]={}),a[X][o]||(a[X][o]={});let i={[X+"."+o+"."+t]:{}},r=[];for(let e of b._sectionIds.filter((e=>e!==t)))e in a[X][o]&&(i[X+"."+o+"."+e]=db.deleteField(),r.push(e));let l=await db.updateBatch({collection:F,id:e,data:i},{collection:W,id:Pe(o,t),data:{[n]:{[K]:a[K],[ee]:a[ee],[V]:{}}}});if(l.error)return void Ko("Could not add student to section.\n"+l.error);a[X][o][t]={};for(let e of r)delete a[X][o][e];b.push(u[Pe(o,t)][n]={[K]:a[K],[ee]:a[ee],[V]:{},[Te]:n,[Le]:e,[Ce]:t}),Zo(`Student ${e}${Kt(a," (",")")} was successfully added to section ${t}.`,"",1)}na()}}async function Jn(e,t){if(!e.length)return;let n,a,o=[],i=[],r=[];for(let l of e)a=St(l[0]),n=b.filter((e=>e[Te]===a))[0],n?n[Ce]===t?i.push(l):(n[ee]||(n[ee]=l[1]),n[K]||(n[K]=l[2]),r.push(n)):o.push(l);if(r.length){var l=await zt(r.map((e=>e[Le])));if(l.error)return void Ko("Something went wrong.\n"+l.error)}if(o.length){var s=Xt(o);let t=e.filter((e=>!(e[0]in s)));if(t.length){let e=await zt(t.map((e=>e[0])));if(e.error)return void Ko("Something went wrong.\n"+e.error);Object.assign(s,e)}}let c="";if(r.length||o.length){if(i.length&&(c+=`<details><summary>${i.length} students are already in ${t} and will not be added</summary><small>${i.map((e=>e[0])).join(", ")}</small></details>\n`),r.length&&(c+=`<details><summary>${r.length} students are enrolled in this course under a different section id, and will be moved to ${t}</summary><small>${r.map((e=>e[Le])).join(", ")}</small></details>\n`),o.length&&(c+=`<details><summary>${o.length} students will be added to ${t}</summary><small>${o.map((e=>e[0])).join(", ")}</small></details>\n`),await Vo(c+"Are you sure you would like to proceed with this action?")){const e=localStorage.semesterSelected;let n={},a={},i={},c=b._sectionIds.filter((e=>e!==t));if(!(await Jt(e,t))._docs[0][ve]){let n=await db.insertOne(W,Pe(e,t),{[ve]:Tn._sectionDoc[ve]});if(n.error)return void Ko(`Could not create attendance record for section ${t}.\n${n.error}`)}for(let o of r){let r=o[Ce];i[r]||(i[r]={});let s={[ee]:o[ee],[K]:o[K],[V]:o[V]};if(o[te]){let e=o[te].split("/");e[2]=t,s[te]=e.join("/")}a[o[Te]]=s,i[r][o[Te]]=db.deleteField();let d=o[Le];n[d]={[X]:{[e]:{[t]:l[d][X][e][r],[r]:db.deleteField()}}}}for(let i of o){let o=i[0],r=St(i[0]);if(o in s){a[r]={[ee]:s[o][ee]||i[1],[K]:s[o][K]||i[2],[V]:{}},n[o]={[X]:{[e]:{[t]:{}}}},s[o][ee]||(n[o][ee]=i[1]),s[o][K]||(n[o][K]=i[2]);for(let t of c)n[o][X][e][t]=db.deleteField()}else a[r]={[ee]:i[1],[K]:i[2],[V]:{}},n[o]={[ee]:i[1],[K]:i[2],[X]:{[e]:{[t]:{}}}}}let u=[{collection:W,id:Pe(e,t),data:a}];for(let t in i)u.push({collection:W,id:Pe(e,t),data:i[t]});for(let e in n)u.push({collection:F,id:e,data:n[e]});Ut(1);let f=await db.upsertBatch(...u);if(f.error)return Ut(0),void Ko(`Failed to add students to section ${t}.\n${f.error}`);for(let a in n){m[a]||(m[a]={}),m[a][X]||(m[a][X]={}),m[a][X][e]||(m[a][X][e]={}),m[a][X][e][t]=n[a][X][e][t];for(let t of c)m[a][X][e][t]&&delete m[a][X][e][t]}d[Pe(e,t)]||(d[Pe(e,t)]={});for(let n in a)d[Pe(e,t)][n]||(d[Pe(e,t)][n]={}),Object.assign(d[Pe(e,t)][n],a[n]);for(let t in i)if(d[Pe(e,t)])for(let n in i[t])d[Pe(e,t)][n]&&delete d[Pe(e,t)][n];let g=[];for(let n of r){(await moveFiles(un(n[Te],e,n[Ce]),un(n[Te],e,t))).error&&g.push(n[Le])}Ut(0),na(!0),g.length?Xo(`${r.length+o.length} students added to section ${t}.\n\nEncountered an issue moving photos from old section to new for <details><summary>${g.length} students</summary>${g}</details>.\n`):Zo(`${r.length+o.length} students successfully added to section ${t}`,"Success",1)}}else Xo(`No students were added because all of the selected students are already in section ${t}.`);Ue("#addUsersEmails").value="",Ue("#addUsersNames").value="",Ue("#addUsersList").innerHTML=""}const Qn=Ue("#attendances");var y;async function zn(){Ue("#attendanceTableGradeEquationInput").value=Tn._sectionDoc[ge]||B,Ue("#minLateInput").value=Tn._sectionDoc[he]||25,await na(),Pt("attendanceTableScreen"),y?.hiddenCols?.length<2&&Ue("#attendancesHolder").getBoundingClientRect().width<400&&setTimeout(pa,100),Ue("#classLocation").innerText=(await Zn(Tn.innerText))[2]}async function Zn(e){let t=localStorage.getItem("loc_"+e);return t&&(t=JSON.parse(t)),3!==t?.length&&(t=k,Xn(e,t)),t}function Xn(e,t){localStorage.setItem("loc_"+e,JSON.stringify(t))}async function Kn(){var e=await Zn(Tn.innerText);setTimeout((async function(){mt(Ue("#setClassLocDiv"),e[0],e[1],1,(t=>e=t))}),150),await Vo('<div id="setClassLocDiv" class="w300 h300"></div>')&&(e.push(await gt(...e)),Xn(Tn.innerText,e),Ue("#classLocation").innerText=e[2],la())}async function ea(){try{const e=Ue("#attendanceTableGradeEquationInput").value;if(Oe.some((t=>!je(executeEquation(e,t)))))return void Ke("errorGradingOptions","saveGradingOptionsBtn");const t=parseInt(Ue("#minLateInput").value);if(!je(t)||t<1)return Ko("Minutes Late field must be a number greater than or equal to 1."),void ze("saveGradingOptionsBtn");let n=await Vo("Are you sure you would like to save this as the new grading equation?\nOnce saved, students will see their grades updated according to this new equation.",{},["Save grading equation","Cancel"]);if(!n||"Cancel"===n)return;const a=b._sectionIds[0];n=await db.updateOne(G,localStorage.semesterSelected,{[`${a}.${ge}`]:e,[`${a}.${he}`]:t}),n?.error?Ko("Error saving grading options to database.\n\n"+n.error):(d[localStorage.semesterSelected][a][ge]=Tn._sectionDoc[ge]=e,d[localStorage.semesterSelected][a][he]=Tn._sectionDoc[he]=t,ze("saveGradingOptionsBtn"),Zo("Grading options saved","",1))}catch(e){Ko("Something went wrong saving grading options:\n"+e.stack)}}function ta(){try{const e=Ue("#attendanceTableGradeEquationInput").value;if(Oe.some((t=>!je(executeEquation(e,t)))))return void Ke("errorGradingOptions","saveGradingOptionsBtn");ze("errorGradingOptions");let t=parseInt(Ue("#minLateInput").value);je(t)||(Ue("#minLateInput").value=t=Tn._sectionDoc[ge]||25),t<1&&(Ue("#minLateInput").value=t=1),t!=Tn._sectionDoc[he]||e!=Tn._sectionDoc[ge]?Ze("saveGradingOptionsBtn"):ze("saveGradingOptionsBtn");let n=y.header.indexOf(Ie),a=y.header.indexOf(ke),o=y.header.indexOf(Be),i=y.header.indexOf(xe);for(let r of y){let l=r.slice(Ne).filter((e=>"excused"===e)).length;r[i]=r.slice(Ne).filter((e=>je(e)&&e>=t)).length,r[n]=executeEquation(e,{P:r[a],A:r[o],L:r[i],E:l})}la()}catch(e){Ko("Something went wrong updating grading:\n"+e.stack)}}async function na(e=!1,t=!0){e&&await jn(!0),Fn();var n=Ue("#attendanceTableGradeEquationInput").value;try{n&&!Oe.some((e=>!je(executeEquation(n,e))))||(Ue("#attendanceTableGradeEquationInput").value=n=Tn._sectionDoc[ge]||B)}catch(e){Ue("#attendanceTableGradeEquationInput").value=n=Tn._sectionDoc[ge]||B}var a=parseInt(Ue("#minLateInput").value);let o,i;(!a||a<1)&&(Ue("#minLateInput").value=a=Tn._sectionDoc[he]||25);for(let e of b){e.attendAndAbsentArray=[],e.attendTimeOffsets=[],e[ke]=0,e[Be]=0,e[xe]=0,e[Ae]=e[K]||"",e[Ee]=e[ee]||"";for(let[t,n]of b.attendanceCodesAndTimes){if(o=e[V][t],o)e.attendAndAbsentArray.push(o);else{o={[Q]:M,code:t},e[V][t]=o,e.attendAndAbsentArray.push(o);let a={[Q]:M,[z]:n};db.updateOne(W,Pe(localStorage.semesterSelected,e[Ce]),{[e[Te]+"."+V+"."+t]:a}),db.updateOne(F,e[Le],{[X+"."+localStorage.semesterSelected+"."+e[Ce]+"."+t]:a}),e[Le]in m&&(m[e[Le]][X]||(m[e[Le]][X]={}),m[e[Le]][X][localStorage.semesterSelected]||(m[e[Le]][X][localStorage.semesterSelected]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]]||(m[e[Le]][X][localStorage.semesterSelected][e[Ce]]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t]=a)}o[Q]===M?(e[Be]++,e.attendTimeOffsets.push("absent")):o[Q]===D?e.attendTimeOffsets.push("excused"):(i=Math.floor((o[z]-n)/60),i>=a?e[xe]++:e[ke]++,e.attendTimeOffsets.push(i))}try{e[Ie]=executeEquation(n,{P:e[ke],L:e[xe],A:e[Be],E:e.attendTimeOffsets.filter((e=>"excused"===e)).length})}catch(t){e[Ie]="Error"}}(y=[]).semester=localStorage.semesterSelected,y.id=y.semester+"_"+b._sectionIds.join("_"),y.attendanceCodes=b.attendanceCodesAndTimes.map((e=>e[0])),y.attendanceTimes=b.attendanceCodesAndTimes.map((e=>at(e[1]," "))),y.header=Re.concat(y.attendanceTimes);for(let e of b){let t=[];for(let n of Re)t.push(e[n]);t=t.concat(e.attendTimeOffsets),t._fullRecord=e,y.push(t)}y.sortStack=JSON.parse(localStorage.getItem("sortStack_"+y.id)||"[]"),y.sortDesc=JSON.parse(localStorage.getItem("sortDesc_"+y.id)||"[]"),y.hiddenCols=JSON.parse(localStorage.getItem("hiddenCols_"+y.id)||"[true]"),t&&la()}function aa(e,t,n,a,o){return async function(i){i.preventDefault();let r=["View attendance...","Edit attendance...",""];t[Q]===M?r.push("Mark present","Mark late","_Mark absent","Mark excused"):t[Q]===D?r.push("Mark present","Mark late","Mark absent","_Mark excused"):a>=o?r.push("Mark present","_Mark late","Mark absent","Mark excused"):r.push("_Mark present","Mark late","Mark absent","Mark excused");let l,s=await Yo(i.clientX,i.clientY,r);if("View attendance..."===s?oa(e,t,n,a)():"Edit attendance..."===s?ia(e,t,n,a):"Mark present"===s?(l=U,a=0):"Mark late"===s?(l=U,a=2*o):"Mark absent"===s?(l=M,a=0):"Mark excused"===s&&(l=D,a=0),void 0!==l){let o=Pe(localStorage.semesterSelected,e[Ce]),i=e[Te]+"."+V+"."+t.code+".",r={[i+z]:db.makeTimestamp(n,a),[i+Q]:l},s=[{collection:W,id:o,data:r}],d=X+"."+localStorage.semesterSelected+"."+e[Ce]+"."+t.code+".",c={[d+oe]:`updated by ${auth.currentUser.email} on ${at()[0]}`};i+Q in r&&(c[d+Q]=r[i+Q]),i+z in r&&(c[d+z]=r[i+z]),s.push({collection:F,id:e[Le],data:c});let u=await db.updateBatch(...s);if(u.error)Ko("Unable to update attendance record.\n"+u.error);else{if(t[Q]=r[i+Q],t[z]=r[i+z],e[Le]in m){m[e[Le]][X]||(m[e[Le]][X]={}),m[e[Le]][X][localStorage.semesterSelected]||(m[e[Le]][X][localStorage.semesterSelected]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]]||(m[e[Le]][X][localStorage.semesterSelected][e[Ce]]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code]||(m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code]={});let n=m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code];n[z]=c[d+Q],n[z]=c[d+z],n[oe]=c[d+oe]}Zo("Record updated.","",1),na()}}}}function oa(e,t,n,a){return async function(){let o=n.split(" ").join(" at "),i=`Record for ${Kt(e)} (${e[Te]}) for attendance taken on ${o}:\n\n`;t[Q]===D?i+="Attendance excused.":t[Q]===M?i+="Absent.":i+=`Attendance marked ${a?"after "+a+"min":"right away"}.\n\nSeat: ${t[ne]||"missing"}`,(t[te]||t[ae])&&(i+="\n\n",t[te]&&(i+=`<img src="${await getLinkFromStoragePath(cn(e[Te],localStorage.semesterSelected,e[Ce],t.code))}" onerror="this.src='${P}';" width="125">`),t[ae]&&(i+='<div id="locmap"></div>',setTimeout((()=>{mt(Ue("#locmap"),...t[ae])}),150))),t[oe]&&(i+="\n\nNotes:\n"+t[oe]),"Edit attendance record"===(await Vo(i+"\n\n",{},["OK","Edit attendance record"])).clicked&&ia(e,t,n,a)}}async function ia(e,t,n,a){let o=Pe(localStorage.semesterSelected,e[Ce]),i=e[Te]+"."+V+"."+t.code+".",r=n.split(" ").join(" at "),l={Present:{type:"radio",name:"status"},Absent:{type:"radio",name:"status"},Excused:{type:"radio",name:"status"},"Minutes late":{type:"number",value:t[Q]?"":a},Seat:t[ne]||"",Notes:t[oe]||""};t[Q]===M?l.Absent.checked=!0:t[Q]===D?l.Excused.checked=!0:l.Present.checked=!0;let s=await Vo(`Record for ${Kt(e)} (${e[Te]}) for attendance taken on ${r}:\n\n`,l,["Save","Cancel"]);if("Save"===s?.clicked){let r={};if(s.Present){let e=parseInt(s["Minutes late"])||0;(t[Q]||e!==a)&&(r[i+z]=db.makeTimestamp(n,e))}else{let e=db.makeTimestamp(n);t[z]?.seconds!=e.seconds&&(r[i+z]=e)}if(s.Present&&t[Q]?r[i+Q]=U:s.Absent&&t[Q]!==M?r[i+Q]=M:s.Excused&&t[Q]!==D&&(r[i+Q]=D),s.Seat!==t[ne]&&(r[i+ne]=s.Seat||""),s.Notes!==t[oe]&&(r[i+oe]=s.Notes||""),Object.keys(r).length){let n,a,l=[{collection:W,id:o,data:r}];(i+Q in r||i+z in r)&&(a=X+"."+localStorage.semesterSelected+"."+e[Ce]+"."+t.code+".",n={[a+oe]:`updated by ${auth.currentUser.email} on ${at()[0]}`},i+Q in r&&(n[a+Q]=r[i+Q]),i+z in r&&(n[a+z]=r[i+z]),l.push({collection:F,id:e[Le],data:n}));let s=await db.updateBatch(...l);if(s.error)Ko("Unable to update attendance record.\n"+s.error);else{if(i+Q in r&&(t[Q]=r[i+Q]),i+z in r&&(t[z]=r[i+z]),i+ne in r&&(t[ne]=r[i+ne]),i+oe in r&&(t[oe]=r[i+oe]),n&&e[Le]in m){m[e[Le]][X]||(m[e[Le]][X]={}),m[e[Le]][X][localStorage.semesterSelected]||(m[e[Le]][X][localStorage.semesterSelected]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]]||(m[e[Le]][X][localStorage.semesterSelected][e[Ce]]={}),m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code]||(m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code]={});let o=m[e[Le]][X][localStorage.semesterSelected][e[Ce]][t.code];a+Q in n&&(o[z]=n[a+Q]),a+z in n&&(o[z]=n[a+z]),o[oe]=n[a+oe]}Zo("Record updated.","",1),na()}}else Zo("Nothing changed. Record not updated.")}}function ra(e){return async function(){rt(null,null,await Promise.all(e.attendAndAbsentArray.filter((e=>e[te])).map((t=>getLinkFromStoragePath(cn(e[Te],localStorage.semesterSelected,e[Ce],t.code)))))),window._nextImg=rt;let t=`${Kt(e)}\n${e[Le]}\n${e[Ce]}\n\n<img id="studentPromptImg" src=${P} onclick="window._nextImg(1,this)" onload="this.onload=null;window._nextImg(0,this)" onerror="this.src='${P}'" width="${j}">\n\nAbsent: ${e[Be]}\nLate: ${e[xe]}\n\n`,n=await Vo(t,{},b._sectionIds.length>1?["OK","Change student's requirements","Change student section","Remove student from section"]:["OK","Change student's requirements","Remove student from section"]);if("Change student section"===n.clicked){let t=b._sectionIds.filter((t=>t!==e[Ce]));t.length>1?n=await Vo("Choose which section you would like to move the student to:",{},t.concat(["Cancel"])):n.clicked=t[0],n&&await Yn(e[Te],e,n.clicked),na()}else if("Remove student from section"===n.clicked){if(n=await Vo(`Are you sure you want to remove ${Kt(e)} (${e[Te]}) from section ${e[Ce]}?\n\nWARNING: This action will permanently DELETE all of the student's attendance records associated with this section.`,{},["DELETE student from section","Cancel"]),"DELETE student from section"===n.clicked){const t=Pe(localStorage.semesterSelected,e[Ce]),n=e[Le];let a=await db.updateBatch({collection:W,id:t,data:{[e[Te]]:db.deleteField()}},{collection:F,id:n,data:{[X+"."+localStorage.semesterSelected+"."+e[Ce]]:db.deleteField()}});if(a.error)return void Ko("Could not delete student record.\n\n"+a.error);if(delete u[t][e[Te]],m[n])try{delete m[n][X][localStorage.semesterSelected][e[Ce]]}catch(e){}(await deleteFiles(un(e[Te],localStorage.semesterSelected,e[Ce]))).error?Xo("Deleted student from section, but could not delete student's uploaded photos."):Zo(`${Kt(e)} (${e[Te]}) was deleted from section ${e[Ce]}.`,"",1),await jn(!1),na(!1)}}else if("Change student's requirements"===n.clicked){let t=Ht((Tn._sectionDoc[ye]||{})[e[Te]]??Tn._sectionDoc[Se]),a={"Collect location":[{value:-1,label:"No"},{value:0,label:"Yes"},{value:1,label:"Request"},{value:2,label:"Require"}],"Collect seat code":[{value:-1,label:"No"},{value:0,label:"Yes"},{value:1,label:"Request"},{value:2,label:"Require"}],"Collect student photo":[{value:-1,label:"No"},{value:0,label:"Yes"},{value:1,label:"Request"},{value:2,label:"Require"}]};if(a["Collect location"][t[ae]+1].selected=!0,a["Collect seat code"][t[ne]+1].selected=!0,a["Collect student photo"][t[te]+1].selected=!0,n=await Vo(`Change required attendance information for ${Kt(e)} (${e[Te]}):\n\nSet collection status to<li>"Yes" to collect information, but not to require it</li>\n<li>"Request" to give student a warning message if they do not supply the information</li>\n<li>"Require" to disable attendance collection until student enters required information</li>\n`,a,["Save student attendance requirements","Cancel"]),!n)return;let o={[ae]:parseInt(n["Collect location"]),[ne]:parseInt(n["Collect seat code"]),[te]:parseInt(n["Collect student photo"])};if(Ye(o,t))return void Zo("No changes were made.","Attendance information requirements were not updated:");t=Ht(Tn._sectionDoc[Se]);let i=Ye(o,t)?db.deleteField():jt(o),r=await db.updateOne(G,localStorage.semesterSelected,{[`${Tn.innerText}.${ye}.${e[Te]}`]:i});r?.error?Ko("Unable to save new user requirements.\nPlease try again.\n\n"+r.error):(Tn._sectionDoc[ye]||(Tn._sectionDoc[ye]={}),Fe(i)?Tn._sectionDoc[ye][e[Te]]=i:delete Tn._sectionDoc[ye][e[Te]],Zo(`Personalized attendance info requirements updated for ${Kt(e)}.`))}}}async function la(){let e=Ue("#attendancesHolder").scrollLeft,t=Ue("#attendancesHolder").scrollTop;Qn.innerHTML="";var n=await Zn(Tn.innerText),a=parseInt(Ue("#minLateInput").value)||Tn._sectionDoc[he]||25;et(y,y.sortStack,{excused:9e8,absent:9e9});for(let e of[y.header].concat(y)){var o=Qn.appendChild(document.createElement("row"));for(let t=0;t<y.header.length;t++)if(!y.hiddenCols[t]){var i=o.appendChild(document.createElement("div"));if(e===y.header)i.innerText=e[t],t>=Ne&&(i.title=y.attendanceCodes[t-Ne]),i.addEventListener("click",(()=>ba(t))),i.addEventListener("contextmenu",wa),i.classList.add("table-header"),i.setAttribute("title","Click to sort. Right-click to hide/show.");else if(t>=Ne){i.innerHTML="excused"===e[t]?"➖":"absent"===e[t]?"❌":e[t]<a?"✔️":"+"+e[t]+"min";let o=e._fullRecord.attendAndAbsentArray[t-Ne];if("excused"!==e[t]&&"absent"!==e[t])if(!o[ne]&&Tn._sectionDoc[ne]>0&&i.classList.add("missingSeat"),!o[te]&&Tn._sectionDoc[te]>0&&i.classList.add("missingPhoto"),!o[ae]&&Tn._sectionDoc[ae]>0)i.classList.add("missingLocation");else if(o[ae]){i.classList.add("hasLocation");let e=ft(o[ae],n);i.style.setProperty("--distColor",`rgb(${e/15},${255-e/15},0)`)}i.onclick=oa(e._fullRecord,o,y.header[t],e[t]),i.oncontextmenu=aa(e._fullRecord,o,y.header[t],e[t],a),i.style.textAlign="center"}else i.innerText=e[t],i.onclick=ra(e._fullRecord),isNaN(parseFloat(e[t]))||(i.style.textAlign="center",Number.isInteger(e[t])||(i.innerText=e[t].toFixed(1)))}}Qn.style.setProperty("--colNum",o.children.length),Ue("#attendancesHolder").scrollLeft=e,Ue("#attendancesHolder").scrollTop=t}async function sa(){let e=await Vo("Manually add attendance column (all students will be marked absent by default):",{"Attendance code":{required:!0,value:_e[Je(26)]+Math.random().toString().substring(2,6)},"Attendance time":{required:!0,type:"datetime-local",value:at(null,"T")}});e&&(b.attendanceCodesAndTimes.map((e=>e[0])).includes(e["Attendance code"])?Ko(`Cannot add column with attendance code ${e["Attendance code"]}:\nThis attendance code has already been used for another attendance.`):(e["Attendance time"]=db.makeTimestamp(e["Attendance time"].split("T").join(" ")),b.attendanceCodesAndTimes.push([e["Attendance code"],e["Attendance time"]]),b.attendanceCodesAndTimes.sort(((e,t)=>e[1]-t[1])),na(!1)))}async function da(){localStorage.setItem("hiddenCols_"+y.id,JSON.stringify(y.hiddenCols)),await la()}function ca(){if(y.showingAttendanceCol){delete y.showingAttendanceCol;for(let e=Ne;e<y.header.length;e++)y.hiddenCols[e]=!1;da()}else ua()}async function ua(e){e||(e=y.showingAttendanceCol=y.showingAttendanceCol||y.header.length-1);for(let t=Ne;t<y.header.length;t++)y.hiddenCols[t]=e!==t;await da()}function ma(){y.showingAttendanceCol=Ne,ua(y.showingAttendanceCol)}function fa(){y.showingAttendanceCol=y.header.length-1,ua(y.showingAttendanceCol)}function ga(){y.showingAttendanceCol=y.showingAttendanceCol?y.showingAttendanceCol-1:Ne,y.showingAttendanceCol<Ne&&(y.showingAttendanceCol=y.header.length-1),ua(y.showingAttendanceCol)}function ha(){y.showingAttendanceCol=y.showingAttendanceCol?y.showingAttendanceCol+1:y.header.length-1,y.showingAttendanceCol>=y.header.length&&(y.showingAttendanceCol=Ne),ua(y.showingAttendanceCol)}async function pa(){let e=y.header.length-y.hiddenCols.filter((e=>e)).length;const t=Re.indexOf(Ee),n=Re.indexOf(Te);if(e<3&&!y.hiddenCols[t]&&y.hiddenCols[n])return y.hiddenCols[t]=!0,y.hiddenCols[n]=!1,void da();const a=Ue("#attendancesHolder").getBoundingClientRect().width;if(e<3||Qn.getBoundingClientRect().width<=a){for(let e=0;e<Ne;e++)y.hiddenCols[e]=!1;return await da(),void(Qn.getBoundingClientRect().width<a&&ca())}Qn.getBoundingClientRect().width>a&&await ua();for(var o=[...$e];o.length>1&&Qn.getBoundingClientRect().width>a;){let e=o.pop();await Sa(y.header.indexOf(e),!1)}}function Sa(e,t=null){null===t&&(t=y.hiddenCols[e]),y.hiddenCols[e]=!t,da()}async function va(){let e=await Vo("Select which columns to show",Object.fromEntries(y.header.map(((e,t)=>[e,!y.hiddenCols[t]])))),t=!1;for(let n in e){let a=y.header.indexOf(n);a>-1&&Boolean(y.hiddenCols[a])==e[n]&&(y.hiddenCols[a]=!e[n],t=!0)}t&&da()}async function wa(e){e.preventDefault();const t=e.currentTarget.innerText;let n=["Hide column"];Re.includes(t)||n.push("Change attendance status","Delete column");let a=await Yo(e.clientX,e.clientY,n);if("Hide column"==a)Sa(y.header.indexOf(t),!1);else if("Change attendance status"==a){let e=await Vo(`Change attendance statuses for ${t}:`,{"Current status":["Any","Absent","Excused","Present"],"New status":["Absent","Excused","Present"]});if(e){const n={Absent:M,Present:U,Excused:D},a=n[e["Current status"]],o=n[e["New status"]];if(a===o)return void Zo("Nothing to change.");const i=localStorage.semesterSelected,r=b.attendanceCodesAndTimes.find((e=>at(e[1]," ")==t))[0];let l={},s=[],d=[];for(let e of b){let t=e[V][r][Q]||U;if(t!==o&&(void 0===a||t===a)){let t=e[Ce];l[t]||(l[t]={}),l[t][e[Te]+"."+V+"."+r+"."+Q]=o,s.push({collection:F,id:e[Le],data:{[X+"."+i+"."+t+"."+r+"."+Q]:o}}),d.push(e)}}if(0===d.length)Zo("Nothing to change.");else if(await Vo(`You are about to mark ${d.length} student(s) ${e["New status"].toLowerCase()} for ${t}.\n\nAre you sure you would like to proceed?`)){for(let e in l)s.push({collection:W,id:Pe(i,e),data:l[e]});let n=db.updateBatch(...s);if(n.error)Ko("Could not update records.\n"+n.error);else{for(let e of d)e[V][r][Q]=o;na(),Zo(`${d.length} student(s) were marked ${e["New status"].toLowerCase()} for ${t}.`,"Success.",1)}}}}else if("Delete column"==a){if("delete"===(await Vo(`Are you sure you would like to delete all attendance data for ${t}?<p>WARNING:<p>All data associated with ${t} attendance will be lost, including photos and attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.`,{Confirm:""})).Confirm.toLowerCase()){const e=localStorage.semesterSelected,n=b.attendanceCodesAndTimes.find((e=>at(e[1]," ")==t))[0];let a={},o=[];for(let t of b){let i=t[Ce];a[i]||(a[i]={}),a[i][t[Te]+"."+V+"."+n]=db.deleteField(),o.push({collection:F,id:t[Le],data:{[X+"."+e+"."+i+"."+n]:db.deleteField()}})}for(let t in a)o.push({collection:W,id:Pe(e,t),data:a[t]});let i=db.updateBatch(...o);if(i.error)Ko("Could not update records.\n"+i.error);else{for(let t of b)deleteFile(cn(t[Te],e,t[Ce],n)),delete t[V][n];b.attendanceCodesAndTimes=b.attendanceCodesAndTimes.filter((e=>e[0]!==n)),na(),Zo(`Deleted all attendance records for ${t}.`,"Success.",1)}}}}function ba(e){y.sortStack[0]===e?(y.sortDesc[e]=!y.sortDesc[e],localStorage.setItem("sortDesc_"+y.id,JSON.stringify(y.sortDesc))):(y.sortStack=[e].concat(y.sortStack.filter((t=>t!=e))),localStorage.setItem("sortStack_"+y.id,JSON.stringify(y.sortStack))),la()}function ya(e){let t="";for(let n of[y.header].concat(y)){for(let a=0;a<y.header.length;a++)e&&!e[a]||(t+=(je(n[a])&&n[a].toString().split(".")[1]?.length>2?n[a].toFixed(2):n[a])+",");t=t.replace(/(,$)/,"\n")}return t}async function Ca(){let e=Object.fromEntries(y.header.map(((e,t)=>[e,!0])));e.Filename="attendance-"+y.id+".csv";let t=await Vo("Select fields to include in your downloaded data:\n\n<small><a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=true)\">Select All</a> <a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=false)\">Deselect All</a></small>",e,["Download","Cancel"]);var n,a,o;t&&y.header.some((e=>t[e]))&&(t.Filename?t.Filename.endsWith(".csv")||(t.Filename+=".csv"):t.Filename="attendance-"+y.id+".csv",n=t.Filename,a=ya(y.header.map((e=>t[e]))),(o=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),o.setAttribute("download",n),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o))}dt(Ue("#attendancesHolder"));const La=Ue("#roomMap"),Ta=Ue("#roomMapHolder");var C;async function Aa(e=!1){e&&await jn(!0),Fn();let t=Tn._sectionDoc;b.roomId=t[re],localStorage["roomMapZoom-"+b.roomId]||(localStorage["roomMapZoom-"+b.roomId]=1),C=b.attendanceCodesAndTimes.length-1,Ea(),Ue("#attendanceRoomViewLastBtn").classList.add("disabled")}async function Ea(){let e=b.roomId?await Vt(b.roomId):[["","","","","","","","","",""]],t=e.flat().filter((e=>e));var n={},a=[],o=[],i=b.attendanceCodesAndTimes[C][0];Ue("#roomViewDate").innerText=at(b.attendanceCodesAndTimes[C][1]," ");for(let e of b){let r=e[V][i];if(r&&r[Q]!==D&&r[Q]!==M){let a=Me(r[ne]);e._seat=a,e._notes=r[oe],e._time=r.time,e._photo=r[te]?cn(e[Te],localStorage.semesterSelected,e[Ce],i):e[te],t.includes(a)&&!n[a]?n[a]=e:o.push(e)}else a.push(e),r&&(e._notes=r[oe]),r&&r[Q]===D?e._time="excused":e._time="absent",e._photo=e[te]}if(o.sort(((e,t)=>e[K]>t[K]?1:-1)),a.sort(((e,t)=>e[K]>t[K]?1:-1)),La.innerHTML="",Object.keys(n).length){La._cols=0;for(let t=0;t<e.length;t++){let a=e[t];La._cols=Math.max(La._cols,a.length);let o=La.appendChild(document.createElement("div"));for(let i=0;i<a.length;i++){let a=e[t][i],r=o.appendChild(document.createElement("div"));if(a){r.classList.add("seat");let e=n[a];e?Ia(r,e):r.innerText=a}}}}else La._cols=10;let r=La.appendChild(document.createElement("div"));Tn._sectionDoc[ne]>=0&&r.classList.add("bad-seating");for(let e of o){let t=r.appendChild(document.createElement("div"));t.classList.add("seat"),Ia(t,e)}let l=La.appendChild(document.createElement("div"));l.classList.add("absent");for(let e of a){let t=l.appendChild(document.createElement("div"));t.classList.add("seat"),Ia(t,e)}Oa(),r.style.maxWidth=`calc(var(--seat-width) * ${La._cols})`,l.style.maxWidth=`calc(var(--seat-width) * ${La._cols})`,Pt("room"),setTimeout((()=>{Ta.scrollLeft=(Ta.scrollWidth-Ta.offsetWidth)/2}),100)}function Ia(e,t){e.classList.add("taken"),getLinkFromStoragePath(t._photo).then((t=>e.style.backgroundImage=`url("${t||P}"), url(${P})`)),e.innerHTML=`<span>${t[K]}</span>`,e.onmouseover=()=>{e.innerHTML=`<span>${Kt(t)}\n<small>${t[Te]}\n${t._time}\n${t._seat||""}\n${t[Ce]}\n${t._notes||""}</small></span>`},e.onmouseout=()=>{e.innerHTML=`<span>${t[K]}</span>`,e.classList.remove("enlarge")},e.onclick=()=>{e.classList.toggle("enlarge")}}function ka(){--C<0&&(C=b.attendanceCodesAndTimes.length-1),Ea(),Ra()}function xa(){++C>=b.attendanceCodesAndTimes.length&&(C=0),Ea(),Ra()}function Ba(){C!=b.attendanceCodesAndTimes.length-1&&(C=b.attendanceCodesAndTimes.length-1,Ea(),Ue("#attendanceRoomViewLastBtn").classList.add("disabled"))}function Ra(){C==b.attendanceCodesAndTimes.length-1?Ue("#attendanceRoomViewLastBtn").classList.add("disabled"):Ue("#attendanceRoomViewLastBtn").classList.remove("disabled")}function $a(){localStorage["roomMapZoom-"+b.roomId]=(parseFloat(localStorage["roomMapZoom-"+b.roomId])+.1).toFixed(1),Oa()}function Na(){let e=parseFloat(localStorage["roomMapZoom-"+b.roomId])-.1;e>.1&&(localStorage["roomMapZoom-"+b.roomId]=e.toFixed(1)),Oa()}function Oa(){let e=parseFloat(localStorage["roomMapZoom-"+b.roomId]);La.style.setProperty("--seat-width",25*e+"px"),La.style.setProperty("--seat-height",25*e+"px")}function _a(){La.style.setProperty("--name-visible","hidden"===La.style.getPropertyValue("--name-visible")?"visible":"hidden")}dt(Ta);let Pa,Da,Ma={};async function Ua(){let e=[...new Set(b.filter((e=>e[te])).map((e=>e[Ce])))];if(e.length>1){let t=await Vo("Please choose section:",{},e.concat(["Cancel"]));if(!t)return;e[0]=t.clicked}Pa=Pe(localStorage.semesterSelected,e[0]),Ma[Pa]?.length||(Ma[Pa]=Ve(b.filter((t=>t[te]&&t[Ce]===e[0])).map((e=>e[Te]))),Ma[Pa].indx=0),Pt("learnNames"),Ke(["learnNamesMain","learnNamesNameBtn"],["learnNamesDone","learnNamesName"]),Ue("#learnNamesImg").src=P,Ue("#learnNamesName").innerText="",0==Ma[Pa].indx&&ze("learnNamesPrevBtn"),setTimeout(qa,100)}async function qa(){clearTimeout(Da);let e=Ma[Pa][Ma[Pa].indx],[t,n]=De(Pa),a=b.find((t=>t[Te]===e));rt(null,null,await Promise.all(Object.values(a[V]).filter((e=>e[te])).map((a=>getLinkFromStoragePath(cn(e,t,n,a.code)))))),Ha(),Ue("#learnNamesName").innerText=a[K]+" "+a[ee],Ke("learnNamesNameBtn","learnNamesName")}async function Ha(){null!==Ue("#learnNamesImg").offsetParent&&(clearTimeout(Da),rt(null,Ue("#learnNamesImg")),Da=setTimeout(Ha,H))}function ja(){Ma[Pa].length?(Ma[Pa].indx++,Ma[Pa].indx>=Ma[Pa].length?(Ma[Pa]=Ve(Ma[Pa]),Ma[Pa].indx=0,ze("learnNamesPrevBtn")):Ma[Pa].indx&&Ze("learnNamesPrevBtn"),qa()):Ke("learnNamesDone","learnNamesMain")}function Fa(){Ma[Pa].indx--,0==Ma[Pa].indx&&ze("learnNamesPrevBtn"),qa()}function Wa(){Ke("learnNamesName","learnNamesNameBtn")}function Ga(){Ma[Pa].splice(Ma[Pa].indx,1),Ma[Pa].indx>=Ma[Pa].length?ja():qa()}const Ya="Create New Section",Va="No assigned room";async function Ja(){Ue("#addOrEditSectionTitle").innerText="Create New Section",Ue("#editSectionSubmitBtn").innerText=Ya,ze("editSectionDeleteBtn"),Ue("#editSectionIdInput").removeAttribute("disabled"),Ue("#editSectionSemesterSelect").removeAttribute("disabled"),await za(),Ue("#editSectionInstructorEmailsInput").value=auth.currentUser.email,Ue("#editSectionInstructorNamesInput").value="Prof. "+i[ee],Ue("#editSectionIdInput").value="",Ue("#editSectionTitleInput").value="",Ue("#editSectionPatternInput").value="",Ue("#editSectionRoom").innerText=Va,Ue("#editSectionCrosslistInput").value="",Ue("#editSectionGradeInput").value=B,Ue("#editSectionLateInput").value=25,Ue("#editSectionDisplayGrade").checked=!1,Ue("#editSectionLocationYes").checked=!0,Ue("#editSectionSeatYes").checked=!0,Ue("#editSectionPhotoYes").checked=!0,Ue("#editSectionAllowSelfEnroll").checked=!1}async function Qa(e,t){Ue("#addOrEditSectionTitle").innerText=`Edit Section ${e}`,Ue("#addOrEditSectionTitle")._sectionDoc=Tn._sectionDoc,Ue("#editSectionSubmitBtn").innerText="Save Section",Ze("editSectionDeleteBtn"),Ue("#editSectionIdInput").setAttribute("disabled",!0),Ue("#editSectionCrosslistInput").setAttribute("disabled",!0),Ue("#editSectionSemesterSelect").setAttribute("disabled",!0),await za(),Ue("#editSectionIdInput").value=e,Ue("#editSectionTitleInput").value=t[me]||"",Ue("#editSectionPatternInput").value=t[fe]||"",Ue("#editSectionRoom").innerText=t[re]||Va,Ue("#editSectionCrosslistInput").value=t[ue]?.join("\n")||"",Ue("#editSectionInstructorEmailsInput").value=t[ve]?.join("\n")||"",Ue("#editSectionInstructorNamesInput").value=t[we]||"",Ue("#editSectionAllowSelfEnroll").checked=t[be]||!1,Ue("#editSectionGradeInput").value=t[ge]||B,Ue("#editSectionLateInput").value=t[he]||25,Ue("#editSectionDisplayGrade").checked=t[pe]||!1,-1===t[ne]?Ue("#editSectionSeatNo").checked=!0:1===t[ne]?Ue("#editSectionSeatWarn").checked=!0:2===t[ne]?Ue("#editSectionSeatRequire").checked=!0:Ue("#editSectionSeatYes").checked=!0,-1===t[te]?Ue("#editSectionPhotoNo").checked=!0:1===t[te]?Ue("#editSectionPhotoWarn").checked=!0:2===t[te]?Ue("#editSectionPhotoRequire").checked=!0:Ue("#editSectionPhotoYes").checked=!0,-1===t[ae]?Ue("#editSectionLocationNo").checked=!0:1===t[ae]?Ue("#editSectionLocationWarn").checked=!0:2===t[ae]?Ue("#editSectionLocationRequire").checked=!0:Ue("#editSectionLocationYes").checked=!0}async function za(){let e;Pt("addOrEditSection");let t=Ue("#editSectionSemesterSelect");if(1==t.children.length){let n=await qt();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}for(let e of t.children)e.innerText==localStorage.semesterSelected?(e.setAttribute("selected",!0),t.value=e.value):e.removeAttribute("selected")}function Za(){Ue("#editSectionRoom").innerText=Va}function Xa(e){try{const n=e.target;n.value=niceEquation(n.value.trim());let a=illegalEquation(spacedEquation(n.value));if(a.length)return void Ko(`Illegal character(s) found in the equation: ${a}\n\n${di}`);let o=[];var t="<table><tr><td>OnTime</td><td>Late</td><td>Absent</td><td>Excused</td><th>Grade</th></tr>";for(let e of Oe){let a=executeEquation(n.value,e);o.push(a),t+=`<tr><td>${e.P}</td><td>${e.L}</td><td>${e.A}</td><td>${e.E}</td><th>${a}</th></tr>`}t+="</table>",o.some((e=>!je(e)))?Ko("Invalid grading equation.\n\n"+t):o[0]>=o[1]&&o[1]>=o[2]&&o[2]>=o[3]&&o[3]>=o[4]?Zo(t,"Testing your grading equation:"):Xo("There may be something wrong with your grading equation:\n\n"+t)}catch(e){Ko("Something went wrong when testing equation:\n"+e.stack)}}async function Ka(){try{wt(Ue("#editSectionIdInput"));let e=Ue("#editSectionSubmitBtn").innerText===Ya,t=Ue("#editSectionSemesterSelect").value,n=Ue("#editSectionIdInput").value,a={[ve]:Ue("#editSectionInstructorEmailsInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[we]:Ue("#editSectionInstructorNamesInput").value.trim(),[me]:Ue("#editSectionTitleInput").value.trim(),[fe]:Ue("#editSectionPatternInput").value.trim(),[ge]:Ue("#editSectionGradeInput").value.trim(),[he]:Ue("#editSectionLateInput").value,[pe]:Ue("#editSectionDisplayGrade").checked,[ue]:Ue("#editSectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[ne]:Ue("#editSectionSeatWarn").checked+2*Ue("#editSectionSeatRequire").checked-Ue("#editSectionSeatNo").checked,[te]:Ue("#editSectionPhotoWarn").checked+2*Ue("#editSectionPhotoRequire").checked-Ue("#editSectionPhotoNo").checked,[ae]:Ue("#editSectionLocationWarn").checked+2*Ue("#editSectionLocationRequire").checked-Ue("#editSectionLocationNo").checked,[be]:Ue("#editSectionAllowSelfEnroll").checked};if(Ue("#addOrEditSectionTitle")._sectionDoc&&(Ue("#addOrEditSectionTitle")._sectionDoc[ye]&&(a[ye]=Ue("#addOrEditSectionTitle")._sectionDoc[ye]),Ue("#addOrEditSectionTitle")._sectionDoc[z]&&(a[z]=Ue("#addOrEditSectionTitle")._sectionDoc[z])),Ue("#editSectionRoom").innerText!==Va&&(a[re]=Ue("#editSectionRoom").innerText),!t)return void Zo("Please select semester.","Missing information:",-1);if(!n)return void Zo("Please enter section id.","Missing information:",-1);if(e&&n.includes($))return void Zo('Specified section id includes an invalid character "'+$+'".',"Invalid section id:",-1);if(!a[ve])return void Zo("Please enter section instructor email(s).","Missing information:",-1);if(!a[we])return void Zo("Please enter section instructor name(s).","Missing information:",-1);if(a[ue]?.includes(n))return void Zo("Please do not enter current section id under cross-listed section ids.","Invalid cross-listed information:",-1);if(!a[re]){if(a[ne]>-1)return void Zo('You have not assigned a room to this section.\nEither assign a room to this section or select the "No" option under "Collect seat information".',"Missing information:",-1);if(!await Vo("You have not assigned a room to this section.\nAre you sure you would like to continue without a room assignment?"))return}if(Oe.some((e=>!je(executeEquation(a[ge],e)))))return void Zo("Click the help icon next to the Grade Equation field to view the correct format.","Invalid equation format for grading:",-1);let o=await Ft(t);for(let t in o)if(t===n){if(e)return void Zo(`Section ${n} already exists.`,"Duplicate section id:",-1)}else{let i=o[t];if(e&&i[ue]?.includes(n))return void Zo(`Section ${n} already exists.\nIt is cross-listed with section ${t}.`,"Duplicate section id:",-1);if(a[ue]?.includes(t))return void Zo(`Cannot list ${t} as a cross-listed section because a record for ${t} already exists.`,"Duplicate section id:",-1);let r=a[ue]?.filter((e=>i[ue]?.includes(e)));if(r.length)return void Zo(`Cannot list ${r} as cross-listed section(s).\n${t} already includes cross-listed section(s):\n ${r}`,"Duplicate section id:",-1)}if(!e){let e=o[n][ue].filter((e=>!a[ue].includes(e)));if(e.length&&!await Vo(`Are you sure you would like to remove ${e} as cross-listed section(s) for this course?\nThis action may have undesired consequences.`))return}a[Se]=jt(a),delete a[ae],delete a[te],delete a[ne],(await db.updateOne(G,t,{[n]:a})).error?Ko("Failed to add section.\n\nPlease try again."):(Object.assign(a,Ht(a[Se])),o[n]=Object.assign(o[n]||{},a),t===localStorage.semesterSelected&&(e&&Po(n,a,Ue("#instructorSections")),Mo(localStorage.semesterSelected)),n===Tn.innerText&&(Ue("#getAttendanceCrossListIds").innerHTML=a[ue]?"<span>"+a[ue].join("</span> <span>")+"</span>":"",Ue("#getAttendanceSectionInfo").innerText=Ro(a,!0),b._sectionIds=[Tn.innerText].concat(a[ue])),Mt())}catch(e){Ko("Something went wrong validating and saving section information:\n"+e.stack)}}async function eo(){let e=await Vo('Are you sure you want to delete this section?<p>WARNING:<p>All data associated with this section will be lost, including all attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.',{Confirm:""});if(e){if("delete"!==e.Confirm)return void Xo('The section was NOT deleted.\n\nYou clicked OK but did not enter the word "delete" at the Confirm prompt.\nIf you want to delete this section, please try again, and make sure to type the word "delete" at the Confirm prompt.');let t=Ue("#editSectionSemesterSelect").value,n=Ue("#editSectionIdInput").value,a=await db.updateOne(G,t,{[n]:db.deleteField()});a.error?Ko("Failed to delete section.\n",a.error):(delete d[t][n],a=await db.deleteOne(W,Pe(t,n)),a?.error&&Ko("Deleted section, but failed to delete attendance data.\n",a.error),Mo(localStorage.semesterSelected),Mt(),Mt())}}function to(){co((e=>Ue("#editSectionRoom").innerText=e))}const no=Ue("#editRoomLayout");let ao,oo,io={};async function ro(){let e=await Gt(),t=[...new Set(Object.values(e).map((e=>e[ce])))];t.sort(),Ue("#editRoomCampusDataList").innerHTML="",Ue("#roomsCampusSelect").innerHTML='<option value="">All campuses</option>';for(let n of t)if(n){io[n]=[...new Set(Object.values(e).filter((e=>e[ce]===n)).map((e=>e[de])))],io[n].sort(),Ue("#editRoomCampusDataList").appendChild(document.createElement("option")).value=n;let t=Ue("#roomsCampusSelect").appendChild(document.createElement("option"));t.innerText=t.value=n}1===Ue("#editRoomCampusDataList").childElementCount?(Ue("#roomsCampusSelect").value=Ue("#roomsCampusSelect").lastChild.value,Ue("#roomsCampusSelect").setAttribute("disabled",!0)):localStorage.campusSelected&&(Ue("#roomsCampusSelect").value=localStorage.campusSelected,Ue("#roomsCampusSelect").removeAttribute("disabled")),Ue("#editRoomBuildingDataList").innerHTML="";for(let t of new Set(Object.values(e).map((e=>e[de]))))t&&(Ue("#editRoomBuildingDataList").appendChild(document.createElement("option")).value=t);lo(),so()}function lo(){if(localStorage.campusSelected=Ue("#roomsCampusSelect").value,Ue("#roomsBuildingSelect").innerHTML='<option value="">All buildings</option>',localStorage.campusSelected){for(let e of io[localStorage.campusSelected])if(e){let t=Ue("#roomsBuildingSelect").appendChild(document.createElement("option"));t.innerText=t.value=e}localStorage.buildingSelected&&(Ue("#roomsBuildingSelect").value=localStorage.buildingSelected)}else localStorage.buildingSelected="";so()}async function so(){localStorage.buildingSelected=Ue("#roomsBuildingSelect").value;let e=await Gt(),t=Object.keys(c).sort(((e,t)=>e.toLowerCase()>t.toLowerCase()?1:-1));for(;Ue("#roomList").childElementCount>1;)Ue("#roomList").removeChild(Ue("#roomList").lastChild);for(let n of t)!e[n][le]||localStorage.campusSelected&&localStorage.campusSelected!==e[n][ce]||localStorage.buildingSelected&&localStorage.buildingSelected!==e[n][de]||uo(n,e[n])}async function co(e){T=e,Pt("rooms"),Ue("#roomList").childElementCount<2&&ro()}var T,A,E;function uo(e,t){let n=t[se].split("\n").map((e=>e.split("\t"))).flat().filter((e=>e.trim())).length,a=Ue("#roomList").appendChild(document.createElement("div"));a.innerHTML=`${e}\n${n} seats\n${t[de]}\n${t[le]}\n${t[ce]}`,a._editRoomF=function(){Ue("#editRoomId").setAttribute("disabled",!0),Ue("#editRoomId").value=e,Ue("#editRoomCampus").value=t[ce],Ue("#editRoomBuilding").value=t[de],Ue("#editRoomName").value=t[le],oo=[tt(t[se].toUpperCase())],oo.indx=0,go();let n=[];for(let t in d)for(let a in d[t])d[t][a][re]===e&&(n.push(a),d[t][a][ue]?.length&&n.push(...d[t][a][ue]));n.length?(Ue("#editRoomUsedIn").innerText=`Room used for sections:\n  ${n.join(", ")}`,Ke("editRoomUsedIn","editRoomDeleteBtn")):Ke("editRoomDeleteBtn","editRoomUsedIn"),Pt("editRoom")},a.onclick=function(){T?(T(e),Mt()):a._editRoomF()}}function mo(){Ue("#editRoomId").removeAttribute("disabled"),Ue("#editRoomId").value="",Ue("#editRoomCampus").value="",Ue("#editRoomBuilding").value="",Ue("#editRoomName").value="",ze("editRoomDeleteBtn"),ze("editRoomUsedIn"),oo=[],oo.indx=-1,po(Array(6).fill().map((()=>Array(4).fill(" ")))),Pt("editRoom")}function fo(e){e||(e=[...no.children].map((e=>[...e.children].map((e=>e.innerText))))),JSON.stringify(e)!=JSON.stringify(oo[oo.indx])&&(oo.indx++,oo.length=oo.indx,oo.push(e))}function go(e){e?fo(e):e=oo[oo.indx],no.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t],a=no.appendChild(document.createElement("div"));for(let o=0;o<n.length;o++){let i=a.appendChild(document.createElement("div"));i.setAttribute("contenteditable",!0),e[t][o]&&(i.classList.add("seat"),i.innerText=e[t][o]),i.onmouseover=e=>{ao&&e.buttons&&(e.preventDefault(),1===ao?(i.classList.add("seat"),i.innerText="_"):-1===ao&&(i.classList.remove("seat"),i.innerText=""))},i.onmouseout=e=>{if(!ao&&e.buttons){function t(e){e.buttons||(ao=0,fo(),window.removeEventListener("mousemove",t))}e.preventDefault(),ao=i.classList.contains("seat")?-1:1,1===ao?(i.classList.add("seat"),i.innerText="_"):-1===ao&&(i.classList.remove("seat"),i.innerText=""),window.addEventListener("mousemove",t)}},i.oninput=e=>{i.innerText.includes("\n")&&i.blur(),i.innerText?i.classList.add("seat"):i.classList.remove("seat")},i.onblur=e=>{i.innerText=Me(i.innerText),fo()},i.ondblclick=e=>{e.preventDefault(),i.innerText?(i.classList.remove("seat"),i.innerText=""):(i.classList.add("seat"),i.innerText="_",selectText(i))},i.addEventListener("contextmenu",(async r=>{r.preventDefault();let l=await Yo(r.clientX,r.clientY,["Insert left","Insert right","Delete","","Insert row above","Insert row below","Delete row","","Insert col left","Insert col right","Delete col"]);if("Delete"===l)i.remove(),fo();else if("Insert left"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o,0,""),go(n)}else if("Insert right"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o+1,0,""),go(n)}else if("Delete row"===l)a.remove(),fo();else if("Insert row above"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t,0,Array(n.length).fill("")),go(a)}else if("Insert row below"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t+1,0,Array(n.length).fill("")),go(a)}else if("Delete col"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,1))),go(t)}else if("Insert col left"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,0,""))),go(t)}else if("Insert col right"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o+1,0,""))),go(t)}}))}}}async function ho(){let e=await Vo("Select grid size",{Rows:oo[oo.indx].length,Cols:Math.max(...oo[oo.indx].map((e=>e.length)))});e&&po(Array(e.Rows).fill().map((()=>Array(e.Cols).fill(" "))))}function po(e){e||(e=JSON.parse(JSON.stringify(oo[oo.indx])));let t,n=0;for(let a=e.length-1;a>-1;a--){let o=e[a];t=0;for(let i=0;i<o.length;i++)e[a][i]&&e[a][i]&&(e[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[n]+ ++t);t&&n++}go(e)}function So(){let e,t=JSON.parse(JSON.stringify(oo[oo.indx])),n=1;for(let a=t.length-1;a>-1;a--){let o=t[a];e=0;for(let i=0;i<o.length;i++)t[a][i]&&t[a][i]&&(t[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e++]+n);e&&n++}go(t)}function vo(){oo.indx>0&&(oo.indx=0,go())}function wo(){oo.indx>0?(oo.indx--,go()):Zo("Nothing to undo.")}function bo(){oo.indx<oo.length-1?(oo.indx++,go()):Zo("Nothing to redo.")}function yo(){if(null===Ue("#editRoomId").getAttribute("disabled")){if(Ue("#editRoomId").value=Ue("#editRoomId").value.trim(),wt(Ue("#editRoomId")),!Ue("#editRoomId").value)return void Ko("Missing field: Room Id");if(Ue("#editRoomId").value in c)return void Ko(`Room ${Ue("#editRoomId").value} already exists.`)}if(Ue("#editRoomBuilding").value=Ue("#editRoomBuilding").value.trim(),Ue("#editRoomName").value=Ue("#editRoomName").value.trim(),Ue("#editRoomCampus").value=Ue("#editRoomCampus").value.trim(),!Ue("#editRoomBuilding").value)return void Ko("Missing field: Building");if(!Ue("#editRoomName").value)return void Ko("Missing field: Room name or number");if(!Ue("#editRoomCampus").value)return void Ko("Missing field: Campus");let e=[...no.children].map((e=>[...e.children].map((e=>e.innerText)))),t=e.flat();for(let e=0;e<t.length;e++)if(t[e]){if(t.indexOf(t[e])!==e)return void Ko("Duplicate seat code: "+t[e]);if(!t[e].match(/^[a-z0-9]+$/i))return void Ko(`Invalid seat code: ${t[e]}.\nSeat codes must be combinations of letters and numbers.`)}let n={[le]:Ue("#editRoomName").value,[de]:Ue("#editRoomBuilding").value,[ce]:Ue("#editRoomCampus").value,[se]:e.map((e=>e.join("\t"))).join("\n")},a=db.insertOne(Y,Ue("#editRoomId").value,n);a.error?Ko("Could not save changes to room.\n"+a.error):(c[Ue("#editRoomId").value]=n,n[ce]!==localStorage.campusSelected?localStorage.campusSelected="":n[de]!==localStorage.buildingSelected&&(localStorage.buildingSelected=""),Mt(),ro(),T&&(Mt(),T(Ue("#editRoomId").value)))}async function Co(){if(await Vo("Are you sure you would like to delete this room record?",{},["Delete","Cancel"])){let e=db.deleteOne(Y,Ue("#editRoomId").value);e.error?Ko("Could not delete room record.\n"+e.error):(delete c[Ue("#editRoomId").value],Mt(),ro())}}function Lo(){let e=[...no.children].reverse().map((e=>[...e.children].map((e=>e.innerText)))).flat().filter((e=>e));window.open("printLabels.html?"+e,"lectureSeatsLabels")}function To(e,t=""){(A=e)?ze("manageUsersAddUserButtons"):Ze("manageUsersAddUserButtons"),Ue("#manageUsersTitle").innerHTML=t,Pt("manageUsers");const n=Ue("#manageUsersPages");if(!n.childElementCount){for(let e of _e){let t=n.appendChild(document.createElement("span"));t.innerText=e,t.onclick=()=>{Ue("#manageUsersEmailInput").value="",Ue("#manageUsersNameInput").value="",Ue("#manageUsersLastNameInput").value="",Ue(".manageUsersSelectedFilter").value=Ue(".manageUsersSelectedFilter")==Ue("#manageUsersEmailInput")?e:e.toUpperCase(),Ao()}}let e=n.appendChild(document.createElement("span"));e.innerText="—",e.onclick=()=>{Ue("#manageUsersEmailInput").value="",Ue("#manageUsersNameInput").value="",Ue("#manageUsersLastNameInput").value="",Ao()}}}async function Ao(){let e=Ue("#manageUsersEmailInput").value,t=Ue("#manageUsersNameInput").value,n=Ue("#manageUsersLastNameInput").value,a=Ue("#manageUsersSelectRoleStudent").checked,o=Ue("#manageUsersSelectRoleInstructor").checked,i=Ue("#manageUsersSelectRoleAdmin").checked;if(!(e||t||n||o||i))return void(manageUsersList.innerHTML='When "Any role" or "Students Only" role is selected, you must also supply additional filters for email and/or last name and/or preferred name.');let r={};if(e?r=await Qt(e):n?r=await Qt(n,ee):t?r=await Qt(t,K):o?r=await Qt([1,3],ie):i&&(r=await Qt([2,3],ie)),r?.error)Ko("Could not perform search.\n"+r.error);else{const e=Ue("#manageUsersList");e.innerHTML="",t=t.toLowerCase(),n=n.toLowerCase();for(let e in r){let l=r[e];n&&!(l[ee].toLowerCase()||"").startsWith(n)||(t&&!(l[K].toLowerCase()||"").startsWith(t)||a&&l[ie]||(!o||l[ie]&N)&&(!i||l[ie]&O)&&Eo(e,l))}e.innerHTML?e.insertBefore(document.createElement("row"),e.firstElementChild).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>":e.innerHTML="No users found matching the specified filters."}}function Eo(e,t){let n=Ue("#manageUsersList").appendChild(document.createElement("row"));n.innerHTML=`<div>${t[ie]&O?"✔️":""}</div><div>${t[ie]&N?"✔️":""}</div><div>${e}</div><div>${t[ee]||""}</div><div>${t[K]||""}</div>`,n.onclick=async function(){if(A)return void A(e);let a=`${e}\n${Kt(t,"\n")}\n`,o=await getOneLinkFromStoragePath(St(e));o&&(a+=`<img src="${o}" height=${j}>\n`);for(let e in t[X]){let n=Object.keys(t[X][e]);n.length&&(a+=`<small>${e}: ${n}</small>\n`)}let i=await Vo(a,{Instructor:Boolean(t[ie]&N),Admin:Boolean(t[ie]&O)},["Save","Cancel"]);if(i){let a=i.Instructor*N+i.Admin*O,o=`Are you sure you would like to change the role for ${e}?`;if(a&N&&!(t[ie]&N)&&(o+="\n<li>Adding instructor privileges</li>"),!(a&N)&&t[ie]&N&&(o+="\n<li>Taking away instructor privileges</li>"),a&O&&!(t[ie]&O)&&(o+="\n<li>Adding admin privileges</li>"),!(a&O)&&t[ie]&O&&(o+="\n<li>Taking away admin privileges</li>"),a!==t[ie]&&await Vo(o)){let o=await db.updateOne(F,e,{[ie]:a});o.error?Ko(`Could not update user profile for ${e}.\n`+o.error):(t[ie]=a,n.innerHTML=`<div>${a&O?"✔️":""}</div><div>${a&N?"✔️":""}</div><div>${e}</div><div>${t[ee]||""}</div><div>${t[K]||""}</div>`)}}}}async function Io(){let e=await Vo("",{Email:{placeholder:"username"+I,required:!0,onchange:"this.value=this.value.trim().toLowerCase();if(!this.value.endsWith(DOMAIN))this.value+=DOMAIN"},"First name":"","Last name":"",Instructor:!1,Admin:!1},["Add User","Cancel"]);if(e){let t=e.Email.split("@");if(2!==t.length||!vt(t[0])||!e.Email.endsWith(I))return void Ko(`Invalid email address ${e.Email}.`);let n=await db.getDoc(F,e.Email);if(n?.error)return void Ko("Could not access the database.\n"+n.error);if(n)return void Ko(`Cannot add user.\nUser with the email ${e.Email} already exists.`);let a={};if(e["First name"]&&(a[K]=e["First name"]),e["Last name"]&&(a[ee]=e["Last name"]),(e.Instructor||e.Admin)&&(a[ie]=e.Instructor*N+e.Admin*O),n=await db.insertOne(F,e.Email,a),n.error)return void Ko("Could not add user to database.\n"+n.error);m[e.Email]=a,Ue("#manageUsersList").childElementCount||(Ue("#manageUsersList").innerHTML="",Ue("#manageUsersList").appendChild(document.createElement("row")).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>"),Eo(e.Email,a)}}function ko(e,t="Add users"){(E=e)?ze("addUsersRoleOptions"):Ze("addUsersRoleOptions"),Ue("#addUsersBtn").innerText=t,Ue("#addUsersEmails").innerText="",Ue("#addUsersNames").innerText="",Pt("addUsers")}function xo(){const e=Ue("#addUsersList");Ue("#addUsersEmails").value!==Ue("#addUsersEmails").value.trimStart()&&(Ue("#addUsersEmails").value=Ue("#addUsersEmails").value.trimStart());let t=Ue("#addUsersEmails").value.split("\n").filter((e=>e)),n=Ue("#addUsersNames").value?Ue("#addUsersNames").value.trimEnd().split("\n"):[];if(e.innerHTML="",Ue("#addUsersBtn").setAttribute("disabled",!0),t.length){const a=Ue("#addUsersLastNameFirst").checked;let o,i,r,l,s,d,c,u=[],m=new Set,f=new Set;e.appendChild(document.createElement("row")).innerHTML="<div>Email</div><div>Last Name</div><div>First Name</div>";for(let c=0;c<t.length;c++){s=t[c].toLowerCase(),s.endsWith(I)||(s+=I),o=e.appendChild(document.createElement("row")),i=o.appendChild(document.createElement("div")),r=o.appendChild(document.createElement("div")),l=o.appendChild(document.createElement("div")),i.innerText=s,n[c]&&(d=n[c].split(/\s?,\s?|\s{2,}|\t/),(a?r:l).innerText=ht(d[0]),d[1]&&((a?l:r).innerText=ht(d[1])));let g=s.split("@");2==g.length&&vt(g[0])||(u.push(s),i.classList.add("bad-text")),f.has(s)?(m.add(s),i.innerHTML+=" (duplicate)",i.classList.add("bad-text")):f.add(s)}u.length?c="Invalid emails:\n"+u.join("; ")+"\n":m.size?c="Duplicate emails:\n"+[...m].join("; ")+"\n":n.length>t.length?c=`You specified ${n.length} names, but only ${t.length} matching emails/usernames.`:(c=`Ready to add ${t.length} user(s).`,Ue("#addUsersBtn").removeAttribute("disabled")),Ue("#addUsersSummary").innerHTML=c+"\nCheck the table below to make sure all emails and names are correctly inferred."}else if(n.length)return void Xo("Please enter emails or usernames to proceed.")}function Bo(){let e=[...Ue("#addUsersList").children].map((e=>[...e.children].map((e=>e.innerText)))).slice(1);if(E)E(e);else for(let t=0;t<e.length;t++);}function Ro(e,t){return t?[e[me]||"Title: None",e[fe]||"Pattern: None",e[re]||Va,e[we]||e[ve]?.join("\n")].join("\n"):[e[me],e[fe],e[re]||"",e[we]||e[ve]?.join("\n")].filter((e=>e)).join("\n")}function $o(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard";var i=o.appendChild(document.createElement("div"));return i.class="cardTitle",i.innerText=e,a&&t[ue]&&(i.innerText+="\n"+t[ue].join("\n")),(i=o.appendChild(document.createElement("div"))).innerText=Ro(t),o.addEventListener("click",n),o}async function No(e){kn(e.currentTarget.id,e.currentTarget._sectionDoc)}function Oo(e){an(e.currentTarget.id,e.currentTarget._sectionDoc)}async function _o(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne(F,auth.currentUser.email,{[X+"."+localStorage.semesterSelected+"."+t]:{}})).error?Ko("Failed to add section.\n\nPlease try again."):(i[X][localStorage.semesterSelected]||(i[X][localStorage.semesterSelected]={}),i[X][localStorage.semesterSelected][t]={},Po(t,n,Ue("#studentSections"),Oo),Mt())}function Po(e,t,n,a,o){var i=$o(e,t,a,o);n.insertBefore(i,n.lastElementChild)}async function Do(){Pt("selectStudentSection");var e=await Ft(localStorage.semesterSelected),t=Ue("#availableStudentSections");t.innerHTML="<span></span>";let n=Object.keys(e).sort(),a=new Set(i[X]&&i[X][localStorage.semesterSelected]?Object.keys(i[X][localStorage.semesterSelected]):[]);for(let o of n){let n=e[o];if(n[be]&&!a.has(o)&&!n[ue]?.filter((e=>a.has(e))).length&&(Po(o,n,t,_o),n[ue]?.length))for(let e of n[ue])Po(e,n,t,_o)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")}async function Mo(e){const t=Ue("#studentSections"),n=Ue("#instructorSections");if(!e)return ze(t),void ze(n);Ue("#semesterSelect").value=e,Ze(t),i[ie]&N&&Ze(n);var a=await Ft(e);for(let e=t.childElementCount-2;e>0;e--)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let r=a[o];if(i[X]&&i[X][e]&&o in i[X][e])Po(o,r,t,Oo);else if(r[ue]?.length)for(let n of r[ue])i[X]&&i[X][e]&&n in i[X][e]&&Po(n,r,t,Oo);!n.classList.contains("hidden")&&r[ve]?.includes(auth.currentUser.email)&&Po(o,r,n,No,!0)}}async function Uo(){if(localStorage.semesterSelected){const e=Ue("#allSectionsList");e.innerHTML="";let t=await Ft(localStorage.semesterSelected);for(let n in t){let a=t[n];e.appendChild($o(n,a,(e=>Qa(e.currentTarget.id,e.currentTarget._sectionDoc)),!0))}}}async function qo(){Pt("allSections");const e=Ue("#allSectionsSemesterSelect");if(1==e.children.length){let t,n=await qt();for(let a of n)t=e.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a;localStorage.semesterSelected&&(e.value=localStorage.semesterSelected)}Uo()}const Ho=Ue("#nameInput"),jo=Ue("#lastNameInput"),Fo=Ue("#saveNameBtn");function Wo(){let e=ht(Ho.value),t=ht(jo.value);!e||!t||Ho.lastValue===e&&jo.lastValue===t?ze(Fo):Ze(Fo)}async function Go(){Fo.setAttribute("disabled","true"),Ho.value=ht(Ho.value),jo.value=ht(jo.value);let e=await db.updateOne(F,auth.currentUser.email,{[K]:Ho.value,[ee]:jo.value});e.error?Ko("Unable to update name.\n"+e.error):(ze(Fo),i[K]=Ho.lastValue=Ho.value,i[ee]=jo.lastValue=jo.value,Zo("Name updated.","",1)),Fo.removeAttribute("disabled"),Nt()}function Yo(e,t,n){return new Promise((function(a,o){const i=Ue("#contextMenu");window.dispatchEvent(new Event("click")),e<window.innerWidth/2?(i.style.left=e,i.style.removeProperty("right")):(i.style.right=window.innerWidth-e,i.style.removeProperty("left")),t<window.innerHeight/2?(i.style.top=t,i.style.removeProperty("bottom")):(i.style.bottom=window.innerHeight-t,i.style.removeProperty("top")),i.innerHTML="";for(let e of n){let t=i.appendChild(document.createElement("div"));""===e?t.classList.add("separator"):e.startsWith("_")?t.innerText=e.slice(1):(t.innerText=e,t.onclick=()=>a(e),t.classList.add("contextMenuOption"))}Ze(i),window.addEventListener("click",(()=>{a(!1),ze(i)}),{once:!0}),window.addEventListener("popstate",(()=>{a(!1),ze(i)}),{once:!0})}))}function Vo(e,t={},n){if(s)return new Promise((function(a,o){Ot(),Ze("prompt");const i=Ue("#promptForm");let r={};Ue("#promptFormTitle").innerHTML=e;for(let e in t){let n=i.appendChild(document.createElement("label"));if(n.innerText=e,n.setAttribute("for",e),je(t[e]))r[e]=i.appendChild(document.createElement("input")),r[e].setAttribute("type","number"),r[e].value=t[e],r[e].id=e;else if(He(t[e])){let a=i.appendChild(document.createElement("div"));r[e]=a.appendChild(document.createElement("input")),a.appendChild(n),r[e].setAttribute("type","checkbox"),r[e].checked=t[e],r[e].id=e}else if(Ge(t[e])){r[e]=i.appendChild(document.createElement("select"));for(let n of t[e]){let t=r[e].appendChild(document.createElement("option"));if(We(n))for(let e in n)"value"===e?t.innerText=n[e]:t.setAttribute(e,n[e]);else t.innerText=n}r[e].id=e}else if(Fe(t[e]))t[e].includes("\n")?r[e]=i.appendChild(document.createElement("textarea")):r[e]=i.appendChild(document.createElement("input")),r[e].value=t[e],r[e].id=e;else if(We(t[e])){if(r[e]=i.appendChild(document.createElement("input")),Object.entries(t[e]).forEach((t=>r[e].setAttribute(t[0],t[1]))),r[e].required&&n.classList.add("required"),"checkbox"===r[e].type||"radio"===r[e].type){let t=i.appendChild(document.createElement("div"));t.appendChild(r[e]),t.appendChild(n)}r[e].id=e}else{i.appendChild(document.createElement("div")).appendChild(n)}}for(let e of n||["OK","Cancel"]){let t=Ue("#promptButtons").appendChild(document.createElement("button"));t.innerText=e,t.onclick="cancel"===e.toLowerCase()?()=>{a(!1),Jo()}:()=>{if(!i.reportValidity())return;let t=Object.fromEntries(Object.entries(r).map((([e,t])=>[e,"checkbox"===t.type||"radio"===t.type?t.checked:"number"===t.type?parseFloat(t.value):t.value])));t.clicked=e,a(t),Jo()}}}))}function Jo(){Ue("#promptForm").innerHTML="",Ue("#promptButtons").innerHTML="",ze("prompt"),Nt()}const Qo=Ue("#toast"),zo=Ue("#toastMessage");function Zo(e,t,n){if(n?Qo.style.setProperty("--toast-accent",n>0?"#4f6":n<-.5?"#f64":"#fe4"):Qo.style.setProperty("--toast-accent","gray"),zo.innerHTML=t?t+"\n\n":"",We(e))for(let t in e)e[t]&&(zo.innerHTML+=t+" : "+e[t]+"\n");else zo.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",ei),window.addEventListener("keydown",ei),window.addEventListener("popstate",ei),$t.addEventListener("scroll",ei),Ze(Qo),Qo.classList.add("slide-up")}),200)}function Xo(e){Zo(e,"Warning",-.1)}function Ko(e){Zo(e,"Error",-1)}function ei(){window.removeEventListener("mousedown",ei),window.removeEventListener("keydown",ei),window.removeEventListener("popstate",ei),$t.removeEventListener("scroll",ei),ze(Qo),Qo.classList.remove("slide-up")}const ti=Ue("#theme-switch");function ni(){ai(ti.innerText.startsWith("dark"))}function ai(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),ti.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),ti.innerText="dark_mode")}function oi(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}ai(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);const ii=(e,t)=>{e.constructor===NodeList||Ge(e)||(e=[e]);for(let n of e)n.addEventListener("click",t),n.setAttribute("onclick","")};function ri(e,t,n){let a=e.appendChild(document.createElement("span"));a.classList.add("helpIcon"),ii(a,(()=>Zo(`<span class="material-symbols-outlined">info</span> <b>${t}</b>\n\n${n}`)))}ii(qe(".back"),Mt),ii(qe(".spinner"),(e=>it(e.currentTarget))),ii(qe(".spinnerBtn"),(e=>it(e.currentTarget.firstElementChild))),ii(qe(".logoutBtn"),bt),ii(Ue("#user"),(()=>{Pt("profile")})),ii(Ue("#signInBtn"),xt),ii(Ue("#registerBtn"),Bt),ii(Ue("#resetPwdBtn"),Rt),ii(Ue("#showNoPwdBtn"),Lt),ii(Ue("#signInSendBtn"),Et),ii(qe(".signInWithEmailPasswordBtn"),(()=>{_t("signInWithEmailPassword")})),ii(Ue("#signInCompleteBtn"),It),ii(Ue("#signIngSendEmailBtn"),(()=>{_t("signinSendEmail")})),ii(Ue("#hideSigninLinkSentBtn"),Tt),ii(Ue("#addInstructorSectionBtn"),Ja),ii(Ue("#sectionsQRreaderBtn"),hn),ii(Ue("#addStudentSectionBtn"),Do),ii(Ue("#verifyEmailBtn"),Ct),ii(Ue("#sectionsBtn"),(()=>{Pt("sections")})),ii(Ue("#allSectionsBtn"),qo),ii(Ue("#roomsBtn"),(()=>co())),ii(Ue("#manageUsersBtn"),(()=>To())),ii(Ue("#markAttendanceScanPasscodeBtn"),(()=>{hn("markAttendanceClassCodeInput")})),ii(Ue("#markAttendanceScanSeatCodeBtn"),(()=>{hn("markAttendanceSeatCodeInput")})),ii(Ue("#defaultSelfieImg"),Cn),ii(Ue("#selfieCanvas"),Cn),ii(Ue("#selfieVideo"),Ln),ii(Ue("#addPhotoBtn"),Cn),ii(Ue("#snapPhotoBtn"),Ln),ii(Ue("#switchPhotoBtn"),switchCamera),ii(qe(".refreshLocation"),rn),ii(Ue("#markAttendanceButton"),dn),ii(Ue("#markAttendanceRemoveButton"),fn),ii(Ue("#switchQrCameraBtn"),wn),ii(Ue("#editSectionRoom"),to),ii(Ue("#editSectionRoomBtn"),to),ii(Ue("#editSectionResetRoomBtn"),Za),ii(Ue("#editSectionSubmitBtn"),Ka),ii(Ue("#editSectionDeleteBtn"),eo),ii(Ue("#createNewRoomBtn"),mo),ii(Ue("#editRoomResetBtn"),vo),ii(Ue("#editRoomUndoBtn"),wo),ii(Ue("#editRoomRedoBtn"),bo),ii(Ue("#editRoomGridBtn"),ho),ii(Ue("#editRoom123Btn"),(()=>po())),ii(Ue("#editRoomAbcBtn"),So),ii(Ue("#editRoomSaveBtn"),yo),ii(Ue("#editRoomLabelsBtn"),Lo),ii(Ue("#editRoomDeleteBtn"),Co),ii(Ue("#addUserBtn"),Io),ii(Ue("#showAddUsersBtn"),(()=>ko())),ii(Ue("#addUsersBtn"),Bo),ii(Ue("#createSectionURLBtn"),Bn),ii(Ue("#randomAttendanceClassCodeBtn"),xn),ii(Ue("#createQRCodeBtn"),(()=>On())),ii(Ue("#createURLBtn"),Rn),ii(Ue("#collectAttendanceBtn"),Dn),ii(Ue("#refreshAttendanceBtn"),(()=>{Hn(!0)})),ii(Ue("#studentsAddBtn"),Gn),ii(Ue("#getAttendanceShowAttendanceTableBtn"),zn),ii(Ue("#getAttendanceShowRoomBtn"),(()=>Aa())),ii(Ue("#learnNamesBtn"),Ua),ii(Ue("#hideQRBtn"),(()=>{ze("QRcodeContainer")})),ii(Ue("#showQRPopupBtn"),$n),ii(Ue("#gotoRoomBtn"),(()=>{Mt(),setTimeout(Aa,100)})),ii(Ue("#refreshAttendTableBtn"),(()=>{na(!0)})),ii(Ue("#saveGradingOptionsBtn"),ea),ii(Ue("#attendanceTableSelectColsBtn"),va),ii(Ue("#attendanceTableFitBtn"),pa),ii(Ue("#attendanceTableColFirstBtn"),ma),ii(Ue("#attendanceTableColLeftBtn"),ga),ii(Ue("#attendanceTableColsAllBtn"),ca),ii(Ue("#attendanceTableColRightBtn"),ha),ii(Ue("#attendanceTableColsLastBtn"),fa),ii(Ue("#attendanceTableOptionsBtn"),(()=>{Xe("attendanceTableOptions")})),ii(Ue("#attendanceTableOptionsHideBtn"),(()=>{ze("attendanceTableOptions")})),ii(Ue("#downloadAttendanceBtn"),Ca),ii(Ue("#attendanceTableAddColBtn"),sa),ii(Ue("#attendanceTableAddStudentBtn"),Wn),ii(Ue("#attendanceTableAddStudentsBtn"),Gn),ii(Ue("#attendanceTableClassLocBtn"),Kn),ii(Ue("#showAttendanceTableBtn"),(()=>{Mt(),setTimeout(zn,100)})),ii(Ue("#refreshRoomBtn"),(()=>{Aa(!0)})),ii(Ue("#attendanceRoomViewLeftBtn"),ka),ii(Ue("#attendanceRoomViewRightBtn"),xa),ii(Ue("#attendanceRoomViewLastBtn"),Ba),ii(Ue("#attendanceRoomViewZoomOutBtn"),Na),ii(Ue("#attendanceRoomViewZoomInBtn"),$a),ii(Ue("#attendanceRoomViewNamesBtn"),_a),ii(Ue("#learnNamesImg"),Ha),ii(Ue("#learnNamesNameBtn"),Wa),ii(Ue("#learnNamesNextBtn"),ja),ii(Ue("#learnNamesPrevBtn"),Fa),ii(Ue("#learnNamesRemoveBtn"),Ga),ii(Ue("#attendanceCollectionStatus"),(()=>kn())),ii(Ue("#saveNameBtn"),Go),ii(Ue("#closeHelpBtn"),(()=>{ze("infoScreen")})),ii(Ue("#showHelpBtn"),(()=>{Ze("infoScreen")})),ii(Ue("#fontPlusBtn"),(()=>{oi(1)})),ii(Ue("#fontMinusBtn"),(()=>{oi(-1)})),ii(Ue("#theme-switch"),ni),Ue("#getAttendanceClassCodeInput").addEventListener("input",(()=>wt(An,"Attendance passcode"))),Ue("#attendanceTableGradeEquationInput").addEventListener("input",ta),Ue("#minLateInput").addEventListener("input",ta),Ue("#markAttendanceClassCodeInput").addEventListener("input",ln),Ue("#markAttendanceSeatCodeInput").addEventListener("input",ln),Ue("#manageUsersEmailInput").addEventListener("input",Ao),Ue("#manageUsersLastNameInput").addEventListener("input",Ao),Ue("#manageUsersNameInput").addEventListener("input",Ao),Ue("#addUsersEmails").addEventListener("input",xo),Ue("#addUsersNames").addEventListener("input",xo),Ue("#addUsersLastNameFirst").addEventListener("input",xo),Ue("#nameInput").addEventListener("input",Wo),Ue("#lastNameInput").addEventListener("input",Wo),Ue("#editSectionIdInput").addEventListener("input",(()=>wt(Ue("#editSectionIdInput"),"Section Id"))),Ue("#editRoomId").addEventListener("input",(()=>wt(Ue("#editRoomId"),"Room Id"))),Ue("#attendanceTableGradeEquationInput").addEventListener("change",Xa),Ue("#editSectionGradeInput").addEventListener("change",Xa),Ue("#roomsCampusSelect").addEventListener("change",lo),Ue("#roomsBuildingSelect").addEventListener("change",so),Ue("#manageUsersSelectRoleAny").addEventListener("change",Ao),Ue("#manageUsersSelectRoleStudent").addEventListener("change",Ao),Ue("#manageUsersSelectRoleInstructor").addEventListener("change",Ao),Ue("#manageUsersSelectRoleAdmin").addEventListener("change",Ao),Ue("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,Mo(e.target.value)})),Ue("#allSectionsSemesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,Uo()})),Ue("#manageUsersEmailInput").addEventListener("focus",(()=>{})),Ue("#manageUsersLastNameInput").addEventListener("focus",(()=>{})),Ue("#manageUsersNameInput").addEventListener("focus",(()=>{}));const li="<b>How to enable your camera:</b>\n<li>To the left of your address bar (near top-left or bottom-left of your browser screen) you should see one of the following icons:\n  <icon>page_info</icon> or <small>A</small>A or <icon>info</icon> or <icon>lock</icon>.\nClick this icon.</li>\n<li>Under Permissions or Website settings, <b>toggle the Camera setting to Allow or toggle it to the On position <icon>toggle_on</icon></b>.</li>\n<li>Reload this page</li>\n",si="<b>How to enable location:</b>\n<li>To the left of your address bar (near top-left or bottom-left of your browser screen) you should see one of the following icons:\n  <icon>page_info</icon> or <small>A</small>A or <icon>info</icon> or <icon>lock</icon>.\nClick this icon.</li>\n<li>Under Permissions or Website settings, <b>toggle the Location setting to Allow or toggle it to the On position <icon>toggle_on</icon></b>.</li>\n<li>Reload this page</li>\n",di="Grading equation example:\n    ( 100 * P + 50 * L ) / N\nsignifies that the grade is calculated as the average of all unexcused attendances (N), where student gets 100pts for being present (P) and 50pts for being late (L).\n\nGrading equation instructions:\n<li>Use the letters P, L, A, E to signify the numbers of times student was present, late, absent, and excused, respectively.</li>\n<li>Use the letter N to signify the total number of unexcused attendances; N = P + L + A.</li>\n<li>Use operators +, -, *, /, %, ^ to signify addition, subtraction, multiplication, division, modulo (i.e., remainder), and exponentiation, respectively.</li>\n<li>Use _ before an expression to truncate that expression (i.e., get the integer part of a decimal point number). Tip: for positive numbers _(X+0.5) will round X and _(X+0.9999) will give you ceiling of X.</li>\n<li>Use X?Y:Z to signify the expression: if X is true, then Y, otherwise Z.</li>\n<li>Use operators = != > &lt; >= &lt;= to signify equality, inequality, greater than, less than, greater than or equal to, and less than or equal to comparisons, respectively.</li>\n<li>Use operators & and | to signify logical AND and OR operations, respectively; use ! before an expression to signify logical negation.</li>\n";ri(Ue('label[for="nameInput"]'),"Preferred Name","What would you like to be called?"),ii(qe(".locationEnableHelp"),(()=>Zo(si,"Enabling location permissions"))),ri(Ue('label[for="attendanceTableGradeEquationInput"]'),"Attendance grade equation",di),ri(Ue('label[for="editSectionGradeInput"]'),"Attendance grade equation",di),ri(Ue("#editSectionSeatLabel"),"Seat information collection",'If this section has a room selected, the room will have a Seat Code assigned to each seat location.\nCollecting Seat Code information will enable viewing student names/photos within a mapped room layout.\n<li>Selecting "No" will not collect Seat Code information when attendance is marked.</li>\n<li>Selecting "Yes" will present a text input for a student to enter their Seat Code.</li>\n<li>Selecting "Request" will warn a student that Seat Code is requested by instructor, but will allow student to ignore the warning and mark attendance without supplying a Seat Code.</li>\n<li>Selecting "Require" will require a student to enter their Seat Code.</li>\n'),ri(Ue("#editSectionPhotoLabel"),"Student photo collection",'Collecting student photos may be helpful for verifying attendance and for learning student names.\n<li>Selecting "No" will not collect student photos when attendance is marked.</li>\n<li>Selecting "Yes" will present an option for taking a selfie to each student.</li>\n<li>Selecting "Request" will warn a student that a selfie is requested by instructor, but will allow student to ignore the warning and mark attendance without supplying a selfie.</li>\n<li>Selecting "Require" will require a student to take a selfie for marking attendance.</li>\n'),ri(Ue("#editSectionLocationLabel"),"Geo-Location collection",'Collecting geolocation may be very helpful for verifying attendance.\nHowever, many devices have location-sharing turned off, and some of the students may be uncomfortable turning on location-sharing due to privacy concerns or for some technical reasons.\n<li>Selecting "No" will not collect student geolocation when attendance is marked.</li>\n<li>Selecting "Yes" will collect student location when location-sharing is enabled.</li>\n<li>Selecting "Request" will warn a student that location-sharing is requested by instructor, but will allow student to ignore the warning and mark attendance even if location-sharing is off.</li>\n<li>Selecting "Require" will require a student to turn on location-sharing for marking attendance.</li>\n'),ri(Ue('label[for="editSectionAllowSelfEnroll"]'),"Allow students to self-enroll","<li>When this option is checked, any student will be able to add this section to their My Sections screen.</li>\n<li>When this option is unchecked, this section will only appear in a student's My Sections screen if the instructor had enrolled the student in this section, or after a student used an attendance QR code to mark their attendance for this section.</li>\n"),ri(Ue('label[for="addUsersEmails"]'),"Enter emails or usernames",`Enter each user's email or username on its own line.\n\nWARNING: Blank lines will be ignored.\n\nIf entering emails, each email must be in the format <i>username<span class="domainName"></span></i>.\nIf entering usernames, <i>${I}</i> will be automatically added at the end of each username to get user's email addresses.`),ri(Ue('label[for="addUsersNames"]'),"Enter user's names",'Enter each user\'s name on their own line.\n\nIf the "Last name first" checkbox is checked, enter names in one of the following formats:\n<li>Last Name</li>\n<li>Last Name, First Name</li>\n<li>Last Name &nbsp; First Name</li>\n\nIf the "Last name first" checkbox is unchecked, enter names in one of the following formats:\n<li>First Name</li>\n<li>First Name, Last Name</li>\n<li>First Name &nbsp; Last Name</li>\n'),Ke("accessibility","error"),document.getElementById("errorDetails").innerHTML="No JavaScript errors encountered. CSS errors may be occurring."}catch(e){showError(e)}}();