"use strict";!function(){const e="2024-02-11",t="LectureSeats",n="v0.1."+e.replace(/-/g,"")+" (beta)",a="@caldwell.edu",o=[40.83352325048076,-74.27245652688725],i="|",r="user-icon.png",l=200,s="users",d="attend",c="sections",u="rooms",m="a",f="c",p="u",h="d",g="m",S="e",v="n",w="f",b="p",C="s",y="l",E="nt",A="rl",T="rn",I="rm",k="bl",x="cm",B="x",R="pt",$="i",N="in",M="Section",P="Email",U="Username",O="Name",_="Last Name",D="Attendance-Grade",H="On-time",F="Late",j="Absent",W=[P,U,_,O,M,D,H,F,j],q=[_,O,U,M,D,j,F,H,P],V=W.length,J="abcdefghijklmnopqrstuvwxyz",Y=(e,t)=>e+i+t,Q=e=>e.split(i),z=e=>e?e.replace(/\s/g,"").toUpperCase():"",Z=document.querySelector.bind(document),X=e=>e?.constructor===Number,K=e=>e?.constructor===String,G=e=>e?.constructor===Object,ee=e=>e?.constructor===Array;function te(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function ne(e){(K(e)?document.getElementById(e):e).classList.add("hidden")}function ae(e){(K(e)?document.getElementById(e):e).classList.remove("hidden")}function oe(e){(K(e)?document.getElementById(e):e).classList.toggle("hidden")}function ie(e){return e.map((e=>({r:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({r:e})=>e))}function re(e){return Math.floor(Math.random()*e)}function le(e){return e.split("\n").map((e=>e.split("\t")))}function se(e,t=2){return e.toString().padStart(t,"0")}function de(e){let t;return t=e?new Date(e?.constructor===db.Timestamp?1e3*e.seconds:e):new Date,[t.getFullYear()+"-"+se(t.getMonth()+1)+"-"+se(t.getDate()),se(t.getHours())+":"+se(t.getMinutes())]}function ce(e){e.style.animation="",e.offsetWidth,e.style.animation="spin 0.5s",setTimeout((()=>e.style.animation=""),500)}var ue=[];function me(e,t,n){n?(ue=n).indx=0:ue.indx=(ue.indx+(e||1+re(ue.length-1)))%ue.length,t&&(ue.target=t),ue.target&&(ue.target.src=ue[ue.indx])}var fe,pe,he=0,ge=0;function Se(e){let t=e.target.getBoundingClientRect();he=t.x-e.clientX,ge=t.y-e.clientY,window.addEventListener("mousemove",ve,!0)}function ve(e){fe.style.position="fixed",fe.style.top=e.clientY+ge+"px",fe.style.left=e.clientX+he+"px"}function we(e){let t,n,a,o,i=!1;e.addEventListener("mousedown",(r=>{i=!0,e.classList.add("dragging"),t=r.pageX-e.offsetLeft,n=r.pageY-e.offsetTop,a=e.scrollLeft,o=e.scrollTop})),e.addEventListener("mouseleave",(t=>{i&&(i=!1,e.classList.remove("dragging"))})),e.addEventListener("mouseup",(t=>{i&&(Math.round(a)===Math.round(e.scrollLeft)&&Math.round(o)===Math.round(e.scrollTop)||(t.preventDefault(),t.stopPropagation(),window.addEventListener("click",(e=>{e.stopPropagation()}),{capture:!0,once:!0})),i=!1,e.classList.remove("dragging"))})),e.addEventListener("mousemove",(r=>{i&&(r.preventDefault(),r.stopPropagation(),e.scrollLeft=a-3*(r.pageX-e.offsetLeft-t),e.scrollTop=o-3*(r.pageY-e.offsetTop-n))}))}window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",ve,!0),pe&&pe(fe.style.left,fe.style.top)}),!1);const be=1/(6378137*Math.PI/180);function Ce(e,t,n,a,o){let i=L.map(e,{});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(i);let r=a*be;let l=function(e,t){return e*be/Math.cos(t*Math.PI/180)}(a,t);i.fitBounds([[t-r,n-l],[t+r,n+l]]);let s=L.circle([t,n],{radius:a}).addTo(i);o&&i.on("moveend",(e=>{let t=i.getCenter();t=[t.lat,t.lng],o(t),s.setLatLng(t)}))}var ye,Le={};function Ee(e,t){let n=e+","+t;if(n in Le)return Le[n];let[a,o]=e,[i,r]=t;const l=a*Math.PI/180,s=i*Math.PI/180,d=(i-a)*Math.PI/180,c=(r-o)*Math.PI/180,u=Math.sin(d/2)*Math.sin(d/2)+Math.cos(l)*Math.cos(s)*Math.sin(c/2)*Math.sin(c/2);let m=6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)));return Le[n]=m,m}async function Ae(e,t){let n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`);if(n.ok)return(await n.json()).display_name}function Te(e){return(e=e.trim()).split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}function Ie(e){return e.replaceAll(" ",".")+a}function ke(e){try{return e.split("@")[0].replaceAll("."," ")}catch(e){}}function xe(e){return e?.target&&(e=e.target.value),e.search(/(^(?!(__)))(?!.*(\.\.))(^([a-zA-Z0-9-_.]+)$)/)>=0}function Be(e,t){let n=e.value.search(/(^(?!(__)))(^([a-zA-Z0-9-_]+)$)/)>=0;return n||(e.value=e.value.replace(/[^A-Za-z0-9-_]+/g,"").replace(/^_+/,"_"),t&&Sa(t+" can only contain letters, numbers, dashes, and underscores.\nCannot start with two underscores.")),n}async function Re(){delete window.loadPath,await auth.signOut(),location.reload()}async function $e(e){if(e){if(ne("signin"),ae(Ue),ae("user"),(ye=await db.getDoc(s,e.email))?.error)return void je("dbError");if(null===ye){ye={};let t=await db.insertOne(s,e.email,ye);if(t.error)return void wa("Could not add user to database.\n\n"+t.error.code)}let t;ye.n&&ye.f||We("profile","Please enter your last name and your preferred name and save."),e.email.startsWith("_test_")||!auth.currentUser.emailVerified?(localStorage.verificationEmailSent?Z("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent:await Ne(),ae("emailVerificationLink"),We("profile","Please verify your email address before proceeding.")):(delete localStorage.verificationEmailSent,ne("emailVerificationLink")),ye.e||(ye.e={}),localStorage.semesterSelected&&!ye.e[localStorage.semesterSelected]&&(ye.e[localStorage.semesterSelected]={}),Z("#userDisplayName").innerText=e.email,sa.value=sa.lastValue=ye.n||"",da.value=da.lastValue=ye.f||"",2&ye.rl&&(ae("allSectionsBtn"),ae("manageUsersBtn")),(1&ye.rl||2&ye.rl)&&ae("roomsBtn"),localStorage.markAttendanceSectionId&&ct(),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&await Nt();let n=Z("#semesterSelect");if(1==n.children.length){let e=await Xe();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),ra(a))}}else if(ye=null,delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,ae("signin"),ne(Ue),ne("user"),Z("#signInSendEmailInput").value=Z("#signInEmailInput").value=localStorage.email||"",isSignInWithEmailLink(auth,window.loadPath||"")){delete localStorage.signInLinkSent;let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-action-code"===e?.error?wa("This sign-in link has expired.\nPlease enter your username and click the [Send sign-in link] button to receive a new link."):"auth/invalid-email"===e?.error?(localStorage.email="",Fe("signinConfirmEmail")):e?.error&&wa("Could not sign in.\n\n"+e.error)}else localStorage.email&&localStorage.signInLinkSent&&Me()}async function Ne(){try{await sendEmailVerification(window.auth.currentUser),localStorage.verificationEmailSent=de().join(" at "),Z("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent,Sa("Email verification link was sent to "+auth.currentUser.email)}catch(e){"auth/too-many-requests"===e.code?wa("Cannot send another email yet.\nPlease wait a few minutes before retrying."):wa("Could not send email.\n"+e.code)}}function Me(){Z("#signinLinkSent > div:first-child").innerHTML=`We sent an email with a sign-in link to ${localStorage.email}${a} on ${localStorage.signInLinkSent}.<p>The email subject should be "Sign in to LectureSeats".<p>Please go to your email and click on the sign-in link.`,Fe("signinLinkSent")}function Pe(e,t){switch(e.code){case"auth/email-already-in-use":wa(`Email address ${Z("#signInEmailInput").value}${a} already in use.`);break;case"auth/invalid-email":wa(`Email address ${Z("#signInEmailInput").value}${a} is invalid.`);break;case"auth/operation-not-allowed":wa("Error during sign up.");break;case"auth/user-not-found":wa(`User ${Z("#signInEmailInput").value}${a} not found.`+(t?"":"\nDid you mean to click the Register button?"));break;case"auth/wrong-password":wa("Wrong password.");break;case"auth/missing-password":wa("No password provided.");break;case"auth/weak-password":wa("Password is not strong enough. Add additional characters including special characters and numbers.");break;default:wa("Unable to perform action.\n"+e.message);break}}window.addEventListener("load",(async function(){if(navigator.userAgent.includes("Firefox"))return ne("signin"),ae(Ue),void(Ue.innerHTML="Sorry, this app does not work on Firefox.<p>Please use Chrome or Safari for best experience.");let e;setInterval((()=>{e&&navigator.onLine?(De(),je("sections"),e=!1):e||this.navigator.onLine||(We("offlineError"),e=!0)}),500),setTimeout((()=>location.reload()),864e5),document.title=t,document.querySelectorAll(".domainName").forEach((e=>e.innerText=a)),Z("#versionInfo").innerText=`LectureSeats ${n}\n\nApplication last updated on: 2024-02-11.\n`,window.loadPath=window.location.href;let o=new URLSearchParams(location.search);if(window.history.pushState(null,t,location.origin+this.location.pathname),o.has("s")){let[e,t]=Q(o.get("s"));localStorage.semesterSelected=e,localStorage.markAttendanceSectionId=t}o.has("c")&&(localStorage.markAttendanceCode=o.get("c")),onAuth($e,(e=>wa("Authentication error.\n\n"+e)))}));const Ue=Z("#main");var Oe,_e=!0;function De(){_e=!0,Oe=null}function He(e){_e=!1,Oe=e}function Fe(e){te(Z("#signin"),Z("#"+e))}function je(e){_e?window.location.hash=e:Oe&&Sa(Oe)}function We(e,t){te(Ue,Z("#"+e)),He(t)}function qe(){_e&&history.back()}function Ve(e){e?(ae("loading"),He()):(ne("loading"),De())}window.onhashchange=function(e){_e?(te(Ue,Z(location.hash||"#sections")),Ue.scrollTop=0):"#_"!==location.hash&&(location.hash="#_")},window.addEventListener("keydown",(e=>{"Escape"===e.key&&qe()})),window.addEventListener("popstate",(e=>{ne("helpScreen")}));var Je={},Ye={},Qe={},ze={},Ze={};async function Xe(){return["2023Fall","2024Winter","2024Spring","2024Summer","2024Fall"]}async function Ke(e){if(e&&!Je[e])if(Je[e]=await db.getDoc(c,e),null===Je[e])Je[e]={};else if(Je[e].error)return void wa("Something went wrong.\n\nTry to reload.");return Je[e]}async function Ge(e,t){let n=await Ke(e);if(n[t])return n[t].id=t,n[t]}async function et(e){return!e&&Ye._gotAllRooms||((Ye=await db.find(u))._gotAllRooms=!0),Ye}async function tt(e){return le((await async function(e){return e in Ye||(Ye[e]=await db.getDoc(u,e)),Ye[e]}(e)).rm.toUpperCase())}async function nt(e,t,n){ee(t)||(t=[t]);var a=[];for(var o of(a._docs=[],a._sectionIds=[],t)){let t=Y(e,o);if(n||!Qe[t])if(Qe[t]=await db.getDoc(d,t),null===Qe[t])Qe[t]={};else{if(Qe[t].error)return void wa("Something went wrong.\n\nPlease try again.");for(let e in Qe[t])e.length>1&&(Qe[t][e].Email=Ie(e),Qe[t][e].Username=e,Qe[t][e].Section=o,Object.entries(Qe[t][e].a).forEach((([e,t])=>{let n=de(t.d);t.date=n[0],t.time=n[1],t.code=e})))}a.push(...Object.entries(Qe[t]).filter((([e,t])=>e.length>1)).map((([e,t])=>t))),a._docs.push(Qe[t])}return a._sectionIds=t,a}async function at(e,t){if(!e)return{};if(ee(e))return Object.assign(...await Promise.all(e.map((e=>at(e,t)))));e=t?t===v||t===w?Te(e):e:e.toLowerCase();let n=t?t+":"+e:e,a=Ze[n];return a?Object.fromEntries(a.map((e=>[e,ze[e]]))):t&&t!==v&&t!==w||(a=Object.entries(Ze).filter((e=>n.startsWith(e[0]))).map((e=>e[1]))[0],!a)?(a=t?t===v||t===w?await db.find(s,db.orderBy(t),...db.startsWith(t,e)):await db.find(s,db.orderBy(t),db.where(t,"==",e)):await db.find(s,db.orderBy(db.documentId()),...db.startsWith(db.documentId(),e)),a.error||(Object.assign(ze,a),Ze[n]=Object.keys(a)),a):(a=a.map((e=>[e,ze[e]])),Object.fromEntries(a.filter((n=>t?n[1][t].startsWith(e):n[0].startsWith(e)))))}async function ot(e){let t={},n=[];for(let a of e)a in ze?t[a]=ze[a]:n.push(a);if(!n.length)return t;for(let e=0;e<n.length;e+=30){let a=await db.find(s,db.where(db.documentId(),"in",n.slice(e,e+30)));if(a.error)return a;Object.assign(t,a),Object.assign(ze,a)}return t}async function it(e){let t=ze[e];if(t)return t;let n=await db.getDoc(s,e);return n?.error||n&&(ze[e]=n),n}function rt(e,t="",n=""){if(!e.n&&!e.f)return"";let a;return a=e.n&&e.f?e.n.split(" ").includes(e.f)?e.n:e.f+", "+e.n:e.n||e.f,t+a+n}const lt=Z("#markAttendanceSectionId"),st=Z("#markAttendanceClassCodeInput"),dt=Z("#markAttendanceLocation");async function ct(e,t){if(je("markAttendance"),!e){if(e=localStorage.markAttendanceSectionId,delete localStorage.markAttendanceSectionId,(t=await Ge(localStorage.semesterSelected,e)).x?.length){let n=[e].concat(t.x),a=n.filter((e=>e in ye.e[localStorage.semesterSelected]));if(a.length)e=a[0];else{e=(await fa("Please choose which section you are enrolled in.",{},n)).clicked}}ye.e[localStorage.semesterSelected][e]||(ye.e[localStorage.semesterSelected][e]={})}lt.innerText=e,lt._sectionDoc=t,Z("#markAttendanceRemoveButtonSectionId").innerText=e,st.value=localStorage.markAttendanceCode||"",delete localStorage.markAttendanceCode,t.s<0?ne("markAttendanceSeatContainer"):(ae("markAttendanceSeatContainer"),t.s>0?Z('label[for="markAttendanceSeatCodeInput"]').classList.add("required"):Z('label[for="markAttendanceSeatCodeInput"]').classList.remove("required"),Z("#markAttendanceSeatCodeInput").value=""),lt._sectionDoc.p<0?ne("markAttendancePhotoContainer"):(ae("markAttendancePhotoContainer"),lt._sectionDoc.p>0?Z('label[for="selfieCanvas"]').classList.add("required"):Z('label[for="selfieCanvas"]').classList.remove("required"),ae("defaultSelfieImg"),ae("addPhotoBtn"),ne(At),ne(Tt),ne("snapPhotoBtn"),ne("switchPhotoBtn")),lt._sectionDoc.l<0?ne("markAttendanceLocationContainer"):(ae("markAttendanceLocationContainer"),lt._sectionDoc.l>0?Z('label[for="markAttendanceLocation"]').classList.add("required"):Z('label[for="markAttendanceLocation"]').classList.remove("required")),mt(localStorage.semesterSelected,e),ut()}async function ut(){const e=Z("#markAttendanceRequirementsList");e.innerHTML="";let t=!1;if(st.value||(e.appendChild(document.createElement("li")).innerText="Attendance passcode",t=!0),lt._sectionDoc.l>-1&&!dt.value){let n=await async function(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}();n.error?(ne(dt),lt._sectionDoc.l>0?(ae("markAttendanceLocationOffButRequired"),ne("markAttendanceLocationOff"),e.appendChild(document.createElement("li")).innerText="Location",lt._sectionDoc.l>1&&(t=!0)):(ne("markAttendanceLocationOffButRequired"),ae("markAttendanceLocationOff"))):(dt.value=n,ae(dt),ne("markAttendanceLocationOffButRequired"),ne("markAttendanceLocationOff"))}if(lt._sectionDoc.s>0&&!await async function(e,t){return!t||((e=z(e))?(await tt(t)).flat().indexOf(e)>=0:void 0)}(Z("#markAttendanceSeatCodeInput").value,lt._sectionDoc.r)&&(e.appendChild(document.createElement("li")).innerText="Valid seat code",lt._sectionDoc.s>1&&(t=!0)),lt._sectionDoc.p>-1){let n=yt?.size&&Et&&(new Date).getTime()-Et<6e5;lt._sectionDoc.p>0&&!n&&(ae("defaultSelfieImg"),ne(At),ne(Tt),yt=Et=null,e.appendChild(document.createElement("li")).innerText="New photo",lt._sectionDoc.p>1&&(t=!0))}e.innerHTML?ae("markAttendanceRequirements"):ne("markAttendanceRequirements"),t?Z("#markAttendanceButton").setAttribute("disabled",!0):Z("#markAttendanceButton").removeAttribute("disabled")}function mt(e,t){const n=Z("#attendanceMarked");let a=Object.values(ye.e[e][t]).sort(((e,t)=>e.d-t.d));if(a?.length){n.innerHTML="";let e=n.appendChild(document.createElement("summary")),t=n.appendChild(document.createElement("small")),o=0,i=0,r=0;for(let e of a){let n=de(e.d),a=t.appendChild(document.createElement("div")),l=n[0]+" ";1===e.u?(l+="absent",a.setAttribute("absent",!0),i++):2===e.u?(l+="absence excused",a.setAttribute("excused",!0),r++):-1===e.u?(l+=n[1]+" failed to mark attendance",a.setAttribute("absent",!0)):(l+=n[1],o++),e.nt&&(l+=" <small>("+e.nt+")</small>"),a.innerHTML=l}e.innerHTML=`${o} attendance(s) marked; ${i} unexcused absence(s); ${r} excused absence(s)`,Ue.scrollTop=0}else n.innerHTML=""}function ft(e,t,n,a){return[e,t,n,a+".jpg"].join("/")}function pt(e,t,n){return[e,t,n].join("/")}const ht=new ZXing.BrowserMultiFormatReader;var gt,St;async function vt(e){je("QRreader"),gt=await getVideoStream(!1),St=e,Ct(),window.addEventListener("popstate",wt,{once:!0})}function wt(){ht.reset(),window.removeEventListener("popstate",wt)}function bt(e,t){if(e){let t;if(wt(),qe(),e.text?.startsWith("http")&&(t=new URLSearchParams(e.text.split("?")[1])),St)t?.has("c")&&(e.text=t.get("c")),document.getElementById(St).value=e.text,ut();else if(t?.has("s")){let[e,n]=Q(t.get("s"));localStorage.semesterSelected!==e&&(localStorage.semesterSelected=e,ra(e)),localStorage.markAttendanceSectionId=n,localStorage.markAttendanceCode=t.get("c"),setTimeout(ct,50)}}!t||t instanceof ZXing.NotFoundException||wa("Could not complete QR scan.\n"+t)}async function Ct(){ht.decodeFromStream(gt,"QRreaderVideo",bt)}var yt=null,Lt=null,Et=null;const At=Z("#selfieCanvas"),Tt=Z("#selfieVideo");async function It(){try{await startCamera(Tt,l),window.addEventListener("popstate",stopCamera,{once:!0}),ne("defaultSelfieImg"),ne(At),ne("addPhotoBtn"),ae(Tt),ae("snapPhotoBtn"),ae("switchPhotoBtn")}catch(e){selfiePhotoBtn.innerHTML='<span class="material-symbols-outlined">photo_camera</span> Retry taking selfie...',wa("Unable to start camera.\nPlease make sure your camera permissions are enabled, reload, and try again.")}}async function kt(){ne(Tt),ne("snapPhotoBtn"),ne("switchPhotoBtn"),ae(At),ae("addPhotoBtn"),takePhoto(Tt,At,l),yt=await canvasToBlob(At),Et=(new Date).getTime(),ut()}const xt=Z("#getAttendanceSectionId"),Bt=Z("#getAttendanceClassCodeInput"),Rt=Z("#collectAttendanceBtn"),$t=Z("#minutesToCollectAttendance");async function Nt(e,t){if(je("getAttendance"),!e){let n=Q(localStorage.takingAttendance);localStorage.semesterSelected=n[0],e=n[1],t=await Ge(localStorage.semesterSelected,e)}if(xt.innerText=e,xt._sectionDoc=t,Z("#getAttendanceCrossListIds").innerHTML=t.x?"<span>"+t.x.join("</span> <span>")+"</span>":"",Z("#attendanceRoomSectionId").innerHTML=Z("#attendanceTableSectionId").innerHTML=`<div><span>${xt.innerText} ${Z("#getAttendanceCrossListIds").innerText}</span></div>`,Z("#getAttendanceSectionInfo").innerText=t.pt+"\n"+(t.r||Rn)+"\n"+(t.in||t.i.join("\n")),Z("#getAttendanceEditBtn").setAttribute("onclick",""),Z("#getAttendanceEditBtn").onclick=n=>{$n(e,t)},ne("currentAttendanceStatus"),await Vt(),Ht.length&&(Jt(),t.r&&Ht.attendanceCodesAndTimes.length?ae("getAttendanceShowRoomBtn"):ne("getAttendanceShowRoomBtn")),Ht._docs[0].c&&Ht._docs[0].d.seconds+60*Ht._docs[0].m>db.now())localStorage.takingAttendance=Y(localStorage.semesterSelected,e),Bt.value=Ht._docs[0].c,localStorage.minutesToCollectAttendance=Ht._docs[0].m,localStorage.attendanceEndtime=Ht._docs[0].d.seconds+60*Ht._docs[0].m,Ft(),ae("getAttendanceControls"),qt();else{localStorage.takingAttendance===Y(localStorage.semesterSelected,e)?(delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,ae("getAttendanceControls")):localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&ne("getAttendanceControls");let t=Ht.attendanceCodesAndTimes[Ht.attendanceCodesAndTimes.length-1];t&&t[1].split(" ")[0]===de()[0]?(Bt.value=t[0],qt(!1)):Mt()}$t.innerText=localStorage.minutesToCollectAttendance||75}function Mt(){Bt.value=J[re(26)]+Math.random().toString().substring(2,6)}$t.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t)}else"ArrowUp"===e.key?e.target.innerText=(parseInt(e.target.innerText)||0)+1:isNaN(parseInt(e.key))&&!["Backspace","Delete","ArrowLeft","ArrowRight"].includes(e.key)&&e.preventDefault()}));const Pt=new ZXing.BrowserQRCodeSvgWriter;function Ut(e=null){const t=Z("#QRcodeContainer");let n=location.protocol+"//"+location.host+location.pathname+"?c="+Bt.value+"&s="+Y(localStorage.semesterSelected,xt.innerText);if(n!==t.url){t.url=n,Z("#QRcode").innerHTML="",Pt.writeToDom("#QRcode",n,300,300);let e=Z("#QRcode > svg");e.removeAttribute("width"),e.removeAttribute("height"),e.setAttribute("viewBox","0 0 300 300"),fe=t,pe=(e,t)=>localStorage.qrPos=[e,t],e.addEventListener("mousedown",Se,!1),_t.observe(t),localStorage.qrPos&&([t.style.left,t.style.top]=localStorage.qrPos.split(",")),localStorage.qrSize&&([t.style.width,t.style.height]=localStorage.qrSize.split(","))}null===e?oe("QRcodeContainer"):e?ae("QRcodeContainer"):ne("QRcodeContainer")}let Ot;const _t=new ResizeObserver((e=>{let t=e[0].contentRect;t.width,t.height&&(clearTimeout(Ot),Ot=setTimeout((()=>localStorage.qrSize=[t.width,t.height]),1e3))}));var Dt,Ht;function Ft(){Rt.innerText="Stop",Bt.setAttribute("disabled",!0),Z("#collectingAttendance").innerText="Collecting",ae("createQRCodeBtn"),ae("createURLBtn"),Ut(!0),ne("randomAttendanceClassCodeBtn"),ae("attendanceCollectionStatus"),Z("#attendanceCollectionStatus>div").innerText=xt.innerText+" "+Z("#getAttendanceCrossListIds").innerText.trim(),$t.removeAttribute("contenteditable"),qt(!1),clearInterval(Dt),Dt=setInterval(jt,1e3)}function jt(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)Wt(!1);else{let t=Math.floor(e/60),n=e-60*t;$t.innerText=t+":"+se(n),Z("#attendanceCollectionStatus>span").innerText=$t.innerText}}async function Wt(e=!0,t=!0){if(e){let e=xt.innerText,t=xt._sectionDoc,n=[],a=db.updateOne(d,Y(localStorage.semesterSelected,e),{[f]:db.deleteField()});if(a.error&&n.push(e),t.x?.length)for(let e of t.x)a=db.updateOne(d,Y(localStorage.semesterSelected,e),{[f]:db.deleteField()}),a.error&&n.push(e);if(n.length)return void wa("Error updating database for the following sections:\n"+n)}clearInterval(Dt),Dt=void 0,Rt.innerText="Start",Bt.removeAttribute("disabled"),Z("#collectingAttendance").innerText="Collect",ne("QRcodeContainer"),ne("createQRCodeBtn"),ne("createURLBtn"),ae("randomAttendanceClassCodeBtn"),ne("attendanceCollectionStatus"),$t.setAttribute("contenteditable","true"),$t.innerText=localStorage.minutesToCollectAttendance||"75",Ht._docs.forEach((e=>delete e.c)),delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,t&&qt(!0)}async function qt(e=!0){ae("currentAttendanceStatus"),e&&(await Vt(!0),void 0!==Dt&&(!Ht._docs[0].c||!(Ht._docs[0].d.seconds+60*Ht._docs[0].m)>db.now())&&Wt(!1,!1)),Z("#currentAttendanceStatus > span").innerHTML=`Today's attendance for passcode ${Bt.value}:\n${Ht.filter((e=>e.a[Bt.value]&&!e.a[Bt.value].u)).length} of ${Ht.length} marked present\n<small>(last checked ${(new Date).toLocaleTimeString()}</small>)`}async function Vt(e){let t=xt.innerText,n=xt._sectionDoc,a=[t].concat(n.x||[]);(Ht=await nt(localStorage.semesterSelected,a,e)).length?(ae("showStudentsOptions"),ne("showStudentsAddBtn"),Ht.filter((e=>e.p)).length?ae("learnNamesBtn"):ne("learnNamesBtn")):(ae("showStudentsAddBtn"),ne("showStudentsOptions"))}function Jt(){if(!Ht.attendanceCodesAndTimes){var e={};Ht.map((e=>Object.values(e.a))).flat().forEach((t=>{let n=e[t.code],a=t.date+" "+t.time;(!n||n>a)&&(e[t.code]=a)})),Ht.attendanceCodesAndTimes=Object.entries(e).sort(((e,t)=>e[1]>t[1]?1:-1))}}async function Yt(){let e=xt.innerText,t=xt._sectionDoc;if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await fa("Please select a section for adding a student",{},n)).clicked,!e)return}Gn((t=>{qe(),setTimeout(Zt,100,t,e)}),`Add students to section\n${e}`)}async function Qt(e,t,n){const a=t.Section,o=t.Email;let i=await it(o);if(await fa(`Are you sure you would like to move ${o}${rt(i," (",")")} from section ${a} to section ${n}?`)){const r=localStorage.semesterSelected;if(!(await nt(r,n))._docs[0].i){let e=await db.insertOne(d,Y(r,n),{[$]:xt._sectionDoc.i});if(e.error)return void wa(`Could not create attendance record for section ${n}.\n${e.error}`)}let l=[],c={[v]:i.n,[w]:i.f,[m]:t.a};if(t.p){Ve(1);let o=await moveFiles(pt(e,r,a),pt(e,r,n));if(Ve(0),o.error)return void wa("Attendance record was not moved to new section:\n\nCould not move student photos to new section.\n"+o.error);let i=t.p.split("/");i[2]=n,c.p=i.join("/")}l.push({collection:d,id:Y(r,n),data:{[e]:c}}),l.push({collection:d,id:Y(r,a),data:{[e]:db.deleteField()}}),l.push({collection:s,id:o,data:{["e."+r+"."+n]:i.e[r][a]||{},["e."+r+"."+a]:db.deleteField()}});let u=await db.updateBatch(...l);if(u?.error){let o;return t.p&&(Ve(1),o=await moveFiles(pt(e,r,n),pt(e,r,a)),Ve(0)),void wa(o?.error?"Student photos were moved to new section, but the rest of attendance data could not be moved.\n"+u.error+"\n\nCould not move photos back to original section.\n"+o.error:"Attendance record could not be moved to new section.\n"+u.error)}!i.e[r][n]&&i.e[r][a]&&(i.e[r][n]=i.e[r][a],delete i.e[r][a]),Qe[Y(r,n)][e]=t,t.Section=n,delete Qe[Y(r,a)][e],Sa(`Student ${o}${rt(i," (",")")} was successfully moved from section ${a} to section ${n}.`,"",1)}}async function zt(e,t){const n=ke(e);let a=await it(e);if(!a)return void wa(`Student with the email ${e} was not found.`);let o=Ht.filter((e=>e.Username===n))[0];if(o)o.Section===t?wa(`Student with the email ${e} is already in section ${t}.`):(await Qt(n,o,t),nn());else{if(await fa(`Are you sure you would like to add ${e}${rt(a," (",")")} to section ${t}?`)){const o=localStorage.semesterSelected;if(!(await nt(o,t))._docs[0].i){let e=await db.insertOne(d,Y(o,t),{[$]:xt._sectionDoc.i});if(e.error)return void wa(`Could not create attendance record for section ${t}.\n${e.error}`)}a.e||(a.e={}),a.e[o]||(a.e[o]={});let i={["e."+o+"."+t]:{}},r=[];for(let e of Ht._sectionIds.filter((e=>e!==t)))e in a.e[o]&&(i["e."+o+"."+e]=db.deleteField(),r.push(e));let l=await db.updateBatch({collection:s,id:e,data:i},{collection:d,id:Y(o,t),data:{[n]:{[v]:a.n,[w]:a.f,[m]:{}}}});if(l.error)return void wa("Could not add student to section.\n"+l.error);a.e[o][t]={};for(let e of r)delete a.e[o][e];Ht.push(Qe[Y(o,t)][n]={[v]:a.n,[w]:a.f,[m]:{},[U]:n,[P]:e,[M]:t}),Sa(`Student ${e}${rt(a," (",")")} was successfully added to section ${t}.`,"",1)}nn()}}async function Zt(e,t){if(!e.length)return;let n,a,o=[],i=[],r=[];for(let l of e)a=ke(l[0]),n=Ht.filter((e=>e.Username===a))[0],n?n.Section===t?i.push(l):(n.f||(n.f=l[1]),n.n||(n.n=l[2]),r.push(n)):o.push(l);if(r.length){var l=await ot(r.map((e=>e.Email)));if(l.error)return void wa("Something went wrong.\n"+l.error)}if(o.length){var c=function(e){let t={},n=Object.assign({},...Object.values(Qe));for(let a of e){let e=ke(a);e in n&&(t[a]={[w]:n[e].f,[v]:n[e].n})}return t}(o);let t=e.filter((e=>!(e[0]in c)));if(t.length){let e=await ot(t.map((e=>e[0])));if(e.error)return void wa("Something went wrong.\n"+e.error);Object.assign(c,e)}}let u="";if(r.length||o.length){if(i.length&&(u+=`<details><summary>${i.length} students are already in ${t} and will not be added</summary><small>${i.map((e=>e[0])).join(", ")}</small></details>\n`),r.length&&(u+=`<details><summary>${r.length} students are enrolled in this course under a different section id, and will be moved to ${t}</summary><small>${r.map((e=>e.Email)).join(", ")}</small></details>\n`),o.length&&(u+=`<details><summary>${o.length} students will be added to ${t}</summary><small>${o.map((e=>e[0])).join(", ")}</small></details>\n`),await fa(u+"Are you sure you would like to proceed with this action?")){const e=localStorage.semesterSelected;let n={},a={},i={},u=Ht._sectionIds.filter((e=>e!==t));if(!(await nt(e,t))._docs[0].i){let n=await db.insertOne(d,Y(e,t),{[$]:xt._sectionDoc.i});if(n.error)return void wa(`Could not create attendance record for section ${t}.\n${n.error}`)}for(let o of r){let r=o.Section;i[r]||(i[r]={});let s={[w]:o.f,[v]:o.n,[m]:o.a};if(o.p){let e=o.p.split("/");e[2]=t,s.p=e.join("/")}a[o.Username]=s,i[r][o.Username]=db.deleteField();let d=o.Email;n[d]={[S]:{[e]:{[t]:l[d].e[e][r],[r]:db.deleteField()}}}}for(let i of o){let o=i[0],r=ke(i[0]);if(o in c){a[r]={[w]:c[o].f||i[1],[v]:c[o].n||i[2],[m]:{}},n[o]={[S]:{[e]:{[t]:{}}}},c[o].f||(n[o].f=i[1]),c[o].n||(n[o].n=i[2]);for(let t of u)n[o].e[e][t]=db.deleteField()}else a[r]={[w]:i[1],[v]:i[2],[m]:{}},n[o]={[w]:i[1],[v]:i[2],[S]:{[e]:{[t]:{}}}}}let f=[{collection:d,id:Y(e,t),data:a}];for(let t in i)f.push({collection:d,id:Y(e,t),data:i[t]});for(let e in n)f.push({collection:s,id:e,data:n[e]});Ve(1);let p=await db.upsertBatch(...f);if(p.error)return Ve(0),void wa(`Failed to add students to section ${t}.\n${p.error}`);for(let a in n){ze[a]||(ze[a]={}),ze[a].e||(ze[a].e={}),ze[a].e[e]||(ze[a].e[e]={}),ze[a].e[e][t]=n[a].e[e][t];for(let t of u)ze[a].e[e][t]&&delete ze[a].e[e][t]}Je[Y(e,t)]||(Je[Y(e,t)]={});for(let n in a)Je[Y(e,t)][n]||(Je[Y(e,t)][n]={}),Object.assign(Je[Y(e,t)][n],a[n]);for(let t in i)if(Je[Y(e,t)])for(let n in i[t])Je[Y(e,t)][n]&&delete Je[Y(e,t)][n];let h=[];for(let n of r){(await moveFiles(pt(n.Username,e,n.Section),pt(n.Username,e,t))).error&&h.push(n.Email)}Ve(0),nn(!0),h.length?va(`${r.length+o.length} students added to section ${t}.\n\nEncountered an issue moving photos from old section to new for <details><summary>${h.length} students</summary>${h}</details>.\n`):Sa(`${r.length+o.length} students successfully added to section ${t}`,"Success",1)}}else va(`No students were added because all of the selected students are already in section ${t}.`);Z("#addUsersEmails").value="",Z("#addUsersNames").value="",Z("#addUsersList").innerHTML=""}const Xt=Z("#attendances");var Kt;async function Gt(){await nn(),je("attendanceTableScreen"),Kt?.hiddenCols?.length<2&&Z("#attendancesHolder").getBoundingClientRect().width<400&&setTimeout(mn,100),Z("#classLocation").innerText=await Ae(...await en(xt.innerText))}async function en(e){let t=localStorage.getItem("loc_"+e);return t?t=JSON.parse(t):(t=o,tn(e,t)),t}function tn(e,t){localStorage.setItem("loc_"+e,JSON.stringify(t))}async function nn(e=!1){e&&await Vt(!0),Jt();var t=parseInt(Z("#minLateInput").value);!t||t<1?Z("#minLateInput").value=t=parseInt(localStorage.minutesConsideredLate)||20:localStorage.minutesConsideredLate=t;var n=parseInt(Z("#pointsLateInput").value);let a,o;!n||n<0||n>100?Z("#pointsLateInput").value=n=parseInt(localStorage.pointsForLate)||50:localStorage.pointsForLate=n;for(let e of Ht){e.attendAndAbsentArray=[],e.attendTimeOffsets=[],e[H]=0,e.Absent=0,e.Late=0,e.Name=e.n||"",e[_]=e.f||"";for(let[n,i]of Ht.attendanceCodesAndTimes){if(a=e.a[n],a)e.attendAndAbsentArray.push(a);else{a={[p]:1,code:n},e.a[n]=a,e.attendAndAbsentArray.push(a);let t={[p]:1,[h]:db.makeTimestamp(i)};db.updateOne(d,Y(localStorage.semesterSelected,e.Section),{[e.Username+"."+"a."+n]:t}),db.updateOne(s,e.Email,{["e."+localStorage.semesterSelected+"."+e.Section+"."+n]:t}),e.Email in ze&&(ze[e.Email].e||(ze[e.Email].e={}),ze[e.Email].e[localStorage.semesterSelected]||(ze[e.Email].e[localStorage.semesterSelected]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section]||(ze[e.Email].e[localStorage.semesterSelected][e.Section]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section][n]=t)}1===a.u?(e.Absent++,e.attendTimeOffsets.push("absent")):2===a.u?e.attendTimeOffsets.push("excused"):(o=Math.floor((a.d-db.makeTimestamp(i))/60),o>=t?e.Late++:e[H]++,e.attendTimeOffsets.push(o))}e[D]=(100*e[H]+e.Late*n)/(e[H]+e.Late+e.Absent)}(Kt=[]).semester=localStorage.semesterSelected,Kt.id=Kt.semester+"_"+Ht._sectionIds.join("_"),Kt.attendanceCodes=Ht.attendanceCodesAndTimes.map((e=>e[0])),Kt.attendanceTimes=Ht.attendanceCodesAndTimes.map((e=>e[1])),Kt.header=W.concat(Kt.attendanceTimes);for(let e of Ht){let t=[];for(let n of W)t.push(e[n]);t=t.concat(e.attendTimeOffsets),t._fullRecord=e,Kt.push(t)}Kt.sortStack=JSON.parse(localStorage.getItem("sortStack_"+Kt.id)||"[]"),Kt.sortDesc=JSON.parse(localStorage.getItem("sortDesc_"+Kt.id)||"[]"),Kt.hiddenCols=JSON.parse(localStorage.getItem("hiddenCols_"+Kt.id)||"[true]"),sn()}function an(e,t,n,a){return async function(o){o.preventDefault();let i=["View attendance...","Edit attendance...",""];1===t.u?i.push("Mark present","Mark late","_Mark absent","Mark excused"):2===t.u?i.push("Mark present","Mark late","Mark absent","_Mark excused"):a>parseInt(Z("#minLateInput").value)?i.push("Mark present","_Mark late","Mark absent","Mark excused"):i.push("_Mark present","Mark late","Mark absent","Mark excused");let r,l=await ma(o.clientX,o.clientY,i);if("View attendance..."===l?on(e,t,n,a)():"Edit attendance..."===l?rn(e,t,n,a):"Mark present"===l?(r=0,a=0):"Mark late"===l?(r=0,a=2*parseInt(Z("#minLateInput").value)):"Mark absent"===l?(r=1,a=0):"Mark excused"===l&&(r=2,a=0),void 0!==r){let o=Y(localStorage.semesterSelected,e.Section),i=e.Username+"."+"a."+t.code+".",l={[i+h]:db.makeTimestamp(n,a),[i+p]:r},c=[{collection:d,id:o,data:l}],u="e."+localStorage.semesterSelected+"."+e.Section+"."+t.code+".",m={[u+E]:`updated by ${auth.currentUser.email} on ${de()[0]}`};i+p in l&&(m[u+p]=l[i+p]),i+h in l&&(m[u+h]=l[i+h]),c.push({collection:s,id:e.Email,data:m});let f=await db.updateBatch(...c);if(f.error)wa("Unable to update attendance record.\n"+f.error);else{if(t.u=l[i+p],t.d=l[i+h],e.Email in ze){ze[e.Email].e||(ze[e.Email].e={}),ze[e.Email].e[localStorage.semesterSelected]||(ze[e.Email].e[localStorage.semesterSelected]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section]||(ze[e.Email].e[localStorage.semesterSelected][e.Section]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code]||(ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code]={});let n=ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code];n.d=m[u+p],n.d=m[u+h],n.nt=m[u+E]}Sa("Record updated.","",1),nn()}}}}function on(e,t,n,a){return async function(){let o=n.split(" ").join(" at "),i=`Record for ${rt(e)} (${e.Username}) for attendance taken on ${o}:\n\n`;2===t.u?i+="Attendance excused.":1===t.u?i+="Absent.":i+=`Attendance marked ${a?"after "+a+"min":"right away"}.\n\nSeat: ${t.s||"missing"}`,(t.p||t.l)&&(i+="\n\n",t.p&&(i+=`<img src="${await getLinkFromStoragePath(ft(e.Username,localStorage.semesterSelected,e.Section,t.code))}" onerror="this.src='user-icon.png';" width="125">`),t.l&&(i+='<div id="locmap"></div>',setTimeout((()=>{Ce(Z("#locmap"),...t.l)}),150))),t.nt&&(i+="\n\nNotes:\n"+t.nt),"Edit attendance record"===(await fa(i+"\n\n",{},["OK","Edit attendance record"])).clicked&&rn(e,t,n,a)}}async function rn(e,t,n,a){let o=Y(localStorage.semesterSelected,e.Section),i=e.Username+"."+"a."+t.code+".",r=n.split(" ").join(" at "),l={Present:{type:"radio",name:"status"},Absent:{type:"radio",name:"status"},Excused:{type:"radio",name:"status"},"Minutes late":{type:"number",value:t.u?"":a},Seat:t.s||"",Notes:t.nt||""};1===t.u?l.Absent.checked=!0:2===t.u?l.Excused.checked=!0:l.Present.checked=!0;let c=await fa(`Record for ${rt(e)} (${e.Username}) for attendance taken on ${r}:\n\n`,l,["Save","Cancel"]);if("Save"===c?.clicked){let r={};if(c.Present){let e=parseInt(c["Minutes late"])||0;(t.u||e!==a)&&(r[i+h]=db.makeTimestamp(n,e))}else{let e=db.makeTimestamp(n);t.d?.seconds!=e.seconds&&(r[i+h]=e)}if(c.Present&&t.u?r[i+p]=0:c.Absent&&1!==t.u?r[i+p]=1:c.Excused&&2!==t.u&&(r[i+p]=2),c.Seat!==t.s&&(r[i+C]=c.Seat||""),c.Notes!==t.nt&&(r[i+E]=c.Notes||""),Object.keys(r).length){let n,a,l=[{collection:d,id:o,data:r}];(i+p in r||i+h in r)&&(a="e."+localStorage.semesterSelected+"."+e.Section+"."+t.code+".",n={[a+E]:`updated by ${auth.currentUser.email} on ${de()[0]}`},i+p in r&&(n[a+p]=r[i+p]),i+h in r&&(n[a+h]=r[i+h]),l.push({collection:s,id:e.Email,data:n}));let c=await db.updateBatch(...l);if(c.error)wa("Unable to update attendance record.\n"+c.error);else{if(i+p in r&&(t.u=r[i+p]),i+h in r&&(t.d=r[i+h]),i+C in r&&(t.s=r[i+C]),i+E in r&&(t.nt=r[i+E]),n&&e.Email in ze){ze[e.Email].e||(ze[e.Email].e={}),ze[e.Email].e[localStorage.semesterSelected]||(ze[e.Email].e[localStorage.semesterSelected]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section]||(ze[e.Email].e[localStorage.semesterSelected][e.Section]={}),ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code]||(ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code]={});let o=ze[e.Email].e[localStorage.semesterSelected][e.Section][t.code];a+p in n&&(o.d=n[a+p]),a+h in n&&(o.d=n[a+h]),o.nt=n[a+E]}Sa("Record updated.","",1),nn()}}else Sa("Nothing changed. Record not updated.")}}function ln(e){return async function(){me(null,null,await Promise.all(e.attendAndAbsentArray.filter((e=>e.p)).map((t=>getLinkFromStoragePath(ft(e.Username,localStorage.semesterSelected,e.Section,t.code)))))),window._nextImg=me;let t=`${rt(e)}\n${e.Email}\n${e.Section}\n\n<img id="studentPromptImg" src=user-icon.png onclick="window._nextImg(1,this)" onload="this.onload=null;window._nextImg(0,this)" onerror="this.src='user-icon.png'" width="200">\n\nAbsent: ${e.Absent}\nLate: ${e.Late}\n\n`,n=await fa(t,{},Ht._sectionIds.length>1?["OK","Change student section","Remove student from section"]:["OK","Remove student from section"]);if("Change student section"===n.clicked){let t=Ht._sectionIds.filter((t=>t!==e.Section));t.length>1?n=await fa("Choose which section you would like to move the student to:",{otherSections:t},t.concat(["Cancel"])):n.clicked=t[0],n&&await Qt(e.Username,e,n.clicked),nn()}else if("Remove student from section"===n.clicked&&(n=await fa(`Are you sure you want to remove ${rt(e)} (${e.Username}) from section ${e.Section}?\n\nWARNING: This action will permanently DELETE all of the student's attendance records associated with this section.`,{},["DELETE student from section","Cancel"]),"DELETE student from section"===n.clicked)){const t=Y(localStorage.semesterSelected,e.Section),n=e.Email;let a=await db.updateBatch({collection:d,id:t,data:{[e.Username]:db.deleteField()}},{collection:s,id:n,data:{["e."+localStorage.semesterSelected+"."+e.Section]:db.deleteField()}});if(a.error)return void wa("Could not delete student record.\n\n"+a.error);if(delete Qe[t][e.Username],ze[n])try{delete ze[n].e[localStorage.semesterSelected][e.Section]}catch(e){}(await deleteFiles(pt(e.Username,localStorage.semesterSelected,e.Section))).error?va("Deleted student from section, but could not delete student's uploaded photos."):Sa(`${rt(e)} (${e.Username}) was deleted from section ${e.Section}.`,"",1),await Vt(!1),nn(!1)}}}async function sn(){let e=Z("#attendancesHolder").scrollLeft,t=Z("#attendancesHolder").scrollTop;Xt.innerHTML="";var n=await en(xt.innerText),a=parseInt(localStorage.minutesConsideredLate);!function(e,t,n={}){t?.length&&e.sort(((t,a)=>{let o,i;for(let r of Kt.sortStack){if(o=n[t[r]]||t[r],i=n[a[r]]||a[r],o>i)return e.sortDesc[r]?-1:1;if(i>o)return e.sortDesc[r]?1:-1}}))}(Kt,Kt.sortStack,{excused:9e8,absent:9e9});for(let e of[Kt.header].concat(Kt)){var o=Xt.appendChild(document.createElement("row"));for(let t=0;t<Kt.header.length;t++)if(!Kt.hiddenCols[t]){var i=o.appendChild(document.createElement("div"));if(e===Kt.header)i.innerText=e[t],t>=V&&(i.title=Kt.attendanceCodes[t-V]),i.addEventListener("click",(()=>hn(t))),i.addEventListener("contextmenu",pn),i.classList.add("table-header"),i.setAttribute("title","Click to sort. Right-click to hide/show.");else if(t>=V){i.innerHTML="excused"===e[t]?"➖":"absent"===e[t]?"❌":e[t]<a?"✔️":"+"+e[t]+"min";let o=e._fullRecord.attendAndAbsentArray[t-V];if("excused"!==e[t]&&"absent"!==e[t])if(o.s||i.classList.add("missingSeat"),o.p||i.classList.add("missingPhoto"),o.l){i.classList.add("hasLocation");let e=Ee(o.l,n);i.style.setProperty("--distColor",`rgb(${e/15},${255-e/15},0)`)}else i.classList.add("missingLocation");i.onclick=on(e._fullRecord,o,Kt.header[t],e[t]),i.oncontextmenu=an(e._fullRecord,o,Kt.header[t],e[t]),i.style.textAlign="center"}else i.innerText=e[t],i.onclick=ln(e._fullRecord),isNaN(parseFloat(e[t]))||(i.style.textAlign="center",Number.isInteger(e[t])||(i.innerText=e[t].toFixed(1)))}}Xt.style.setProperty("--colNum",o.children.length),Z("#attendancesHolder").scrollLeft=e,Z("#attendancesHolder").scrollTop=t}async function dn(){localStorage.setItem("hiddenCols_"+Kt.id,JSON.stringify(Kt.hiddenCols)),await sn()}function cn(){if(Kt.showingAttendanceCol){delete Kt.showingAttendanceCol;for(let e=V;e<Kt.header.length;e++)Kt.hiddenCols[e]=!1;dn()}else un()}async function un(e){e||(e=Kt.showingAttendanceCol=Kt.showingAttendanceCol||Kt.header.length-1);for(let t=V;t<Kt.header.length;t++)Kt.hiddenCols[t]=e!==t;await dn()}async function mn(){let e=Kt.header.length-Kt.hiddenCols.filter((e=>e)).length;const t=W.indexOf(_),n=W.indexOf(U);if(e<3&&!Kt.hiddenCols[t]&&Kt.hiddenCols[n])return Kt.hiddenCols[t]=!0,Kt.hiddenCols[n]=!1,void dn();const a=Z("#attendancesHolder").getBoundingClientRect().width;if(e<3||Xt.getBoundingClientRect().width<=a){for(let e=0;e<V;e++)Kt.hiddenCols[e]=!1;return await dn(),void(Xt.getBoundingClientRect().width<a&&cn())}Xt.getBoundingClientRect().width>a&&await un();for(var o=[...q];o.length>1&&Xt.getBoundingClientRect().width>a;){let e=o.pop();await fn(Kt.header.indexOf(e),!1)}}function fn(e,t=null){null===t&&(t=Kt.hiddenCols[e]),Kt.hiddenCols[e]=!t,dn()}async function pn(e){e.preventDefault();const t=e.currentTarget.innerText;let n=["Hide column"];W.includes(t)||n.push("Change attendance status","Delete column");let a=await ma(e.clientX,e.clientY,n);if("Hide column"==a)fn(Kt.header.indexOf(t),!1);else if("Change attendance status"==a){let e=await fa(`Change attendance statuses for ${t}:`,{"Current status":["Any","Absent","Excused","Present"],"New status":["Absent","Excused","Present"]});if(e){const n={Absent:1,Present:0,Excused:2},a=n[e["Current status"]],o=n[e["New status"]];if(a===o)return void Sa("Nothing to change.");const i=localStorage.semesterSelected,r=Ht.attendanceCodesAndTimes.find((e=>e[1]==t))[0];let l={},c=[],u=[];for(let e of Ht){let t=e.a[r].u||0;if(t!==o&&(void 0===a||t===a)){let t=e.Section;l[t]||(l[t]={}),l[t][e.Username+"."+"a."+r+"."+p]=o,c.push({collection:s,id:e.Email,data:{["e."+i+"."+t+"."+r+"."+p]:o}}),u.push(e)}}if(0===u.length)Sa("Nothing to change.");else if(await fa(`You are about to mark ${u.length} student(s) ${e["New status"].toLowerCase()} for ${t}.\n\nAre you sure you would like to proceed?`)){for(let e in l)c.push({collection:d,id:Y(i,e),data:l[e]});let n=db.updateBatch(...c);if(n.error)wa("Could not update records.\n"+n.error);else{for(let e of u)e.a[r].u=o;nn(),Sa(`${u.length} student(s) were marked ${e["New status"].toLowerCase()} for ${t}.`,"Success.",1)}}}}else if("Delete column"==a){if("delete"===(await fa(`Are you sure you would like to delete all attendance data for ${t}?<p>WARNING:<p>All data associated with ${t} attendance will be lost, including photos and attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.`,{Confirm:""})).Confirm.toLowerCase()){const e=localStorage.semesterSelected,n=Ht.attendanceCodesAndTimes.find((e=>e[1]==t))[0];let a={},o=[];for(let t of Ht){let i=t.Section;a[i]||(a[i]={}),a[i][t.Username+"."+"a."+n]=db.deleteField(),o.push({collection:s,id:t.Email,data:{["e."+e+"."+i+"."+n]:db.deleteField()}})}for(let t in a)o.push({collection:d,id:Y(e,t),data:a[t]});let i=db.updateBatch(...o);if(i.error)wa("Could not update records.\n"+i.error);else{for(let t of Ht)deleteFile(ft(t.Username,e,t.Section,n)),delete t.a[n];Ht.attendanceCodesAndTimes=Ht.attendanceCodesAndTimes.filter((e=>e[0]!==n)),nn(),Sa(`Deleted all attendance records for ${t}.`,"Success.",1)}}}}function hn(e){Kt.sortStack[0]===e?(Kt.sortDesc[e]=!Kt.sortDesc[e],localStorage.setItem("sortDesc_"+Kt.id,JSON.stringify(Kt.sortDesc))):(Kt.sortStack=[e].concat(Kt.sortStack.filter((t=>t!=e))),localStorage.setItem("sortStack_"+Kt.id,JSON.stringify(Kt.sortStack))),sn()}we(Z("#attendancesHolder"));const gn=Z("#roomMap"),Sn=Z("#roomMapHolder");var vn;async function wn(e=!1){e&&await Vt(!0),Jt();let t=xt._sectionDoc;Ht.roomId=t.r,localStorage["roomMapZoom-"+Ht.roomId]||(localStorage["roomMapZoom-"+Ht.roomId]=1),vn=Ht.attendanceCodesAndTimes.length-1,bn(),Z("#attendanceRoomViewLastBtn").classList.add("disabled")}async function bn(){let e=Ht.roomId?await tt(Ht.roomId):[["","","","","","","","","",""]],t=e.flat().filter((e=>e));var n={},a=[],o=[],i=Ht.attendanceCodesAndTimes[vn][0];Z("#roomViewDate").innerText=Ht.attendanceCodesAndTimes[vn][1];for(let e of Ht){let r=e.a[i];if(r&&2!==r.u&&1!==r.u){let a=z(r.s);e._seat=a,e._notes=r.nt,e._time=r.time,e._photo=r.p?ft(e.Username,localStorage.semesterSelected,e.Section,i):e.p,t.includes(a)&&!n[a]?n[a]=e:o.push(e)}else a.push(e),r&&(e._notes=r.nt),r&&2===r.u?e._time="excused":e._time="absent",e._photo=e.p}if(gn.innerHTML="",Object.keys(n).length){gn._cols=0;for(let t=0;t<e.length;t++){let a=e[t];gn._cols=Math.max(gn._cols,a.length);let o=gn.appendChild(document.createElement("div"));for(let i=0;i<a.length;i++){let a=e[t][i],r=o.appendChild(document.createElement("div"));if(a){r.classList.add("seat");let e=n[a];e?Cn(r,e):r.innerText=a}}}}let r=gn.appendChild(document.createElement("div"));r.classList.add("bad-seating");for(let e of o){let t=r.appendChild(document.createElement("div"));t.classList.add("seat"),Cn(t,e)}let l=gn.appendChild(document.createElement("div"));l.classList.add("absent");for(let e of a){let t=l.appendChild(document.createElement("div"));t.classList.add("seat"),Cn(t,e)}Ln(),r.style.maxWidth=`calc(var(--seat-width) * ${gn._cols})`,l.style.maxWidth=`calc(var(--seat-width) * ${gn._cols})`,je("room"),setTimeout((()=>{Sn.scrollLeft=(Sn.scrollWidth-Sn.offsetWidth)/2}),100)}function Cn(e,t){e.classList.add("taken"),getLinkFromStoragePath(t._photo).then((t=>e.style.backgroundImage=`url("${t||r}"), url(user-icon.png)`)),e.innerHTML=`<span>${t.n}</span>`,e.onmouseover=()=>{e.innerHTML=`<span>${rt(t)}\n<small>${t.Username}\n${t._time}\n${t._seat||""}\n${t.Section}\n${t._notes||""}</small></span>`},e.onmouseout=()=>{e.innerHTML=`<span>${t.n}</span>`,e.classList.remove("enlarge")},e.onclick=()=>{e.classList.toggle("enlarge")}}function yn(){vn==Ht.attendanceCodesAndTimes.length-1?Z("#attendanceRoomViewLastBtn").classList.add("disabled"):Z("#attendanceRoomViewLastBtn").classList.remove("disabled")}function Ln(){let e=parseFloat(localStorage["roomMapZoom-"+Ht.roomId]);gn.style.setProperty("--seat-width",25*e+"px"),gn.style.setProperty("--seat-height",25*e+"px")}we(Sn);let En,An,Tn={};async function In(){clearTimeout(An);let e=Tn[En][Tn[En].indx],[t,n]=Q(En),a=Ht.find((t=>t.Username===e));me(null,null,await Promise.all(Object.values(a.a).filter((e=>e.p)).map((a=>getLinkFromStoragePath(ft(e,t,n,a.code)))))),kn(),Z("#learnNamesName").innerText=rt(a),Z("#learnNamesName").classList.add("hideName")}async function kn(){null!==Z("#learnNamesImg").offsetParent&&(clearTimeout(An),me(null,Z("#learnNamesImg")),An=setTimeout(kn,3500))}function xn(){if(!Tn[En].length)return ne("learnNamesMain"),void ae("learnNamesDone");Tn[En].indx++,Tn[En].indx>=Tn[En].length?(Tn[En]=ie(Tn[En]),Tn[En].indx=0,ne("learnNamesPrevBtn")):Tn[En].indx&&ae("learnNamesPrevBtn"),In()}const Bn="Create New Section",Rn="No assigned room";async function $n(e,t){Z("#editSectionSubmitBtn").innerText="Save Section",ae("editSectionDeleteBtn"),Z("#editSectionIdInput").setAttribute("disabled",!0),Z("#editSectionSemesterSelect").setAttribute("disabled",!0),await Nn(),Z("#editSectionIdInput").value=e,Z("#editSectionPatternInput").value=t.pt,Z("#editSectionRoom").innerText=t.r||Rn,Z("#editSectionCrosslistInput").value=t.x?.join("\n")||"",Z("#editSectionInstructorEmailsInput").value=t.i?.join("\n")||"",Z("#editSectionInstructorNamesInput").value=t.in||"",Z("#editSectionAllowSelfEnroll").checked=t.v,-1===t.s?Z("#editSectionSeatNo").checked=!0:1===t.s?Z("#editSectionSeatWarn").checked=!0:2===t.s?Z("#editSectionSeatRequire").checked=!0:Z("#editSectionSeatYes").checked=!0,-1===t.p?Z("#editSectionPhotoNo").checked=!0:1===t.p?Z("#editSectionPhotoWarn").checked=!0:2===t.p?Z("#editSectionPhotoRequire").checked=!0:Z("#editSectionPhotoYes").checked=!0,-1===t.l?Z("#editSectionLocationNo").checked=!0:1===t.l?Z("#editSectionLocationWarn").checked=!0:2===t.l?Z("#editSectionLocationRequire").checked=!0:Z("#editSectionLocationYes").checked=!0}async function Nn(){let e;je("addOrEditSection");let t=Z("#editSectionSemesterSelect");if(1==t.children.length){let n=await Xe();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}for(let e of t.children)e.innerText==localStorage.semesterSelected?(e.setAttribute("selected",!0),t.value=e.value):e.removeAttribute("selected")}function Mn(){jn((e=>Z("#editSectionRoom").innerText=e))}const Pn=Z("#editRoomLayout");let Un,On,_n={};async function Dn(){let e=await et(),t=[...new Set(Object.values(e).map((e=>e.cm)))];t.sort(),Z("#editRoomCampusDataList").innerHTML="",Z("#roomsCampusSelect").innerHTML='<option value="">All campuses</option>';for(let n of t)if(n){_n[n]=[...new Set(Object.values(e).filter((e=>e.cm===n)).map((e=>e.bl)))],_n[n].sort(),Z("#editRoomCampusDataList").appendChild(document.createElement("option")).value=n;let t=Z("#roomsCampusSelect").appendChild(document.createElement("option"));t.innerText=t.value=n}1===Z("#editRoomCampusDataList").childElementCount?(Z("#roomsCampusSelect").value=Z("#roomsCampusSelect").lastChild.value,Z("#roomsCampusSelect").setAttribute("disabled",!0)):localStorage.campusSelected&&(Z("#roomsCampusSelect").value=localStorage.campusSelected,Z("#roomsCampusSelect").removeAttribute("disabled")),Z("#editRoomBuildingDataList").innerHTML="";for(let t of new Set(Object.values(e).map((e=>e.bl))))t&&(Z("#editRoomBuildingDataList").appendChild(document.createElement("option")).value=t);Hn(),Fn()}function Hn(){if(localStorage.campusSelected=Z("#roomsCampusSelect").value,Z("#roomsBuildingSelect").innerHTML='<option value="">All buildings</option>',localStorage.campusSelected){for(let e of _n[localStorage.campusSelected])if(e){let t=Z("#roomsBuildingSelect").appendChild(document.createElement("option"));t.innerText=t.value=e}localStorage.buildingSelected&&(Z("#roomsBuildingSelect").value=localStorage.buildingSelected)}else localStorage.buildingSelected="";Fn()}async function Fn(){localStorage.buildingSelected=Z("#roomsBuildingSelect").value;let e=await et(),t=Object.keys(Ye).sort(((e,t)=>e.toLowerCase()>t.toLowerCase()?1:-1));for(;Z("#roomList").childElementCount>1;)Z("#roomList").removeChild(Z("#roomList").lastChild);for(let n of t)!e[n].rn||localStorage.campusSelected&&localStorage.campusSelected!==e[n].cm||localStorage.buildingSelected&&localStorage.buildingSelected!==e[n].bl||Jn(n,e[n])}async function jn(e){Wn=e,je("rooms"),Z("#roomList").childElementCount<2&&Dn()}var Wn,qn,Vn;function Jn(e,t){let n=t.rm.split("\n").map((e=>e.split("\t"))).flat().filter((e=>e.trim())).length,a=Z("#roomList").appendChild(document.createElement("div"));a.innerHTML=`${e}\n${n} seats\n${t.bl}\n${t.rn}\n${t.cm}`,a._editRoomF=function(){Z("#editRoomId").setAttribute("disabled",!0),Z("#editRoomId").value=e,Z("#editRoomCampus").value=t.cm,Z("#editRoomBuilding").value=t.bl,Z("#editRoomName").value=t.rn,On=[le(t.rm.toUpperCase())],On.indx=0,Qn();let n=[];for(let t in Je)for(let a in Je[t])Je[t][a].r===e&&(n.push(a),Je[t][a].x?.length&&n.push(...Je[t][a].x));n.length?(Z("#editRoomUsedIn").innerText=`Room used for sections:\n  ${n.join(", ")}`,ae("editRoomUsedIn"),ne("editRoomDeleteBtn")):(ne("editRoomUsedIn"),ae("editRoomDeleteBtn")),je("editRoom")},a.onclick=function(){Wn?(Wn(e),qe()):a._editRoomF()}}function Yn(e){e||(e=[...Pn.children].map((e=>[...e.children].map((e=>e.innerText))))),JSON.stringify(e)!=JSON.stringify(On[On.indx])&&(On.indx++,On.length=On.indx,On.push(e))}function Qn(e){e?Yn(e):e=On[On.indx],Pn.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t],a=Pn.appendChild(document.createElement("div"));for(let o=0;o<n.length;o++){let i=a.appendChild(document.createElement("div"));i.setAttribute("contenteditable",!0),e[t][o]&&(i.classList.add("seat"),i.innerText=e[t][o]),i.onmouseover=e=>{Un&&e.buttons&&(e.preventDefault(),1===Un?(i.classList.add("seat"),i.innerText="_"):-1===Un&&(i.classList.remove("seat"),i.innerText=""))},i.onmouseout=e=>{if(!Un&&e.buttons){function t(e){e.buttons||(Un=0,Yn(),window.removeEventListener("mousemove",t))}e.preventDefault(),Un=i.classList.contains("seat")?-1:1,1===Un?(i.classList.add("seat"),i.innerText="_"):-1===Un&&(i.classList.remove("seat"),i.innerText=""),window.addEventListener("mousemove",t)}},i.oninput=e=>{i.innerText.includes("\n")&&i.blur(),i.innerText?i.classList.add("seat"):i.classList.remove("seat")},i.onblur=e=>{i.innerText=z(i.innerText),Yn()},i.ondblclick=e=>{e.preventDefault(),i.innerText?(i.classList.remove("seat"),i.innerText=""):(i.classList.add("seat"),i.innerText="_",selectText(i))},i.addEventListener("contextmenu",(async r=>{r.preventDefault();let l=await ma(r.clientX,r.clientY,["Insert left","Insert right","Delete","","Insert row above","Insert row below","Delete row","","Insert col left","Insert col right","Delete col"]);if("Delete"===l)i.remove(),Yn();else if("Insert left"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o,0,""),Qn(n)}else if("Insert right"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o+1,0,""),Qn(n)}else if("Delete row"===l)a.remove(),Yn();else if("Insert row above"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t,0,Array(n.length).fill("")),Qn(a)}else if("Insert row below"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t+1,0,Array(n.length).fill("")),Qn(a)}else if("Delete col"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,1))),Qn(t)}else if("Insert col left"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,0,""))),Qn(t)}else if("Insert col right"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o+1,0,""))),Qn(t)}}))}}}function zn(e){e||(e=JSON.parse(JSON.stringify(On[On.indx])));let t,n=0;for(let a=e.length-1;a>-1;a--){let o=e[a];t=0;for(let i=0;i<o.length;i++)e[a][i]&&e[a][i]&&(e[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[n]+ ++t);t&&n++}Qn(e)}function Zn(e,t=""){(qn=e)?ne("manageUsersAddUserButtons"):ae("manageUsersAddUserButtons"),Z("#manageUsersTitle").innerHTML=t,je("manageUsers");const n=Z("#manageUsersPages");if(!n.childElementCount){for(let e of J){let t=n.appendChild(document.createElement("span"));t.innerText=e,t.onclick=()=>{Z("#manageUsersEmailInput").value="",Z("#manageUsersNameInput").value="",Z("#manageUsersLastNameInput").value="",Z(".manageUsersSelectedFilter").value=Z(".manageUsersSelectedFilter")==Z("#manageUsersEmailInput")?e:e.toUpperCase(),Xn()}}let e=n.appendChild(document.createElement("span"));e.innerText="—",e.onclick=()=>{Z("#manageUsersEmailInput").value="",Z("#manageUsersNameInput").value="",Z("#manageUsersLastNameInput").value="",Xn()}}}async function Xn(){let e=Z("#manageUsersEmailInput").value,t=Z("#manageUsersNameInput").value,n=Z("#manageUsersLastNameInput").value,a=Z("#manageUsersSelectRoleStudent").checked,o=Z("#manageUsersSelectRoleInstructor").checked,i=Z("#manageUsersSelectRoleAdmin").checked;if(!(e||t||n||o||i))return void(manageUsersList.innerHTML='When "Any role" or "Students Only" role is selected, you must also supply additional filters for email and/or last name and/or preferred name.');let r={};if(e?r=await at(e):n?r=await at(n,w):t?r=await at(t,v):o?r=await at([1,3],A):i&&(r=await at([2,3],A)),r?.error)wa("Could not perform search.\n"+r.error);else{const e=Z("#manageUsersList");e.innerHTML="",t=t.toLowerCase(),n=n.toLowerCase();for(let e in r){let l=r[e];n&&!(l.f.toLowerCase()||"").startsWith(n)||(t&&!(l.n.toLowerCase()||"").startsWith(t)||a&&l.rl||(!o||1&l.rl)&&(!i||2&l.rl)&&Kn(e,l))}e.innerHTML?e.insertBefore(document.createElement("row"),e.firstElementChild).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>":e.innerHTML="No users found matching the specified filters."}}function Kn(e,t){let n=Z("#manageUsersList").appendChild(document.createElement("row"));n.innerHTML=`<div>${2&t.rl?"✔️":""}</div><div>${1&t.rl?"✔️":""}</div><div>${e}</div><div>${t.f||""}</div><div>${t.n||""}</div>`,n.onclick=async function(){if(qn)return void qn(e);let a=`${e}\n${rt(t,"\n")}\n`,o=await getOneLinkFromStoragePath(ke(e));o&&(a+=`<img src="${o}" height=200>\n`);for(let e in t.e){let n=Object.keys(t.e[e]);n.length&&(a+=`<small>${e}: ${n}</small>\n`)}let i=await fa(a,{Instructor:Boolean(1&t.rl),Admin:Boolean(2&t.rl)},["Save","Cancel"]);if(i){let a=1*i.Instructor+2*i.Admin,o=`Are you sure you would like to change the role for ${e}?`;if(1&a&&!(1&t.rl)&&(o+="\n<li>Adding instructor privileges</li>"),!(1&a)&&1&t.rl&&(o+="\n<li>Taking away instructor privileges</li>"),2&a&&!(2&t.rl)&&(o+="<li>Adding admin privileges</li>"),!(2&a)&&2&t.rl&&(o+="<li>Taking away admin privileges</li>"),a!==t.rl&&await fa(o)){let o=await db.updateOne(s,e,{[A]:a});o.error?wa(`Could not update user profile for ${e}.\n`+o.error):(t.rl=a,n.innerHTML=`<div>${2&a?"✔️":""}</div><div>${1&a?"✔️":""}</div><div>${e}</div><div>${t.f||""}</div><div>${t.n||""}</div>`)}}}}function Gn(e,t="Add users"){(Vn=e)?ne("addUsersRoleOptions"):ae("addUsersRoleOptions"),Z("#addUsersBtn").innerText=t,Z("#addUsersEmails").innerText="",Z("#addUsersNames").innerText="",je("addUsers")}function ea(){const e=Z("#addUsersList");Z("#addUsersEmails").value!==Z("#addUsersEmails").value.trimStart()&&(Z("#addUsersEmails").value=Z("#addUsersEmails").value.trimStart());let t=Z("#addUsersEmails").value.split("\n").filter((e=>e)),n=Z("#addUsersNames").value?Z("#addUsersNames").value.trimEnd().split("\n"):[];if(e.innerHTML="",Z("#addUsersBtn").setAttribute("disabled",!0),t.length){const o=Z("#addUsersLastNameFirst").checked;let i,r,l,s,d,c,u,m=[],f=new Set,p=new Set;e.appendChild(document.createElement("row")).innerHTML="<div>Email</div><div>Last Name</div><div>First Name</div>";for(let u=0;u<t.length;u++){d=t[u].toLowerCase(),d.endsWith(a)||(d+=a),i=e.appendChild(document.createElement("row")),r=i.appendChild(document.createElement("div")),l=i.appendChild(document.createElement("div")),s=i.appendChild(document.createElement("div")),r.innerText=d,n[u]&&(c=n[u].split(/\s?,\s?|\s{2,}|\t/),(o?l:s).innerText=Te(c[0]),c[1]&&((o?s:l).innerText=Te(c[1])));let h=d.split("@");2==h.length&&xe(h[0])||(m.push(d),r.classList.add("bad-text")),p.has(d)?(f.add(d),r.innerHTML+=" (duplicate)",r.classList.add("bad-text")):p.add(d)}m.length?u="Invalid emails:\n"+m.join("; ")+"\n":f.size?u="Duplicate emails:\n"+[...f].join("; ")+"\n":n.length>t.length?u=`You specified ${n.length} names, but only ${t.length} matching emails/usernames.`:(u=`Ready to add ${t.length} user(s).`,Z("#addUsersBtn").removeAttribute("disabled")),Z("#addUsersSummary").innerHTML=u+"\nCheck the table below to make sure all emails and names are correctly inferred."}else if(n.length)return void va("Please enter emails or usernames to proceed.")}function ta(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard";var i=o.appendChild(document.createElement("div"));return i.class="cardTitle",i.innerText=e,a&&t.x&&(i.innerText+="\n"+t.x.join("\n")),(i=o.appendChild(document.createElement("div"))).innerText=t.pt,(i=o.appendChild(document.createElement("div"))).innerText=t.r||Rn,(i=o.appendChild(document.createElement("div"))).innerText=t.in||t.i,o.addEventListener("click",n),o}async function na(e){Nt(e.currentTarget.id,e.currentTarget._sectionDoc)}function aa(e){ct(e.currentTarget.id,e.currentTarget._sectionDoc)}async function oa(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne(s,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+t]:{}})).error?wa("Failed to add section.\n\nPlease try again."):(ye.e[localStorage.semesterSelected]||(ye.e[localStorage.semesterSelected]={}),ye.e[localStorage.semesterSelected][t]={},ia(t,n,Z("#studentSections"),aa),qe())}function ia(e,t,n,a,o){var i=ta(e,t,a,o);n.insertBefore(i,n.lastElementChild)}async function ra(e){const t=Z("#studentSections"),n=Z("#instructorSections");if(!e)return ne(t),void ne(n);Z("#semesterSelect").value=e,ae(t),1&ye.rl&&ae(n);var a=await Ke(e);for(let e=t.childElementCount-2;e>0;e--)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let i=a[o];if(ye.e&&ye.e[e]&&o in ye.e[e])ia(o,i,t,aa);else if(i.x?.length)for(let n of i.x)ye.e&&ye.e[e]&&n in ye.e[e]&&ia(n,i,t,aa);!n.classList.contains("hidden")&&i.i?.includes(auth.currentUser.email)&&ia(o,i,n,na,!0)}}async function la(){if(localStorage.semesterSelected){const e=Z("#allSectionsList");e.innerHTML="";let t=await Ke(localStorage.semesterSelected);for(let n in t){let a=t[n];e.appendChild(ta(n,a,(e=>$n(e.currentTarget.id,e.currentTarget._sectionDoc)),!0))}}}const sa=Z("#nameInput"),da=Z("#lastNameInput"),ca=Z("#saveNameBtn");function ua(){let e=Te(sa.value),t=Te(da.value);!e||!t||sa.lastValue===e&&da.lastValue===t?ne(ca):ae(ca)}function ma(e,t,n){return new Promise((function(a,o){const i=Z("#contextMenu");window.dispatchEvent(new Event("click")),e<window.innerWidth/2?(i.style.left=e,i.style.removeProperty("right")):(i.style.right=window.innerWidth-e,i.style.removeProperty("left")),t<window.innerHeight/2?(i.style.top=t,i.style.removeProperty("bottom")):(i.style.bottom=window.innerHeight-t,i.style.removeProperty("top")),i.innerHTML="";for(let e of n){let t=i.appendChild(document.createElement("div"));""===e?t.classList.add("separator"):e.startsWith("_")?t.innerText=e.slice(1):(t.innerText=e,t.onclick=()=>a(e),t.classList.add("contextMenuOption"))}ae(i),window.addEventListener("click",(()=>{a(!1),ne(i)}),{once:!0}),window.addEventListener("popstate",(()=>{a(!1),ne(i)}),{once:!0})}))}function fa(e,t={},n){if(_e)return new Promise((function(a,o){He(),ae("prompt");const i=Z("#promptForm");let r={};Z("#promptFormTitle").innerHTML=e;for(let e in t){let n=i.appendChild(document.createElement("label"));if(n.innerText=e,n.setAttribute("for",e),X(t[e]))r[e]=i.appendChild(document.createElement("input")),r[e].setAttribute("type","number"),r[e].value=t[e],r[e].id=e;else if(t[e]?.constructor===Boolean){let a=i.appendChild(document.createElement("div"));r[e]=a.appendChild(document.createElement("input")),a.appendChild(n),r[e].setAttribute("type","checkbox"),r[e].checked=t[e],r[e].id=e}else if(ee(t[e])){r[e]=i.appendChild(document.createElement("select"));for(let n of t[e])r[e].appendChild(document.createElement("option")).innerText=n;r[e].id=e}else if(K(t[e]))t[e].includes("\n")?r[e]=i.appendChild(document.createElement("textarea")):r[e]=i.appendChild(document.createElement("input")),r[e].value=t[e],r[e].id=e;else if(G(t[e])){if(r[e]=i.appendChild(document.createElement("input")),Object.entries(t[e]).forEach((t=>r[e].setAttribute(t[0],t[1]))),r[e].required&&n.classList.add("required"),"checkbox"===r[e].type||"radio"===r[e].type){let t=i.appendChild(document.createElement("div"));t.appendChild(r[e]),t.appendChild(n)}r[e].id=e}else{i.appendChild(document.createElement("div")).appendChild(n)}}for(let e of n||["OK","Cancel"]){let t=Z("#promptButtons").appendChild(document.createElement("button"));t.innerText=e,t.onclick="cancel"===e.toLowerCase()?()=>{a(!1),pa()}:()=>{if(!i.reportValidity())return;let t=Object.fromEntries(Object.entries(r).map((([e,t])=>[e,"checkbox"===t.type||"radio"===t.type?t.checked:"number"===t.type?parseFloat(t.value):t.value])));t.clicked=e,a(t),pa()}}}))}function pa(){Z("#promptForm").innerHTML="",Z("#promptButtons").innerHTML="",ne("prompt"),De()}const ha=Z("#toast"),ga=Z("#toastMessage");function Sa(e,t,n){if(n?ha.style.setProperty("--toast-accent",n>0?"#4f6":n<-.5?"#f64":"#fe4"):ha.style.setProperty("--toast-accent","gray"),ga.innerHTML=t?t+"\n\n":"",G(e))for(let t in e)e[t]&&(ga.innerHTML+=t+" : "+e[t]+"\n");else ga.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",ba),window.addEventListener("keydown",ba),window.addEventListener("popstate",ba),Ue.addEventListener("scroll",ba),ae(ha),ha.classList.add("slide-up")}),200)}function va(e){Sa(e,"Warning",-.1)}function wa(e){Sa(e,"Error",-1)}function ba(){window.removeEventListener("mousedown",ba),window.removeEventListener("keydown",ba),window.removeEventListener("popstate",ba),Ue.removeEventListener("scroll",ba),ne(ha),ha.classList.remove("slide-up")}const Ca=Z("#theme-switch");function ya(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),Ca.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),Ca.innerText="dark_mode")}function La(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}ya(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);const Ea=(e,t)=>{e.addEventListener("click",t),e.setAttribute("onclick","")};[...document.querySelectorAll(".back")].forEach((e=>Ea(e,qe))),[...document.querySelectorAll(".spinner")].forEach((e=>Ea(e,(e=>ce(e.currentTarget))))),[...document.querySelectorAll(".spinnerBtn")].forEach((e=>Ea(e,(e=>ce(e.currentTarget.firstElementChild))))),Ea(Z("#user"),(()=>{je("profile")})),Ea(Z("#signInBtn"),(function(){Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),localStorage.email=Z("#signInEmailInput").value,signIn(Z("#signInEmailInput").value,Z("#signInPasswordInput").value).catch(Pe)})),Ea(Z("#registerBtn"),(function(){xe(Z("#signInEmailInput").value)?(Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),signUp(Z("#signInEmailInput").value,Z("#signInPasswordInput").value).then((e=>{})).catch(Pe)):wa("Invalid email address.")})),Ea(Z("#resetPwdBtn"),(async function(){Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),xe(Z("#signInEmailInput").value)?Z("#signInEmailInput").value?await fa(`Would you like to send an email with a password-reset link to ${Z("#signInEmailInput").value}${a}?`)&&passwordReset(Z("#signInEmailInput").value).then((()=>{Sa("Password reset email sent.","",1)})).catch((e=>Pe(e,!0))):Sa("You must enter your email address to reset your password."):wa("Invalid email address.")})),Ea(Z("#showNoPwdBtn"),(function(){localStorage.email&&localStorage.signInLinkSent?Me():Fe("signinSendEmail")})),Ea(Z("#signInSendBtn"),(async function(){if(!xe(Z("#signInSendEmailInput").value))return void wa("Invalid email address.");if(localStorage.email=Z("#signInSendEmailInput").value=Z("#signInSendEmailInput").value.trim().toLowerCase(),!localStorage.email)return void Sa("Please enter your username.");let e=await sendEmailLink(localStorage.email);"auth/invalid-email"===e?.error?(wa(`${localStorage.email}${a} is not a valid email address.`),localStorage.email=""):e?.error?wa(`Could not send sign-in email to ${localStorage.email}${a}.\n\n${e.error}`):(localStorage.signInLinkSent=de().join(" at "),Me())})),Ea(Z("#signInWithEmailPasswordBtn"),(()=>{Fe("signInWithEmailPassword")})),Ea(Z("#signInCompleteBtn"),(async function(){if(localStorage.email=Z("#signInConfirmEmailInput").value.trim(),!localStorage.email)return void Sa("Please enter your username and click the [Sign in] button.");let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-email"===e?.error?(wa(`Email ${localStorage.email}${a} does not match the email address to which the link was sent.`),localStorage.email=""):e?.error&&wa("Could not sign in.\n\n"+e.error)})),Ea(Z("#signInWithEmailPasswordBtn2"),(()=>{Fe("signInWithEmailPassword")})),Ea(Z("#signIngSendEmailBtn"),(()=>{Fe("signinSendEmail")})),Ea(Z("#hideSigninLinkSentBtn"),(function(){delete localStorage.signInLinkSent,Fe("signinSendEmail")})),Ea(Z("#signInWithEmailPasswordBtn3"),(()=>{Fe("signInWithEmailPassword")})),Ea(Z("#addInstructorSectionBtn"),(async function(){Z("#editSectionSubmitBtn").innerText=Bn,ne("editSectionDeleteBtn"),Z("#editSectionIdInput").removeAttribute("disabled"),Z("#editSectionSemesterSelect").removeAttribute("disabled"),await Nn(),Z("#editSectionInstructorEmailsInput").value=auth.currentUser.email,Z("#editSectionInstructorNamesInput").value="Prof. "+ye.f,Z("#editSectionIdInput").value="",Z("#editSectionPatternInput").value="",Z("#editSectionRoom").innerText=Rn,Z("#editSectionCrosslistInput").value="",Z("#editSectionLocationYes").checked=!0,Z("#editSectionSeatYes").checked=!0,Z("#editSectionPhotoYes").checked=!0,Z("#editSectionAllowSelfEnroll").checked=!1})),Ea(Z("#sectionsQRreaderBtn"),vt),Ea(Z("#addStudentSectionBtn"),(async function(){je("selectStudentSection");var e=await Ke(localStorage.semesterSelected),t=Z("#availableStudentSections");t.innerHTML="<span></span>";let n=Object.keys(e).sort(),a=new Set(ye.e&&ye.e[localStorage.semesterSelected]?Object.keys(ye.e[localStorage.semesterSelected]):[]);for(let o of n){let n=e[o];if(n.v&&!a.has(o)&&!n.x?.filter((e=>a.has(e))).length&&(ia(o,n,t,oa),n.x?.length))for(let e of n.x)ia(e,n,t,oa)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")})),Ea(Z("#verifyEmailBtn"),Ne),Ea(Z("#sectionsBtn"),(()=>{je("sections")})),Ea(Z("#allSectionsBtn"),(async function(){je("allSections");const e=Z("#allSectionsSemesterSelect");if(1==e.children.length){let t,n=await Xe();for(let a of n)t=e.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a;localStorage.semesterSelected&&(e.value=localStorage.semesterSelected)}la()})),Ea(Z("#roomsBtn"),(()=>jn())),Ea(Z("#manageUsersBtn"),(()=>Zn())),Ea(Z("#logoutBtn"),Re),Ea(Z("#logoutBtn2"),Re),Ea(Z("#markAttendanceScanPasscodeBtn"),(()=>{vt("markAttendanceClassCodeInput")})),Ea(Z("#markAttendanceScanSeatCodeBtn"),(()=>{vt("markAttendanceSeatCodeInput")})),Ea(Z("#defaultSelfieImg"),It),Ea(Z("#selfieCanvas"),It),Ea(Z("#selfieVideo"),kt),Ea(Z("#addPhotoBtn"),It),Ea(Z("#snapPhotoBtn"),kt),Ea(Z("#switchPhotoBtn"),switchCamera),Ea(Z("#locationMissingBtn"),ut),Ea(Z("#locationMissingBtn2"),ut),Ea(Z("#markAttendanceButton"),(async function(){if(dt.value=null,await ut(),Z("#markAttendanceButton").getAttribute("disabled"))Sa("Missing some of the required fields.","",-1);else{if(markAttendanceRequirementsList.innerHTML&&!await fa(`Your instructor requests the following information that you have not supplied:\n${markAttendanceRequirementsList.innerHTML}\n\nAre you sure you would like to mark attendance as is?\n\nPress Cancel to go back and add all of the required information.\nPress OK to mark your attendance without the requested information.`))return;let e=st.value,t=lt.innerText,n=localStorage.semesterSelected;if(e in ye.e[n][t]&&!ye.e[n][t][e].u)return void Sa("You are already marked present, no need to do it again.");Ve(!0);let a=Z("#markAttendanceSeatCodeInput").value,o=dt.value;o&&(o=[o.latitude,o.longitude,Math.round(o.accuracy)]);let i=await async function(e,t,n,a,o,i){const r=ke(auth.currentUser.email);let l={[h]:db.serverTimestamp()},c={[`${r}.n`]:ye.n,[`${r}.f`]:ye.f,[`${r}.a.${n}`]:l};o?.size&&(Lt=ft(r,e,t,n),l.p=!0,c[`${r}.p`]=Lt);a&&(l.s=a);i&&(l.l=i);let u=await db.updateOne(d,Y(e,t),c);if(u?.error)return ye.e[e][t][n]={[h]:db.Timestamp.now(),[p]:-1},{error:"Please make sure the instructor is taking attendance, and that your attendance passcode is correct."};let m="",f=[];o?.size&&(u=await uploadFile(Lt,o),u?.error&&(m+="- we were unable to save your photo\n",f.push("photo not saved")));u=await db.updateOne(s,auth.currentUser.email,{["e."+e+"."+t+"."+n]:{[h]:db.serverTimestamp()}}),u?.error&&(m+="- we were unable to save your attendance receipt\n",f.push("missing receipt"));if(ye.e[e][t][n]={[h]:db.Timestamp.now(),[E]:f.length?f.join(", "):""},m)return{warning:"Your attendance was marked (the instructor knows you attended).\nHOWEVER:\n"+m}}(n,t,e,a,yt,o);i?.error?(mt(n,t),Sa(i.error,"Your attendance was NOT marked.",-1)):i?.warning?(mt(n,t),va(i.warning)):(mt(n,t),Sa("Your attendance was marked.","Success!",1)),Ve(!1)}})),Ea(Z("#markAttendanceRemoveButton"),(async function(){let e="Are you sure you would like to remove this section from the list of sections you are enrolled in?";if(Z("#attendanceMarked").innerHTML&&(e+="\n\nWARNING: This action will delete all of your attendance receipts for this section."),await fa(e)){let e=lt.innerText;(await db.updateOne(s,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+e]:db.deleteField()})).error?wa("Something went wrong. Please try again."):(delete ye.e[localStorage.semesterSelected][e],ra(localStorage.semesterSelected),qe())}})),Ea(Z("#switchQrCameraBtn"),(async function(){gt=await switchCameraStream(gt),ht.reset(),Ct()})),Ea(Z("#editSectionRoom"),Mn),Ea(Z("#editSectionRoomBtn"),Mn),Ea(Z("#editSectionResetRoomBtn"),(function(){Z("#editSectionRoom").innerText=Rn})),Ea(Z("#editSectionSubmitBtn"),(async function(){Be(Z("#editSectionIdInput"));let e=Z("#editSectionSubmitBtn").innerText===Bn,t=Z("#editSectionSemesterSelect").value,n=Z("#editSectionIdInput").value,a={[$]:Z("#editSectionInstructorEmailsInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[N]:Z("#editSectionInstructorNamesInput").value.trim(),[R]:Z("#editSectionPatternInput").value,[B]:Z("#editSectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[C]:Z("#editSectionSeatWarn").checked+2*Z("#editSectionSeatRequire").checked-Z("#editSectionSeatNo").checked,[b]:Z("#editSectionPhotoWarn").checked+2*Z("#editSectionPhotoRequire").checked-Z("#editSectionPhotoNo").checked,[y]:Z("#editSectionLocationWarn").checked+2*Z("#editSectionLocationRequire").checked-Z("#editSectionLocationNo").checked,v:Z("#editSectionAllowSelfEnroll").checked};if(Z("#editSectionRoom").innerText!==Rn&&(a.r=Z("#editSectionRoom").innerText),!t)return void Sa("Please select semester.","Missing information:",-1);if(!n)return void Sa("Please enter section id.","Missing information:",-1);if(e&&n.includes(i))return void Sa('Specified section id includes an invalid character "|".',"Invalid section id:",-1);if(!a.pt)return void Sa("Please enter section day/time pattern.","Missing information:",-1);if(!a.i)return void Sa("Please enter section instructor email(s).","Missing information:",-1);if(!a.in)return void Sa("Please enter section instructor name(s).","Missing information:",-1);if(a.x?.includes(n))return void Sa("Please do not enter current section id under cross-listed section ids.","Invalid cross-listed information:",-1);if(!a.r){if(a.s>-1)return void Sa('You have not assigned a room to this section.\nEither assign a room to this section or select the "No" option under "Collect seat information".',"Missing information:",-1);if(!await fa("You have not assigned a room to this section.\nAre you sure you would like to continue without a room assignment?"))return}let o=await Ke(t);for(let t in o)if(t===n){if(e)return void Sa(`Section ${n} already exists.`,"Duplicate section id:",-1)}else{let i=o[t];if(e&&i.x?.includes(n))return void Sa(`Section ${n} already exists.\nIt is cross-listed with section ${t}.`,"Duplicate section id:",-1);if(a.x?.includes(t))return void Sa(`Cannot list ${t} as a cross-listed section because a record for ${t} already exists.`,"Duplicate section id:",-1);let r=a.x?.filter((e=>i.x?.includes(e)));if(r.length)return void Sa(`Cannot list ${r} as cross-listed section(s).\n${t} already includes cross-listed section(s):\n ${r}`,"Duplicate section id:",-1);if(a.r&&i.pt===a.pt&&i.r===a.r)return void Sa(i.r+" is booked at this time by section "+t+".\n\nIf these sections are cross-listed, please edit information for "+t+" to indicate this, rather than creating a new section.","",-1)}if(!e){let e=o[n].x.filter((e=>!a.x.includes(e)));if(e.length&&!await fa(`Are you sure you would like to remove ${e} as cross-listed section(s) for this course?\nThis action may have undesired consequences.`))return}(await db.updateOne(c,t,{[n]:a})).error?wa("Failed to add section.\n\nPlease try again."):(o[n]=Object.assign(o[n]||{},a),t===localStorage.semesterSelected&&(e&&ia(n,a,Z("#instructorSections")),ra(localStorage.semesterSelected)),n===xt.innerText&&(Z("#getAttendanceCrossListIds").innerHTML=a.x?"<span>"+a.x.join("</span> <span>")+"</span>":"",Z("#getAttendanceSectionInfo").innerText=a.pt+"\n"+(a.r||Rn)+"\n"+(a.in||a.i.join("\n")),Ht._sectionIds=[xt.innerText].concat(a.x)),qe())})),Ea(Z("#editSectionDeleteBtn"),(async function(){let e=await fa('Are you sure you want to delete this section?<p>WARNING:<p>All data associated with this section will be lost, including all attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.',{Confirm:""});if(e){if("delete"!==e.Confirm)return void va('The section was NOT deleted.\n\nYou clicked OK but did not enter the word "delete" at the Confirm prompt.\nIf you want to delete this section, please try again, and make sure to type the word "delete" at the Confirm prompt.');let t=Z("#editSectionSemesterSelect").value,n=Z("#editSectionIdInput").value,a=await db.updateOne(c,t,{[n]:db.deleteField()});a.error?wa("Failed to delete section.\n",a.error):(delete Je[t][n],a=await db.deleteOne(d,Y(t,n)),a?.error&&wa("Deleted section, but failed to delete attendance data.\n",a.error),ra(localStorage.semesterSelected),qe(),qe())}})),Ea(Z("#createNewRoomBtn"),(function(){Z("#editRoomId").removeAttribute("disabled"),Z("#editRoomId").value="",Z("#editRoomCampus").value="",Z("#editRoomBuilding").value="",Z("#editRoomName").value="",ne("editRoomDeleteBtn"),ne("editRoomUsedIn"),On=[],On.indx=-1,zn(Array(6).fill().map((()=>Array(4).fill(" ")))),je("editRoom")})),Ea(Z("#editRoomResetBtn"),(function(){On.indx>0&&(On.indx=0,Qn())})),Ea(Z("#editRoomUndoBtn"),(function(){On.indx>0?(On.indx--,Qn()):Sa("Nothing to undo.")})),Ea(Z("#editRoomRedoBtn"),(function(){On.indx<On.length-1?(On.indx++,Qn()):Sa("Nothing to redo.")})),Ea(Z("#editRoomGridBtn"),(async function(){let e=await fa("Select grid size",{Rows:On[On.indx].length,Cols:Math.max(...On[On.indx].map((e=>e.length)))});e&&zn(Array(e.Rows).fill().map((()=>Array(e.Cols).fill(" "))))})),Ea(Z("#editRoom123Btn"),(()=>zn())),Ea(Z("#editRoomAbcBtn"),(function(){let e,t=JSON.parse(JSON.stringify(On[On.indx])),n=1;for(let a=t.length-1;a>-1;a--){let o=t[a];e=0;for(let i=0;i<o.length;i++)t[a][i]&&t[a][i]&&(t[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e++]+n);e&&n++}Qn(t)})),Ea(Z("#editRoomSaveBtn"),(function(){if(null===Z("#editRoomId").getAttribute("disabled")){if(Z("#editRoomId").value=Z("#editRoomId").value.trim(),Be(Z("#editRoomId")),!Z("#editRoomId").value)return void wa("Missing field: Room Id");if(Z("#editRoomId").value in Ye)return void wa(`Room ${Z("#editRoomId").value} already exists.`)}if(Z("#editRoomBuilding").value=Z("#editRoomBuilding").value.trim(),Z("#editRoomName").value=Z("#editRoomName").value.trim(),Z("#editRoomCampus").value=Z("#editRoomCampus").value.trim(),!Z("#editRoomBuilding").value)return void wa("Missing field: Building");if(!Z("#editRoomName").value)return void wa("Missing field: Room name or number");if(!Z("#editRoomCampus").value)return void wa("Missing field: Campus");let e=[...Pn.children].map((e=>[...e.children].map((e=>e.innerText)))),t=e.flat();for(let e=0;e<t.length;e++)if(t[e]){if(t.indexOf(t[e])!==e)return void wa("Duplicate seat code: "+t[e]);if(!t[e].match(/^[a-z0-9]+$/i))return void wa(`Invalid seat code: ${t[e]}.\nSeat codes must be combinations of letters and numbers.`)}let n={[T]:Z("#editRoomName").value,[k]:Z("#editRoomBuilding").value,[x]:Z("#editRoomCampus").value,[I]:e.map((e=>e.join("\t"))).join("\n")},a=db.insertOne(u,Z("#editRoomId").value,n);a.error?wa("Could not save changes to room.\n"+a.error):(Ye[Z("#editRoomId").value]=n,n.cm!==localStorage.campusSelected?localStorage.campusSelected="":n.bl!==localStorage.buildingSelected&&(localStorage.buildingSelected=""),qe(),Dn(),Wn&&(qe(),Wn(Z("#editRoomId").value)))})),Ea(Z("#editRoomLabelsBtn"),(function(){let e=[...Pn.children].reverse().map((e=>[...e.children].map((e=>e.innerText)))).flat().filter((e=>e));window.open("printLabels.html?"+e,"lectureSeatsLabels")})),Ea(Z("#editRoomDeleteBtn"),(async function(){if(await fa("Are you sure you would like to delete this room record?",{},["Delete","Cancel"])){let e=db.deleteOne(u,Z("#editRoomId").value);e.error?wa("Could not delete room record.\n"+e.error):(delete Ye[Z("#editRoomId").value],qe(),Dn())}})),Ea(Z("#addUserBtn"),(async function(){let e=await fa("",{Email:{placeholder:"username"+a,required:!0,onchange:"this.value=this.value.trim().toLowerCase();if(!this.value.endsWith(DOMAIN))this.value+=DOMAIN"},"First name":"","Last name":"",Instructor:!1,Admin:!1},["Add User","Cancel"]);if(e){let t=e.Email.split("@");if(2!==t.length||!xe(t[0])||!e.Email.endsWith(a))return void wa(`Invalid email address ${e.Email}.`);let n=await db.getDoc(s,e.Email);if(n?.error)return void wa("Could not access the database.\n"+n.error);if(n)return void wa(`Cannot add user.\nUser with the email ${e.Email} already exists.`);let o={};if(e["First name"]&&(o.n=e["First name"]),e["Last name"]&&(o.f=e["Last name"]),(e.Instructor||e.Admin)&&(o.rl=1*e.Instructor+2*e.Admin),n=await db.insertOne(s,e.Email,o),n.error)return void wa("Could not add user to database.\n"+n.error);ze[e.Email]=o,Z("#manageUsersList").childElementCount||(Z("#manageUsersList").innerHTML="",Z("#manageUsersList").appendChild(document.createElement("row")).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>"),Kn(e.Email,o)}})),Ea(Z("#showAddUsersBtn"),(()=>Gn())),Ea(Z("#addUsersBtn"),(function(){let e=[...Z("#addUsersList").children].map((e=>[...e.children].map((e=>e.innerText)))).slice(1);if(Vn)Vn(e);else for(let t=0;t<e.length;t++);})),Ea(Z("#createSectionURLBtn"),(function(){let e=new URL(window.location);e.hash=e.search="",e.searchParams.append("s",Y(localStorage.semesterSelected,xt.innerText)),navigator.clipboard.writeText(e.href),Sa("URL link for this section copied to clipboard.")})),Ea(Z("#randomAttendanceClassCodeBtn"),Mt),Ea(Z("#createQRCodeBtn"),(()=>Ut())),Ea(Z("#createURLBtn"),(function(){let e=new URL(window.location);e.hash=e.search="",e.searchParams.append("s",Y(localStorage.semesterSelected,xt.innerText)),e.searchParams.append("c",Bt.value),navigator.clipboard.writeText(e.href),Sa("URL link for this attendance copied to clipboard.")})),Ea(Z("#collectAttendanceBtn"),(async function(){if("Start"===Rt.innerText){let e=parseInt($t.innerText);if(isNaN(e)||e<1)return void Sa("Please enter a numeric value greater than or equal to 1 for the minutes attendance is to be collected.");if(e>180&&!await fa(`WARNING: You are attempting to open attendance collection for ${Math.floor(e/60)}+ hours.\nAre you sure you wish to continue?`))return;if(!Bt.value)return void Sa("Please enter a passcode for taking attendance.");{Be(Bt),Jt();let e=Ht.attendanceCodesAndTimes.find((e=>e[0]===Bt.value));if(e){let t=de()[0];if(e[1].split(" ")[0]!==t)return void wa(`Cannot use attendance passcode ${Bt.value}.\nThis passcode has already been used to take attendance on ${e[1].split(" ").join(" at ")}.`);if(!await fa(`You were collecting attendance earlier today using the same passcode.\n\nWould you like to continue taking the same attendance?\n\n<li>To continue collecting attendance for passcode ${Bt.value}, click Continue.</li><li>To take a new attendance, click Cancel, change the value for Attendance passcode, and click the Start button again.</li>`,{},["Continue","Cancel"]))return}}Ve(!0);let t=xt.innerText,n=xt._sectionDoc,a=db.now()+60*e,o={[f]:Bt.value,[h]:db.serverTimestamp(),[g]:e};o.i=n.i;let i=await db.upsertOne(d,Y(localStorage.semesterSelected,t),o);if(i?.error)return wa("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Ve(!1);if(n.x?.length)for(let e of n.x)if(i=await db.upsertOne(d,Y(localStorage.semesterSelected,e),o),i?.error)return wa("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Ve(!1);Ht._docs.forEach((e=>{o.d={seconds:db.now()},Object.assign(e,o)})),localStorage.minutesToCollectAttendance=e,localStorage.takingAttendance=Y(localStorage.semesterSelected,t),localStorage.attendanceEndtime=a,Ft()}else Wt();Ve(!1)})),Ea(Z("#refreshAttendanceBtn"),(()=>{qt(!0)})),Ea(Z("#studentsAddBtn"),Yt),Ea(Z("#getAttendanceShowAttendanceTableBtn"),Gt),Ea(Z("#getAttendanceShowRoomBtn"),(()=>wn())),Ea(Z("#learnNamesBtn"),(async function(){let e=[...new Set(Ht.filter((e=>e.p)).map((e=>e.Section)))];if(e.length>1){let t=await fa("Please choose section:",{},e.concat(["Cancel"]));if(!t)return;e[0]=t.clicked}En=Y(localStorage.semesterSelected,e[0]),Tn[En]?.length||(Tn[En]=ie(Ht.filter((t=>t.p&&t.Section===e[0])).map((e=>e.Username))),Tn[En].indx=0),je("learnNames"),ae("learnNamesMain"),ne("learnNamesDone"),Z("#learnNamesImg").src=r,Z("#learnNamesName").innerText="",Z("#learnNamesName").classList.add("hideName"),0==Tn[En].indx&&ne("learnNamesPrevBtn"),setTimeout(In,100)})),Ea(Z("#hideQRBtn"),(()=>{ne("QRcodeContainer")})),Ea(Z("#showQRPopupBtn"),(function(){let e=location.protocol+"//"+location.host+location.pathname+"?c="+Bt.value+"&s="+Y(localStorage.semesterSelected,xt.innerText);window.open(`qrcode.html?${e}`,"LectureSeats QR Code","width=300,height=300,top=100,left=600")})),Ea(Z("#gotoRoomBtn"),(()=>{qe(),setTimeout(wn,100)})),Ea(Z("#refreshAttendTableBtn"),(()=>{nn(!0)})),Ea(Z("#attendanceTableSelectColsBtn"),(async function(){let e=await fa("Select which columns to show",Object.fromEntries(Kt.header.map(((e,t)=>[e,!Kt.hiddenCols[t]])))),t=!1;for(let n in e){let a=Kt.header.indexOf(n);a>-1&&Boolean(Kt.hiddenCols[a])==e[n]&&(Kt.hiddenCols[a]=!e[n],t=!0)}t&&dn()})),Ea(Z("#attendanceTableFitBtn"),mn),Ea(Z("#attendanceTableColFirstBtn"),(function(){Kt.showingAttendanceCol=V,un(Kt.showingAttendanceCol)})),Ea(Z("#attendanceTableColLeftBtn"),(function(){Kt.showingAttendanceCol=Kt.showingAttendanceCol?Kt.showingAttendanceCol-1:V,Kt.showingAttendanceCol<V&&(Kt.showingAttendanceCol=Kt.header.length-1),un(Kt.showingAttendanceCol)})),Ea(Z("#attendanceTableColsAllBtn"),cn),Ea(Z("#attendanceTableColRightBtn"),(function(){Kt.showingAttendanceCol=Kt.showingAttendanceCol?Kt.showingAttendanceCol+1:Kt.header.length-1,Kt.showingAttendanceCol>=Kt.header.length&&(Kt.showingAttendanceCol=V),un(Kt.showingAttendanceCol)})),Ea(Z("#attendanceTableColsLastBtn"),(function(){Kt.showingAttendanceCol=Kt.header.length-1,un(Kt.showingAttendanceCol)})),Ea(Z("#attendanceTableOptionsBtn"),(()=>{oe("attendanceTableOptions")})),Ea(Z("#attendanceTableOptionsHideBtn"),(()=>{ne("attendanceTableOptions")})),Ea(Z("#downloadAttendanceBtn"),(async function(){let e=Object.fromEntries(Kt.header.map(((e,t)=>[e,!0])));e.Filename="attendance-"+Kt.id+".csv";let t=await fa("Select fields to include in your downloaded data:\n\n<small><a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=true)\">Select All</a> <a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=false)\">Deselect All</a></small>",e,["Download","Cancel"]);var n,a,o;t&&Kt.header.some((e=>t[e]))&&(t.Filename?t.Filename.endsWith(".csv")||(t.Filename+=".csv"):t.Filename="attendance-"+Kt.id+".csv",n=t.Filename,a=function(e){let t="";for(let n of[Kt.header].concat(Kt)){for(let a=0;a<Kt.header.length;a++)e&&!e[a]||(t+=(X(n[a])&&n[a].toString().split(".")[1]?.length>2?n[a].toFixed(2):n[a])+",");t=t.replace(/(,$)/,"\n")}return t}(Kt.header.map((e=>t[e]))),(o=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),o.setAttribute("download",n),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o))})),Ea(Z("#attendanceTableAddColBtn"),(async function(){let e=await fa("Manually add attendance column (all students will be marked absent by default):",{"Attendance code":{required:!0,value:Math.random().toString().substring(2)},"Attendance time":{required:!0,type:"datetime-local",value:de().join("T")}});Ht.attendanceCodesAndTimes.map((e=>e[0])).includes(e["Attendance code"])?wa(`Cannot add column with attendance code ${e["Attendance code"]}:\nThis attendance code has already been used for another attendance.`):(Ht.attendanceCodesAndTimes.push([e["Attendance code"],e["Attendance time"].split("T").join(" ")]),Ht.attendanceCodesAndTimes.sort(((e,t)=>e[1]>t[1]?1:-1)),nn(!1))})),Ea(Z("#attendanceTableAddStudentBtn"),(async function(){let e=xt.innerText,t=xt._sectionDoc;if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await fa("Please select a section for adding a student",{},n)).clicked,!e)return}Zn((t=>{qe(),setTimeout(zt,100,t,e)}),`Find user records by using the filters below.\nClick on any user record to add that user to section ${e}.`)})),Ea(Z("#attendanceTableAddStudentsBtn"),Yt),Ea(Z("#attendanceTableClassLocBtn"),(async function(){var e=await en(xt.innerText);setTimeout((async function(){Ce(Z("#setClassLocDiv"),...e,1,(t=>e=t))}),150),await fa('<div id="setClassLocDiv" class="w300 h300"></div>')&&(tn(xt.innerText,e),Z("#classLocation").innerText=await Ae(...await en(xt.innerText)),sn())})),Ea(Z("#showAttendanceTableBtn"),(()=>{qe(),setTimeout(Gt,100)})),Ea(Z("#refreshRoomBtn"),(()=>{wn(!0)})),Ea(Z("#attendanceRoomViewLeftBtn"),(function(){--vn<0&&(vn=Ht.attendanceCodesAndTimes.length-1),bn(),yn()})),Ea(Z("#attendanceRoomViewRightBtn"),(function(){++vn>=Ht.attendanceCodesAndTimes.length&&(vn=0),bn(),yn()})),Ea(Z("#attendanceRoomViewLastBtn"),(function(){vn!=Ht.attendanceCodesAndTimes.length-1&&(vn=Ht.attendanceCodesAndTimes.length-1,bn(),Z("#attendanceRoomViewLastBtn").classList.add("disabled"))})),Ea(Z("#attendanceRoomViewZoomOutBtn"),(function(){let e=parseFloat(localStorage["roomMapZoom-"+Ht.roomId])-.1;e>.1&&(localStorage["roomMapZoom-"+Ht.roomId]=e.toFixed(1)),Ln()})),Ea(Z("#attendanceRoomViewZoomInBtn"),(function(){localStorage["roomMapZoom-"+Ht.roomId]=(parseFloat(localStorage["roomMapZoom-"+Ht.roomId])+.1).toFixed(1),Ln()})),Ea(Z("#attendanceRoomViewNamesBtn"),(function(){gn.style.setProperty("--name-visible","hidden"===gn.style.getPropertyValue("--name-visible")?"visible":"hidden")})),Ea(Z("#learnNamesImg"),kn),Ea(Z("#learnNamesName"),(function(){Z("#learnNamesName").classList.remove("hideName")})),Ea(Z("#learnNamesNextBtn"),xn),Ea(Z("#learnNamesPrevBtn"),(function(){Tn[En].indx--,0==Tn[En].indx&&ne("learnNamesPrevBtn"),In()})),Ea(Z("#learnNamesRemoveBtn"),(function(){Tn[En].splice(Tn[En].indx,1),Tn[En].indx>=Tn[En].length?xn():In()})),Ea(Z("#attendanceCollectionStatus"),(()=>Nt())),Ea(Z("#saveNameBtn"),(async function(){ca.setAttribute("disabled","true"),sa.value=Te(sa.value),da.value=Te(da.value);let e=await db.updateOne(s,auth.currentUser.email,{[v]:sa.value,[w]:da.value});e.error?wa("Unable to update name.\n"+e.error):(ne(ca),ye.n=sa.lastValue=sa.value,ye.f=da.lastValue=da.value,Sa("Name updated.","",1)),ca.removeAttribute("disabled"),De()})),Ea(Z("#helpScreen"),(()=>{ne("helpScreen")})),Ea(Z("#closeHelpBtn"),(()=>{ne("helpScreen")})),Ea(Z("#showHelpBtn"),(()=>{ae("helpScreen")})),Ea(Z("#fontPlusBtn"),(()=>{La(1)})),Ea(Z("#fontMinusBtn"),(()=>{La(-1)})),Ea(Z("#theme-switch"),(function(){ya(Ca.innerText.startsWith("dark"))})),Z("#getAttendanceClassCodeInput").addEventListener("input",(()=>Be(Bt,"Attendance passcode"))),Z("#minLateInput").addEventListener("input",nn),Z("#pointsLateInput").addEventListener("input",nn),Z("#markAttendanceClassCodeInput").addEventListener("input",ut),Z("#markAttendanceSeatCodeInput").addEventListener("input",ut),Z("#manageUsersEmailInput").addEventListener("input",Xn),Z("#manageUsersLastNameInput").addEventListener("input",Xn),Z("#manageUsersNameInput").addEventListener("input",Xn),Z("#addUsersEmails").addEventListener("input",ea),Z("#addUsersNames").addEventListener("input",ea),Z("#addUsersLastNameFirst").addEventListener("input",ea),Z("#nameInput").addEventListener("input",ua),Z("#lastNameInput").addEventListener("input",ua),Z("#editSectionIdInput").addEventListener("input",(()=>Be(Z("#editSectionIdInput"),"Section Id"))),Z("#editRoomId").addEventListener("input",(()=>Be(Z("#editRoomId"),"Room Id"))),Z("#roomsCampusSelect").addEventListener("change",Hn),Z("#roomsBuildingSelect").addEventListener("change",Fn),Z("#manageUsersSelectRoleAny").addEventListener("change",Xn),Z("#manageUsersSelectRoleStudent").addEventListener("change",Xn),Z("#manageUsersSelectRoleInstructor").addEventListener("change",Xn),Z("#manageUsersSelectRoleAdmin").addEventListener("change",Xn),Z("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,ra(e.target.value)})),Z("#allSectionsSemesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,la()})),Z("#manageUsersEmailInput").addEventListener("focus",(()=>{})),Z("#manageUsersLastNameInput").addEventListener("focus",(()=>{})),Z("#manageUsersNameInput").addEventListener("focus",(()=>{}))}();