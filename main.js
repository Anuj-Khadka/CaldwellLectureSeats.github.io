"use strict";const DOMAIN="@caldwell.edu",APP_TITLE="LectureSeats",SEMESTER_SECTION_SEPARATOR="|",INSTRUCTOR=1,ADMIN=2,REQUIRED_LOC=1,REQUIRED_SEAT=2,REQUIRED_PHOTO=4,PHOTO_TIMEOUT=6e5,DEFAULT_USER_IMG="user-icon.png",STATUS_EXCUSED=2,STATUS_ABSENT=1,STATUS_ERROR_MARKING_ATTENDANCE=-1,STATUS_PRESENT=0,cUSERS="users",cATTENDANCE="attend",cSECTIONS="sections",cROOMS="rooms",fATTENDANCES="a",fATTENDANCE_CODE="c",fABSENCE_STATUS="u",fDATETIME="d",fDURATION="m",fENROLLED_SECTIONS="e",fNAME="n",fPHOTO="p",fSEAT="s",fLOCATION="l",fNOTES="nt",fROLE="rl",fROOM_ID="r",fROOM_NAME="rn",fROOM_MAP="rm",fBUILDING="bl",fCAMPUS="cm",fSECTION_CROSS_LISTED="x",fSECTION_PATTERN="pt",fSECTION_REQUIRED_FIELDS="rq",fINSTRUCTOR_EMAILS="i",fINSTRUCTOR_NAMES="in",$=document.querySelector.bind(document);function makeFirstElementChild(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function hide(e){("string"==typeof e?document.getElementById(e):e).classList.add("hidden")}function show(e){("string"==typeof e?document.getElementById(e):e).classList.remove("hidden")}function pad0(e,t=2){return e.toString().padStart(t,"0")}function capitalize(e){return e.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" ")}function usernameFromEmail(e){try{return e.split("@")[0].replaceAll(".","_")}catch(e){}}function getDateTime(e){let t;return t=e?new Date(e?.constructor===db.Timestamp?1e3*e.seconds:e):new Date,[t.getFullYear()+"-"+pad0(t.getMonth()+1)+"-"+pad0(t.getDate()),pad0(t.getHours())+":"+pad0(t.getMinutes())]}async function getLocation(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}function download(e,t){var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function spinOnce(e){e.style.animation="",e.offsetWidth,e.style.animation="spin 0.5s",setTimeout((()=>e.style.animation=""),500)}function isMatch(e,t){if(!t)return!0;for(let n in t)if(e[n]!==t[n])return!1;return!0}var draggable,draggableOffsetX=0,draggableOffsetY=0;function makeDraggable(e,t){draggable=e,t.addEventListener("mousedown",mouseDown,!1)}function mouseDown(e){let t=e.target.getBoundingClientRect();draggableOffsetX=t.x-e.clientX,draggableOffsetY=t.y-e.clientY,window.addEventListener("mousemove",divMove,!0)}function divMove(e){draggable.style.position="fixed",draggable.style.top=e.clientY+draggableOffsetY+"px",draggable.style.left=e.clientX+draggableOffsetX+"px"}function enableDragToScroll(e){let t,n,a,o,r=!1;e.addEventListener("mousedown",(i=>{r=!0,e.classList.add("dragging"),t=i.pageX-e.offsetLeft,n=i.pageY-e.offsetTop,a=e.scrollLeft,o=e.scrollTop})),e.addEventListener("mouseleave",(t=>{r&&(r=!1,e.classList.remove("dragging"))})),e.addEventListener("mouseup",(t=>{r&&(Math.round(a)===Math.round(e.scrollLeft)&&Math.round(o)===Math.round(e.scrollTop)||(t.preventDefault(),t.stopPropagation(),window.addEventListener("click",(e=>{e.stopPropagation()}),{capture:!0,once:!0})),r=!1,e.classList.remove("dragging"))})),e.addEventListener("mousemove",(i=>{r&&(i.preventDefault(),i.stopPropagation(),e.scrollLeft=a-3*(i.pageX-e.offsetLeft-t),e.scrollTop=o-3*(i.pageY-e.offsetTop-n))}))}window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",divMove,!0)}),!1);const EARTH_RADIUS=6378137,DEGREES_PER_METER=1/(6378137*Math.PI/180);function metersToLatitude(e){return e*DEGREES_PER_METER}function metersToLongitude(e,t){return e*DEGREES_PER_METER/Math.cos(t*Math.PI/180)}function createMapInDiv(e,t,n,a,o){let r=L.map(e,{});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(r);let i=metersToLatitude(a),s=metersToLongitude(a,t);r.fitBounds([[t-i,n-s],[t+i,n+s]]);let c=L.circle([t,n],{radius:a}).addTo(r);o&&r.on("moveend",(e=>{let t=r.getCenter();t=[t.lat,t.lng],o(t),c.setLatLng(t)}))}var userDoc,distancesBetweenCoords={};function getDistanceBetweenCoords(e,t){let n=e+","+t;if(n in distancesBetweenCoords)return distancesBetweenCoords[n];let[a,o]=e,[r,i]=t;const s=a*Math.PI/180,c=r*Math.PI/180,d=(r-a)*Math.PI/180,l=(i-o)*Math.PI/180,u=Math.sin(d/2)*Math.sin(d/2)+Math.cos(s)*Math.cos(c)*Math.sin(l/2)*Math.sin(l/2);let m=6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)));return distancesBetweenCoords[n]=m,m}async function getAddr(e,t){let n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`);if(n.ok)return(await n.json()).display_name}async function signOut(){delete window.loadPath,await auth.signOut(),location.reload()}async function checkSignIn(e){if(e||auth.currentUser){if(hide("signin"),show(mainDiv),show("user"),(userDoc=await db.findOne(cUSERS,e.email))?.error)return void toastError("Failed to search database.\n\n"+userDoc.error);if(null===userDoc){userDoc={};let t=await db.insertOne(cUSERS,userDoc,e.email);if(t.error)return void toastError("Could not add user to database.\n\n"+t.error.code)}let t;userDoc.n||forceInMain("profile","Please enter your name and save."),userDoc.e||(userDoc.e={}),localStorage.semesterSelected&&!userDoc.e[localStorage.semesterSelected]&&(userDoc.e[localStorage.semesterSelected]={}),$("#userDisplayName").innerText=e.email,nameInput.value=nameInput.lastValue=userDoc.n||"",(1&userDoc.rl||2&userDoc.rl)&&(show("roomsBtn"),show("allSectionsBtn")),localStorage.markAttendanceSectionId&&showMarkAttendance(),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&(await showGetAttendance(),takingAttendance());let n=$("#semesterSelect");if(1==n.children.length){let e=await getSemesters();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),showEnrolledAndTeachingSections(a))}}else if(userDoc=null,delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,show("signin"),hide(mainDiv),hide("user"),$("#signInSendEmailInput").value=$("#signInEmailInput").value=localStorage.email||"",isSignInWithEmailLink(auth,window.loadPath||"")){delete localStorage.signInLinkSent;let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-action-code"===e?.error?toastError("This sign-in link has expired.\nPlease enter your username and click the [Send sign-in link] button to receive a new link."):"auth/invalid-email"===e?.error?(localStorage.email="",showInSignin("signinConfirmEmail")):e?.error&&toastError("Could not sign in.\n\n"+e.error)}else localStorage.email&&localStorage.signInLinkSent&&showSigninLinkSent()}function showPasswordlessSignin(){localStorage.email&&localStorage.signInLinkSent?showSigninLinkSent():showInSignin("signinSendEmail")}function hideSigninLinkSent(){delete localStorage.signInLinkSent,showInSignin("signinSendEmail")}function showSigninLinkSent(){$("#signinLinkSent > div:first-child").innerHTML=`We sent an email with a sign-in link to ${localStorage.email}${DOMAIN} on ${localStorage.signInLinkSent}.<p>The email subject should be "Sign in to LectureSeats".<p>Please go to your email and click on the sign-in link.`,showInSignin("signinLinkSent")}async function signInSendButtonClick(){if(localStorage.email=$("#signInSendEmailInput").value.trim(),!localStorage.email)return void toast("Please enter your username.");let e=await sendEmailLink(localStorage.email);"auth/invalid-email"===e?.error?(toastError(`${localStorage.email}${DOMAIN} is not a valid email address.`),localStorage.email=""):e?.error?toastError(`Could not send sign-in email to ${localStorage.email}${DOMAIN}.\n\n${e.error}`):(localStorage.signInLinkSent=getDateTime().join(" at "),showSigninLinkSent())}async function signInCompleteButtonClick(){if(localStorage.email=$("#signInConfirmEmailInput").value.trim(),!localStorage.email)return void toast("Please enter your username and click the [Sign in] button.");let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-email"===e?.error?(toastError(`Email ${localStorage.email}${DOMAIN} does not match the email address to which the link was sent.`),localStorage.email=""):e?.error&&toastError("Could not sign in.\n\n"+e.error)}function authErrorHandling(e,t){switch(e.code){case"auth/email-already-in-use":toastError(`Email address ${$("#signInEmailInput").value}${DOMAIN} already in use.`);break;case"auth/invalid-email":toastError(`Email address ${$("#signInEmailInput").value}${DOMAIN} is invalid.`);break;case"auth/operation-not-allowed":toastError("Error during sign up.");break;case"auth/user-not-found":toastError(`User ${$("#signInEmailInput").value}${DOMAIN} not found.`+(t?"":"\nDid you mean to click the Register button?"));break;case"auth/wrong-password":toastError("Wrong password.");break;case"auth/missing-password":toastError("No password provided.");break;case"auth/weak-password":toastError("Password is not strong enough. Add additional characters including special characters and numbers.");break;default:toastError("Unable to perform action.\n"+e.message);break}}function signInButtonClick(){localStorage.email=$("#signInEmailInput").value,$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),signIn($("#signInEmailInput").value,$("#signInPasswordInput").value).catch(authErrorHandling)}function registerButtonClick(){$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),signUp($("#signInEmailInput").value,$("#signInPasswordInput").value).then((e=>{})).catch(authErrorHandling)}function resetPassword(){$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),$("#signInEmailInput").value?confirm(`Would you like to send an email with a password-reset link to ${$("#signInEmailInput").value}${DOMAIN}?`)&&passwordReset($("#signInEmailInput").value).then((()=>{toast("Password reset email sent.","",1)})).catch((e=>authErrorHandling(e,!0))):toast("You must enter your email address to reset your password.")}window.addEventListener("load",(async function(){document.title=APP_TITLE,document.querySelectorAll(".domainName").forEach((e=>e.innerText=DOMAIN)),window.loadPath=window.location.href;let e=new URLSearchParams(location.search);if(window.history.pushState(null,APP_TITLE,location.origin+this.location.pathname),e.has("s")){let[t,n]=e.get("s").split("|");localStorage.semesterSelected=t,localStorage.markAttendanceSectionId=n}e.has("c")&&(localStorage.markAttendanceCode=e.get("c")),onAuth(checkSignIn,(e=>toastError("Authentication error.\n\n"+e)))}));const mainDiv=$("#main");var navDisallowMessage,navAllowed=!0;function allowNav(){navAllowed=!0,navDisallowMessage=null}function disallowNav(e){navAllowed=!1,navDisallowMessage=e}function showInSignin(e){makeFirstElementChild($("#signin"),$("#"+e))}function showInMain(e){navAllowed?window.location.hash=e:navDisallowMessage&&toast(navDisallowMessage)}function forceInMain(e,t){makeFirstElementChild(mainDiv,$("#"+e)),disallowNav(t)}function navigateBack(){navAllowed&&history.back()}function loadingScreen(e){e?(show("loading"),disallowNav()):(hide("loading"),allowNav())}window.onhashchange=function(e){navAllowed?makeFirstElementChild(mainDiv,$(location.hash||"#sections")):"#_"!==location.hash&&(location.hash="#_")},window.addEventListener("keydown",(e=>{"Escape"===e.key&&navigateBack()})),window.addEventListener("popstate",(e=>{"#getAttendance"!==location.hash&&"#attendanceTableScreen"!==location.hash&&"#room"!==location.hash&&localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&(showGetAttendance(),takingAttendance())}));var allSections={},allRooms={},allSemesters=["2023Fall","2024Winter","2024Spring"],allAttendances={},allUsers=null;async function getSemesters(){return["2023Fall","2024Winter","2024Spring"]}async function getSections(e){if(e&&!allSections[e])if(allSections[e]=await db.findOne(cSECTIONS,e),null===allSections[e])allSections[e]={};else if(allSections[e].error)return void toastError("Something went wrong.\n\nTry to reload.");return allSections[e]}async function getSection(e,t){let n=await getSections(e);if(n[t].id=t,n)return n[t]}async function getRooms(){return allRooms=await db.find(cROOMS)}async function getRoom(e){return(await getRooms())[e]}async function getRoomMap(e){return(await getRoom(e)).rm.toLowerCase().split("\n").map((e=>e.split("\t")))}async function getAttendance(e,t,n){t.constructor!==Array&&(t=[t]);var a=[];for(var o of t){let t=e+"|"+o;if(n||!allAttendances[t])if(allAttendances[t]=await db.findOne("attend",t),null===allAttendances[t])allAttendances[t]={};else{if(allAttendances[t].error)return void toastError("Something went wrong.\n\nPlease try again.");for(let e in allAttendances[t])e.length>1?(allAttendances[t][e].userId=e,allAttendances[t][e].sectionId=o,allAttendances[t][e].n=capitalize(allAttendances[t][e].n)||e,Object.entries(allAttendances[t][e].a).forEach((([e,t])=>{let n=getDateTime(t.d);t.date=n[0],t.time=n[1],t.code=e}))):a[e]=allAttendances[t][e]}a.push(...Object.entries(allAttendances[t]).filter((([e,t])=>e.length>1)).map((([e,t])=>t)))}var r={};return a.map((e=>Object.values(e.a))).flat().forEach((e=>{if("00:00"!==e.time){let t=r[e.code],n=e.date+" "+e.time;(!t||t>n)&&(r[e.code]=n)}})),a.attendanceCodesAndTimes=Object.entries(r).sort(((e,t)=>e[1]>t[1]?1:-1)),a}async function getUsers(){return allUsers||(allUsers=await db.find(cUSERS)),allUsers}const markAttendanceSectionId=$("#markAttendanceSectionId"),markAttendanceClassCodeInput=$("#markAttendanceClassCodeInput"),markAttendanceLocation=$("#markAttendanceLocation");async function showMarkAttendance(e,t){if(showInMain("markAttendance"),!e){if(e=localStorage.markAttendanceSectionId,delete localStorage.markAttendanceSectionId,(t=await getSection(localStorage.semesterSelected,e)).x?.length){let n=[e].concat(t.x),a=n.filter((e=>e in userDoc.e[localStorage.semesterSelected]));if(a.length)e=a[0];else{e=(await promptF("Please choose which section you are enrolled in.",{},n)).clicked}}userDoc.e[localStorage.semesterSelected][e]||(userDoc.e[localStorage.semesterSelected][e]={})}markAttendanceSectionId.innerText=e,$("#markAttendanceRemoveButtonSectionId").innerText=e,markAttendanceSectionId._sectionDoc=t,markAttendanceClassCodeInput.value=localStorage.markAttendanceCode||"",delete localStorage.markAttendanceCode,$("#markAttendanceSeatCodeInput").value="",show("defaultSelfieImg"),show("addPhotoBtn"),hide(selfieCanvas),hide(selfieVideo),hide("snapPhotoBtn"),hide("switchPhotoBtn"),showMarkedAttendances(localStorage.semesterSelected,e),checkMissingAttendanceInfo()}async function validateSeat(e,t){if(e=e?.toLowerCase()?.trim(),e)return(await getRoomMap(t)).flat().indexOf(e)>=0}async function checkMissingAttendanceInfo(){const e=$("#markAttendanceRequirementsList");if(e.innerHTML="",markAttendanceClassCodeInput.value||(e.appendChild(document.createElement("li")).innerText="Attendance passcode"),1&markAttendanceSectionId._sectionDoc.rq?$('label[for="markAttendanceLocation"]').classList.add("required"):$('label[for="markAttendanceLocation"]').classList.remove("required"),!markAttendanceLocation.value){let t=await getLocation();t.error?(hide(markAttendanceLocation),1&markAttendanceSectionId._sectionDoc.rq?(show("markAttendanceLocationOffButRequired"),e.appendChild(document.createElement("li")).innerText="Location"):show("markAttendanceLocationOff")):(markAttendanceLocation.value=t,show(markAttendanceLocation),hide("markAttendanceLocationOff"))}2&markAttendanceSectionId._sectionDoc.rq?$('label[for="markAttendanceSeatCodeInput"]').classList.add("required"):$('label[for="markAttendanceSeatCodeInput"]').classList.remove("required"),2&markAttendanceSectionId._sectionDoc.rq&&!await validateSeat($("#markAttendanceSeatCodeInput").value,markAttendanceSectionId._sectionDoc.r)&&(e.appendChild(document.createElement("li")).innerText="Valid seat code"),4&markAttendanceSectionId._sectionDoc.rq?$('label[for="selfieCanvas"]').classList.add("required"):$('label[for="selfieCanvas"]').classList.remove("required");let t=selfieBlob?.size&&photoTakenTime&&(new Date).getTime()-photoTakenTime<6e5;4&markAttendanceSectionId._sectionDoc.rq&&!t&&(show("defaultSelfieImg"),hide(selfieCanvas),hide(selfieVideo),selfieBlob=photoTakenTime=null,e.appendChild(document.createElement("li")).innerText="New photo"),e.innerHTML?($("#markAttendanceButton").setAttribute("disabled",!0),show("markAttendanceRequirements")):($("#markAttendanceButton").removeAttribute("disabled"),hide("markAttendanceRequirements"))}function showMarkedAttendances(e,t){let n=$("#attendanceMarked"),a=Object.values(userDoc.e[e][t]).sort(((e,t)=>e.d-t.d));if(a?.length){n.innerHTML="Attendance marked:";for(let e of a){let t=getDateTime(e.d),a=n.appendChild(document.createElement("div")),o=t[0]+" ";1===e.u?(o+="absent",a.setAttribute("absent",!0)):2===e.u?(o+="absence excused",a.setAttribute("excused",!0)):-1===e.u?(o+=t[1]+" failed to mark attendance",a.setAttribute("absent",!0)):o+=t[1],e.nt&&(o+=" <small>("+e.nt+")</small>"),a.innerHTML=o}mainDiv.scrollTop=0}else n.innerHTML=""}async function checkInfoAndMarkAttendance(){if(markAttendanceLocation.value=null,await checkMissingAttendanceInfo(),markAttendanceRequirementsList.innerHTML)toast("Missing some of the required fields.","",-1);else{let e=markAttendanceClassCodeInput.value,t=markAttendanceSectionId.innerText,n=localStorage.semesterSelected;if(e in userDoc.e[n][t]&&!userDoc.e[n][t][e].u)return void toast("You are already marked present, no need to do it again.");loadingScreen(!0);let a=$("#markAttendanceSeatCodeInput").value,o=markAttendanceLocation.value;o&&(o=[o.latitude,o.longitude,Math.round(o.accuracy)]);let r=await markAttendance(n,t,e,a,selfieBlob,o);r?.error?(showMarkedAttendances(n,t),toast(r.error,"Your attendance was NOT marked.",-1)):r?.warning?(showMarkedAttendances(n,t),toastWarn(r.warning,-.1)):(showMarkedAttendances(n,t),toast("Your attendance was marked.","Success!",1)),loadingScreen(!1)}}function photoStoragePath(e,t,n,a){return[e,t,n,a+".jpg"].join("/")}function photoStorageFolderPath(e,t,n){return[e,t,n].join("/")}async function markAttendance(e,t,n,a,o,r){let i=usernameFromEmail(auth.currentUser.email),s=`${i}.a.${n}`,c=`${i}.n`,d=`${i}.p`,l={d:db.serverTimestamp()},u={[c]:userDoc.n,[s]:l};o?.size&&(photoId=photoStoragePath(i,e,t,n),l.p=!0,u[d]=photoId),a&&(l.s=a),r&&(l.l=r);let m=await db.updateOne("attend",e+"|"+t,u);if(m?.error)return userDoc.e[e][t][n]={d:db.Timestamp.now(),u:-1},{error:"Please make sure the instructor is taking attendance, and that your attendance passcode is correct."};let g="",p=[];return m=await uploadFile(photoId,o),m?.error&&(g+="- we were unable to save your photo\n",p.push("photo not saved")),m=await db.updateOne(cUSERS,auth.currentUser.email,{["e."+e+"."+t+"."+n]:{d:db.serverTimestamp()}}),m?.error&&(g+="- we were unable to save your attendance receipt\n",p.push("missing receipt")),userDoc.e[e][t][n]={d:db.Timestamp.now(),nt:p.length?p.join(", "):""},g?{warning:"Your attendance was marked (the instructor knows you attended).\nHOWEVER:\n"+g}:void 0}$("#markAttendanceRemoveButton").addEventListener("click",(async e=>{if(confirm("Are you sure you would like to remove this section from the list of sections you are enrolled in?")){let e=markAttendanceSectionId.innerText;(await db.updateOne(cUSERS,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+e]:db.deleteField()})).error?toastError("Something went wrong. Please try again."):(delete userDoc.e[localStorage.semesterSelected][e],showEnrolledAndTeachingSections(localStorage.semesterSelected),navigateBack())}})),$("#markAttendanceButton").addEventListener("click",checkInfoAndMarkAttendance);const codeReader=new ZXing.BrowserMultiFormatReader;var currentQRstream,scanTarget;async function openQRreader(e){showInMain("QRreader"),currentQRstream=await getVideoStream(!1),scanTarget=e,startQRreader(),window.addEventListener("popstate",closeQRreader,{once:!0})}function closeQRreader(){codeReader.reset(),window.removeEventListener("popstate",closeQRreader)}function onScanResult(e,t){if(e){if(e.text?.startsWith("http")){let t=new URLSearchParams(e.text.split("?")[1]);t.has("c")&&(e={text:t.get("c")})}document.getElementById(scanTarget).value=e.text,checkMissingAttendanceInfo(),closeQRreader(),navigateBack()}!t||t instanceof ZXing.NotFoundException||toastError("Could not complete QR scan.\n"+t)}async function startQRreader(){codeReader.decodeFromStream(currentQRstream,"QRreaderVideo",onScanResult)}async function switchQRCamera(){currentQRstream=await switchCameraStream(currentQRstream),codeReader.reset(),startQRreader()}var selfieBlob=null,photoId=null,photoTakenTime=null;const selfieCanvas=$("#selfieCanvas"),selfieVideo=$("#selfieVideo");async function enableSelfieCamera(){try{await startCamera(selfieVideo,200),window.addEventListener("popstate",stopCamera,{once:!0}),hide("defaultSelfieImg"),hide(selfieCanvas),hide("addPhotoBtn"),show(selfieVideo),show("snapPhotoBtn"),show("switchPhotoBtn")}catch(e){selfiePhotoBtn.innerHTML='<span class="material-symbols-outlined">photo_camera</span> Retry taking selfie...',toastError("Unable to start camera.\nPlease make sure your camera permissions are enabled, reload, and try again.")}}async function snapPhoto(){hide(selfieVideo),hide("snapPhotoBtn"),hide("switchPhotoBtn"),show(selfieCanvas),show("addPhotoBtn"),takePhoto(selfieVideo,selfieCanvas,200),selfieBlob=await canvasToBlob(selfieCanvas),photoTakenTime=(new Date).getTime(),checkMissingAttendanceInfo()}const getAttendanceSectionId=$("#getAttendanceSectionId"),getAttendanceClassCodeInput=$("#getAttendanceClassCodeInput"),collectAttendanceBtn=$("#collectAttendanceBtn"),minutesToCollectAttendanceText=$("#minutesToCollectAttendance");async function showGetAttendance(e,t){showInMain("getAttendance"),e||(e=localStorage.takingAttendance,t=await getSection(localStorage.semesterSelected,e)),getAttendanceSectionId.innerText=e,$("#getAttendanceCrossListIds").innerHTML=t.x?"<span>"+t.x.join("</span> <span>")+"</span>":"",$("#getAttendanceSectionInfo").innerText=t.pt+"\n"+t.r+"\n"+(t.in||t.i.join("\n")),$("#getAttendanceEditBtn").onclick=t=>{editSection(e)},$("#currentAttendance").classList.add("hidden"),localStorage.minutesToCollectAttendance&&(minutesToCollectAttendanceText.innerText=localStorage.minutesToCollectAttendance),localStorage.attendanceCode?getAttendanceClassCodeInput.value=localStorage.attendanceCode:randomAttendanceClassCodeClick(),updateCurrentAttendanceRecords()}function randomAttendanceClassCodeClick(){getAttendanceClassCodeInput.value=Math.random().toString().substring(2)}minutesToCollectAttendanceText.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t)}else"ArrowUp"===e.key?e.target.innerText=(parseInt(e.target.innerText)||0)+1:isNaN(parseInt(e.key))&&!["Backspace","Delete","ArrowLeft","ArrowRight"].includes(e.key)&&e.preventDefault()}));const codeWriter=new ZXing.BrowserQRCodeSvgWriter;function createQRClick(){const e=$("#QRcode");$("#collectingAttendanceDiv");let t=location.protocol+"//"+location.host+location.pathname+"?c="+getAttendanceClassCodeInput.value+"&s="+localStorage.semesterSelected+"|"+getAttendanceSectionId.innerText;if(t!==e.getAttribute("title")){e.setAttribute("title",t),e.innerHTML="",codeWriter.writeToDom("#QRcode",t,300,300);let n=$("#QRcode > svg");n.removeAttribute("width"),n.removeAttribute("height"),n.setAttribute("viewBox","0 0 300 300"),makeDraggable(e,n)}$("#QRcode").classList.toggle("hidden")}var attendanceTimer,currentAttendanceRecords;async function collectAttendanceBtnClick(){if("Start"===collectAttendanceBtn.innerText){let e=parseInt(minutesToCollectAttendanceText.innerText);if(isNaN(e)||e<1)return void toast("Please enter a numeric value greater than or equal to 1 for the minutes attendance is to be collected.");if(e>180&&!await promptF(`WARNING: You are attempting to open attendance collection for ${Math.floor(e/60)}+ hours.\nAre you sure you wish to continue?`))return;if(!getAttendanceClassCodeInput.value)return void toast("Please enter a passcode for taking attendance.");loadingScreen(!0);let t=getAttendanceSectionId.innerText,n=await getSection(localStorage.semesterSelected,t),a=db.now()+60*e,o={i:n.i,c:getAttendanceClassCodeInput.value,d:db.serverTimestamp(),m:e},r=await db.upsertOne("attend",localStorage.semesterSelected+"|"+t,o);if(r.error)return toastError("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+r.error),void loadingScreen(!1);if(n.x?.length)for(let e of n.x)if(r=await db.upsertOne("attend",localStorage.semesterSelected+"|"+e,o),r.error)return toastError("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+r.error),void loadingScreen(!1);localStorage.minutesToCollectAttendance=e,localStorage.attendanceCode=getAttendanceClassCodeInput.value,localStorage.takingAttendance=t,localStorage.attendanceEndtime=a,takingAttendance()}else stopTakingAttendance();loadingScreen(!1)}function takingAttendance(){collectAttendanceBtn.innerText="Stop",getAttendanceClassCodeInput.setAttribute("disabled",!0),$("#getAttendance .back").setAttribute("disabled",!0),$("#collectingAttendance").innerText="Collecting",show("createQRCodeBtn"),hide("randomAttendanceClassCodeBtn"),minutesToCollectAttendanceText.removeAttribute("contenteditable"),refreshCurrentAttendance(!1),clearInterval(attendanceTimer),attendanceTimer=setInterval(updateAttendanceTime,1e3)}function updateAttendanceTime(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)stopTakingAttendance(!1);else{let t=Math.floor(e/60),n=e-60*t;minutesToCollectAttendanceText.innerText=t+":"+pad0(n)}}async function stopTakingAttendance(e=!0){if(showInMain("getAttendance"),e){let e=getAttendanceSectionId.innerText,t=await getSection(localStorage.semesterSelected,e);if(db.updateOne("attend",localStorage.semesterSelected+"|"+e,{c:db.deleteField()}),t.x?.length)for(let e of t.x)db.updateOne("attend",localStorage.semesterSelected+"|"+e,{c:db.deleteField()})}clearInterval(attendanceTimer),collectAttendanceBtn.innerText="Start",getAttendanceClassCodeInput.removeAttribute("disabled"),$("#getAttendance .back").removeAttribute("disabled"),$("#collectingAttendance").innerText="Collect",hide("QRcode"),hide("createQRCodeBtn"),show("randomAttendanceClassCodeBtn"),refreshCurrentAttendance(!0),minutesToCollectAttendanceText.setAttribute("contenteditable","true"),minutesToCollectAttendanceText.innerText=localStorage.minutesToCollectAttendance||"75",delete localStorage.takingAttendance,delete localStorage.attendanceCode,delete localStorage.attendanceEndtime}async function refreshCurrentAttendance(e=!0){$("#currentAttendance").classList.remove("hidden"),await updateCurrentAttendanceRecords(e),$("#currentAttendance > span").innerHTML=`Attendance ${getAttendanceClassCodeInput.value}:\n${currentAttendanceRecords.filter((e=>e.a[getAttendanceClassCodeInput.value])).length} of ${currentAttendanceRecords.length} marked present\n<small>(last checked ${(new Date).toLocaleTimeString()}</small>)`}async function updateCurrentAttendanceRecords(e){let t=getAttendanceSectionId.innerText,n=await getSection(localStorage.semesterSelected,t),a=[t].concat(n.x||[]);currentAttendanceRecords=await getAttendance(localStorage.semesterSelected,a,e)}async function addStudentBtnClick(){let e=getAttendanceSectionId.innerText,t=await getSection(localStorage.semesterSelected,e);if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await promptF("Please select a section for adding a student",{},n)).clicked,!e)return}await addStudentAvailableStudents(e);let n=await promptF(`Adding student to section ${e}.\n\nPlease enter student id`,{"Student ID":{oninput:"addStudentInput(this.value)",list:"addStudentUserSelectDataList"}},["Add Student","Cancel"]);"Add Student"===n.clicked&&n["Student ID"]&&addStudent(n["Student ID"],e,t)}function addStudentInput(e){}async function addStudentAvailableStudents(e){let t=new Set((await getAttendance(localStorage.semesterSelected,e)).map((e=>e.userId))),n=Object.entries(await getUsers()).filter((e=>!t.has(usernameFromEmail(e[0]))));$("#addStudentUserSelectDataList").innerHTML="";for(let e of n){let t=$("#addStudentUserSelectDataList").appendChild(document.createElement("option"));t.innerText=t.value=usernameFromEmail(e[0]),e.n&&(t.innerText+=" ("+e[1].n+")")}}async function addStudent(e,t,n){const a=e+DOMAIN;if(!(a in await getUsers()))return void toastError(`Student with the username ${e} was not found.`);const o=localStorage.semesterSelected;let r,i;if(n.x?.length&&(i=[n.id].concat(n.x).filter((e=>e.id!==t)),r=(await getAttendance(o,i)).filter((t=>t.userId===e))),r?.length){r=r[0];const n=r.sectionId;if(confirm(`Are you sure you would like to move ${e} from section ${n} to section ${t}?`)){let i=(await getUsers())[a];if(!i.e[o][t]&&i.e[o][n]){let e=await db.updateOne(cUSERS,a,{["e."+o+"."+t]:i.e[o][n],["e."+o+"."+n]:db.deleteField()});if(e.error)return void toastError("Student personal record could not be updated.\n"+e.error);i.e[o][t]=i.e[o][n],delete i.e[o][n]}let s={n:i.n,a:r.a};r.p&&(s.p=r.p);let c=await db.updateOne("attend",o+"|"+t,{[e]:s});if(c.error)return void toastError("Attendance record for student could not be created.\n"+c.error);if(allAttendances[o+"|"+t][e]=r,r.sectionId=t,c=await db.updateOne("attend",o+"|"+n,{[e]:db.deleteField()}),c.error)return void toastError("New attendance record for student was created, but the old attendance record for student could not be deleted.\n"+c.error);delete allAttendances[o+"|"+n][e],toast(`Student ${e} was successfully moved from section ${n} to section ${t}.`,"",1)}}else if(confirm(`Are you sure you would like to add ${e} to section ${t}?`)){let n=(await getUsers())[a];n.e||(n.e={}),n.e[o]||(n.e[o]={});let r={["e."+o+"."+t]:{}},s=[];if(i)for(let e of i)e in n.e[o]&&(r["e."+o+"."+e]=db.deleteField(),s.push(e));let c=await db.updateOne(cUSERS,a,r);if(c.error)return void toastError("Student personal record could not be updated.\n"+c.error);n.e[o][t]={};for(let e of s)delete n.e[o][e];if(c=await db.updateOne("attend",o+"|"+t,{[e]:{n:n.n,a:{}}}),c.error)return void toastError("Attendance record for student could not be created.\n"+c.error);allAttendances[o+"|"+t][e]={n:n.n,a:{},userId:e,sectionId:t},toast(`Student ${e} was successfully added to section ${t}.`,"",1)}createAttendanceTable()}const attendancesDiv=$("#attendances");function attendanceToday(){attendanceTable.filtered=attendanceTable.header.length-1,displayAttendanceTable()}function attendanceHistory(){delete attendanceTable.filtered,displayAttendanceTable()}var attendanceTable;enableDragToScroll(attendancesDiv);const ATTEND_CODE_SEPARATOR=" : ",ATTEND_TABLE_DATA_COL_OFFSET=7,ATTEND_TABLE_MIN_DISPLAY_COLS=[1,2];async function getClassLocation(e){let t=localStorage.getItem("loc_"+e);return t?t=JSON.parse(t):(t=await getLocation(),t=[t.latitude,t.longitude],setClassLocation(e,t)),t}function setClassLocation(e,t){localStorage.setItem("loc_"+e,JSON.stringify(t))}async function showAttendanceTable(){createAttendanceTable(),showInMain("attendanceTableScreen"),$("#classLocation").innerText=await getAddr(...await getClassLocation(getAttendanceSectionId.innerText))}async function setClassLoc(){_classLoc=await getClassLocation(getAttendanceSectionId.innerText),setTimeout((async function(){createMapInDiv($("#setClassLocDiv"),..._classLoc,1,changeClassLoc)}),150),"OK"==(await promptF('<div id="setClassLocDiv" class="w300 h300"></div>')).clicked&&(setClassLocation(getAttendanceSectionId.innerText,_classLoc),$("#classLocation").innerText=await getAddr(...await getClassLocation(getAttendanceSectionId.innerText)))}var _classLoc;function changeClassLoc(e){_classLoc=e}async function createAttendanceTable(e=!1){e&&await updateCurrentAttendanceRecords(!0);var t=parseInt($("#minLateInput").value);!t||t<1?$("#minLateInput").value=t=parseInt(localStorage.minutesConsideredLate)||20:localStorage.minutesConsideredLate=t;var n=parseInt($("#pointsLateInput").value);let a,o;!n||n<0||n>100?$("#pointsLateInput").value=n=parseInt(localStorage.pointsForLate)||50:localStorage.pointsForLate=n;for(let e of currentAttendanceRecords){e.attendAndAbsentArray=[],e.attendTimeOffsets=[],e.presentOnTime=0,e.absent=0,e.late=0;for(let[n,r]of currentAttendanceRecords.attendanceCodesAndTimes)a=e.a[n],a||(a={u:1,code:n}),e.attendAndAbsentArray.push(a),1===a.u?(e.absent++,e.attendTimeOffsets.push("absent")):2===a.u?e.attendTimeOffsets.push("excused"):(o=Math.floor((a.d-db.makeTimestamp(r))/60),o>=t?e.late++:e.presentOnTime++,e.attendTimeOffsets.push(o));e.attendanceGrade=(100*e.presentOnTime+e.late*n)/(e.presentOnTime+e.late+e.absent)}(attendanceTable=[]).semester=localStorage.semesterSelected,attendanceTable.id=getAttendanceSectionId.parentElement.innerText,attendanceTable.attendanceCodes=currentAttendanceRecords.attendanceCodesAndTimes.map((e=>e[0])),attendanceTable.attendanceTimes=currentAttendanceRecords.attendanceCodesAndTimes.map((e=>e[1])),attendanceTable.header=["Section","User","Name","Attendance-Grade","On-time","Late","Absent"].concat(attendanceTable.attendanceTimes);for(let e of currentAttendanceRecords){let t=[e.sectionId,e.userId,capitalize(e.n)||user,e.attendanceGrade,e.presentOnTime,e.late,e.absent].concat(e.attendTimeOffsets);t._fullRecord=e,attendanceTable.push(t)}displayAttendanceTable()}function createAttendanceEditingPrompt(e,t,n,a){return async function(){let o=localStorage.semesterSelected+"|"+e.sectionId,r=e.userId+".a."+t.code+".",i=n.join(" at "),s=`Record for ${e.n} (${e.userId}) for attendance taken on ${i}:\n\n`;if(t&&1!==t.u?(2===t.u?s+="Attendance excused.":(s+=`Attendance marked ${a?"after "+a+"min":"right away"}.\n\nSeat: ${t.s||"missing"}`,t.p&&(s+=`\n\n<img src="${await getLinkFromStoragePath(photoStoragePath(e.userId,localStorage.semesterSelected,e.sectionId,t.code))}" onerror="this.src='user-icon.png';" width="125">`),t.l&&(s+='<div class="locmap"></div>',setTimeout((()=>{createMapInDiv($(".locmap"),...t.l)}),150))),t.nt&&(s+="\n\nNotes:\n"+t.nt)):(s+="Absent.",t||(t={fABSENCE_STATUS:1})),"Edit attendance record"===(await promptF(s+"\n\n",{},["OK","Edit attendance record"])).clicked){let s=await promptF(`Record for ${e.n} (${e.userId}) for attendance taken on ${i}:\n\n`,{"Minutes late":{type:"number",value:t.u?"":a},Seat:t.s||"",Notes:t.nt||""},["Mark Present","Mark Absent","Mark Excused","Cancel"]);if(s.clicked.startsWith("Mark")){let i={};if("Mark Present"===s.clicked){let e=parseInt(s["Minutes late"])||0;(t.u||e!==a)&&(i[r+"d"]=db.makeTimestamp(n,e))}else{let e=db.makeTimestamp(n[0]+" 00:00");t.d!=e&&(i[r+"d"]=e)}if("Mark Present"===s.clicked&&t.u?i[r+"u"]=0:"Mark Absent"===s.clicked&&1!==t.u?i[r+"u"]=1:"Mark Excused"===s.clicked&&2!==t.u&&(i[r+"u"]=2),s.Seat!==t.s&&(i[r+"s"]=s.Seat||""),s.Notes!==t.nt&&(i[r+"nt"]=s.Notes||""),Object.keys(i).length){let n=await db.updateOne("attend",o,i);if(n.error)toastError("Unable to update attendance record.\n"+n.error);else{let n=await db.updateOne(cUSERS,e.userId+DOMAIN,{["e."+localStorage.semesterSelected+"."+e.sectionId+"."+t.code]:{u:i[r+"u"],d:i[r+"d"],nt:`updated by ${auth.currentUser.email} on ${getDateTime()[0]}`}});n.error?toastError("Updated attendance record for instructor, but unable to update student's personal attendance record.\n"+n.error):toast("Record updated.","",1),createAttendanceTable(!0)}}}}}}function createAttendanceStudentPrompt(e){return async function(){let t=`${e.n} (${e.userId})\n${e.sectionId}\n\n<img src="${await getLinkFromStoragePath(e.p)||"user-icon.png"}">\n\nAbsent: ${e.absent}\nLate: ${e.late}`,n=await promptF(t+"\n\n",{},["OK","Remove student from section"]);if("Remove student from section"===n.clicked&&(n=await promptF(`Are you sure you want to remove ${e.n} (${e.userId}) from section ${e.sectionId}?\n\nWARNING: This action will permanently DELETE all of the student's attendance records associated with this section.`,{},["DELETE student from section","Cancel"]),"DELETE student from section"===n.clicked)){const t=localStorage.semesterSelected+"|"+e.sectionId;let n=await db.updateOne("attend",t,{[e.userId]:db.deleteField()});if(n.error)return void toastError("Could not delete student record.\n\n"+n.error);n=await db.updateOne(cUSERS,e.userId+DOMAIN,{["e."+localStorage.semesterSelected+"."+e.sectionId]:db.deleteField()});let a=await deleteFiles(photoStorageFolderPath(e.userId,localStorage.semesterSelected,e.sectionId));n.error&&a.error?toastError("Deleted student from section, but failed to update student's personal record and could not delete student's uploaded photos."):n.error?toastError("Deleted student from section, but failed to update student's personal record."):a.error?toastError("Deleted student from section, but could not delete student's uploaded photos."):toast(`${e.n} (${e.userId}) was deleted from section ${e.sectionId}.`,"",1),createAttendanceTable(!0)}}}async function displayAttendanceTable(){attendancesDiv.innerHTML="";var e=parseInt($("#minLateInput").value),t=await getClassLocation(getAttendanceSectionId.innerText);e||($("#minLateInput").value=e=parseInt(localStorage.minutesConsideredLate)||20);for(let o of[attendanceTable.header].concat(attendanceTable)){var n=attendancesDiv.appendChild(document.createElement("row"));for(let r=0;r<attendanceTable.header.length;r++)if(!attendanceTable.filtered||ATTEND_TABLE_MIN_DISPLAY_COLS.concat([attendanceTable.filtered]).includes(r)){var a=n.appendChild(document.createElement("div"));if(o===attendanceTable.header)a.innerText=o[r],a.title=attendanceTable.attendanceCodes[r-7],a.addEventListener("click",(()=>sortAttendanceTable(r))),a.classList.add("table-header");else if(r>=7){a.innerHTML="excused"===o[r]?"➖":"absent"===o[r]?"❌":o[r]<e?"✔️":"+"+o[r]+"min";let n=o._fullRecord.attendAndAbsentArray[r-7];if("excused"!==o[r]&&"absent"!==o[r])if(n.s||a.classList.add("missingSeat"),n.p||a.classList.add("missingPhoto"),n.l){a.classList.add("hasLocation");let e=getDistanceBetweenCoords(n.l,t);a.style.setProperty("--distColor",`rgb(${e/15},${255-e/15},0)`)}else a.classList.add("missingLocation");a.onclick=createAttendanceEditingPrompt(o._fullRecord,n,attendanceTable.header[r].split(" "),o[r]),a.style.textAlign="center"}else a.innerText=o[r],a.onclick=createAttendanceStudentPrompt(o._fullRecord),isNaN(parseFloat(o[r]))||(a.style.textAlign="center",Number.isInteger(o[r])||(a.innerText=o[r].toFixed(1)))}}attendancesDiv.style.setProperty("--colNum",n.children.length)}var sortedFields=[];function sortAttendanceTable(e){sortedFields[e]=-1==sortedFields[e]?1:-1;attendanceTable.sort(((t,n)=>{let a="excused"===t[e]?9e8:"absent"===t[e]?9e9:t[e],o="excused"===n[e]?9e8:"absent"===n[e]?9e9:n[e];return a<o?sortedFields[e]:o<a?-1*sortedFields[e]:t._indx-n._indx})).forEach(((e,t)=>e._indx=t)),displayAttendanceTable()}function attendanceCSV(){let e="";for(let t of[attendanceTable.header].concat(attendanceTable)){for(let n=0;n<attendanceTable.header.length;n++)e+=t[n]+",";e+="\n"}return e}function downloadAttendanceRecord(){download("attendance-"+attendanceTable.id+".csv",attendanceCSV())}const roomMap=$("#roomMap"),roomMapHolder=$("#roomMapHolder");async function showRoom(e=!1){e&&await updateCurrentAttendanceRecords(!0);let t=await getSection(localStorage.semesterSelected,getAttendanceSectionId.innerText),n=await getRoomMap(t.r),a=n.flat().filter((e=>e));var o={},r=[],i=[],s=currentAttendanceRecords.attendanceCodesAndTimes[currentAttendanceRecords.attendanceCodesAndTimes.length-1][0];for(let e of currentAttendanceRecords){let t=e.a[s];if(t&&2!==t.u&&1!==t.u){let n=t.s?.toLowerCase()?.trim();e._seat=n,e._notes=t.nt,e._time=t.time,a.includes(n)&&!o[n]?o[n]=e:i.push(e)}else r.push(e),t&&(e._notes=t.nt),t&&2===t.u?e._time="excused":e._time="absent"}roomMap.innerHTML="",roomMap._rows=n.length,roomMap._cols=0;for(let e=0;e<n.length;e++){let t=n[e];roomMap._cols=Math.max(roomMap._cols,t.length);let a=roomMap.appendChild(document.createElement("div"));for(let r=0;r<t.length;r++){let t=n[e][r],i=a.appendChild(document.createElement("div"));if(t){i.classList.add("seat");let e=o[t];e?addStudentToSeat(i,e):i.innerText=t}}}let c=roomMap.appendChild(document.createElement("div"));c.classList.add("bad-seating");for(let e of i){let t=c.appendChild(document.createElement("div"));t.classList.add("seat"),addStudentToSeat(t,e)}let d=roomMap.appendChild(document.createElement("div"));d.classList.add("absent");for(let e of r){let t=d.appendChild(document.createElement("div"));t.classList.add("seat"),addStudentToSeat(t,e)}let l=parseFloat(localStorage.roomMapZoom)||1;roomMap.style.setProperty("--seat-width",25*l+"px"),roomMap.style.setProperty("--seat-height",25*l+"px"),c.style.maxWidth=`calc(var(--seat-width) * ${roomMap._cols})`,d.style.maxWidth=`calc(var(--seat-width) * ${roomMap._cols})`,$("#roomMapZoom").value=l,showInMain("room"),setTimeout((()=>{roomMapHolder.scrollLeft=(roomMapHolder.scrollWidth-roomMapHolder.offsetWidth)/2}),100)}function addStudentToSeat(e,t){e.classList.add("taken"),getLinkFromStoragePath(t.p).then((t=>e.style.backgroundImage=`url("${t||"user-icon.png"}"), url(user-icon.png)`)),e.innerHTML=`<span>${t.n.split(" ")[0]}</span>`,e.onmouseover=()=>{e.innerHTML=`<span>${t.n.split(" ")[0]}\n${t.userId}\n${t.sectionId}\n${t._seat||""}\n${t._time}\n${t._notes||""}</span>`},e.onmouseout=()=>{e.innerHTML=`<span>${t.n.split(" ")[0]}</span>`,e.classList.remove("enlarge")},e.onclick=()=>{e.classList.toggle("enlarge")}}function changeRoomMapSize(e){let t=parseFloat(e.value);e.title=(100*t).toFixed(0)+"%",roomMap.style.setProperty("--seat-width",25*t),roomMap.style.setProperty("--seat-height",25*t),localStorage.roomMapZoom=t}function roomNames(e){roomMap.style.setProperty("--name-visible",e?"visible":"hidden")}enableDragToScroll(roomMapHolder);let learnNameRecs={},learnNameIndx=0;async function learnNamesNextBtnClick(){let e=learnNameRecs[localStorage.semesterSelected+"|"+getAttendanceSectionId.innerText];e?.length||(e=learnNameRecs[localStorage.semesterSelected+"|"+getAttendanceSectionId.innerText]=(await getAttendance(localStorage.semesterSelected,getAttendanceSectionId.innerText)).map((e=>({r:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({r:e})=>e)),window.addEventListener("popstate",clearLearnNames,{once:!0}));let t=e.pop();$("#learnNamesImg").src=await getLinkFromStoragePath(t.p),$("#learnNamesName").innerText=t.n,$("#learnNamesName").classList.add("hideName")}function clearLearnNames(){learnNameRecs={},$("#learnNamesImg").src="user-icon.png",$("#learnNamesName").innerText="",$("#learnNamesName").classList.add("hideName")}function learnNamesNameClick(){$("#learnNamesName").classList.remove("hideName")}const CREATE_SECTION_BUTTON_TEXT="Create New Section";async function deleteSection(e,t){if(confirm("Are you sure you want to delete section "+t+" for "+e+"?\n\nWARNING: All attendance data for this section and any cross-listed sections will be deleted.")){(await db.updateOne(cSECTIONS,e,null)).error?toastError("Cannot delete section."):(delete(await getSections(e))[t],showEnrolledAndTeachingSections(e),navigateBack())}}async function createNewSection(){let e;$("#sectionSubmitBtn").innerText="Create New Section",showInMain("addInstructorSection");let t=$("#sectionSemesterSelect");if(t.removeAttribute("disabled"),1==t.children.length){let n=await getSemesters();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}for(let e of t.children)e.innerText==localStorage.semesterSelected?e.setAttribute("selected",!0):e.removeAttribute("selected");let n=$("#sectionRoomSelect");if(1==n.children.length){let t=await getRooms();for(let a in t)e=n.appendChild(document.createElement("option")),e.id=e.value=a,e.innerText=t[a].bl+" - "+t[a].rn}$("#sectionInstructorEmailsInput").value||($("#sectionInstructorEmailsInput").value=auth.currentUser.email),$("#sectionInstructorNamesInput").value||($("#sectionInstructorNamesInput").value=userDoc.n),$("#sectionIdInput").removeAttribute("disabled")}async function editSection(e){$("#sectionSubmitBtn").innerText="Save Section",showInMain("addInstructorSection");let t,n=await getSection(localStorage.semesterSelected,e),a=$("#sectionSemesterSelect");if(a.setAttribute("disabled",!0),1==a.children.length){let e=await getSemesters();for(let n of e)t=a.appendChild(document.createElement("option")),t.id=t.value=t.innerText=n}for(let e of a.children)e.innerText==localStorage.semesterSelected?(e.setAttribute("selected",!0),a.value=e.value):e.removeAttribute("selected");let o=$("#sectionRoomSelect");if(1==o.children.length){let e=await getRooms();for(let n in e)t=o.appendChild(document.createElement("option")),t.id=t.value=n,t.innerText=e[n].bl+" - "+e[n].rn}for(let e of o.children)e.value==n.r?(e.setAttribute("selected",!0),o.value=e.value):e.removeAttribute("selected");$("#sectionIdInput").setAttribute("disabled",!0),$("#sectionIdInput").value=e,$("#sectionPatternInput").value=n.pt,$("#sectionCrosslistInput").value=n.x?.join("\n")||"",$("#sectionInstructorEmailsInput").value=n.i?.join("\n")||"",$("#sectionInstructorNamesInput").value=n.in||"",$("#sectionLocRequiredCheckbox").checked=1&n.rq,$("#sectionSeatRequiredCheckbox").checked=2&n.rq,$("#sectionPhotoRequiredCheckbox").checked=4&n.rq}function makeSectionCard(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard";var r=o.appendChild(document.createElement("div"));return r.class="cardTitle",r.innerText=e,a&&t.x&&(r.innerText+="\n"+t.x.join("\n")),(r=o.appendChild(document.createElement("div"))).innerText=t.pt,(r=o.appendChild(document.createElement("div"))).innerText=t.r,(r=o.appendChild(document.createElement("div"))).innerText=t.in||t.i,o.addEventListener("click",n),o}async function getAttendanceCardClick(e){showGetAttendance(e.currentTarget.id,e.currentTarget._sectionDoc)}function markAttendanceCardClick(e){showMarkAttendance(e.currentTarget.id,e.currentTarget._sectionDoc)}async function addSectionToStudentClick(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne(cUSERS,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+t]:{}})).error?toastError("Failed to add section.\n\nPlease try again."):(userDoc.e[localStorage.semesterSelected]||(userDoc.e[localStorage.semesterSelected]={}),userDoc.e[localStorage.semesterSelected][t]={},addSectionCard(t,n,$("#studentSections"),markAttendanceCardClick),navigateBack())}function addSectionCard(e,t,n,a,o){var r=makeSectionCard(e,t,a,o);n.insertBefore(r,n.lastElementChild)}async function showAvailableStudentSections(){showInMain("selectStudentSection");var e=await getSections(localStorage.semesterSelected),t=$("#availableStudentSections");t.innerHTML="<span></span>";let n=Object.keys(e).sort(),a=new Set(userDoc.e&&userDoc.e[localStorage.semesterSelected]?Object.keys(userDoc.e[localStorage.semesterSelected]):[]);for(let o of n){let n=e[o];if(!a.has(o)&&!n.x?.filter((e=>a.has(e))).length&&(addSectionCard(o,n,t,addSectionToStudentClick),n.x?.length))for(let e of n.x)addSectionCard(e,n,t,addSectionToStudentClick)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")}async function showEnrolledAndTeachingSections(e){var t=$("#studentSections"),n=$("#instructorSections");if(!e)return hide(t),void hide(n);show(t),1&userDoc.rl&&show(n);var a=await getSections(e);for(let e=t.childElementCount-1;e--;)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let r=a[o];if(userDoc.e&&userDoc.e[e]&&o in userDoc.e[e])addSectionCard(o,r,t,markAttendanceCardClick);else if(r.x?.length)for(let n of r.x)userDoc.e&&userDoc.e[e]&&n in userDoc.e[e]&&addSectionCard(n,r,t,markAttendanceCardClick);!n.classList.contains("hidden")&&r.i?.includes(auth.currentUser.email)&&addSectionCard(o,r,n,getAttendanceCardClick,!0)}}$("#sectionSubmitBtn").addEventListener("click",(async e=>{let t="Create New Section"===$("#sectionSubmitBtn").innerText,n=$("#sectionSemesterSelect").value,a=$("#sectionIdInput").value,o={r:$("#sectionRoomSelect").value,i:$("#sectionInstructorEmailsInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),in:$("#sectionInstructorNamesInput").value.trim(),pt:$("#sectionPatternInput").value,x:$("#sectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),rq:1*$("#sectionLocRequiredCheckbox").checked|2*$("#sectionSeatRequiredCheckbox").checked|4*$("#sectionPhotoRequiredCheckbox").checked};if(!n)return void toast("Please select semester.","Missing information:",-1);if(!a)return void toast("Please enter section id.","Missing information:",-1);if(t&&a.includes("|"))return void toast('Specified section id includes an invalid character "|".',"Invalid section id:",-1);if(t&&await getSection(n,a))return void toast("Section "+a+" already exists.","Duplicate section id:",-1);if(!o.pt)return void toast("Please enter section day/time pattern.","Missing information:",-1);if(!o.r)return void toast("Please select a room.","Missing information:",-1);if(!o.i)return void toast("Please enter section instructor email(s).","Missing information:",-1);if(!o.in)return void toast("Please enter section instructor name(s).","Missing information:",-1);let r=await getSections(n);for(let e in r)if(e!==a){let t=r[e];if(t.pt===o.pt&&t.r===o.r)return void toast(t.r+" is booked at this time by section "+e+".\n\nIf these sections are cross-listed, please edit information for "+e+" to indicate this, rather than creating a new section.","",-1)}(await db.updateOne(cSECTIONS,n,{[a]:o})).error?toastError("Failed to add section.\n\nPlease try again."):(r[a]=o,n===localStorage.semesterSelected&&(t&&addSectionCard(a,o,$("#instructorSections")),showEnrolledAndTeachingSections(localStorage.semesterSelected)),a===getAttendanceSectionId.innerText&&($("#getAttendanceCrossListIds").innerHTML=o.x?"<span>"+o.x.join("</span> <span>")+"</span>":"",$("#getAttendanceSectionInfo").innerText=o.pt+"\n"+o.r+"\n"+(o.in||o.i.join("\n"))),navigateBack())})),$("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,showEnrolledAndTeachingSections(e.target.value)}));const nameInput=$("#nameInput"),saveNameBtn=$("#saveNameBtn");function promptF(e,t={},n){return new Promise((function(a,o){disallowNav(),$("#promptFormTitle").innerHTML=e;let r={};for(let e in t)$("#promptForm").appendChild(document.createElement("span")).innerText=e,r[e]=$("#promptForm").appendChild(document.createElement("input")),r[e].id=e,"number"==typeof t[e]?(r[e].setAttribute("type","number"),r[e].value=t[e]):"string"==typeof t[e]?r[e].value=t[e]:Object.entries(t[e]).forEach((t=>r[e].setAttribute(t[0],t[1])));for(let e of n||["OK","Cancel"]){let t=$("#promptButtons").appendChild(document.createElement("button"));t.innerText=e,t.onclick="cancel"===e.toLowerCase()?()=>{a(!1),hidePrompt()}:()=>{let t=Object.fromEntries(Object.entries(r).map((([e,t])=>[e,t.value])));t.clicked=e,a(t),hidePrompt()}}$("#prompt").classList.remove("hidden")}))}function hidePrompt(){$("#promptForm").innerHTML="",$("#promptButtons").innerHTML="",$("#prompt").classList.add("hidden"),allowNav()}nameInput.addEventListener("input",(e=>{let t=nameInput.value.trim();t&&nameInput.lastValue!==t?show(saveNameBtn):hide(saveNameBtn)})),saveNameBtn.addEventListener("click",(async e=>{saveNameBtn.setAttribute("disabled","true");let t=await db.updateOne(cUSERS,auth.currentUser.email,{n:nameInput.value.trim()});t.error?toastError("Unable to update name.\n"+t.error):(hide(saveNameBtn),userDoc.n=nameInput.lastValue=nameInput.value,toast("Name updated.","",1)),saveNameBtn.removeAttribute("disabled"),allowNav()}));const toastDiv=$("#toast"),toastMsg=$("#toastMessage");function toast(e,t,n){if(n?toastDiv.style.setProperty("--toast-accent",n>0?"#4f6":n<-.5?"#f64":"#fe4"):toastDiv.style.setProperty("--toast-accent","gray"),toastMsg.innerHTML=t?t+"\n\n":"","object"==typeof e)for(let t in e)e[t]&&(toastMsg.innerHTML+=t+" : "+e[t]+"\n");else toastMsg.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",closeToast),window.addEventListener("keydown",closeToast),window.addEventListener("popstate",closeToast),mainDiv.addEventListener("scroll",closeToast),show(toastDiv),toastDiv.classList.add("slide-up")}),200)}function toastWarn(e){toast(e,"Warning",-.1)}function toastError(e){toast(e,"Error",-1)}function closeToast(){window.removeEventListener("mousedown",closeToast),window.removeEventListener("keydown",closeToast),window.removeEventListener("popstate",closeToast),mainDiv.removeEventListener("scroll",closeToast),hide(toastDiv),toastDiv.classList.remove("slide-up")}const themeToggle=$("#theme-switch");function toggleDarkMode(){setTheme(themeToggle.innerText.startsWith("dark"))}function setTheme(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),themeToggle.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),themeToggle.innerText="dark_mode")}function changeFontSize(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}setTheme(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);