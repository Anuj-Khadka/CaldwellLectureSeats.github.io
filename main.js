"use strict";!function(){const e="2024-02-04",t="LectureSeats",n="v0.1."+e.replace(/-/g,"")+" (beta)",a="@caldwell.edu",o=[40.83352325048076,-74.27245652688725],i="|",r="user-icon.png",l=200,s="users",d="attend",c="sections",u="rooms",m="a",f="c",p="u",h="d",g="m",S="e",v="n",w="f",b="p",y="s",C="l",A="nt",T="rl",E="rn",I="rm",k="bl",x="cm",B="x",R="pt",$="i",N="in",P="Section",U="Email",O="Username",M="Name",_="Last Name",D="Attendance-Grade",H="On-time",F="Late",j="Absent",W=[U,O,_,M,P,D,H,F,j],q=[_,M,O,P,D,j,F,H,U],V=W.length,J="abcdefghijklmnopqrstuvwxyz",Y=(e,t)=>e+i+t,Q=e=>e.split(i),z=e=>e?e.replace(/\s/g,"").toUpperCase():"",Z=document.querySelector.bind(document);function X(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function K(e){("string"==typeof e?document.getElementById(e):e).classList.add("hidden")}function G(e){("string"==typeof e?document.getElementById(e):e).classList.remove("hidden")}function ee(e){("string"==typeof e?document.getElementById(e):e).classList.toggle("hidden")}function te(e){return e.map((e=>({r:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({r:e})=>e))}function ne(e){return Math.floor(Math.random()*e)}function ae(e){return e.split("\n").map((e=>e.split("\t")))}function oe(e,t=2){return e.toString().padStart(t,"0")}function ie(e){let t;return t=e?new Date(e?.constructor===db.Timestamp?1e3*e.seconds:e):new Date,[t.getFullYear()+"-"+oe(t.getMonth()+1)+"-"+oe(t.getDate()),oe(t.getHours())+":"+oe(t.getMinutes())]}function re(e){e.style.animation="",e.offsetWidth,e.style.animation="spin 0.5s",setTimeout((()=>e.style.animation=""),500)}var le=[];function se(e,t,n){n?(le=n).indx=0:le.indx=(le.indx+(e||1+ne(le.length-1)))%le.length,t&&(le.target=t),le.target&&(le.target.src=le[le.indx])}var de,ce,ue=0,me=0;function fe(e){let t=e.target.getBoundingClientRect();ue=t.x-e.clientX,me=t.y-e.clientY,window.addEventListener("mousemove",pe,!0)}function pe(e){de.style.position="fixed",de.style.top=e.clientY+me+"px",de.style.left=e.clientX+ue+"px"}function he(e){let t,n,a,o,i=!1;e.addEventListener("mousedown",(r=>{i=!0,e.classList.add("dragging"),t=r.pageX-e.offsetLeft,n=r.pageY-e.offsetTop,a=e.scrollLeft,o=e.scrollTop})),e.addEventListener("mouseleave",(t=>{i&&(i=!1,e.classList.remove("dragging"))})),e.addEventListener("mouseup",(t=>{i&&(Math.round(a)===Math.round(e.scrollLeft)&&Math.round(o)===Math.round(e.scrollTop)||(t.preventDefault(),t.stopPropagation(),window.addEventListener("click",(e=>{e.stopPropagation()}),{capture:!0,once:!0})),i=!1,e.classList.remove("dragging"))})),e.addEventListener("mousemove",(r=>{i&&(r.preventDefault(),r.stopPropagation(),e.scrollLeft=a-3*(r.pageX-e.offsetLeft-t),e.scrollTop=o-3*(r.pageY-e.offsetTop-n))}))}window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",pe,!0),ce&&ce(de.style.left,de.style.top)}),!1);const ge=1/(6378137*Math.PI/180);function Se(e,t,n,a,o){let i=L.map(e,{});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(i);let r=a*ge;let l=function(e,t){return e*ge/Math.cos(t*Math.PI/180)}(a,t);i.fitBounds([[t-r,n-l],[t+r,n+l]]);let s=L.circle([t,n],{radius:a}).addTo(i);o&&i.on("moveend",(e=>{let t=i.getCenter();t=[t.lat,t.lng],o(t),s.setLatLng(t)}))}var ve,we={};function be(e,t){let n=e+","+t;if(n in we)return we[n];let[a,o]=e,[i,r]=t;const l=a*Math.PI/180,s=i*Math.PI/180,d=(i-a)*Math.PI/180,c=(r-o)*Math.PI/180,u=Math.sin(d/2)*Math.sin(d/2)+Math.cos(l)*Math.cos(s)*Math.sin(c/2)*Math.sin(c/2);let m=6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)));return we[n]=m,m}async function ye(e,t){let n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`);if(n.ok)return(await n.json()).display_name}function Ce(e){return(e=e.trim()).split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}function Le(e){return e.replaceAll(" ",".")+a}function Ae(e){try{return e.split("@")[0].replaceAll("."," ")}catch(e){}}function Te(e){return e?.target&&(e=e.target.value),e.search(/(^(?!(__)))(?!.*(\.\.))(^([a-zA-Z0-9-_.]+)$)/)>=0}function Ee(e,t){let n=e.value.search(/(^(?!(__)))(^([a-zA-Z0-9-_]+)$)/)>=0;return n||(e.value=e.value.replace(/[^A-Za-z0-9-_]+/g,"").replace(/^_+/,"_"),t&&ua(t+" can only contain letters, numbers, dashes, and underscores.\nCannot start with two underscores.")),n}async function Ie(){delete window.loadPath,await auth.signOut(),location.reload()}async function ke(e){if(e){if(K("signin"),G($e),G("user"),(ve=await db.getDoc(s,e.email))?.error)return void _e("dbError");if(null===ve){ve={};let t=await db.insertOne(s,e.email,ve);if(t.error)return void fa("Could not add user to database.\n\n"+t.error.code)}let t;ve.n&&ve.f||De("profile","Please enter your last name and your preferred name and save."),e.email.startsWith("_test_")||!auth.currentUser.emailVerified?(localStorage.verificationEmailSent?Z("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent:await xe(),G("emailVerificationLink"),De("profile","Please verify your email address before proceeding.")):(delete localStorage.verificationEmailSent,K("emailVerificationLink")),ve.e||(ve.e={}),localStorage.semesterSelected&&!ve.e[localStorage.semesterSelected]&&(ve.e[localStorage.semesterSelected]={}),Z("#userDisplayName").innerText=e.email,na.value=na.lastValue=ve.n||"",aa.value=aa.lastValue=ve.f||"",2&ve.rl&&(G("allSectionsBtn"),G("manageUsersBtn")),(1&ve.rl||2&ve.rl)&&G("roomsBtn"),localStorage.markAttendanceSectionId&&rt(),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&await xt();let n=Z("#semesterSelect");if(1==n.children.length){let e=await Ye();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),ea(a))}}else if(ve=null,delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,G("signin"),K($e),K("user"),Z("#signInSendEmailInput").value=Z("#signInEmailInput").value=localStorage.email||"",isSignInWithEmailLink(auth,window.loadPath||"")){delete localStorage.signInLinkSent;let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-action-code"===e?.error?fa("This sign-in link has expired.\nPlease enter your username and click the [Send sign-in link] button to receive a new link."):"auth/invalid-email"===e?.error?(localStorage.email="",Me("signinConfirmEmail")):e?.error&&fa("Could not sign in.\n\n"+e.error)}else localStorage.email&&localStorage.signInLinkSent&&Be()}async function xe(){try{await sendEmailVerification(window.auth.currentUser),localStorage.verificationEmailSent=ie().join(" at "),Z("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent,ua("Email verification link was sent to "+auth.currentUser.email)}catch(e){"auth/too-many-requests"===e.code?fa("Cannot send another email yet.\nPlease wait a few minutes before retrying."):fa("Could not send email.\n"+e.code)}}function Be(){Z("#signinLinkSent > div:first-child").innerHTML=`We sent an email with a sign-in link to ${localStorage.email}${a} on ${localStorage.signInLinkSent}.<p>The email subject should be "Sign in to LectureSeats".<p>Please go to your email and click on the sign-in link.`,Me("signinLinkSent")}function Re(e,t){switch(e.code){case"auth/email-already-in-use":fa(`Email address ${Z("#signInEmailInput").value}${a} already in use.`);break;case"auth/invalid-email":fa(`Email address ${Z("#signInEmailInput").value}${a} is invalid.`);break;case"auth/operation-not-allowed":fa("Error during sign up.");break;case"auth/user-not-found":fa(`User ${Z("#signInEmailInput").value}${a} not found.`+(t?"":"\nDid you mean to click the Register button?"));break;case"auth/wrong-password":fa("Wrong password.");break;case"auth/missing-password":fa("No password provided.");break;case"auth/weak-password":fa("Password is not strong enough. Add additional characters including special characters and numbers.");break;default:fa("Unable to perform action.\n"+e.message);break}}window.addEventListener("load",(async function(){if(navigator.userAgent.includes("Firefox"))return K("signin"),G($e),void($e.innerHTML="Sorry, this app does not work on Firefox.<p>Please use Chrome or Safari for best experience.");let e;setInterval((()=>{e&&navigator.onLine?(Ue(),_e("sections"),e=!1):e||this.navigator.onLine||(De("offlineError"),e=!0)}),500),setTimeout((()=>location.reload()),864e5),document.title=t,document.querySelectorAll(".domainName").forEach((e=>e.innerText=a)),Z("#versionInfo").innerText=`LectureSeats ${n}\n\nApplication last updated on: 2024-02-04.\n`,window.loadPath=window.location.href;let o=new URLSearchParams(location.search);if(window.history.pushState(null,t,location.origin+this.location.pathname),o.has("s")){let[e,t]=Q(o.get("s"));localStorage.semesterSelected=e,localStorage.markAttendanceSectionId=t}o.has("c")&&(localStorage.markAttendanceCode=o.get("c")),onAuth(ke,(e=>fa("Authentication error.\n\n"+e)))}));const $e=Z("#main");var Ne,Pe=!0;function Ue(){Pe=!0,Ne=null}function Oe(e){Pe=!1,Ne=e}function Me(e){X(Z("#signin"),Z("#"+e))}function _e(e){Pe?window.location.hash=e:Ne&&ua(Ne)}function De(e,t){X($e,Z("#"+e)),Oe(t)}function He(){Pe&&history.back()}function Fe(e){e?(G("loading"),Oe()):(K("loading"),Ue())}window.onhashchange=function(e){Pe?(X($e,Z(location.hash||"#sections")),$e.scrollTop=0):"#_"!==location.hash&&(location.hash="#_")},window.addEventListener("keydown",(e=>{"Escape"===e.key&&He()})),window.addEventListener("popstate",(e=>{K("helpScreen")}));var je={},We={},qe={},Ve={},Je={};async function Ye(){return["2023Fall","2024Winter","2024Spring","2024Summer","2024Fall"]}async function Qe(e){if(e&&!je[e])if(je[e]=await db.getDoc(c,e),null===je[e])je[e]={};else if(je[e].error)return void fa("Something went wrong.\n\nTry to reload.");return je[e]}async function ze(e,t){let n=await Qe(e);if(n[t])return n[t].id=t,n[t]}async function Ze(e){return!e&&We._gotAllRooms||((We=await db.find(u))._gotAllRooms=!0),We}async function Xe(e){return ae((await async function(e){return e in We||(We[e]=await db.getDoc(u,e)),We[e]}(e)).rm.toUpperCase())}async function Ke(e,t,n){t.constructor!==Array&&(t=[t]);var a=[];for(var o of(a._docs=[],a._sectionIds=[],t)){let t=Y(e,o);if(n||!qe[t])if(qe[t]=await db.getDoc(d,t),null===qe[t])qe[t]={};else{if(qe[t].error)return void fa("Something went wrong.\n\nPlease try again.");for(let e in qe[t])e.length>1&&(qe[t][e].Email=Le(e),qe[t][e].Username=e,qe[t][e].Section=o,Object.entries(qe[t][e].a).forEach((([e,t])=>{let n=ie(t.d);t.date=n[0],t.time=n[1],t.code=e})))}a.push(...Object.entries(qe[t]).filter((([e,t])=>e.length>1)).map((([e,t])=>t))),a._docs.push(qe[t])}return a._sectionIds=t,a}async function Ge(e,t){if(!e)return{};if(e.constructor===Array)return Object.assign(...await Promise.all(e.map((e=>Ge(e,t)))));e=t?t===v||t===w?Ce(e):e:e.toLowerCase();let n=t?t+":"+e:e,a=Je[n];return a?Object.fromEntries(a.map((e=>[e,Ve[e]]))):t&&t!==v&&t!==w||(a=Object.entries(Je).filter((e=>n.startsWith(e[0]))).map((e=>e[1]))[0],!a)?(a=t?t===v||t===w?await db.find(s,db.orderBy(t),...db.startsWith(t,e)):await db.find(s,db.orderBy(t),db.where(t,"==",e)):await db.find(s,db.orderBy(db.documentId()),...db.startsWith(db.documentId(),e)),a.error||(Object.assign(Ve,a),Je[n]=Object.keys(a)),a):(a=a.map((e=>[e,Ve[e]])),Object.fromEntries(a.filter((n=>t?n[1][t].startsWith(e):n[0].startsWith(e)))))}async function et(e){let t={},n=[];for(let a of e)a in Ve?t[a]=Ve[a]:n.push(a);if(!n.length)return t;for(let e=0;e<n.length;e+=30){let a=await db.find(s,db.where(db.documentId(),"in",n.slice(e,e+30)));if(a.error)return a;Object.assign(t,a),Object.assign(Ve,a)}return t}async function tt(e){let t=Ve[e];if(t)return t;let n=await db.getDoc(s,e);return n?.error||n&&(Ve[e]=n),n}function nt(e,t="",n=""){if(!e.n&&!e.f)return"";let a;return a=e.n&&e.f?e.n.split(" ").includes(e.f)?e.n:e.f+", "+e.n:e.n||e.f,t+a+n}const at=Z("#markAttendanceSectionId"),ot=Z("#markAttendanceClassCodeInput"),it=Z("#markAttendanceLocation");async function rt(e,t){if(_e("markAttendance"),!e){if(e=localStorage.markAttendanceSectionId,delete localStorage.markAttendanceSectionId,(t=await ze(localStorage.semesterSelected,e)).x?.length){let n=[e].concat(t.x),a=n.filter((e=>e in ve.e[localStorage.semesterSelected]));if(a.length)e=a[0];else{e=(await la("Please choose which section you are enrolled in.",{},n)).clicked}}ve.e[localStorage.semesterSelected][e]||(ve.e[localStorage.semesterSelected][e]={})}at.innerText=e,at._sectionDoc=t,Z("#markAttendanceRemoveButtonSectionId").innerText=e,ot.value=localStorage.markAttendanceCode||"",delete localStorage.markAttendanceCode,t.s<0?K("markAttendanceSeatContainer"):(G("markAttendanceSeatContainer"),t.s>0?Z('label[for="markAttendanceSeatCodeInput"]').classList.add("required"):Z('label[for="markAttendanceSeatCodeInput"]').classList.remove("required"),Z("#markAttendanceSeatCodeInput").value=""),at._sectionDoc.p<0?K("markAttendancePhotoContainer"):(G("markAttendancePhotoContainer"),at._sectionDoc.p>0?Z('label[for="selfieCanvas"]').classList.add("required"):Z('label[for="selfieCanvas"]').classList.remove("required"),G("defaultSelfieImg"),G("addPhotoBtn"),K(yt),K(Ct),K("snapPhotoBtn"),K("switchPhotoBtn")),at._sectionDoc.l<0?K("markAttendanceLocationContainer"):(G("markAttendanceLocationContainer"),at._sectionDoc.l>0?Z('label[for="markAttendanceLocation"]').classList.add("required"):Z('label[for="markAttendanceLocation"]').classList.remove("required")),st(localStorage.semesterSelected,e),lt()}async function lt(){const e=Z("#markAttendanceRequirementsList");e.innerHTML="";let t=!1;if(ot.value||(e.appendChild(document.createElement("li")).innerText="Attendance passcode",t=!0),at._sectionDoc.l>-1&&!it.value){let n=await async function(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}();n.error?(K(it),at._sectionDoc.l>0?(G("markAttendanceLocationOffButRequired"),K("markAttendanceLocationOff"),e.appendChild(document.createElement("li")).innerText="Location",at._sectionDoc.l>1&&(t=!0)):(K("markAttendanceLocationOffButRequired"),G("markAttendanceLocationOff"))):(it.value=n,G(it),K("markAttendanceLocationOffButRequired"),K("markAttendanceLocationOff"))}if(at._sectionDoc.s>0&&!await async function(e,t){return!t||((e=z(e))?(await Xe(t)).flat().indexOf(e)>=0:void 0)}(Z("#markAttendanceSeatCodeInput").value,at._sectionDoc.r)&&(e.appendChild(document.createElement("li")).innerText="Valid seat code",at._sectionDoc.s>1&&(t=!0)),at._sectionDoc.p>-1){let n=vt?.size&&bt&&(new Date).getTime()-bt<6e5;at._sectionDoc.p>0&&!n&&(G("defaultSelfieImg"),K(yt),K(Ct),vt=bt=null,e.appendChild(document.createElement("li")).innerText="New photo",at._sectionDoc.p>1&&(t=!0))}e.innerHTML?G("markAttendanceRequirements"):K("markAttendanceRequirements"),t?Z("#markAttendanceButton").setAttribute("disabled",!0):Z("#markAttendanceButton").removeAttribute("disabled")}function st(e,t){const n=Z("#attendanceMarked");let a=Object.values(ve.e[e][t]).sort(((e,t)=>e.d-t.d));if(a?.length){n.innerHTML="";let e=n.appendChild(document.createElement("summary")),t=n.appendChild(document.createElement("small")),o=0,i=0,r=0;for(let e of a){let n=ie(e.d),a=t.appendChild(document.createElement("div")),l=n[0]+" ";1===e.u?(l+="absent",a.setAttribute("absent",!0),i++):2===e.u?(l+="absence excused",a.setAttribute("excused",!0),r++):-1===e.u?(l+=n[1]+" failed to mark attendance",a.setAttribute("absent",!0)):(l+=n[1],o++),e.nt&&(l+=" <small>("+e.nt+")</small>"),a.innerHTML=l}e.innerHTML=`${o} attendance(s) marked; ${i} unexcused absence(s); ${r} excused absence(s)`,$e.scrollTop=0}else n.innerHTML=""}function dt(e,t,n,a){return[e,t,n,a+".jpg"].join("/")}function ct(e,t,n){return[e,t,n].join("/")}const ut=new ZXing.BrowserMultiFormatReader;var mt,ft;async function pt(e){_e("QRreader"),mt=await getVideoStream(!1),ft=e,St(),window.addEventListener("popstate",ht,{once:!0})}function ht(){ut.reset(),window.removeEventListener("popstate",ht)}function gt(e,t){if(e){let t;if(ht(),He(),e.text?.startsWith("http")&&(t=new URLSearchParams(e.text.split("?")[1])),ft)t?.has("c")&&(e.text=t.get("c")),document.getElementById(ft).value=e.text,lt();else if(t?.has("s")){let[e,n]=Q(t.get("s"));localStorage.semesterSelected!==e&&(localStorage.semesterSelected=e,ea(e)),localStorage.markAttendanceSectionId=n,localStorage.markAttendanceCode=t.get("c"),setTimeout(rt,50)}}!t||t instanceof ZXing.NotFoundException||fa("Could not complete QR scan.\n"+t)}async function St(){ut.decodeFromStream(mt,"QRreaderVideo",gt)}var vt=null,wt=null,bt=null;const yt=Z("#selfieCanvas"),Ct=Z("#selfieVideo");async function Lt(){try{await startCamera(Ct,l),window.addEventListener("popstate",stopCamera,{once:!0}),K("defaultSelfieImg"),K(yt),K("addPhotoBtn"),G(Ct),G("snapPhotoBtn"),G("switchPhotoBtn")}catch(e){selfiePhotoBtn.innerHTML='<span class="material-symbols-outlined">photo_camera</span> Retry taking selfie...',fa("Unable to start camera.\nPlease make sure your camera permissions are enabled, reload, and try again.")}}async function At(){K(Ct),K("snapPhotoBtn"),K("switchPhotoBtn"),G(yt),G("addPhotoBtn"),takePhoto(Ct,yt,l),vt=await canvasToBlob(yt),bt=(new Date).getTime(),lt()}const Tt=Z("#getAttendanceSectionId"),Et=Z("#getAttendanceClassCodeInput"),It=Z("#collectAttendanceBtn"),kt=Z("#minutesToCollectAttendance");async function xt(e,t){if(_e("getAttendance"),!e){let n=Q(localStorage.takingAttendance);localStorage.semesterSelected=n[0],e=n[1],t=await ze(localStorage.semesterSelected,e)}if(Tt.innerText=e,Tt._sectionDoc=t,Z("#getAttendanceCrossListIds").innerHTML=t.x?"<span>"+t.x.join("</span> <span>")+"</span>":"",Z("#attendanceRoomSectionId").innerHTML=Z("#attendanceTableSectionId").innerHTML=`<div><span>${Tt.innerText} ${Z("#getAttendanceCrossListIds").innerText}</span></div>`,Z("#getAttendanceSectionInfo").innerText=t.pt+"\n"+(t.r||Tn)+"\n"+(t.in||t.i.join("\n")),Z("#getAttendanceEditBtn").setAttribute("onclick",""),Z("#getAttendanceEditBtn").onclick=n=>{En(e,t)},K("currentAttendanceStatus"),await Ft(),Ot.length&&(jt(),t.r&&Ot.attendanceCodesAndTimes.length?G("getAttendanceShowRoomBtn"):K("getAttendanceShowRoomBtn")),Ot._docs[0].c&&Ot._docs[0].d.seconds+60*Ot._docs[0].m>db.now())localStorage.takingAttendance=Y(localStorage.semesterSelected,e),Et.value=Ot._docs[0].c,localStorage.minutesToCollectAttendance=Ot._docs[0].m,localStorage.attendanceEndtime=Ot._docs[0].d.seconds+60*Ot._docs[0].m,Mt(),G("getAttendanceControls"),Ht();else{localStorage.takingAttendance===Y(localStorage.semesterSelected,e)?(delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,G("getAttendanceControls")):localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&K("getAttendanceControls");let t=Ot.attendanceCodesAndTimes[Ot.attendanceCodesAndTimes.length-1];t&&t[1].split(" ")[0]===ie()[0]?(Et.value=t[0],Ht(!1)):Bt()}kt.innerText=localStorage.minutesToCollectAttendance||75}function Bt(){Et.value=J[ne(26)]+Math.random().toString().substring(2,6)}kt.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t)}else"ArrowUp"===e.key?e.target.innerText=(parseInt(e.target.innerText)||0)+1:isNaN(parseInt(e.key))&&!["Backspace","Delete","ArrowLeft","ArrowRight"].includes(e.key)&&e.preventDefault()}));const Rt=new ZXing.BrowserQRCodeSvgWriter;function $t(e=null){const t=Z("#QRcodeContainer");let n=location.protocol+"//"+location.host+location.pathname+"?c="+Et.value+"&s="+Y(localStorage.semesterSelected,Tt.innerText);if(n!==t.url){t.url=n,Z("#QRcode").innerHTML="",Rt.writeToDom("#QRcode",n,300,300);let e=Z("#QRcode > svg");e.removeAttribute("width"),e.removeAttribute("height"),e.setAttribute("viewBox","0 0 300 300"),de=t,ce=(e,t)=>localStorage.qrPos=[e,t],e.addEventListener("mousedown",fe,!1),Pt.observe(t),localStorage.qrPos&&([t.style.left,t.style.top]=localStorage.qrPos.split(",")),localStorage.qrSize&&([t.style.width,t.style.height]=localStorage.qrSize.split(","))}null===e?ee("QRcodeContainer"):e?G("QRcodeContainer"):K("QRcodeContainer")}let Nt;const Pt=new ResizeObserver((e=>{let t=e[0].contentRect;t.width,t.height&&(clearTimeout(Nt),Nt=setTimeout((()=>localStorage.qrSize=[t.width,t.height]),1e3))}));var Ut,Ot;function Mt(){It.innerText="Stop",Et.setAttribute("disabled",!0),Z("#collectingAttendance").innerText="Collecting",G("createQRCodeBtn"),G("createURLBtn"),$t(!0),K("randomAttendanceClassCodeBtn"),G("attendanceCollectionStatus"),Z("#attendanceCollectionStatus>div").innerText=Tt.innerText+" "+Z("#getAttendanceCrossListIds").innerText.trim(),kt.removeAttribute("contenteditable"),Ht(!1),clearInterval(Ut),Ut=setInterval(_t,1e3)}function _t(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)Dt(!1);else{let t=Math.floor(e/60),n=e-60*t;kt.innerText=t+":"+oe(n),Z("#attendanceCollectionStatus>span").innerText=kt.innerText}}async function Dt(e=!0,t=!0){if(e){let e=Tt.innerText,t=Tt._sectionDoc,n=[],a=db.updateOne(d,Y(localStorage.semesterSelected,e),{[f]:db.deleteField()});if(a.error&&n.push(e),t.x?.length)for(let e of t.x)a=db.updateOne(d,Y(localStorage.semesterSelected,e),{[f]:db.deleteField()}),a.error&&n.push(e);if(n.length)return void fa("Error updating database for the following sections:\n"+n)}clearInterval(Ut),Ut=void 0,It.innerText="Start",Et.removeAttribute("disabled"),Z("#collectingAttendance").innerText="Collect",K("QRcodeContainer"),K("createQRCodeBtn"),K("createURLBtn"),G("randomAttendanceClassCodeBtn"),K("attendanceCollectionStatus"),kt.setAttribute("contenteditable","true"),kt.innerText=localStorage.minutesToCollectAttendance||"75",Ot._docs.forEach((e=>delete e.c)),delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,t&&Ht(!0)}async function Ht(e=!0){G("currentAttendanceStatus"),e&&(await Ft(!0),void 0!==Ut&&(!Ot._docs[0].c||!(Ot._docs[0].d.seconds+60*Ot._docs[0].m)>db.now())&&Dt(!1,!1)),Z("#currentAttendanceStatus > span").innerHTML=`Today's attendance for passcode ${Et.value}:\n${Ot.filter((e=>e.a[Et.value]&&!e.a[Et.value].u)).length} of ${Ot.length} marked present\n<small>(last checked ${(new Date).toLocaleTimeString()}</small>)`}async function Ft(e){let t=Tt.innerText,n=Tt._sectionDoc,a=[t].concat(n.x||[]);(Ot=await Ke(localStorage.semesterSelected,a,e)).length?(G("showStudentsOptions"),K("showStudentsAddBtn"),Ot.filter((e=>e.p)).length?G("learnNamesBtn"):K("learnNamesBtn")):(G("showStudentsAddBtn"),K("showStudentsOptions"))}function jt(){if(!Ot.attendanceCodesAndTimes){var e={};Ot.map((e=>Object.values(e.a))).flat().forEach((t=>{let n=e[t.code],a=t.date+" "+t.time;(!n||n>a)&&(e[t.code]=a)})),Ot.attendanceCodesAndTimes=Object.entries(e).sort(((e,t)=>e[1]>t[1]?1:-1))}}async function Wt(){let e=Tt.innerText,t=Tt._sectionDoc;if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await la("Please select a section for adding a student",{},n)).clicked,!e)return}Yn((t=>{He(),setTimeout(Jt,100,t,e)}),`Add students to section\n${e}`)}async function qt(e,t,n){const a=t.Section,o=t.Email;let i=await tt(o);if(await la(`Are you sure you would like to move ${o}${nt(i," (",")")} from section ${a} to section ${n}?`)){const r=localStorage.semesterSelected;if(!(await Ke(r,n))._docs[0].i){let e=await db.insertOne(d,Y(r,n),{[$]:Tt._sectionDoc.i});if(e.error)return void fa(`Could not create attendance record for section ${n}.\n${e.error}`)}let l=[],c={[v]:i.n,[w]:i.f,[m]:t.a};if(t.p){Fe(1);let o=await moveFiles(ct(e,r,a),ct(e,r,n));if(Fe(0),o.error)return void fa("Attendance record was not moved to new section:\n\nCould not move student photos to new section.\n"+o.error);let i=t.p.split("/");i[2]=n,c.p=i.join("/")}l.push({collection:d,id:Y(r,n),data:{[e]:c}}),l.push({collection:d,id:Y(r,a),data:{[e]:db.deleteField()}}),l.push({collection:s,id:o,data:{["e."+r+"."+n]:i.e[r][a]||{},["e."+r+"."+a]:db.deleteField()}});let u=await db.updateBatch(...l);if(u?.error){let o;return t.p&&(Fe(1),o=await moveFiles(ct(e,r,n),ct(e,r,a)),Fe(0)),void fa(o?.error?"Student photos were moved to new section, but the rest of attendance data could not be moved.\n"+u.error+"\n\nCould not move photos back to original section.\n"+o.error:"Attendance record could not be moved to new section.\n"+u.error)}!i.e[r][n]&&i.e[r][a]&&(i.e[r][n]=i.e[r][a],delete i.e[r][a]),qe[Y(r,n)][e]=t,t.Section=n,delete qe[Y(r,a)][e],ua(`Student ${o}${nt(i," (",")")} was successfully moved from section ${a} to section ${n}.`,"",1)}}async function Vt(e,t){const n=Ae(e);let a=await tt(e);if(!a)return void fa(`Student with the email ${e} was not found.`);let o=Ot.filter((e=>e.Username===n))[0];if(o)o.Section===t?fa(`Student with the email ${e} is already in section ${t}.`):(await qt(n,o,t),Kt());else{if(await la(`Are you sure you would like to add ${e}${nt(a," (",")")} to section ${t}?`)){const o=localStorage.semesterSelected;if(!(await Ke(o,t))._docs[0].i){let e=await db.insertOne(d,Y(o,t),{[$]:Tt._sectionDoc.i});if(e.error)return void fa(`Could not create attendance record for section ${t}.\n${e.error}`)}a.e||(a.e={}),a.e[o]||(a.e[o]={});let i={["e."+o+"."+t]:{}},r=[];for(let e of Ot._sectionIds.filter((e=>e!==t)))e in a.e[o]&&(i["e."+o+"."+e]=db.deleteField(),r.push(e));let l=await db.updateBatch({collection:s,id:e,data:i},{collection:d,id:Y(o,t),data:{[n]:{[v]:a.n,[w]:a.f,[m]:{}}}});if(l.error)return void fa("Could not add student to section.\n"+l.error);a.e[o][t]={};for(let e of r)delete a.e[o][e];Ot.push(qe[Y(o,t)][n]={[v]:a.n,[w]:a.f,[m]:{},[O]:n,[U]:e,[P]:t}),ua(`Student ${e}${nt(a," (",")")} was successfully added to section ${t}.`,"",1)}Kt()}}async function Jt(e,t){if(!e.length)return;let n,a,o=[],i=[],r=[];for(let l of e)a=Ae(l[0]),n=Ot.filter((e=>e.Username===a))[0],n?n.Section===t?i.push(l):(n.f||(n.f=l[1]),n.n||(n.n=l[2]),r.push(n)):o.push(l);if(r.length){var l=await et(r.map((e=>e.Email)));if(l.error)return void fa("Something went wrong.\n"+l.error)}if(o.length){var c=function(e){let t={},n=Object.assign({},...Object.values(qe));for(let a of e){let e=Ae(a);e in n&&(t[a]={[w]:n[e].f,[v]:n[e].n})}return t}(o);let t=e.filter((e=>!(e[0]in c)));if(t.length){let e=await et(t.map((e=>e[0])));if(e.error)return void fa("Something went wrong.\n"+e.error);Object.assign(c,e)}}let u="";if(r.length||o.length){if(i.length&&(u+=`<details><summary>${i.length} students are already in ${t} and will not be added</summary><small>${i.map((e=>e[0])).join(", ")}</small></details>\n`),r.length&&(u+=`<details><summary>${r.length} students are enrolled in this course under a different section id, and will be moved to ${t}</summary><small>${r.map((e=>e.Email)).join(", ")}</small></details>\n`),o.length&&(u+=`<details><summary>${o.length} students will be added to ${t}</summary><small>${o.map((e=>e[0])).join(", ")}</small></details>\n`),await la(u+"Are you sure you would like to proceed with this action?")){const e=localStorage.semesterSelected;let n={},a={},i={},u=Ot._sectionIds.filter((e=>e!==t));if(!(await Ke(e,t))._docs[0].i){let n=await db.insertOne(d,Y(e,t),{[$]:Tt._sectionDoc.i});if(n.error)return void fa(`Could not create attendance record for section ${t}.\n${n.error}`)}for(let o of r){let r=o.Section;i[r]||(i[r]={});let s={[w]:o.f,[v]:o.n,[m]:o.a};if(o.p){let e=o.p.split("/");e[2]=t,s.p=e.join("/")}a[o.Username]=s,i[r][o.Username]=db.deleteField();let d=o.Email;n[d]={[S]:{[e]:{[t]:l[d].e[e][r],[r]:db.deleteField()}}}}for(let i of o){let o=i[0],r=Ae(i[0]);if(o in c){a[r]={[w]:c[o].f||i[1],[v]:c[o].n||i[2],[m]:{}},n[o]={[S]:{[e]:{[t]:{}}}},c[o].f||(n[o].f=i[1]),c[o].n||(n[o].n=i[2]);for(let t of u)n[o].e[e][t]=db.deleteField()}else a[r]={[w]:i[1],[v]:i[2],[m]:{}},n[o]={[w]:i[1],[v]:i[2],[S]:{[e]:{[t]:{}}}}}let f=[{collection:d,id:Y(e,t),data:a}];for(let t in i)f.push({collection:d,id:Y(e,t),data:i[t]});for(let e in n)f.push({collection:s,id:e,data:n[e]});Fe(1);let p=await db.upsertBatch(...f);if(p.error)return Fe(0),void fa(`Failed to add students to section ${t}.\n${p.error}`);for(let a in n){Ve[a]||(Ve[a]={}),Ve[a].e||(Ve[a].e={}),Ve[a].e[e]||(Ve[a].e[e]={}),Ve[a].e[e][t]=n[a].e[e][t];for(let t of u)Ve[a].e[e][t]&&delete Ve[a].e[e][t]}je[Y(e,t)]||(je[Y(e,t)]={});for(let n in a)je[Y(e,t)][n]||(je[Y(e,t)][n]={}),Object.assign(je[Y(e,t)][n],a[n]);for(let t in i)if(je[Y(e,t)])for(let n in i[t])je[Y(e,t)][n]&&delete je[Y(e,t)][n];let h=[];for(let n of r){(await moveFiles(ct(n.Username,e,n.Section),ct(n.Username,e,t))).error&&h.push(n.Email)}Fe(0),Kt(!0),h.length?ma(`${r.length+o.length} students added to section ${t}.\n\nEncountered an issue moving photos from old section to new for <details><summary>${h.length} students</summary>${h}</details>.\n`):ua(`${r.length+o.length} students successfully added to section ${t}`,"Success",1)}}else ma(`No students were added because all of the selected students are already in section ${t}.`);Z("#addUsersEmails").value="",Z("#addUsersNames").value="",Z("#addUsersList").innerHTML=""}const Yt=Z("#attendances");var Qt;async function zt(){await Kt(),_e("attendanceTableScreen"),Qt?.hiddenCols?.length<2&&Z("#attendancesHolder").getBoundingClientRect().width<400&&setTimeout(rn,100),Z("#classLocation").innerText=await ye(...await Zt(Tt.innerText))}async function Zt(e){let t=localStorage.getItem("loc_"+e);return t?t=JSON.parse(t):(t=o,Xt(e,t)),t}function Xt(e,t){localStorage.setItem("loc_"+e,JSON.stringify(t))}async function Kt(e=!1){e&&await Ft(!0),jt();var t=parseInt(Z("#minLateInput").value);!t||t<1?Z("#minLateInput").value=t=parseInt(localStorage.minutesConsideredLate)||20:localStorage.minutesConsideredLate=t;var n=parseInt(Z("#pointsLateInput").value);let a,o;!n||n<0||n>100?Z("#pointsLateInput").value=n=parseInt(localStorage.pointsForLate)||50:localStorage.pointsForLate=n;for(let e of Ot){e.attendAndAbsentArray=[],e.attendTimeOffsets=[],e[H]=0,e.Absent=0,e.Late=0,e.Name=e.n||"",e[_]=e.f||"";for(let[n,i]of Ot.attendanceCodesAndTimes){if(a=e.a[n],a)e.attendAndAbsentArray.push(a);else{a={[p]:1,code:n},e.a[n]=a,e.attendAndAbsentArray.push(a);let t={[p]:1,[h]:db.makeTimestamp(i)};db.updateOne(d,Y(localStorage.semesterSelected,e.Section),{[e.Username+"."+"a."+n]:t}),db.updateOne(s,e.Email,{["e."+localStorage.semesterSelected+"."+e.Section+"."+n]:t}),e.Email in Ve&&(Ve[e.Email].e||(Ve[e.Email].e={}),Ve[e.Email].e[localStorage.semesterSelected]||(Ve[e.Email].e[localStorage.semesterSelected]={}),Ve[e.Email].e[localStorage.semesterSelected][e.Section]||(Ve[e.Email].e[localStorage.semesterSelected][e.Section]={}),Ve[e.Email].e[localStorage.semesterSelected][e.Section][n]=t)}1===a.u?(e.Absent++,e.attendTimeOffsets.push("absent")):2===a.u?e.attendTimeOffsets.push("excused"):(o=Math.floor((a.d-db.makeTimestamp(i))/60),o>=t?e.Late++:e[H]++,e.attendTimeOffsets.push(o))}e[D]=(100*e[H]+e.Late*n)/(e[H]+e.Late+e.Absent)}(Qt=[]).semester=localStorage.semesterSelected,Qt.id=Qt.semester+"_"+Ot._sectionIds.join("_"),Qt.attendanceCodes=Ot.attendanceCodesAndTimes.map((e=>e[0])),Qt.attendanceTimes=Ot.attendanceCodesAndTimes.map((e=>e[1])),Qt.header=W.concat(Qt.attendanceTimes);for(let e of Ot){let t=[];for(let n of W)t.push(e[n]);t=t.concat(e.attendTimeOffsets),t._fullRecord=e,Qt.push(t)}Qt.sortStack=JSON.parse(localStorage.getItem("sortStack_"+Qt.id)||"[]"),Qt.sortDesc=JSON.parse(localStorage.getItem("sortDesc_"+Qt.id)||"[]"),Qt.hiddenCols=JSON.parse(localStorage.getItem("hiddenCols_"+Qt.id)||"[true]"),tn()}function Gt(e,t,n,a){return async function(){let o=Y(localStorage.semesterSelected,e.Section),i=e.Username+"."+"a."+t.code+".",r=n.split(" ").join(" at "),l=`Record for ${nt(e)} (${e.Username}) for attendance taken on ${r}:\n\n`;if(2===t.u?l+="Attendance excused.":1===t.u?l+="Absent.":l+=`Attendance marked ${a?"after "+a+"min":"right away"}.\n\nSeat: ${t.s||"missing"}`,(t.p||t.l)&&(l+="\n\n",t.p&&(l+=`<img src="${await getLinkFromStoragePath(dt(e.Username,localStorage.semesterSelected,e.Section,t.code))}" onerror="this.src='user-icon.png';" width="125">`),t.l&&(l+='<div id="locmap"></div>',setTimeout((()=>{Se(Z("#locmap"),...t.l)}),150))),t.nt&&(l+="\n\nNotes:\n"+t.nt),"Edit attendance record"===(await la(l+"\n\n",{},["OK","Edit attendance record"])).clicked){let l={Present:{type:"radio",name:"status"},Absent:{type:"radio",name:"status"},Excused:{type:"radio",name:"status"},"Minutes late":{type:"number",value:t.u?"":a},Seat:t.s||"",Notes:t.nt||""};1===t.u?l.Absent.checked=!0:2===t.u?l.Excused.checked=!0:l.Present.checked=!0;let c=await la(`Record for ${nt(e)} (${e.Username}) for attendance taken on ${r}:\n\n`,l,["Save","Cancel"]);if("Save"===c?.clicked){let r={};if(c.Present){let e=parseInt(c["Minutes late"])||0;(t.u||e!==a)&&(r[i+h]=db.makeTimestamp(n,e))}else{let e=db.makeTimestamp(n);t.d?.seconds!=e.seconds&&(r[i+h]=e)}if(c.Present&&t.u?r[i+p]=0:c.Absent&&1!==t.u?r[i+p]=1:c.Excused&&2!==t.u&&(r[i+p]=2),c.Seat!==t.s&&(r[i+y]=c.Seat||""),c.Notes!==t.nt&&(r[i+A]=c.Notes||""),Object.keys(r).length){let n,a,l=[{collection:d,id:o,data:r}];(i+p in r||i+h in r)&&(a="e."+localStorage.semesterSelected+"."+e.Section+"."+t.code+".",n={[a+A]:`updated by ${auth.currentUser.email} on ${ie()[0]}`},i+p in r&&(n[a+p]=r[i+p]),i+h in r&&(n[a+h]=r[i+h]),l.push({collection:s,id:e.Email,data:n}));let c=await db.updateBatch(...l);if(c.error)fa("Unable to update attendance record.\n"+c.error);else{if(i+p in r&&(t.u=r[i+p]),i+h in r&&(t.d=r[i+h]),i+y in r&&(t.s=r[i+y]),i+A in r&&(t.nt=r[i+A]),n&&e.Email in Ve){Ve[e.Email].e||(Ve[e.Email].e={}),Ve[e.Email].e[localStorage.semesterSelected]||(Ve[e.Email].e[localStorage.semesterSelected]={}),Ve[e.Email].e[localStorage.semesterSelected][e.Section]||(Ve[e.Email].e[localStorage.semesterSelected][e.Section]={}),Ve[e.Email].e[localStorage.semesterSelected][e.Section][t.code]||(Ve[e.Email].e[localStorage.semesterSelected][e.Section][t.code]={});let o=Ve[e.Email].e[localStorage.semesterSelected][e.Section][t.code];a+p in n&&(o.d=n[a+p]),a+h in n&&(o.d=n[a+h]),o.nt=n[a+A]}ua("Record updated.","",1),Kt()}}else ua("Nothing changed. Record not updated.")}}}}function en(e){return async function(){se(null,null,await Promise.all(e.attendAndAbsentArray.filter((e=>e.p)).map((t=>getLinkFromStoragePath(dt(e.Username,localStorage.semesterSelected,e.Section,t.code)))))),window._nextImg=se;let t=`${nt(e)}\n${e.Email}\n${e.Section}\n\n<img id="studentPromptImg" src=user-icon.png onclick="window._nextImg(1,this)" onload="this.onload=null;window._nextImg(0,this)" onerror="this.src='user-icon.png'" width="200">\n\nAbsent: ${e.Absent}\nLate: ${e.Late}\n\n`,n=await la(t,{},Ot._sectionIds.length>1?["OK","Change student section","Remove student from section"]:["OK","Remove student from section"]);if("Change student section"===n.clicked){let t=Ot._sectionIds.filter((t=>t!==e.Section));t.length>1?n=await la("Choose which section you would like to move the student to:",{otherSections:t},t.concat(["Cancel"])):n.clicked=t[0],n&&await qt(e.Username,e,n.clicked),Kt()}else if("Remove student from section"===n.clicked&&(n=await la(`Are you sure you want to remove ${nt(e)} (${e.Username}) from section ${e.Section}?\n\nWARNING: This action will permanently DELETE all of the student's attendance records associated with this section.`,{},["DELETE student from section","Cancel"]),"DELETE student from section"===n.clicked)){const t=Y(localStorage.semesterSelected,e.Section),n=e.Email;let a=await db.updateBatch({collection:d,id:t,data:{[e.Username]:db.deleteField()}},{collection:s,id:n,data:{["e."+localStorage.semesterSelected+"."+e.Section]:db.deleteField()}});if(a.error)return void fa("Could not delete student record.\n\n"+a.error);if(delete qe[t][e.Username],Ve[n])try{delete Ve[n].e[localStorage.semesterSelected][e.Section]}catch(e){}(await deleteFiles(ct(e.Username,localStorage.semesterSelected,e.Section))).error?ma("Deleted student from section, but could not delete student's uploaded photos."):ua(`${nt(e)} (${e.Username}) was deleted from section ${e.Section}.`,"",1),await Ft(!1),Kt(!1)}}}async function tn(){let e=Z("#attendancesHolder").scrollLeft,t=Z("#attendancesHolder").scrollTop;Yt.innerHTML="";var n=await Zt(Tt.innerText),a=parseInt(localStorage.minutesConsideredLate);!function(e,t,n={}){t?.length&&e.sort(((t,a)=>{let o,i;for(let r of Qt.sortStack){if(o=n[t[r]]||t[r],i=n[a[r]]||a[r],o>i)return e.sortDesc[r]?-1:1;if(i>o)return e.sortDesc[r]?1:-1}}))}(Qt,Qt.sortStack,{excused:9e8,absent:9e9});for(let e of[Qt.header].concat(Qt)){var o=Yt.appendChild(document.createElement("row"));for(let t=0;t<Qt.header.length;t++)if(!Qt.hiddenCols[t]){var i=o.appendChild(document.createElement("div"));if(e===Qt.header)i.innerText=e[t],t>=V&&(i.title=Qt.attendanceCodes[t-V]),i.addEventListener("click",(()=>dn(t))),i.addEventListener("contextmenu",sn),i.classList.add("table-header"),i.setAttribute("title","Click to sort. Right-click to hide/show.");else if(t>=V){i.innerHTML="excused"===e[t]?"➖":"absent"===e[t]?"❌":e[t]<a?"✔️":"+"+e[t]+"min";let o=e._fullRecord.attendAndAbsentArray[t-V];if("excused"!==e[t]&&"absent"!==e[t])if(o.s||i.classList.add("missingSeat"),o.p||i.classList.add("missingPhoto"),o.l){i.classList.add("hasLocation");let e=be(o.l,n);i.style.setProperty("--distColor",`rgb(${e/15},${255-e/15},0)`)}else i.classList.add("missingLocation");i.onclick=Gt(e._fullRecord,o,Qt.header[t],e[t]),i.style.textAlign="center"}else i.innerText=e[t],i.onclick=en(e._fullRecord),isNaN(parseFloat(e[t]))||(i.style.textAlign="center",Number.isInteger(e[t])||(i.innerText=e[t].toFixed(1)))}}Yt.style.setProperty("--colNum",o.children.length),Z("#attendancesHolder").scrollLeft=e,Z("#attendancesHolder").scrollTop=t}async function nn(){localStorage.setItem("hiddenCols_"+Qt.id,JSON.stringify(Qt.hiddenCols)),await tn()}function an(){if(Qt.showingAttendanceCol){delete Qt.showingAttendanceCol;for(let e=V;e<Qt.header.length;e++)Qt.hiddenCols[e]=!1;nn()}else on()}async function on(e){e||(e=Qt.showingAttendanceCol=Qt.showingAttendanceCol||Qt.header.length-1);for(let t=V;t<Qt.header.length;t++)Qt.hiddenCols[t]=e!==t;await nn()}async function rn(){let e=Qt.header.length-Qt.hiddenCols.filter((e=>e)).length;const t=W.indexOf(_),n=W.indexOf(O);if(e<3&&!Qt.hiddenCols[t]&&Qt.hiddenCols[n])return Qt.hiddenCols[t]=!0,Qt.hiddenCols[n]=!1,void nn();const a=Z("#attendancesHolder").getBoundingClientRect().width;if(e<3||Yt.getBoundingClientRect().width<=a){for(let e=0;e<V;e++)Qt.hiddenCols[e]=!1;return await nn(),void(Yt.getBoundingClientRect().width<a&&an())}Yt.getBoundingClientRect().width>a&&await on();for(var o=[...q];o.length>1&&Yt.getBoundingClientRect().width>a;){let e=o.pop();await ln(Qt.header.indexOf(e),!1)}}function ln(e,t=null){null===t&&(t=Qt.hiddenCols[e]),Qt.hiddenCols[e]=!t,nn()}async function sn(e){e.preventDefault();const t=e.currentTarget.innerText;let n=["Hide column"];W.includes(t)||n.push("Change attendance status","Delete column");let a=await ra(e.clientX,e.clientY,n);if("Hide column"==a)ln(Qt.header.indexOf(t),!1);else if("Change attendance status"==a){let e=await la(`Change attendance statuses for ${t}:`,{"Current status":["Any","Absent","Excused","Present"],"New status":["Absent","Excused","Present"]});if(e){const n={Absent:1,Present:0,Excused:2},a=n[e["Current status"]],o=n[e["New status"]];if(a===o)return void ua("Nothing to change.");const i=localStorage.semesterSelected,r=Ot.attendanceCodesAndTimes.find((e=>e[1]==t))[0];let l={},c=[],u=[];for(let e of Ot){let t=e.a[r].u||0;if(t!==o&&(void 0===a||t===a)){let t=e.Section;l[t]||(l[t]={}),l[t][e.Username+"."+"a."+r+"."+p]=o,c.push({collection:s,id:e.Email,data:{["e."+i+"."+t+"."+r+"."+p]:o}}),u.push(e)}}if(0===u.length)ua("Nothing to change.");else if(await la(`You are about to mark ${u.length} student(s) ${e["New status"].toLowerCase()} for ${t}.\n\nAre you sure you would like to proceed?`)){for(let e in l)c.push({collection:d,id:Y(i,e),data:l[e]});let n=db.updateBatch(...c);if(n.error)fa("Could not update records.\n"+n.error);else{for(let e of u)e.a[r].u=o;Kt(),ua(`${u.length} student(s) were marked ${e["New status"].toLowerCase()} for ${t}.`,"Success.",1)}}}}else if("Delete column"==a){if("delete"===(await la(`Are you sure you would like to delete all attendance data for ${t}?<p>WARNING:<p>All data associated with ${t} attendance will be lost, including photos and attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.`,{Confirm:""})).Confirm.toLowerCase()){const e=localStorage.semesterSelected,n=Ot.attendanceCodesAndTimes.find((e=>e[1]==t))[0];let a={},o=[];for(let t of Ot){let i=t.Section;a[i]||(a[i]={}),a[i][t.Username+"."+"a."+n]=db.deleteField(),o.push({collection:s,id:t.Email,data:{["e."+e+"."+i+"."+n]:db.deleteField()}})}for(let t in a)o.push({collection:d,id:Y(e,t),data:a[t]});let i=db.updateBatch(...o);if(i.error)fa("Could not update records.\n"+i.error);else{for(let t of Ot)deleteFile(dt(t.Username,e,t.Section,n)),delete t.a[n];Ot.attendanceCodesAndTimes=Ot.attendanceCodesAndTimes.filter((e=>e[0]!==n)),Kt(),ua(`Deleted all attendance records for ${t}.`,"Success.",1)}}}}function dn(e){Qt.sortStack[0]===e?(Qt.sortDesc[e]=!Qt.sortDesc[e],localStorage.setItem("sortDesc_"+Qt.id,JSON.stringify(Qt.sortDesc))):(Qt.sortStack=[e].concat(Qt.sortStack.filter((t=>t!=e))),localStorage.setItem("sortStack_"+Qt.id,JSON.stringify(Qt.sortStack))),tn()}he(Z("#attendancesHolder"));const cn=Z("#roomMap"),un=Z("#roomMapHolder");var mn;async function fn(e=!1){e&&await Ft(!0),jt();let t=Tt._sectionDoc;Ot.roomId=t.r,localStorage["roomMapZoom-"+Ot.roomId]||(localStorage["roomMapZoom-"+Ot.roomId]=1),mn=Ot.attendanceCodesAndTimes.length-1,pn(),Z("#attendanceRoomViewLastBtn").classList.add("disabled")}async function pn(){let e=Ot.roomId?await Xe(Ot.roomId):[["","","","","","","","","",""]],t=e.flat().filter((e=>e));var n={},a=[],o=[],i=Ot.attendanceCodesAndTimes[mn][0];Z("#roomViewDate").innerText=Ot.attendanceCodesAndTimes[mn][1];for(let e of Ot){let r=e.a[i];if(r&&2!==r.u&&1!==r.u){let a=z(r.s);e._seat=a,e._notes=r.nt,e._time=r.time,e._photo=r.p?dt(e.Username,localStorage.semesterSelected,e.Section,i):e.p,t.includes(a)&&!n[a]?n[a]=e:o.push(e)}else a.push(e),r&&(e._notes=r.nt),r&&2===r.u?e._time="excused":e._time="absent",e._photo=e.p}if(cn.innerHTML="",Object.keys(n).length){cn._cols=0;for(let t=0;t<e.length;t++){let a=e[t];cn._cols=Math.max(cn._cols,a.length);let o=cn.appendChild(document.createElement("div"));for(let i=0;i<a.length;i++){let a=e[t][i],r=o.appendChild(document.createElement("div"));if(a){r.classList.add("seat");let e=n[a];e?hn(r,e):r.innerText=a}}}}let r=cn.appendChild(document.createElement("div"));r.classList.add("bad-seating");for(let e of o){let t=r.appendChild(document.createElement("div"));t.classList.add("seat"),hn(t,e)}let l=cn.appendChild(document.createElement("div"));l.classList.add("absent");for(let e of a){let t=l.appendChild(document.createElement("div"));t.classList.add("seat"),hn(t,e)}Sn(),r.style.maxWidth=`calc(var(--seat-width) * ${cn._cols})`,l.style.maxWidth=`calc(var(--seat-width) * ${cn._cols})`,_e("room"),setTimeout((()=>{un.scrollLeft=(un.scrollWidth-un.offsetWidth)/2}),100)}function hn(e,t){e.classList.add("taken"),getLinkFromStoragePath(t._photo).then((t=>e.style.backgroundImage=`url("${t||r}"), url(user-icon.png)`)),e.innerHTML=`<span>${t.n}</span>`,e.onmouseover=()=>{e.innerHTML=`<span>${nt(t)}\n<small>${t.Username}\n${t._time}\n${t._seat||""}\n${t.Section}\n${t._notes||""}</small></span>`},e.onmouseout=()=>{e.innerHTML=`<span>${t.n}</span>`,e.classList.remove("enlarge")},e.onclick=()=>{e.classList.toggle("enlarge")}}function gn(){mn==Ot.attendanceCodesAndTimes.length-1?Z("#attendanceRoomViewLastBtn").classList.add("disabled"):Z("#attendanceRoomViewLastBtn").classList.remove("disabled")}function Sn(){let e=parseFloat(localStorage["roomMapZoom-"+Ot.roomId]);cn.style.setProperty("--seat-width",25*e+"px"),cn.style.setProperty("--seat-height",25*e+"px")}he(un);let vn,wn,bn={};async function yn(){clearTimeout(wn);let e=bn[vn][bn[vn].indx],[t,n]=Q(vn),a=Ot.find((t=>t.Username===e));se(null,null,await Promise.all(Object.values(a.a).filter((e=>e.p)).map((a=>getLinkFromStoragePath(dt(e,t,n,a.code)))))),Cn(),Z("#learnNamesName").innerText=nt(a),Z("#learnNamesName").classList.add("hideName")}async function Cn(){null!==Z("#learnNamesImg").offsetParent&&(clearTimeout(wn),se(null,Z("#learnNamesImg")),wn=setTimeout(Cn,3500))}function Ln(){if(!bn[vn].length)return K("learnNamesMain"),void G("learnNamesDone");bn[vn].indx++,bn[vn].indx>=bn[vn].length?(bn[vn]=te(bn[vn]),bn[vn].indx=0,K("learnNamesPrevBtn")):bn[vn].indx&&G("learnNamesPrevBtn"),yn()}const An="Create New Section",Tn="No assigned room";async function En(e,t){Z("#editSectionSubmitBtn").innerText="Save Section",G("editSectionDeleteBtn"),Z("#editSectionIdInput").setAttribute("disabled",!0),Z("#editSectionSemesterSelect").setAttribute("disabled",!0),await In(),Z("#editSectionIdInput").value=e,Z("#editSectionPatternInput").value=t.pt,Z("#editSectionRoom").innerText=t.r||Tn,Z("#editSectionCrosslistInput").value=t.x?.join("\n")||"",Z("#editSectionInstructorEmailsInput").value=t.i?.join("\n")||"",Z("#editSectionInstructorNamesInput").value=t.in||"",Z("#editSectionAllowSelfEnroll").checked=t.v,-1===t.s?Z("#editSectionSeatNo").checked=!0:1===t.s?Z("#editSectionSeatWarn").checked=!0:2===t.s?Z("#editSectionSeatRequire").checked=!0:Z("#editSectionSeatYes").checked=!0,-1===t.p?Z("#editSectionPhotoNo").checked=!0:1===t.p?Z("#editSectionPhotoWarn").checked=!0:2===t.p?Z("#editSectionPhotoRequire").checked=!0:Z("#editSectionPhotoYes").checked=!0,-1===t.l?Z("#editSectionLocationNo").checked=!0:1===t.l?Z("#editSectionLocationWarn").checked=!0:2===t.l?Z("#editSectionLocationRequire").checked=!0:Z("#editSectionLocationYes").checked=!0}async function In(){let e;_e("addOrEditSection");let t=Z("#editSectionSemesterSelect");if(1==t.children.length){let n=await Ye();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}for(let e of t.children)e.innerText==localStorage.semesterSelected?(e.setAttribute("selected",!0),t.value=e.value):e.removeAttribute("selected")}function kn(){On((e=>Z("#editSectionRoom").innerText=e))}const xn=Z("#editRoomLayout");let Bn,Rn,$n={};async function Nn(){let e=await Ze(),t=[...new Set(Object.values(e).map((e=>e.cm)))];t.sort(),Z("#editRoomCampusDataList").innerHTML="",Z("#roomsCampusSelect").innerHTML='<option value="">All campuses</option>';for(let n of t)if(n){$n[n]=[...new Set(Object.values(e).filter((e=>e.cm===n)).map((e=>e.bl)))],$n[n].sort(),Z("#editRoomCampusDataList").appendChild(document.createElement("option")).value=n;let t=Z("#roomsCampusSelect").appendChild(document.createElement("option"));t.innerText=t.value=n}1===Z("#editRoomCampusDataList").childElementCount?(Z("#roomsCampusSelect").value=Z("#roomsCampusSelect").lastChild.value,Z("#roomsCampusSelect").setAttribute("disabled",!0)):localStorage.campusSelected&&(Z("#roomsCampusSelect").value=localStorage.campusSelected,Z("#roomsCampusSelect").removeAttribute("disabled")),Z("#editRoomBuildingDataList").innerHTML="";for(let t of new Set(Object.values(e).map((e=>e.bl))))t&&(Z("#editRoomBuildingDataList").appendChild(document.createElement("option")).value=t);Pn(),Un()}function Pn(){if(localStorage.campusSelected=Z("#roomsCampusSelect").value,Z("#roomsBuildingSelect").innerHTML='<option value="">All buildings</option>',localStorage.campusSelected){for(let e of $n[localStorage.campusSelected])if(e){let t=Z("#roomsBuildingSelect").appendChild(document.createElement("option"));t.innerText=t.value=e}localStorage.buildingSelected&&(Z("#roomsBuildingSelect").value=localStorage.buildingSelected)}else localStorage.buildingSelected="";Un()}async function Un(){localStorage.buildingSelected=Z("#roomsBuildingSelect").value;let e=await Ze(),t=Object.keys(We).sort(((e,t)=>e.toLowerCase()>t.toLowerCase()?1:-1));for(;Z("#roomList").childElementCount>1;)Z("#roomList").removeChild(Z("#roomList").lastChild);for(let n of t)!e[n].rn||localStorage.campusSelected&&localStorage.campusSelected!==e[n].cm||localStorage.buildingSelected&&localStorage.buildingSelected!==e[n].bl||Hn(n,e[n])}async function On(e){Mn=e,_e("rooms"),Z("#roomList").childElementCount<2&&Nn()}var Mn,_n,Dn;function Hn(e,t){let n=t.rm.split("\n").map((e=>e.split("\t"))).flat().filter((e=>e.trim())).length,a=Z("#roomList").appendChild(document.createElement("div"));a.innerHTML=`${e}\n${n} seats\n${t.bl}\n${t.rn}\n${t.cm}`,a._editRoomF=function(){Z("#editRoomId").setAttribute("disabled",!0),Z("#editRoomId").value=e,Z("#editRoomCampus").value=t.cm,Z("#editRoomBuilding").value=t.bl,Z("#editRoomName").value=t.rn,Rn=[ae(t.rm.toUpperCase())],Rn.indx=0,jn();let n=[];for(let t in je)for(let a in je[t])je[t][a].r===e&&(n.push(a),je[t][a].x?.length&&n.push(...je[t][a].x));n.length?(Z("#editRoomUsedIn").innerText=`Room used for sections:\n  ${n.join(", ")}`,G("editRoomUsedIn"),K("editRoomDeleteBtn")):(K("editRoomUsedIn"),G("editRoomDeleteBtn")),_e("editRoom")},a.onclick=function(){Mn?(Mn(e),He()):a._editRoomF()}}function Fn(e){e||(e=[...xn.children].map((e=>[...e.children].map((e=>e.innerText))))),JSON.stringify(e)!=JSON.stringify(Rn[Rn.indx])&&(Rn.indx++,Rn.length=Rn.indx,Rn.push(e))}function jn(e){e?Fn(e):e=Rn[Rn.indx],xn.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t],a=xn.appendChild(document.createElement("div"));for(let o=0;o<n.length;o++){let i=a.appendChild(document.createElement("div"));i.setAttribute("contenteditable",!0),e[t][o]&&(i.classList.add("seat"),i.innerText=e[t][o]),i.onmouseover=e=>{Bn&&e.buttons&&(e.preventDefault(),1===Bn?(i.classList.add("seat"),i.innerText="_"):-1===Bn&&(i.classList.remove("seat"),i.innerText=""))},i.onmouseout=e=>{if(!Bn&&e.buttons){function t(e){e.buttons||(Bn=0,Fn(),window.removeEventListener("mousemove",t))}e.preventDefault(),Bn=i.classList.contains("seat")?-1:1,1===Bn?(i.classList.add("seat"),i.innerText="_"):-1===Bn&&(i.classList.remove("seat"),i.innerText=""),window.addEventListener("mousemove",t)}},i.oninput=e=>{i.innerText.includes("\n")&&i.blur(),i.innerText?i.classList.add("seat"):i.classList.remove("seat")},i.onblur=e=>{i.innerText=z(i.innerText),Fn()},i.ondblclick=e=>{e.preventDefault(),i.innerText?(i.classList.remove("seat"),i.innerText=""):(i.classList.add("seat"),i.innerText="_",selectText(i))},i.addEventListener("contextmenu",(async r=>{r.preventDefault();let l=await ra(r.clientX,r.clientY,["Insert left","Insert right","Delete","","Insert row above","Insert row below","Delete row","","Insert col left","Insert col right","Delete col"]);if("Delete"===l)i.remove(),Fn();else if("Insert left"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o,0,""),jn(n)}else if("Insert right"===l){let n=JSON.parse(JSON.stringify(e));n[t].splice(o+1,0,""),jn(n)}else if("Delete row"===l)a.remove(),Fn();else if("Insert row above"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t,0,Array(n.length).fill("")),jn(a)}else if("Insert row below"===l){let a=JSON.parse(JSON.stringify(e));a.splice(t+1,0,Array(n.length).fill("")),jn(a)}else if("Delete col"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,1))),jn(t)}else if("Insert col left"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,0,""))),jn(t)}else if("Insert col right"===l){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o+1,0,""))),jn(t)}}))}}}function Wn(e){e||(e=JSON.parse(JSON.stringify(Rn[Rn.indx])));let t,n=0;for(let a=e.length-1;a>-1;a--){let o=e[a];t=0;for(let i=0;i<o.length;i++)e[a][i]&&e[a][i]&&(e[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[n]+ ++t);t&&n++}jn(e)}function qn(e,t=""){(_n=e)?K("manageUsersAddUserButtons"):G("manageUsersAddUserButtons"),Z("#manageUsersTitle").innerHTML=t,_e("manageUsers");const n=Z("#manageUsersPages");if(!n.childElementCount){for(let e of J){let t=n.appendChild(document.createElement("span"));t.innerText=e,t.onclick=()=>{Z("#manageUsersEmailInput").value="",Z("#manageUsersNameInput").value="",Z("#manageUsersLastNameInput").value="",Z(".manageUsersSelectedFilter").value=Z(".manageUsersSelectedFilter")==Z("#manageUsersEmailInput")?e:e.toUpperCase(),Vn()}}let e=n.appendChild(document.createElement("span"));e.innerText="—",e.onclick=()=>{Z("#manageUsersEmailInput").value="",Z("#manageUsersNameInput").value="",Z("#manageUsersLastNameInput").value="",Vn()}}}async function Vn(){let e=Z("#manageUsersEmailInput").value,t=Z("#manageUsersNameInput").value,n=Z("#manageUsersLastNameInput").value,a=Z("#manageUsersSelectRoleStudent").checked,o=Z("#manageUsersSelectRoleInstructor").checked,i=Z("#manageUsersSelectRoleAdmin").checked;if(!(e||t||n||o||i))return void(manageUsersList.innerHTML='When "Any role" or "Students Only" role is selected, you must also supply additional filters for email and/or last name and/or preferred name.');let r={};if(e?r=await Ge(e):n?r=await Ge(n,w):t?r=await Ge(t,v):o?r=await Ge([1,3],T):i&&(r=await Ge([2,3],T)),r?.error)fa("Could not perform search.\n"+r.error);else{const e=Z("#manageUsersList");e.innerHTML="",t=t.toLowerCase(),n=n.toLowerCase();for(let e in r){let l=r[e];n&&!(l.f.toLowerCase()||"").startsWith(n)||(t&&!(l.n.toLowerCase()||"").startsWith(t)||a&&l.rl||(!o||1&l.rl)&&(!i||2&l.rl)&&Jn(e,l))}e.innerHTML?e.insertBefore(document.createElement("row"),e.firstElementChild).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>":e.innerHTML="No users found matching the specified filters."}}function Jn(e,t){let n=Z("#manageUsersList").appendChild(document.createElement("row"));n.innerHTML=`<div>${2&t.rl?"✔️":""}</div><div>${1&t.rl?"✔️":""}</div><div>${e}</div><div>${t.f||""}</div><div>${t.n||""}</div>`,n.onclick=async function(){if(_n)return void _n(e);let a=`${e}\n${nt(t,"\n")}\n`,o=await getOneLinkFromStoragePath(Ae(e));o&&(a+=`<img src="${o}" height=200>\n`);for(let e in t.e){let n=Object.keys(t.e[e]);n.length&&(a+=`<small>${e}: ${n}</small>\n`)}let i=await la(a,{Instructor:Boolean(1&t.rl),Admin:Boolean(2&t.rl)},["Save","Cancel"]);if(i){let a=1*i.Instructor+2*i.Admin,o=`Are you sure you would like to change the role for ${e}?`;if(1&a&&!(1&t.rl)&&(o+="\n<li>Adding instructor privileges</li>"),!(1&a)&&1&t.rl&&(o+="\n<li>Taking away instructor privileges</li>"),2&a&&!(2&t.rl)&&(o+="<li>Adding admin privileges</li>"),!(2&a)&&2&t.rl&&(o+="<li>Taking away admin privileges</li>"),a!==t.rl&&await la(o)){let o=await db.updateOne(s,e,{[T]:a});o.error?fa(`Could not update user profile for ${e}.\n`+o.error):(t.rl=a,n.innerHTML=`<div>${2&a?"✔️":""}</div><div>${1&a?"✔️":""}</div><div>${e}</div><div>${t.f||""}</div><div>${t.n||""}</div>`)}}}}function Yn(e,t="Add users"){(Dn=e)?K("addUsersRoleOptions"):G("addUsersRoleOptions"),Z("#addUsersBtn").innerText=t,Z("#addUsersEmails").innerText="",Z("#addUsersNames").innerText="",_e("addUsers")}function Qn(){const e=Z("#addUsersList");Z("#addUsersEmails").value!==Z("#addUsersEmails").value.trimStart()&&(Z("#addUsersEmails").value=Z("#addUsersEmails").value.trimStart());let t=Z("#addUsersEmails").value.split("\n").filter((e=>e)),n=Z("#addUsersNames").value?Z("#addUsersNames").value.trimEnd().split("\n"):[];if(e.innerHTML="",Z("#addUsersBtn").setAttribute("disabled",!0),t.length){const o=Z("#addUsersLastNameFirst").checked;let i,r,l,s,d,c,u,m=[],f=new Set,p=new Set;e.appendChild(document.createElement("row")).innerHTML="<div>Email</div><div>Last Name</div><div>First Name</div>";for(let u=0;u<t.length;u++){d=t[u].toLowerCase(),d.endsWith(a)||(d+=a),i=e.appendChild(document.createElement("row")),r=i.appendChild(document.createElement("div")),l=i.appendChild(document.createElement("div")),s=i.appendChild(document.createElement("div")),r.innerText=d,n[u]&&(c=n[u].split(/\s?,\s?|\s{2,}|\t/),(o?l:s).innerText=Ce(c[0]),c[1]&&((o?s:l).innerText=Ce(c[1])));let h=d.split("@");2==h.length&&Te(h[0])||(m.push(d),r.classList.add("bad-text")),p.has(d)?(f.add(d),r.innerHTML+=" (duplicate)",r.classList.add("bad-text")):p.add(d)}m.length?u="Invalid emails:\n"+m.join("; ")+"\n":f.size?u="Duplicate emails:\n"+[...f].join("; ")+"\n":n.length>t.length?u=`You specified ${n.length} names, but only ${t.length} matching emails/usernames.`:(u=`Ready to add ${t.length} user(s).`,Z("#addUsersBtn").removeAttribute("disabled")),Z("#addUsersSummary").innerHTML=u+"\nCheck the table below to make sure all emails and names are correctly inferred."}else if(n.length)return void ma("Please enter emails or usernames to proceed.")}function zn(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard";var i=o.appendChild(document.createElement("div"));return i.class="cardTitle",i.innerText=e,a&&t.x&&(i.innerText+="\n"+t.x.join("\n")),(i=o.appendChild(document.createElement("div"))).innerText=t.pt,(i=o.appendChild(document.createElement("div"))).innerText=t.r||Tn,(i=o.appendChild(document.createElement("div"))).innerText=t.in||t.i,o.addEventListener("click",n),o}async function Zn(e){xt(e.currentTarget.id,e.currentTarget._sectionDoc)}function Xn(e){rt(e.currentTarget.id,e.currentTarget._sectionDoc)}async function Kn(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne(s,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+t]:{}})).error?fa("Failed to add section.\n\nPlease try again."):(ve.e[localStorage.semesterSelected]||(ve.e[localStorage.semesterSelected]={}),ve.e[localStorage.semesterSelected][t]={},Gn(t,n,Z("#studentSections"),Xn),He())}function Gn(e,t,n,a,o){var i=zn(e,t,a,o);n.insertBefore(i,n.lastElementChild)}async function ea(e){const t=Z("#studentSections"),n=Z("#instructorSections");if(!e)return K(t),void K(n);Z("#semesterSelect").value=e,G(t),1&ve.rl&&G(n);var a=await Qe(e);for(let e=t.childElementCount-2;e>0;e--)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let i=a[o];if(ve.e&&ve.e[e]&&o in ve.e[e])Gn(o,i,t,Xn);else if(i.x?.length)for(let n of i.x)ve.e&&ve.e[e]&&n in ve.e[e]&&Gn(n,i,t,Xn);!n.classList.contains("hidden")&&i.i?.includes(auth.currentUser.email)&&Gn(o,i,n,Zn,!0)}}async function ta(){if(localStorage.semesterSelected){const e=Z("#allSectionsList");e.innerHTML="";let t=await Qe(localStorage.semesterSelected);for(let n in t){let a=t[n];e.appendChild(zn(n,a,(e=>En(e.currentTarget.id,e.currentTarget._sectionDoc)),!0))}}}const na=Z("#nameInput"),aa=Z("#lastNameInput"),oa=Z("#saveNameBtn");function ia(){let e=Ce(na.value),t=Ce(aa.value);!e||!t||na.lastValue===e&&aa.lastValue===t?K(oa):G(oa)}function ra(e,t,n){return new Promise((function(a,o){const i=Z("#contextMenu");window.dispatchEvent(new Event("click")),e<window.innerWidth/2?(i.style.left=e,i.style.removeProperty("right")):(i.style.right=window.innerWidth-e,i.style.removeProperty("left")),t<window.innerHeight/2?(i.style.top=t,i.style.removeProperty("bottom")):(i.style.bottom=window.innerHeight-t,i.style.removeProperty("top")),i.innerHTML="";for(let e of n){let t=i.appendChild(document.createElement("div"));""===e?t.classList.add("separator"):e.startsWith("_")?t.innerText=e.slice(1):(t.innerText=e,t.onclick=()=>a(e),t.classList.add("contextMenuOption"))}G(i),window.addEventListener("click",(()=>{a(!1),K(i)}),{once:!0}),window.addEventListener("popstate",(()=>{a(!1),K(i)}),{once:!0})}))}function la(e,t={},n){if(Pe)return new Promise((function(a,o){Oe(),G("prompt");const i=Z("#promptForm");let r={};Z("#promptFormTitle").innerHTML=e;for(let e in t){let n=i.appendChild(document.createElement("label"));if(n.innerText=e,n.setAttribute("for",e),"number"==typeof t[e])r[e]=i.appendChild(document.createElement("input")),r[e].setAttribute("type","number"),r[e].value=t[e],r[e].id=e;else if("boolean"==typeof t[e]){let a=i.appendChild(document.createElement("div"));r[e]=a.appendChild(document.createElement("input")),a.appendChild(n),r[e].setAttribute("type","checkbox"),r[e].checked=t[e],r[e].id=e}else if(t[e]?.constructor===Array){r[e]=i.appendChild(document.createElement("select"));for(let n of t[e])r[e].appendChild(document.createElement("option")).innerText=n;r[e].id=e}else if("string"==typeof t[e])t[e].includes("\n")?r[e]=i.appendChild(document.createElement("textarea")):r[e]=i.appendChild(document.createElement("input")),r[e].value=t[e],r[e].id=e;else if(t[e]?.constructor===Object){if(r[e]=i.appendChild(document.createElement("input")),Object.entries(t[e]).forEach((t=>r[e].setAttribute(t[0],t[1]))),r[e].required&&n.classList.add("required"),"checkbox"===r[e].type||"radio"===r[e].type){let t=i.appendChild(document.createElement("div"));t.appendChild(r[e]),t.appendChild(n)}r[e].id=e}else{i.appendChild(document.createElement("div")).appendChild(n)}}for(let e of n||["OK","Cancel"]){let t=Z("#promptButtons").appendChild(document.createElement("button"));t.innerText=e,t.onclick="cancel"===e.toLowerCase()?()=>{a(!1),sa()}:()=>{if(!i.reportValidity())return;let t=Object.fromEntries(Object.entries(r).map((([e,t])=>[e,"checkbox"===t.type||"radio"===t.type?t.checked:"number"===t.type?parseFloat(t.value):t.value])));t.clicked=e,a(t),sa()}}}))}function sa(){Z("#promptForm").innerHTML="",Z("#promptButtons").innerHTML="",K("prompt"),Ue()}const da=Z("#toast"),ca=Z("#toastMessage");function ua(e,t,n){if(n?da.style.setProperty("--toast-accent",n>0?"#4f6":n<-.5?"#f64":"#fe4"):da.style.setProperty("--toast-accent","gray"),ca.innerHTML=t?t+"\n\n":"","object"==typeof e)for(let t in e)e[t]&&(ca.innerHTML+=t+" : "+e[t]+"\n");else ca.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",pa),window.addEventListener("keydown",pa),window.addEventListener("popstate",pa),$e.addEventListener("scroll",pa),G(da),da.classList.add("slide-up")}),200)}function ma(e){ua(e,"Warning",-.1)}function fa(e){ua(e,"Error",-1)}function pa(){window.removeEventListener("mousedown",pa),window.removeEventListener("keydown",pa),window.removeEventListener("popstate",pa),$e.removeEventListener("scroll",pa),K(da),da.classList.remove("slide-up")}const ha=Z("#theme-switch");function ga(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),ha.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),ha.innerText="dark_mode")}function Sa(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}ga(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);const va=(e,t)=>{e.addEventListener("click",t),e.setAttribute("onclick","")};[...document.querySelectorAll(".back")].forEach((e=>va(e,He))),[...document.querySelectorAll(".spinner")].forEach((e=>va(e,(e=>re(e.currentTarget))))),[...document.querySelectorAll(".spinnerBtn")].forEach((e=>va(e,(e=>re(e.currentTarget.firstElementChild))))),va(Z("#user"),(()=>{_e("profile")})),va(Z("#signInBtn"),(function(){Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),localStorage.email=Z("#signInEmailInput").value,signIn(Z("#signInEmailInput").value,Z("#signInPasswordInput").value).catch(Re)})),va(Z("#registerBtn"),(function(){Te(Z("#signInEmailInput").value)?(Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),signUp(Z("#signInEmailInput").value,Z("#signInPasswordInput").value).then((e=>{})).catch(Re)):fa("Invalid email address.")})),va(Z("#resetPwdBtn"),(async function(){Z("#signInEmailInput").value=Z("#signInEmailInput").value.trim().toLowerCase(),Te(Z("#signInEmailInput").value)?Z("#signInEmailInput").value?await la(`Would you like to send an email with a password-reset link to ${Z("#signInEmailInput").value}${a}?`)&&passwordReset(Z("#signInEmailInput").value).then((()=>{ua("Password reset email sent.","",1)})).catch((e=>Re(e,!0))):ua("You must enter your email address to reset your password."):fa("Invalid email address.")})),va(Z("#showNoPwdBtn"),(function(){localStorage.email&&localStorage.signInLinkSent?Be():Me("signinSendEmail")})),va(Z("#signInSendBtn"),(async function(){if(!Te(Z("#signInSendEmailInput").value))return void fa("Invalid email address.");if(localStorage.email=Z("#signInSendEmailInput").value=Z("#signInSendEmailInput").value.trim().toLowerCase(),!localStorage.email)return void ua("Please enter your username.");let e=await sendEmailLink(localStorage.email);"auth/invalid-email"===e?.error?(fa(`${localStorage.email}${a} is not a valid email address.`),localStorage.email=""):e?.error?fa(`Could not send sign-in email to ${localStorage.email}${a}.\n\n${e.error}`):(localStorage.signInLinkSent=ie().join(" at "),Be())})),va(Z("#signInWithEmailPasswordBtn"),(()=>{Me("signInWithEmailPassword")})),va(Z("#signInCompleteBtn"),(async function(){if(localStorage.email=Z("#signInConfirmEmailInput").value.trim(),!localStorage.email)return void ua("Please enter your username and click the [Sign in] button.");let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-email"===e?.error?(fa(`Email ${localStorage.email}${a} does not match the email address to which the link was sent.`),localStorage.email=""):e?.error&&fa("Could not sign in.\n\n"+e.error)})),va(Z("#signInWithEmailPasswordBtn2"),(()=>{Me("signInWithEmailPassword")})),va(Z("#signIngSendEmailBtn"),(()=>{Me("signinSendEmail")})),va(Z("#hideSigninLinkSentBtn"),(function(){delete localStorage.signInLinkSent,Me("signinSendEmail")})),va(Z("#signInWithEmailPasswordBtn3"),(()=>{Me("signInWithEmailPassword")})),va(Z("#addInstructorSectionBtn"),(async function(){Z("#editSectionSubmitBtn").innerText=An,K("editSectionDeleteBtn"),Z("#editSectionIdInput").removeAttribute("disabled"),Z("#editSectionSemesterSelect").removeAttribute("disabled"),await In(),Z("#editSectionInstructorEmailsInput").value=auth.currentUser.email,Z("#editSectionInstructorNamesInput").value="Prof. "+ve.f,Z("#editSectionIdInput").value="",Z("#editSectionPatternInput").value="",Z("#editSectionRoom").innerText=Tn,Z("#editSectionCrosslistInput").value="",Z("#editSectionLocationYes").checked=!0,Z("#editSectionSeatYes").checked=!0,Z("#editSectionPhotoYes").checked=!0,Z("#editSectionAllowSelfEnroll").checked=!1})),va(Z("#sectionsQRreaderBtn"),pt),va(Z("#addStudentSectionBtn"),(async function(){_e("selectStudentSection");var e=await Qe(localStorage.semesterSelected),t=Z("#availableStudentSections");t.innerHTML="<span></span>";let n=Object.keys(e).sort(),a=new Set(ve.e&&ve.e[localStorage.semesterSelected]?Object.keys(ve.e[localStorage.semesterSelected]):[]);for(let o of n){let n=e[o];if(n.v&&!a.has(o)&&!n.x?.filter((e=>a.has(e))).length&&(Gn(o,n,t,Kn),n.x?.length))for(let e of n.x)Gn(e,n,t,Kn)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")})),va(Z("#verifyEmailBtn"),xe),va(Z("#sectionsBtn"),(()=>{_e("sections")})),va(Z("#allSectionsBtn"),(async function(){_e("allSections");const e=Z("#allSectionsSemesterSelect");if(1==e.children.length){let t,n=await Ye();for(let a of n)t=e.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a;localStorage.semesterSelected&&(e.value=localStorage.semesterSelected)}ta()})),va(Z("#roomsBtn"),(()=>On())),va(Z("#manageUsersBtn"),(()=>qn())),va(Z("#logoutBtn"),Ie),va(Z("#logoutBtn2"),Ie),va(Z("#markAttendanceScanPasscodeBtn"),(()=>{pt("markAttendanceClassCodeInput")})),va(Z("#markAttendanceScanSeatCodeBtn"),(()=>{pt("markAttendanceSeatCodeInput")})),va(Z("#defaultSelfieImg"),Lt),va(Z("#selfieCanvas"),Lt),va(Z("#selfieVideo"),At),va(Z("#addPhotoBtn"),Lt),va(Z("#snapPhotoBtn"),At),va(Z("#switchPhotoBtn"),switchCamera),va(Z("#locationMissingBtn"),lt),va(Z("#locationMissingBtn2"),lt),va(Z("#markAttendanceButton"),(async function(){if(it.value=null,await lt(),Z("#markAttendanceButton").getAttribute("disabled"))ua("Missing some of the required fields.","",-1);else{if(markAttendanceRequirementsList.innerHTML&&!await la(`Your instructor requests the following information that you have not supplied:\n${markAttendanceRequirementsList.innerHTML}\n\nAre you sure you would like to mark attendance as is?\n\nPress Cancel to go back and add all of the required information.\nPress OK to mark your attendance without the requested information.`))return;let e=ot.value,t=at.innerText,n=localStorage.semesterSelected;if(e in ve.e[n][t]&&!ve.e[n][t][e].u)return void ua("You are already marked present, no need to do it again.");Fe(!0);let a=Z("#markAttendanceSeatCodeInput").value,o=it.value;o&&(o=[o.latitude,o.longitude,Math.round(o.accuracy)]);let i=await async function(e,t,n,a,o,i){const r=Ae(auth.currentUser.email);let l={[h]:db.serverTimestamp()},c={[`${r}.n`]:ve.n,[`${r}.f`]:ve.f,[`${r}.a.${n}`]:l};o?.size&&(wt=dt(r,e,t,n),l.p=!0,c[`${r}.p`]=wt);a&&(l.s=a);i&&(l.l=i);let u=await db.updateOne(d,Y(e,t),c);if(u?.error)return ve.e[e][t][n]={[h]:db.Timestamp.now(),[p]:-1},{error:"Please make sure the instructor is taking attendance, and that your attendance passcode is correct."};let m="",f=[];o?.size&&(u=await uploadFile(wt,o),u?.error&&(m+="- we were unable to save your photo\n",f.push("photo not saved")));u=await db.updateOne(s,auth.currentUser.email,{["e."+e+"."+t+"."+n]:{[h]:db.serverTimestamp()}}),u?.error&&(m+="- we were unable to save your attendance receipt\n",f.push("missing receipt"));if(ve.e[e][t][n]={[h]:db.Timestamp.now(),[A]:f.length?f.join(", "):""},m)return{warning:"Your attendance was marked (the instructor knows you attended).\nHOWEVER:\n"+m}}(n,t,e,a,vt,o);i?.error?(st(n,t),ua(i.error,"Your attendance was NOT marked.",-1)):i?.warning?(st(n,t),ma(i.warning)):(st(n,t),ua("Your attendance was marked.","Success!",1)),Fe(!1)}})),va(Z("#markAttendanceRemoveButton"),(async function(){let e="Are you sure you would like to remove this section from the list of sections you are enrolled in?";if(Z("#attendanceMarked").innerHTML&&(e+="\n\nWARNING: This action will delete all of your attendance receipts for this section."),await la(e)){let e=at.innerText;(await db.updateOne(s,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+e]:db.deleteField()})).error?fa("Something went wrong. Please try again."):(delete ve.e[localStorage.semesterSelected][e],ea(localStorage.semesterSelected),He())}})),va(Z("#switchQrCameraBtn"),(async function(){mt=await switchCameraStream(mt),ut.reset(),St()})),va(Z("#editSectionRoom"),kn),va(Z("#editSectionRoomBtn"),kn),va(Z("#editSectionResetRoomBtn"),(function(){Z("#editSectionRoom").innerText=Tn})),va(Z("#editSectionSubmitBtn"),(async function(){Ee(Z("#editSectionIdInput"));let e=Z("#editSectionSubmitBtn").innerText===An,t=Z("#editSectionSemesterSelect").value,n=Z("#editSectionIdInput").value,a={[$]:Z("#editSectionInstructorEmailsInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[N]:Z("#editSectionInstructorNamesInput").value.trim(),[R]:Z("#editSectionPatternInput").value,[B]:Z("#editSectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),[y]:Z("#editSectionSeatWarn").checked+2*Z("#editSectionSeatRequire").checked-Z("#editSectionSeatNo").checked,[b]:Z("#editSectionPhotoWarn").checked+2*Z("#editSectionPhotoRequire").checked-Z("#editSectionPhotoNo").checked,[C]:Z("#editSectionLocationWarn").checked+2*Z("#editSectionLocationRequire").checked-Z("#editSectionLocationNo").checked,v:Z("#editSectionAllowSelfEnroll").checked};if(Z("#editSectionRoom").innerText!==Tn&&(a.r=Z("#editSectionRoom").innerText),!t)return void ua("Please select semester.","Missing information:",-1);if(!n)return void ua("Please enter section id.","Missing information:",-1);if(e&&n.includes(i))return void ua('Specified section id includes an invalid character "|".',"Invalid section id:",-1);if(!a.pt)return void ua("Please enter section day/time pattern.","Missing information:",-1);if(!a.i)return void ua("Please enter section instructor email(s).","Missing information:",-1);if(!a.in)return void ua("Please enter section instructor name(s).","Missing information:",-1);if(a.x?.includes(n))return void ua("Please do not enter current section id under cross-listed section ids.","Invalid cross-listed information:",-1);if(!a.r){if(a.s>-1)return void ua('You have not assigned a room to this section.\nEither assign a room to this section or select the "No" option under "Collect seat information".',"Missing information:",-1);if(!await la("You have not assigned a room to this section.\nAre you sure you would like to continue without a room assignment?"))return}let o=await Qe(t);for(let t in o)if(t===n){if(e)return void ua(`Section ${n} already exists.`,"Duplicate section id:",-1)}else{let i=o[t];if(e&&i.x?.includes(n))return void ua(`Section ${n} already exists.\nIt is cross-listed with section ${t}.`,"Duplicate section id:",-1);if(a.x?.includes(t))return void ua(`Cannot list ${t} as a cross-listed section because a record for ${t} already exists.`,"Duplicate section id:",-1);let r=a.x?.filter((e=>i.x?.includes(e)));if(r.length)return void ua(`Cannot list ${r} as cross-listed section(s).\n${t} already includes cross-listed section(s):\n ${r}`,"Duplicate section id:",-1);if(a.r&&i.pt===a.pt&&i.r===a.r)return void ua(i.r+" is booked at this time by section "+t+".\n\nIf these sections are cross-listed, please edit information for "+t+" to indicate this, rather than creating a new section.","",-1)}if(!e){let e=o[n].x.filter((e=>!a.x.includes(e)));if(e.length&&!await la(`Are you sure you would like to remove ${e} as cross-listed section(s) for this course?\nThis action may have undesired consequences.`))return}(await db.updateOne(c,t,{[n]:a})).error?fa("Failed to add section.\n\nPlease try again."):(o[n]=Object.assign(o[n]||{},a),t===localStorage.semesterSelected&&(e&&Gn(n,a,Z("#instructorSections")),ea(localStorage.semesterSelected)),n===Tt.innerText&&(Z("#getAttendanceCrossListIds").innerHTML=a.x?"<span>"+a.x.join("</span> <span>")+"</span>":"",Z("#getAttendanceSectionInfo").innerText=a.pt+"\n"+(a.r||Tn)+"\n"+(a.in||a.i.join("\n")),Ot._sectionIds=[Tt.innerText].concat(a.x)),He())})),va(Z("#editSectionDeleteBtn"),(async function(){let e=await la('Are you sure you want to delete this section?<p>WARNING:<p>All data associated with this section will be lost, including all attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.',{Confirm:""});if(e){if("delete"!==e.Confirm)return void ma('The section was NOT deleted.\n\nYou clicked OK but did not enter the word "delete" at the Confirm prompt.\nIf you want to delete this section, please try again, and make sure to type the word "delete" at the Confirm prompt.');let t=Z("#editSectionSemesterSelect").value,n=Z("#editSectionIdInput").value,a=await db.updateOne(c,t,{[n]:db.deleteField()});a.error?fa("Failed to delete section.\n",a.error):(delete je[t][n],a=await db.deleteOne(d,Y(t,n)),a?.error&&fa("Deleted section, but failed to delete attendance data.\n",a.error),ea(localStorage.semesterSelected),He(),He())}})),va(Z("#createNewRoomBtn"),(function(){Z("#editRoomId").removeAttribute("disabled"),Z("#editRoomId").value="",Z("#editRoomCampus").value="",Z("#editRoomBuilding").value="",Z("#editRoomName").value="",K("editRoomDeleteBtn"),K("editRoomUsedIn"),Rn=[],Rn.indx=-1,Wn(Array(6).fill().map((()=>Array(4).fill(" ")))),_e("editRoom")})),va(Z("#editRoomResetBtn"),(function(){Rn.indx>0&&(Rn.indx=0,jn())})),va(Z("#editRoomUndoBtn"),(function(){Rn.indx>0?(Rn.indx--,jn()):ua("Nothing to undo.")})),va(Z("#editRoomRedoBtn"),(function(){Rn.indx<Rn.length-1?(Rn.indx++,jn()):ua("Nothing to redo.")})),va(Z("#editRoomGridBtn"),(async function(){let e=await la("Select grid size",{Rows:Rn[Rn.indx].length,Cols:Math.max(...Rn[Rn.indx].map((e=>e.length)))});e&&Wn(Array(e.Rows).fill().map((()=>Array(e.Cols).fill(" "))))})),va(Z("#editRoom123Btn"),(()=>Wn())),va(Z("#editRoomAbcBtn"),(function(){let e,t=JSON.parse(JSON.stringify(Rn[Rn.indx])),n=1;for(let a=t.length-1;a>-1;a--){let o=t[a];e=0;for(let i=0;i<o.length;i++)t[a][i]&&t[a][i]&&(t[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e++]+n);e&&n++}jn(t)})),va(Z("#editRoomSaveBtn"),(function(){if(null===Z("#editRoomId").getAttribute("disabled")){if(Z("#editRoomId").value=Z("#editRoomId").value.trim(),Ee(Z("#editRoomId")),!Z("#editRoomId").value)return void fa("Missing field: Room Id");if(Z("#editRoomId").value in We)return void fa(`Room ${Z("#editRoomId").value} already exists.`)}if(Z("#editRoomBuilding").value=Z("#editRoomBuilding").value.trim(),Z("#editRoomName").value=Z("#editRoomName").value.trim(),Z("#editRoomCampus").value=Z("#editRoomCampus").value.trim(),!Z("#editRoomBuilding").value)return void fa("Missing field: Building");if(!Z("#editRoomName").value)return void fa("Missing field: Room name or number");if(!Z("#editRoomCampus").value)return void fa("Missing field: Campus");let e=[...xn.children].map((e=>[...e.children].map((e=>e.innerText)))),t=e.flat();for(let e=0;e<t.length;e++)if(t[e]){if(t.indexOf(t[e])!==e)return void fa("Duplicate seat code: "+t[e]);if(!t[e].match(/^[a-z0-9]+$/i))return void fa(`Invalid seat code: ${t[e]}.\nSeat codes must be combinations of letters and numbers.`)}let n={[E]:Z("#editRoomName").value,[k]:Z("#editRoomBuilding").value,[x]:Z("#editRoomCampus").value,[I]:e.map((e=>e.join("\t"))).join("\n")},a=db.insertOne(u,Z("#editRoomId").value,n);a.error?fa("Could not save changes to room.\n"+a.error):(We[Z("#editRoomId").value]=n,n.cm!==localStorage.campusSelected?localStorage.campusSelected="":n.bl!==localStorage.buildingSelected&&(localStorage.buildingSelected=""),He(),Nn(),Mn&&(He(),Mn(Z("#editRoomId").value)))})),va(Z("#editRoomLabelsBtn"),(function(){let e=[...xn.children].reverse().map((e=>[...e.children].map((e=>e.innerText)))).flat().filter((e=>e));window.open("printLabels.html?"+e,"lectureSeatsLabels")})),va(Z("#editRoomDeleteBtn"),(async function(){if(await la("Are you sure you would like to delete this room record?",{},["Delete","Cancel"])){let e=db.deleteOne(u,Z("#editRoomId").value);e.error?fa("Could not delete room record.\n"+e.error):(delete We[Z("#editRoomId").value],He(),Nn())}})),va(Z("#addUserBtn"),(async function(){let e=await la("",{Email:{placeholder:"username"+a,required:!0,onchange:"this.value=this.value.trim().toLowerCase();if(!this.value.endsWith(DOMAIN))this.value+=DOMAIN"},"First name":"","Last name":"",Instructor:!1,Admin:!1},["Add User","Cancel"]);if(e){let t=e.Email.split("@");if(2!==t.length||!Te(t[0])||!e.Email.endsWith(a))return void fa(`Invalid email address ${e.Email}.`);let n=await db.getDoc(s,e.Email);if(n?.error)return void fa("Could not access the database.\n"+n.error);if(n)return void fa(`Cannot add user.\nUser with the email ${e.Email} already exists.`);let o={};if(e["First name"]&&(o.n=e["First name"]),e["Last name"]&&(o.f=e["Last name"]),(e.Instructor||e.Admin)&&(o.rl=1*e.Instructor+2*e.Admin),n=await db.insertOne(s,e.Email,o),n.error)return void fa("Could not add user to database.\n"+n.error);Ve[e.Email]=o,Z("#manageUsersList").childElementCount||(Z("#manageUsersList").innerHTML="",Z("#manageUsersList").appendChild(document.createElement("row")).innerHTML="<div>Admin</div><div>Instructor</div><div>Email</div><div>Last Name</div><div>Preferred Name</div>"),Jn(e.Email,o)}})),va(Z("#showAddUsersBtn"),(()=>Yn())),va(Z("#addUsersBtn"),(function(){let e=[...Z("#addUsersList").children].map((e=>[...e.children].map((e=>e.innerText)))).slice(1);if(Dn)Dn(e);else for(let t=0;t<e.length;t++);})),va(Z("#createSectionURLBtn"),(function(){let e=location.protocol+"//"+location.host+location.pathname+"?s="+Y(localStorage.semesterSelected,Tt.innerText);navigator.clipboard.writeText(e),ua("URL link for this section copied to clipboard.")})),va(Z("#randomAttendanceClassCodeBtn"),Bt),va(Z("#createQRCodeBtn"),(()=>$t())),va(Z("#createURLBtn"),(function(){let e=location.protocol+"//"+location.host+location.pathname+"?c="+Et.value+"&s="+Y(localStorage.semesterSelected,Tt.innerText);navigator.clipboard.writeText(e),ua("URL link for this attendance copied to clipboard.")})),va(Z("#collectAttendanceBtn"),(async function(){if("Start"===It.innerText){let e=parseInt(kt.innerText);if(isNaN(e)||e<1)return void ua("Please enter a numeric value greater than or equal to 1 for the minutes attendance is to be collected.");if(e>180&&!await la(`WARNING: You are attempting to open attendance collection for ${Math.floor(e/60)}+ hours.\nAre you sure you wish to continue?`))return;if(!Et.value)return void ua("Please enter a passcode for taking attendance.");{Ee(Et),jt();let e=Ot.attendanceCodesAndTimes.find((e=>e[0]===Et.value));if(e){let t=ie()[0];if(e[1].split(" ")[0]!==t)return void fa(`Cannot use attendance passcode ${Et.value}.\nThis passcode has already been used to take attendance on ${e[1].split(" ").join(" at ")}.`);if(!await la(`You were collecting attendance earlier today using the same passcode.\n\nWould you like to continue taking the same attendance?\n\n<li>To continue collecting attendance for passcode ${Et.value}, click Continue.</li><li>To take a new attendance, click Cancel, change the value for Attendance passcode, and click the Start button again.</li>`,{},["Continue","Cancel"]))return}}Fe(!0);let t=Tt.innerText,n=Tt._sectionDoc,a=db.now()+60*e,o={[f]:Et.value,[h]:db.serverTimestamp(),[g]:e};o.i=n.i;let i=await db.upsertOne(d,Y(localStorage.semesterSelected,t),o);if(i?.error)return fa("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Fe(!1);if(n.x?.length)for(let e of n.x)if(i=await db.upsertOne(d,Y(localStorage.semesterSelected,e),o),i?.error)return fa("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void Fe(!1);Ot._docs.forEach((e=>{o.d={seconds:db.now()},Object.assign(e,o)})),localStorage.minutesToCollectAttendance=e,localStorage.takingAttendance=Y(localStorage.semesterSelected,t),localStorage.attendanceEndtime=a,Mt()}else Dt();Fe(!1)})),va(Z("#refreshAttendanceBtn"),(()=>{Ht(!0)})),va(Z("#studentsAddBtn"),Wt),va(Z("#getAttendanceShowAttendanceTableBtn"),zt),va(Z("#getAttendanceShowRoomBtn"),(()=>fn())),va(Z("#learnNamesBtn"),(async function(){let e=[...new Set(Ot.filter((e=>e.p)).map((e=>e.Section)))];if(e.length>1){let t=await la("Please choose section:",{},e.concat(["Cancel"]));if(!t)return;e[0]=t.clicked}vn=Y(localStorage.semesterSelected,e[0]),bn[vn]?.length||(bn[vn]=te(Ot.filter((t=>t.p&&t.Section===e[0])).map((e=>e.Username))),bn[vn].indx=0),_e("learnNames"),G("learnNamesMain"),K("learnNamesDone"),Z("#learnNamesImg").src=r,Z("#learnNamesName").innerText="",Z("#learnNamesName").classList.add("hideName"),0==bn[vn].indx&&K("learnNamesPrevBtn"),setTimeout(yn,100)})),va(Z("#hideQRBtn"),(()=>{K("QRcodeContainer")})),va(Z("#showQRPopupBtn"),(function(){let e=location.protocol+"//"+location.host+location.pathname+"?c="+Et.value+"&s="+Y(localStorage.semesterSelected,Tt.innerText);window.open(`qrcode.html?${e}`,"LectureSeats QR Code","width=300,height=300,top=100,left=600")})),va(Z("#gotoRoomBtn"),(()=>{He(),setTimeout(fn,100)})),va(Z("#refreshAttendTableBtn"),(()=>{Kt(!0)})),va(Z("#attendanceTableSelectColsBtn"),(async function(){let e=await la("Select which columns to show",Object.fromEntries(Qt.header.map(((e,t)=>[e,!Qt.hiddenCols[t]])))),t=!1;for(let n in e){let a=Qt.header.indexOf(n);a>-1&&Boolean(Qt.hiddenCols[a])==e[n]&&(Qt.hiddenCols[a]=!e[n],t=!0)}t&&nn()})),va(Z("#attendanceTableFitBtn"),rn),va(Z("#attendanceTableColFirstBtn"),(function(){Qt.showingAttendanceCol=V,on(Qt.showingAttendanceCol)})),va(Z("#attendanceTableColLeftBtn"),(function(){Qt.showingAttendanceCol=Qt.showingAttendanceCol?Qt.showingAttendanceCol-1:V,Qt.showingAttendanceCol<V&&(Qt.showingAttendanceCol=Qt.header.length-1),on(Qt.showingAttendanceCol)})),va(Z("#attendanceTableColsAllBtn"),an),va(Z("#attendanceTableColRightBtn"),(function(){Qt.showingAttendanceCol=Qt.showingAttendanceCol?Qt.showingAttendanceCol+1:Qt.header.length-1,Qt.showingAttendanceCol>=Qt.header.length&&(Qt.showingAttendanceCol=V),on(Qt.showingAttendanceCol)})),va(Z("#attendanceTableColsLastBtn"),(function(){Qt.showingAttendanceCol=Qt.header.length-1,on(Qt.showingAttendanceCol)})),va(Z("#attendanceTableOptionsBtn"),(()=>{ee("attendanceTableOptions")})),va(Z("#attendanceTableOptionsHideBtn"),(()=>{K("attendanceTableOptions")})),va(Z("#downloadAttendanceBtn"),(async function(){let e=Object.fromEntries(Qt.header.map(((e,t)=>[e,!0])));e.Filename="attendance-"+Qt.id+".csv";let t=await la("Select fields to include in your downloaded data:\n\n<small><a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=true)\">Select All</a> <a href=# onclick=\"document.querySelectorAll('#prompt input').forEach(c=>c.checked=false)\">Deselect All</a></small>",e,["Download","Cancel"]);var n,a,o;t&&Qt.header.some((e=>t[e]))&&(t.Filename?t.Filename.endsWith(".csv")||(t.Filename+=".csv"):t.Filename="attendance-"+Qt.id+".csv",n=t.Filename,a=function(e){let t="";for(let n of[Qt.header].concat(Qt)){for(let a=0;a<Qt.header.length;a++)e&&!e[a]||(t+=("number"==typeof n[a]&&n[a].toString().split(".")[1]?.length>2?n[a].toFixed(2):n[a])+",");t=t.replace(/(,$)/,"\n")}return t}(Qt.header.map((e=>t[e]))),(o=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),o.setAttribute("download",n),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o))})),va(Z("#attendanceTableAddColBtn"),(async function(){let e=await la("Manually add attendance column (all students will be marked absent by default):",{"Attendance code":{required:!0,value:Math.random().toString().substring(2)},"Attendance time":{required:!0,type:"datetime-local",value:ie().join("T")}});Ot.attendanceCodesAndTimes.map((e=>e[0])).includes(e["Attendance code"])?fa(`Cannot add column with attendance code ${e["Attendance code"]}:\nThis attendance code has already been used for another attendance.`):(Ot.attendanceCodesAndTimes.push([e["Attendance code"],e["Attendance time"].split("T").join(" ")]),Ot.attendanceCodesAndTimes.sort(((e,t)=>e[1]>t[1]?1:-1)),Kt(!1))})),va(Z("#attendanceTableAddStudentBtn"),(async function(){let e=Tt.innerText,t=Tt._sectionDoc;if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await la("Please select a section for adding a student",{},n)).clicked,!e)return}qn((t=>{He(),setTimeout(Vt,100,t,e)}),`Find user records by using the filters below.\nClick on any user record to add that user to section ${e}.`)})),va(Z("#attendanceTableAddStudentsBtn"),Wt),va(Z("#attendanceTableClassLocBtn"),(async function(){var e=await Zt(Tt.innerText);setTimeout((async function(){Se(Z("#setClassLocDiv"),...e,1,(t=>e=t))}),150),await la('<div id="setClassLocDiv" class="w300 h300"></div>')&&(Xt(Tt.innerText,e),Z("#classLocation").innerText=await ye(...await Zt(Tt.innerText)),tn())})),va(Z("#showAttendanceTableBtn"),(()=>{He(),setTimeout(zt,100)})),va(Z("#refreshRoomBtn"),(()=>{fn(!0)})),va(Z("#attendanceRoomViewLeftBtn"),(function(){--mn<0&&(mn=Ot.attendanceCodesAndTimes.length-1),pn(),gn()})),va(Z("#attendanceRoomViewRightBtn"),(function(){++mn>=Ot.attendanceCodesAndTimes.length&&(mn=0),pn(),gn()})),va(Z("#attendanceRoomViewLastBtn"),(function(){mn!=Ot.attendanceCodesAndTimes.length-1&&(mn=Ot.attendanceCodesAndTimes.length-1,pn(),Z("#attendanceRoomViewLastBtn").classList.add("disabled"))})),va(Z("#attendanceRoomViewZoomOutBtn"),(function(){let e=parseFloat(localStorage["roomMapZoom-"+Ot.roomId])-.1;e>.1&&(localStorage["roomMapZoom-"+Ot.roomId]=e.toFixed(1)),Sn()})),va(Z("#attendanceRoomViewZoomInBtn"),(function(){localStorage["roomMapZoom-"+Ot.roomId]=(parseFloat(localStorage["roomMapZoom-"+Ot.roomId])+.1).toFixed(1),Sn()})),va(Z("#attendanceRoomViewNamesBtn"),(function(){cn.style.setProperty("--name-visible","hidden"===cn.style.getPropertyValue("--name-visible")?"visible":"hidden")})),va(Z("#learnNamesImg"),Cn),va(Z("#learnNamesName"),(function(){Z("#learnNamesName").classList.remove("hideName")})),va(Z("#learnNamesNextBtn"),Ln),va(Z("#learnNamesPrevBtn"),(function(){bn[vn].indx--,0==bn[vn].indx&&K("learnNamesPrevBtn"),yn()})),va(Z("#learnNamesRemoveBtn"),(function(){bn[vn].splice(bn[vn].indx,1),bn[vn].indx>=bn[vn].length?Ln():yn()})),va(Z("#attendanceCollectionStatus"),(()=>xt())),va(Z("#saveNameBtn"),(async function(){oa.setAttribute("disabled","true"),na.value=Ce(na.value),aa.value=Ce(aa.value);let e=await db.updateOne(s,auth.currentUser.email,{[v]:na.value,[w]:aa.value});e.error?fa("Unable to update name.\n"+e.error):(K(oa),ve.n=na.lastValue=na.value,ve.f=aa.lastValue=aa.value,ua("Name updated.","",1)),oa.removeAttribute("disabled"),Ue()})),va(Z("#helpScreen"),(()=>{K("helpScreen")})),va(Z("#closeHelpBtn"),(()=>{K("helpScreen")})),va(Z("#showHelpBtn"),(()=>{G("helpScreen")})),va(Z("#fontPlusBtn"),(()=>{Sa(1)})),va(Z("#fontMinusBtn"),(()=>{Sa(-1)})),va(Z("#theme-switch"),(function(){ga(ha.innerText.startsWith("dark"))})),Z("#getAttendanceClassCodeInput").addEventListener("input",(()=>Ee(Et,"Attendance passcode"))),Z("#minLateInput").addEventListener("input",Kt),Z("#pointsLateInput").addEventListener("input",Kt),Z("#markAttendanceClassCodeInput").addEventListener("input",lt),Z("#markAttendanceSeatCodeInput").addEventListener("input",lt),Z("#manageUsersEmailInput").addEventListener("input",Vn),Z("#manageUsersLastNameInput").addEventListener("input",Vn),Z("#manageUsersNameInput").addEventListener("input",Vn),Z("#addUsersEmails").addEventListener("input",Qn),Z("#addUsersNames").addEventListener("input",Qn),Z("#addUsersLastNameFirst").addEventListener("input",Qn),Z("#nameInput").addEventListener("input",ia),Z("#lastNameInput").addEventListener("input",ia),Z("#editSectionIdInput").addEventListener("input",(()=>Ee(Z("#editSectionIdInput"),"Section Id"))),Z("#editRoomId").addEventListener("input",(()=>Ee(Z("#editRoomId"),"Room Id"))),Z("#roomsCampusSelect").addEventListener("change",Pn),Z("#roomsBuildingSelect").addEventListener("change",Un),Z("#manageUsersSelectRoleAny").addEventListener("change",Vn),Z("#manageUsersSelectRoleStudent").addEventListener("change",Vn),Z("#manageUsersSelectRoleInstructor").addEventListener("change",Vn),Z("#manageUsersSelectRoleAdmin").addEventListener("change",Vn),Z("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,ea(e.target.value)})),Z("#allSectionsSemesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,ta()})),Z("#manageUsersEmailInput").addEventListener("focus",(()=>{})),Z("#manageUsersLastNameInput").addEventListener("focus",(()=>{})),Z("#manageUsersNameInput").addEventListener("focus",(()=>{}))}();