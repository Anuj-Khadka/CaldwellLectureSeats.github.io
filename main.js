"use strict";const APP_TITLE="LectureSeats",VERSION="v0.1.231019 (beta)",APP_LAST_UPDATE="2023-10-19",HELP_LAST_UPDATE="2023-10-17",DOMAIN="@caldwell.edu",SEMESTER_SECTION_SEPARATOR="|",INSTRUCTOR=1,ADMIN=2,REQUIRED_LOC=1,REQUIRED_SEAT=2,REQUIRED_PHOTO=4,PHOTO_TIMEOUT=6e5,DEFAULT_USER_IMG="user-icon.png",STATUS_EXCUSED=2,STATUS_ABSENT=1,STATUS_ERROR_MARKING_ATTENDANCE=-1,STATUS_PRESENT=0,PHOTO_NEXT_TIMER=3500,cUSERS="users",cATTENDANCE="attend",cSECTIONS="sections",cROOMS="rooms",fATTENDANCES="a",fATTENDANCE_CODE="c",fABSENCE_STATUS="u",fDATETIME="d",fDURATION="m",fENROLLED_SECTIONS="e",fNAME="n",fPHOTO="p",fSEAT="s",fLOCATION="l",fNOTES="nt",fROLE="rl",fROOM_ID="r",fROOM_NAME="rn",fROOM_LAYOUT="rm",fBUILDING="bl",fCAMPUS="cm",fSECTION_CROSS_LISTED="x",fSECTION_PATTERN="pt",fSECTION_REQUIRED_FIELDS="rq",fINSTRUCTOR_EMAILS="i",fINSTRUCTOR_NAMES="in",tSECTION_ID="Section",tUSER_ID="User",tNAME="Name",tATTENDANCE_GRADE="Attendance-Grade",tON_TIME="On-time",tLATE="Late",tABSENT="Absent",ATTEND_TABLE_ROW_HEADERS=["Section","User",tNAME,tATTENDANCE_GRADE,tON_TIME,tLATE,tABSENT],semesterSectionId=(e,t)=>e+"|"+t,formatSeatCode=e=>e?e.replace(/\s/g,"").toUpperCase():"",$=document.querySelector.bind(document);function makeFirstElementChild(e,t){e.firstElementChild!==t&&e.insertBefore(t,e.firstElementChild)}function hide(e){("string"==typeof e?document.getElementById(e):e).classList.add("hidden")}function show(e){("string"==typeof e?document.getElementById(e):e).classList.remove("hidden")}function showHide(e){("string"==typeof e?document.getElementById(e):e).classList.toggle("hidden")}function isHidden(e){return null===e.offsetParent}function shuffled(e){return e.map((e=>({r:e,sort:Math.random()}))).sort(((e,t)=>e.sort-t.sort)).map((({r:e})=>e))}function randInt(e){return Math.floor(Math.random()*e)}function capitalize(e){return e.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" ")}function tsv2arr(e){return e.split("\n").map((e=>e.split("\t")))}function usernameFromEmail(e){try{return e.split("@")[0].replaceAll(".","_")}catch(e){}}function pad0(e,t=2){return e.toString().padStart(t,"0")}function getDateTime(e){let t;return t=e?new Date(e?.constructor===db.Timestamp?1e3*e.seconds:e):new Date,[t.getFullYear()+"-"+pad0(t.getMonth()+1)+"-"+pad0(t.getDate()),pad0(t.getHours())+":"+pad0(t.getMinutes())]}async function getLocation(){try{return(await new Promise((function(e,t){navigator.geolocation.getCurrentPosition(e,t,{maximumAge:3e5,timeout:5e3,enableHighAccuracy:!0})}))).coords}catch(e){return{error:e.message}}}function download(e,t){var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function spinOnce(e){e.style.animation="",e.offsetWidth,e.style.animation="spin 0.5s",setTimeout((()=>e.style.animation=""),500)}var draggable,draggableOffsetX=0,draggableOffsetY=0;function makeDraggable(e,t){draggable=e,t.addEventListener("mousedown",mouseDown,!1)}function mouseDown(e){let t=e.target.getBoundingClientRect();draggableOffsetX=t.x-e.clientX,draggableOffsetY=t.y-e.clientY,window.addEventListener("mousemove",divMove,!0)}function divMove(e){draggable.style.position="fixed",draggable.style.top=e.clientY+draggableOffsetY+"px",draggable.style.left=e.clientX+draggableOffsetX+"px"}function enableDragToScroll(e){let t,n,a,o,i=!1;e.addEventListener("mousedown",(r=>{i=!0,e.classList.add("dragging"),t=r.pageX-e.offsetLeft,n=r.pageY-e.offsetTop,a=e.scrollLeft,o=e.scrollTop})),e.addEventListener("mouseleave",(t=>{i&&(i=!1,e.classList.remove("dragging"))})),e.addEventListener("mouseup",(t=>{i&&(Math.round(a)===Math.round(e.scrollLeft)&&Math.round(o)===Math.round(e.scrollTop)||(t.preventDefault(),t.stopPropagation(),window.addEventListener("click",(e=>{e.stopPropagation()}),{capture:!0,once:!0})),i=!1,e.classList.remove("dragging"))})),e.addEventListener("mousemove",(r=>{i&&(r.preventDefault(),r.stopPropagation(),e.scrollLeft=a-3*(r.pageX-e.offsetLeft-t),e.scrollTop=o-3*(r.pageY-e.offsetTop-n))}))}window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",divMove,!0)}),!1);const EARTH_RADIUS=6378137,DEGREES_PER_METER=1/(6378137*Math.PI/180);function metersToLatitude(e){return e*DEGREES_PER_METER}function metersToLongitude(e,t){return e*DEGREES_PER_METER/Math.cos(t*Math.PI/180)}function createMapInDiv(e,t,n,a,o){let i=L.map(e,{});L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(i);let r=metersToLatitude(a),s=metersToLongitude(a,t);i.fitBounds([[t-r,n-s],[t+r,n+s]]);let d=L.circle([t,n],{radius:a}).addTo(i);o&&i.on("moveend",(e=>{let t=i.getCenter();t=[t.lat,t.lng],o(t),d.setLatLng(t)}))}var userDoc,distancesBetweenCoords={};function getDistanceBetweenCoords(e,t){let n=e+","+t;if(n in distancesBetweenCoords)return distancesBetweenCoords[n];let[a,o]=e,[i,r]=t;const s=a*Math.PI/180,d=i*Math.PI/180,c=(i-a)*Math.PI/180,l=(r-o)*Math.PI/180,u=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s)*Math.cos(d)*Math.sin(l/2)*Math.sin(l/2);let m=6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)));return distancesBetweenCoords[n]=m,m}async function getAddr(e,t){let n=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`);if(n.ok)return(await n.json()).display_name}async function signOut(){delete window.loadPath,await auth.signOut(),location.reload()}async function checkSignIn(e){if(e||auth.currentUser){if(hide("signin"),show(mainDiv),show("user"),(userDoc=await db.findOne(cUSERS,e.email))?.error)return void toastError("Failed to search database.\n\n"+userDoc.error);if(null===userDoc){userDoc={};let t=await db.insertOne(cUSERS,userDoc,e.email);if(t.error)return void toastError("Could not add user to database.\n\n"+t.error.code)}let t;userDoc.n||forceInMain("profile","Please enter your name and save."),auth.currentUser.emailVerified?(delete localStorage.verificationEmailSent,hide("emailVerificationLink")):(localStorage.verificationEmailSent?$("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent:await verifyEmail(),show("emailVerificationLink"),forceInMain("profile","Please verify your email address before proceeding.")),userDoc.e||(userDoc.e={}),localStorage.semesterSelected&&!userDoc.e[localStorage.semesterSelected]&&(userDoc.e[localStorage.semesterSelected]={}),$("#userDisplayName").innerText=e.email,nameInput.value=nameInput.lastValue=userDoc.n||"",(1&userDoc.rl||2&userDoc.rl)&&(show("roomsBtn"),show("allSectionsBtn")),localStorage.markAttendanceSectionId&&showMarkAttendance(),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now()&&await showGetAttendance();let n=$("#semesterSelect");if(1==n.children.length){let e=await getSemesters();for(let a of e)t=n.appendChild(document.createElement("option")),t.id=t.value=t.innerText=a,t.id==localStorage.semesterSelected&&(t.setAttribute("selected",!0),showEnrolledAndTeachingSections(a))}}else if(userDoc=null,delete localStorage.takingAttendance,delete localStorage.attendanceEndtime,show("signin"),hide(mainDiv),hide("user"),$("#signInSendEmailInput").value=$("#signInEmailInput").value=localStorage.email||"",isSignInWithEmailLink(auth,window.loadPath||"")){delete localStorage.signInLinkSent;let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-action-code"===e?.error?toastError("This sign-in link has expired.\nPlease enter your username and click the [Send sign-in link] button to receive a new link."):"auth/invalid-email"===e?.error?(localStorage.email="",showInSignin("signinConfirmEmail")):e?.error&&toastError("Could not sign in.\n\n"+e.error)}else localStorage.email&&localStorage.signInLinkSent&&showSigninLinkSent()}async function verifyEmail(){try{await sendEmailVerification(window.auth.currentUser),localStorage.verificationEmailSent=getDateTime().join(" at "),$("#emailVerificationLinkDate").innerText=localStorage.verificationEmailSent,toast("Email verification link was sent to "+auth.currentUser.email)}catch(e){"auth/too-many-requests"===e.code?toastError("Cannot send another email yet.\nPlease wait a few minutes before retrying."):toastError("Could not send email.\n"+e.code)}}function showPasswordlessSignin(){localStorage.email&&localStorage.signInLinkSent?showSigninLinkSent():showInSignin("signinSendEmail")}function hideSigninLinkSent(){delete localStorage.signInLinkSent,showInSignin("signinSendEmail")}function showSigninLinkSent(){$("#signinLinkSent > div:first-child").innerHTML=`We sent an email with a sign-in link to ${localStorage.email}${DOMAIN} on ${localStorage.signInLinkSent}.<p>The email subject should be "Sign in to LectureSeats".<p>Please go to your email and click on the sign-in link.`,showInSignin("signinLinkSent")}async function signInSendButtonClick(){if(localStorage.email=$("#signInSendEmailInput").value.trim(),!localStorage.email)return void toast("Please enter your username.");let e=await sendEmailLink(localStorage.email);"auth/invalid-email"===e?.error?(toastError(`${localStorage.email}${DOMAIN} is not a valid email address.`),localStorage.email=""):e?.error?toastError(`Could not send sign-in email to ${localStorage.email}${DOMAIN}.\n\n${e.error}`):(localStorage.signInLinkSent=getDateTime().join(" at "),showSigninLinkSent())}async function signInCompleteButtonClick(){if(localStorage.email=$("#signInConfirmEmailInput").value.trim(),!localStorage.email)return void toast("Please enter your username and click the [Sign in] button.");let e=await trySigningInWithLink(window.loadPath,localStorage.email);"auth/invalid-email"===e?.error?(toastError(`Email ${localStorage.email}${DOMAIN} does not match the email address to which the link was sent.`),localStorage.email=""):e?.error&&toastError("Could not sign in.\n\n"+e.error)}function authErrorHandling(e,t){switch(e.code){case"auth/email-already-in-use":toastError(`Email address ${$("#signInEmailInput").value}${DOMAIN} already in use.`);break;case"auth/invalid-email":toastError(`Email address ${$("#signInEmailInput").value}${DOMAIN} is invalid.`);break;case"auth/operation-not-allowed":toastError("Error during sign up.");break;case"auth/user-not-found":toastError(`User ${$("#signInEmailInput").value}${DOMAIN} not found.`+(t?"":"\nDid you mean to click the Register button?"));break;case"auth/wrong-password":toastError("Wrong password.");break;case"auth/missing-password":toastError("No password provided.");break;case"auth/weak-password":toastError("Password is not strong enough. Add additional characters including special characters and numbers.");break;default:toastError("Unable to perform action.\n"+e.message);break}}function signInButtonClick(){localStorage.email=$("#signInEmailInput").value,$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),signIn($("#signInEmailInput").value,$("#signInPasswordInput").value).catch(authErrorHandling)}function registerButtonClick(){$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),signUp($("#signInEmailInput").value,$("#signInPasswordInput").value).then((e=>{})).catch(authErrorHandling)}function resetPassword(){$("#signInEmailInput").value=$("#signInEmailInput").value.trim(),$("#signInEmailInput").value?confirm(`Would you like to send an email with a password-reset link to ${$("#signInEmailInput").value}${DOMAIN}?`)&&passwordReset($("#signInEmailInput").value).then((()=>{toast("Password reset email sent.","",1)})).catch((e=>authErrorHandling(e,!0))):toast("You must enter your email address to reset your password.")}window.addEventListener("load",(async function(){setTimeout((()=>location.reload()),864e5),document.title=APP_TITLE,document.querySelectorAll(".domainName").forEach((e=>e.innerText=DOMAIN)),$("#versionInfo").innerText=`LectureSeats ${VERSION}\n\nApplication last updated on: 2023-10-19.\nThis help screen last updated on: 2023-10-17.`,window.loadPath=window.location.href;let e=new URLSearchParams(location.search);if(window.history.pushState(null,APP_TITLE,location.origin+this.location.pathname),e.has("s")){let[t,n]=e.get("s").split("|");localStorage.semesterSelected=t,localStorage.markAttendanceSectionId=n}e.has("c")&&(localStorage.markAttendanceCode=e.get("c")),onAuth(checkSignIn,(e=>toastError("Authentication error.\n\n"+e)))}));const mainDiv=$("#main");var navDisallowMessage,navAllowed=!0;function allowNav(){navAllowed=!0,navDisallowMessage=null}function disallowNav(e){navAllowed=!1,navDisallowMessage=e}function showInSignin(e){makeFirstElementChild($("#signin"),$("#"+e))}function showInMain(e){navAllowed?window.location.hash=e:navDisallowMessage&&toast(navDisallowMessage)}function forceInMain(e,t){makeFirstElementChild(mainDiv,$("#"+e)),disallowNav(t)}function navigateBack(){navAllowed&&history.back()}function loadingScreen(e){e?(show("loading"),disallowNav()):(hide("loading"),allowNav())}window.onhashchange=function(e){navAllowed?(makeFirstElementChild(mainDiv,$(location.hash||"#sections")),mainDiv.scrollTop=0):"#_"!==location.hash&&(location.hash="#_")},window.addEventListener("keydown",(e=>{"Escape"===e.key&&navigateBack()})),window.addEventListener("popstate",(e=>{hide("helpScreen")}));var allSections={},allRooms={},allSemesters=["2023Fall","2024Winter","2024Spring"],allAttendances={},allUsers=null;async function getSemesters(){return["2023Fall","2024Winter","2024Spring"]}async function getSections(e){if(e&&!allSections[e])if(allSections[e]=await db.findOne(cSECTIONS,e),null===allSections[e])allSections[e]={};else if(allSections[e].error)return void toastError("Something went wrong.\n\nTry to reload.");return allSections[e]}async function getSection(e,t){let n=await getSections(e);if(n[t])return n[t].id=t,n[t]}async function getRooms(e){return!e&&allRooms._gotAllRooms||((allRooms=await db.find(cROOMS))._gotAllRooms=!0),allRooms}async function getRoom(e){return e in allRooms||(allRooms[e]=await db.findOne(cROOMS,e)),allRooms[e]}async function getRoomLayout(e){return tsv2arr((await getRoom(e)).rm.toUpperCase())}async function getAttendance(e,t,n){t.constructor!==Array&&(t=[t]);var a=[];for(var o of(a._docs=[],a._sectionIds=[],t)){let t=semesterSectionId(e,o);if(n||!allAttendances[t])if(allAttendances[t]=await db.findOne("attend",t),null===allAttendances[t])allAttendances[t]={};else{if(allAttendances[t].error)return void toastError("Something went wrong.\n\nPlease try again.");for(let e in allAttendances[t])e.length>1&&(allAttendances[t][e].User=e,allAttendances[t][e].Section=o,allAttendances[t][e].Name=capitalize(allAttendances[t][e].n)||e,Object.entries(allAttendances[t][e].a).forEach((([e,t])=>{let n=getDateTime(t.d);t.date=n[0],t.time=n[1],t.code=e})))}a.push(...Object.entries(allAttendances[t]).filter((([e,t])=>e.length>1)).map((([e,t])=>t))),a._docs.push(allAttendances[t]),a._sectionIds.push(o)}return a}async function getUsers(){return allUsers||(allUsers=await db.find(cUSERS)),allUsers}const markAttendanceSectionId=$("#markAttendanceSectionId"),markAttendanceClassCodeInput=$("#markAttendanceClassCodeInput"),markAttendanceLocation=$("#markAttendanceLocation");async function showMarkAttendance(e,t){if(showInMain("markAttendance"),!e){if(e=localStorage.markAttendanceSectionId,delete localStorage.markAttendanceSectionId,(t=await getSection(localStorage.semesterSelected,e)).x?.length){let n=[e].concat(t.x),a=n.filter((e=>e in userDoc.e[localStorage.semesterSelected]));if(a.length)e=a[0];else{e=(await promptF("Please choose which section you are enrolled in.",{},n)).clicked}}userDoc.e[localStorage.semesterSelected][e]||(userDoc.e[localStorage.semesterSelected][e]={})}markAttendanceSectionId.innerText=e,markAttendanceSectionId._sectionDoc=t,$("#markAttendanceRemoveButtonSectionId").innerText=e,markAttendanceClassCodeInput.value=localStorage.markAttendanceCode||"",delete localStorage.markAttendanceCode,t.s<0?hide("markAttendanceSeatContainer"):(show("markAttendanceSeatContainer"),t.s>0?$('label[for="markAttendanceSeatCodeInput"]').classList.add("required"):$('label[for="markAttendanceSeatCodeInput"]').classList.remove("required"),$("#markAttendanceSeatCodeInput").value=""),markAttendanceSectionId._sectionDoc.p<0?hide("markAttendancePhotoContainer"):(show("markAttendancePhotoContainer"),markAttendanceSectionId._sectionDoc.p>0?$('label[for="selfieCanvas"]').classList.add("required"):$('label[for="selfieCanvas"]').classList.remove("required"),show("defaultSelfieImg"),show("addPhotoBtn"),hide(selfieCanvas),hide(selfieVideo),hide("snapPhotoBtn"),hide("switchPhotoBtn")),markAttendanceSectionId._sectionDoc.l<0?hide("markAttendanceLocationContainer"):(show("markAttendanceLocationContainer"),markAttendanceSectionId._sectionDoc.l>0?$('label[for="markAttendanceLocation"]').classList.add("required"):$('label[for="markAttendanceLocation"]').classList.remove("required")),showMarkedAttendances(localStorage.semesterSelected,e),checkMissingAttendanceInfo()}async function validateSeat(e,t){return!t||((e=formatSeatCode(e))?(await getRoomLayout(t)).flat().indexOf(e)>=0:void 0)}async function checkMissingAttendanceInfo(){const e=$("#markAttendanceRequirementsList");e.innerHTML="";let t=!1;if(markAttendanceClassCodeInput.value||(e.appendChild(document.createElement("li")).innerText="Attendance passcode",t=!0),markAttendanceSectionId._sectionDoc.l>-1&&!markAttendanceLocation.value){let n=await getLocation();n.error?(hide(markAttendanceLocation),markAttendanceSectionId._sectionDoc.l>0?(show("markAttendanceLocationOffButRequired"),e.appendChild(document.createElement("li")).innerText="Location",markAttendanceSectionId._sectionDoc.l>1&&(t=!0)):show("markAttendanceLocationOff")):(markAttendanceLocation.value=n,show(markAttendanceLocation),hide("markAttendanceLocationOff"))}if(markAttendanceSectionId._sectionDoc.s>0&&!await validateSeat($("#markAttendanceSeatCodeInput").value,markAttendanceSectionId._sectionDoc.r)&&(e.appendChild(document.createElement("li")).innerText="Valid seat code",markAttendanceSectionId._sectionDoc.s>1&&(t=!0)),markAttendanceSectionId._sectionDoc.p>-1){let n=selfieBlob?.size&&photoTakenTime&&(new Date).getTime()-photoTakenTime<6e5;markAttendanceSectionId._sectionDoc.p>0&&!n&&(show("defaultSelfieImg"),hide(selfieCanvas),hide(selfieVideo),selfieBlob=photoTakenTime=null,e.appendChild(document.createElement("li")).innerText="New photo",markAttendanceSectionId._sectionDoc.p>1&&(t=!0))}e.innerHTML?show("markAttendanceRequirements"):hide("markAttendanceRequirements"),t?$("#markAttendanceButton").setAttribute("disabled",!0):$("#markAttendanceButton").removeAttribute("disabled")}function showMarkedAttendances(e,t){let n=$("#attendanceMarked"),a=Object.values(userDoc.e[e][t]).sort(((e,t)=>e.d-t.d));if(a?.length){n.innerHTML="Attendance marked:";for(let e of a){let t=getDateTime(e.d),a=n.appendChild(document.createElement("div")),o=t[0]+" ";1===e.u?(o+="absent",a.setAttribute("absent",!0)):2===e.u?(o+="absence excused",a.setAttribute("excused",!0)):-1===e.u?(o+=t[1]+" failed to mark attendance",a.setAttribute("absent",!0)):o+=t[1],e.nt&&(o+=" <small>("+e.nt+")</small>"),a.innerHTML=o}mainDiv.scrollTop=0}else n.innerHTML=""}async function checkInfoAndMarkAttendance(){if(markAttendanceLocation.value=null,await checkMissingAttendanceInfo(),$("#markAttendanceButton").getAttribute("disabled"))toast("Missing some of the required fields.","",-1);else{if(markAttendanceRequirementsList.innerHTML&&!await promptF(`Your instructor requests the following information that you have not supplied:\n${markAttendanceRequirementsList.innerHTML}\n\nAre you sure you would like to mark attendance as is?\n\nPress Cancel to go back and add all of the required information.\nPress OK to mark your attendance without the requested information.`))return;let e=markAttendanceClassCodeInput.value,t=markAttendanceSectionId.innerText,n=localStorage.semesterSelected;if(e in userDoc.e[n][t]&&!userDoc.e[n][t][e].u)return void toast("You are already marked present, no need to do it again.");loadingScreen(!0);let a=$("#markAttendanceSeatCodeInput").value,o=markAttendanceLocation.value;o&&(o=[o.latitude,o.longitude,Math.round(o.accuracy)]);let i=await markAttendance(n,t,e,a,selfieBlob,o);i?.error?(showMarkedAttendances(n,t),toast(i.error,"Your attendance was NOT marked.",-1)):i?.warning?(showMarkedAttendances(n,t),toastWarn(i.warning,-.1)):(showMarkedAttendances(n,t),toast("Your attendance was marked.","Success!",1)),loadingScreen(!1)}}function photoStoragePath(e,t,n,a){return[e,t,n,a+".jpg"].join("/")}function photoStorageFolderPath(e,t,n){return[e,t,n].join("/")}async function markAttendance(e,t,n,a,o,i){let r=usernameFromEmail(auth.currentUser.email),s=`${r}.a.${n}`,d=`${r}.n`,c=`${r}.p`,l={d:db.serverTimestamp()},u={[d]:userDoc.n,[s]:l};o?.size&&(photoId=photoStoragePath(r,e,t,n),l.p=!0,u[c]=photoId),a&&(l.s=a),i&&(l.l=i);let m=await db.updateOne("attend",semesterSectionId(e,t),u);if(m?.error)return userDoc.e[e][t][n]={d:db.Timestamp.now(),u:-1},{error:"Please make sure the instructor is taking attendance, and that your attendance passcode is correct."};let S="",h=[];return o?.size&&(m=await uploadFile(photoId,o),m?.error&&(S+="- we were unable to save your photo\n",h.push("photo not saved"))),m=await db.updateOne(cUSERS,auth.currentUser.email,{["e."+e+"."+t+"."+n]:{d:db.serverTimestamp()}}),m?.error&&(S+="- we were unable to save your attendance receipt\n",h.push("missing receipt")),userDoc.e[e][t][n]={d:db.Timestamp.now(),nt:h.length?h.join(", "):""},S?{warning:"Your attendance was marked (the instructor knows you attended).\nHOWEVER:\n"+S}:void 0}async function removeSectionFromStudent(){let e="Are you sure you would like to remove this section from the list of sections you are enrolled in?";if($("#attendanceMarked").innerHTML&&(e+="\n\nWARNING: This action will delete all of your attendance receipts for this section."),await promptF(e)){let e=markAttendanceSectionId.innerText;(await db.updateOne(cUSERS,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+e]:db.deleteField()})).error?toastError("Something went wrong. Please try again."):(delete userDoc.e[localStorage.semesterSelected][e],showEnrolledAndTeachingSections(localStorage.semesterSelected),navigateBack())}}const codeReader=new ZXing.BrowserMultiFormatReader;var currentQRstream,scanTarget;async function openQRreader(e){showInMain("QRreader"),currentQRstream=await getVideoStream(!1),scanTarget=e,startQRreader(),window.addEventListener("popstate",closeQRreader,{once:!0})}function closeQRreader(){codeReader.reset(),window.removeEventListener("popstate",closeQRreader)}function onScanResult(e,t){if(e){if(e.text?.startsWith("http")){let t=new URLSearchParams(e.text.split("?")[1]);t.has("c")&&(e={text:t.get("c")})}document.getElementById(scanTarget).value=e.text,checkMissingAttendanceInfo(),closeQRreader(),navigateBack()}!t||t instanceof ZXing.NotFoundException||toastError("Could not complete QR scan.\n"+t)}async function startQRreader(){codeReader.decodeFromStream(currentQRstream,"QRreaderVideo",onScanResult)}async function switchQRCamera(){currentQRstream=await switchCameraStream(currentQRstream),codeReader.reset(),startQRreader()}var selfieBlob=null,photoId=null,photoTakenTime=null;const selfieCanvas=$("#selfieCanvas"),selfieVideo=$("#selfieVideo");async function enableSelfieCamera(){try{await startCamera(selfieVideo,200),window.addEventListener("popstate",stopCamera,{once:!0}),hide("defaultSelfieImg"),hide(selfieCanvas),hide("addPhotoBtn"),show(selfieVideo),show("snapPhotoBtn"),show("switchPhotoBtn")}catch(e){selfiePhotoBtn.innerHTML='<span class="material-symbols-outlined">photo_camera</span> Retry taking selfie...',toastError("Unable to start camera.\nPlease make sure your camera permissions are enabled, reload, and try again.")}}async function snapPhoto(){hide(selfieVideo),hide("snapPhotoBtn"),hide("switchPhotoBtn"),show(selfieCanvas),show("addPhotoBtn"),takePhoto(selfieVideo,selfieCanvas,200),selfieBlob=await canvasToBlob(selfieCanvas),photoTakenTime=(new Date).getTime(),checkMissingAttendanceInfo()}const getAttendanceSectionId=$("#getAttendanceSectionId"),getAttendanceClassCodeInput=$("#getAttendanceClassCodeInput"),collectAttendanceBtn=$("#collectAttendanceBtn"),minutesToCollectAttendanceText=$("#minutesToCollectAttendance");async function showGetAttendance(e,t){if(showInMain("getAttendance"),e||(e=localStorage.takingAttendance,t=await getSection(localStorage.semesterSelected,e)),getAttendanceSectionId.innerText=e,getAttendanceSectionId._sectionDoc=t,$("#getAttendanceCrossListIds").innerHTML=t.x?"<span>"+t.x.join("</span> <span>")+"</span>":"",$("#getAttendanceSectionInfo").innerText=t.pt+"\n"+(t.r||NO_ASSIGNED_ROOM)+"\n"+(t.in||t.i.join("\n")),$("#getAttendanceEditBtn").onclick=n=>{editSection(e,t)},hide("currentAttendanceStatus"),hide("showStudentsOptions"),await updateCurrentAttendanceRecords(),sortAttendanceCodesAndTimesForCurrentAttendanceRecords(),currentAttendanceRecords._docs[0].c&&currentAttendanceRecords._docs[0].d.seconds+60*currentAttendanceRecords._docs[0].m>db.now()&&(localStorage.takingAttendance=e,getAttendanceClassCodeInput.value=currentAttendanceRecords._docs[0].c,localStorage.minutesToCollectAttendance=currentAttendanceRecords._docs[0].m,localStorage.attendanceEndtime=currentAttendanceRecords._docs[0].d.seconds+60*currentAttendanceRecords._docs[0].m,takingAttendance()),localStorage.takingAttendance&&parseInt(localStorage.attendanceEndtime)>db.now())localStorage.takingAttendance===e?(show("getAttendanceControls"),showCurrentAttendanceStatus()):hide("getAttendanceControls");else{show("getAttendanceControls");let e=currentAttendanceRecords.attendanceCodesAndTimes[currentAttendanceRecords.attendanceCodesAndTimes.length-1];e&&e[1].split(" ")[0]===getDateTime()[0]?(getAttendanceClassCodeInput.value=e[0],showCurrentAttendanceStatus()):randomAttendanceClassCode()}minutesToCollectAttendanceText.innerText=localStorage.minutesToCollectAttendance||75}function randomAttendanceClassCode(){getAttendanceClassCodeInput.value=Math.random().toString().substring(2)}minutesToCollectAttendanceText.addEventListener("keydown",(e=>{if(e.target.getAttribute("contenteditable"))if("ArrowDown"===e.key){let t=(parseInt(e.target.innerText)||0)-1;t>=1&&(e.target.innerText=t)}else"ArrowUp"===e.key?e.target.innerText=(parseInt(e.target.innerText)||0)+1:isNaN(parseInt(e.key))&&!["Backspace","Delete","ArrowLeft","ArrowRight"].includes(e.key)&&e.preventDefault()}));const codeWriter=new ZXing.BrowserQRCodeSvgWriter;function createQRClick(){const e=$("#QRcodeContainer");let t=location.protocol+"//"+location.host+location.pathname+"?c="+getAttendanceClassCodeInput.value+"&s="+semesterSectionId(localStorage.semesterSelected,getAttendanceSectionId.innerText);if(t!==e.getAttribute("title")){e.setAttribute("title",t),$("#QRcode").innerHTML="",codeWriter.writeToDom("#QRcode",t,300,300);let n=$("#QRcode > svg");n.removeAttribute("width"),n.removeAttribute("height"),n.setAttribute("viewBox","0 0 300 300"),makeDraggable(e,n)}$("#QRcodeContainer").classList.toggle("hidden")}async function collectAttendanceBtnClick(){if("Start"===collectAttendanceBtn.innerText){let e=parseInt(minutesToCollectAttendanceText.innerText);if(isNaN(e)||e<1)return void toast("Please enter a numeric value greater than or equal to 1 for the minutes attendance is to be collected.");if(e>180&&!await promptF(`WARNING: You are attempting to open attendance collection for ${Math.floor(e/60)}+ hours.\nAre you sure you wish to continue?`))return;if(!getAttendanceClassCodeInput.value)return void toast("Please enter a passcode for taking attendance.");{sortAttendanceCodesAndTimesForCurrentAttendanceRecords();let e=currentAttendanceRecords.attendanceCodesAndTimes.filter((e=>e[0]===getAttendanceClassCodeInput.value))[0];if(e){let t=getDateTime()[0];if(e[1].split(" ")[0]!==t)return void toastError(`Cannot use attendance passcode ${getAttendanceClassCodeInput.value}.\nThis passcode has already been used to take attendance on ${e[1].split(" ").join(" at ")}.`);if(!await promptF(`You were collecting attendance earlier today using the same passcode.\n\nWould you like to continue taking the same attendance?\n\n<li>To continue collecting attendance for passcode ${getAttendanceClassCodeInput.value}, click Continue.</li><li>To take a new attendance, click Cancel, change the value for Attendance passcode, and click the Start button again.</li>`,{},["Continue","Cancel"]))return}}loadingScreen(!0);let t=getAttendanceSectionId.innerText,n=getAttendanceSectionId._sectionDoc,a=db.now()+60*e,o={c:getAttendanceClassCodeInput.value,d:db.serverTimestamp(),m:e};currentAttendanceRecords?._docs[0].i||(o.i=n.i);let i=await db.upsertOne("attend",semesterSectionId(localStorage.semesterSelected,t),o);if(i.error)return toastError("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void loadingScreen(!1);if(n.x?.length)for(let e of n.x)if(i=await db.upsertOne("attend",semesterSectionId(localStorage.semesterSelected,e),o),i.error)return toastError("Cannot start taking attendance.\nWe are having issues writing to the database.\n"+i.error),void loadingScreen(!1);currentAttendanceRecords._docs.forEach((e=>Object.assign(e,o))),localStorage.minutesToCollectAttendance=e,localStorage.takingAttendance=t,localStorage.attendanceEndtime=a,takingAttendance()}else stopTakingAttendance();loadingScreen(!1)}var attendanceTimer,currentAttendanceRecords;function takingAttendance(){collectAttendanceBtn.innerText="Stop",getAttendanceClassCodeInput.setAttribute("disabled",!0),$("#collectingAttendance").innerText="Collecting",show("createQRCodeBtn"),hide("randomAttendanceClassCodeBtn"),show("attendanceCollectionStatus"),$("#attendanceCollectionStatus>div").innerText=getAttendanceSectionId.parentElement.innerText.trim(),minutesToCollectAttendanceText.removeAttribute("contenteditable"),showCurrentAttendanceStatus(!1),clearInterval(attendanceTimer),attendanceTimer=setInterval(updateAttendanceTime,1e3)}function updateAttendanceTime(){let e=parseInt(localStorage.attendanceEndtime)-db.now();if(e<=0)stopTakingAttendance(!1);else{let t=Math.floor(e/60),n=e-60*t;minutesToCollectAttendanceText.innerText=t+":"+pad0(n),$("#attendanceCollectionStatus>span").innerText=minutesToCollectAttendanceText.innerText}}async function stopTakingAttendance(e=!0){if(e){let e=getAttendanceSectionId.innerText,t=getAttendanceSectionId._sectionDoc,n=[],a=db.updateOne("attend",semesterSectionId(localStorage.semesterSelected,e),{c:db.deleteField()});if(a.error&&n.push(e),t.x?.length)for(let e of t.x)a=db.updateOne("attend",semesterSectionId(localStorage.semesterSelected,e),{c:db.deleteField()}),a.error&&n.push(e);if(n.length)return void toastError("Error updating database for the following sections:\n"+n)}clearInterval(attendanceTimer),collectAttendanceBtn.innerText="Start",getAttendanceClassCodeInput.removeAttribute("disabled"),$("#collectingAttendance").innerText="Collect",hide("QRcodeContainer"),hide("createQRCodeBtn"),show("randomAttendanceClassCodeBtn"),hide("attendanceCollectionStatus"),showCurrentAttendanceStatus(!0),minutesToCollectAttendanceText.setAttribute("contenteditable","true"),minutesToCollectAttendanceText.innerText=localStorage.minutesToCollectAttendance||"75",currentAttendanceRecords._docs.forEach((e=>delete e.c)),delete localStorage.takingAttendance,delete localStorage.attendanceEndtime}async function showCurrentAttendanceStatus(e=!0){show("currentAttendanceStatus"),e&&await updateCurrentAttendanceRecords(!0),$("#currentAttendanceStatus > span").innerHTML=`Today's attendance for passcode ${getAttendanceClassCodeInput.value}:\n${currentAttendanceRecords.filter((e=>e.a[getAttendanceClassCodeInput.value]&&!e.a[getAttendanceClassCodeInput.value].u)).length} of ${currentAttendanceRecords.length} marked present\n<small>(last checked ${(new Date).toLocaleTimeString()}</small>)`}async function updateCurrentAttendanceRecords(e){let t=getAttendanceSectionId.innerText,n=getAttendanceSectionId._sectionDoc,a=[t].concat(n.x||[]);(currentAttendanceRecords=await getAttendance(localStorage.semesterSelected,a,e)).length?(show("showStudentsOptions"),currentAttendanceRecords.filter((e=>e.p)).length?show("learnNamesBtn"):hide("learnNamesBtn")):hide("showStudentsOptions")}function sortAttendanceCodesAndTimesForCurrentAttendanceRecords(){if(!currentAttendanceRecords.attendanceCodesAndTimes){var e={};currentAttendanceRecords.map((e=>Object.values(e.a))).flat().forEach((t=>{if(!t.u){let n=e[t.code],a=t.date+" "+t.time;(!n||n>a)&&(e[t.code]=a)}})),currentAttendanceRecords.attendanceCodesAndTimes=Object.entries(e).sort(((e,t)=>e[1]>t[1]?1:-1))}}async function addStudentBtnClick(){let e=getAttendanceSectionId.innerText,t=getAttendanceSectionId._sectionDoc;if(t.x?.length){let n=[e].concat(t.x);if(n.push("Cancel"),e=(await promptF("Please select a section for adding a student",{},n)).clicked,!e)return}await addStudentAvailableStudents(e);let n=await promptF(`Adding student to section ${e}.\n\nPlease enter student id`,{"Student ID":{oninput:"addStudentInput(this.value)",list:"addStudentUserSelectDataList"}},["Add Student","Cancel"]);"Add Student"===n.clicked&&n["Student ID"]&&addStudent(n["Student ID"],e,t)}function addStudentInput(e){}async function addStudentAvailableStudents(e){let t=new Set((await getAttendance(localStorage.semesterSelected,e)).map((e=>e.userId))),n=Object.entries(await getUsers()).filter((e=>!t.has(usernameFromEmail(e[0]))));$("#addStudentUserSelectDataList").innerHTML="";for(let e of n){let t=$("#addStudentUserSelectDataList").appendChild(document.createElement("option"));t.innerText=t.value=usernameFromEmail(e[0]),e[1].n&&(t.innerText+=" ("+e[1].n+")")}}async function addStudent(e,t,n){const a=e+DOMAIN;if(!(a in await getUsers()))return void toastError(`Student with the username ${e} was not found.`);const o=localStorage.semesterSelected;let i,r;if(n.x?.length&&(r=[n.id].concat(n.x).filter((e=>e.id!==t)),i=(await getAttendance(o,r)).filter((t=>t.userId===e))),i?.length){i=i[0];const n=i.sectionId;if(confirm(`Are you sure you would like to move ${e} from section ${n} to section ${t}?`)){let r=(await getUsers())[a];if(!r.e[o][t]&&r.e[o][n]){let e=await db.updateOne(cUSERS,a,{["e."+o+"."+t]:r.e[o][n],["e."+o+"."+n]:db.deleteField()});if(e.error)return void toastError("Student personal record could not be updated.\n"+e.error);r.e[o][t]=r.e[o][n],delete r.e[o][n]}let s={n:r.n,a:i.a};i.p&&(s.p=i.p);let d=await db.updateOne("attend",semesterSectionId(o,t),{[e]:s});if(d.error)return void toastError("Attendance record for student could not be created.\n"+d.error);if(allAttendances[semesterSectionId(o,t)][e]=i,i.sectionId=t,d=await db.updateOne("attend",semesterSectionId(o,n),{[e]:db.deleteField()}),d.error)return void toastError("New attendance record for student was created, but the old attendance record for student could not be deleted.\n"+d.error);delete allAttendances[semesterSectionId(o,n)][e],toast(`Student ${e} was successfully moved from section ${n} to section ${t}.`,"",1)}}else if(confirm(`Are you sure you would like to add ${e} to section ${t}?`)){let n=(await getUsers())[a];n.e||(n.e={}),n.e[o]||(n.e[o]={});let i={["e."+o+"."+t]:{}},s=[];if(r)for(let e of r)e in n.e[o]&&(i["e."+o+"."+e]=db.deleteField(),s.push(e));let d=await db.updateOne(cUSERS,a,i);if(d.error)return void toastError("Student personal record could not be updated.\n"+d.error);n.e[o][t]={};for(let e of s)delete n.e[o][e];if(d=await db.updateOne("attend",semesterSectionId(o,t),{[e]:{n:n.n,a:{}}}),d.error)return void toastError("Attendance record for student could not be created.\n"+d.error);allAttendances[semesterSectionId(o,t)][e]={n:n.n,a:{},userId:e,sectionId:t},toast(`Student ${e} was successfully added to section ${t}.`,"",1)}createAttendanceTable()}const attendancesDiv=$("#attendances");var attendanceTable;enableDragToScroll($("#attendancesHolder"));const ATTEND_TABLE_DATA_COL_OFFSET=ATTEND_TABLE_ROW_HEADERS.length;async function showAttendanceTable(){await createAttendanceTable(),showInMain("attendanceTableScreen"),!attendanceTable?.hiddenCols?.length&&$("#attendancesHolder").getBoundingClientRect().width<400&&setTimeout(attendanceTableFitToWidth,100),$("#classLocation").innerText=await getAddr(...await getClassLocation(getAttendanceSectionId.innerText))}async function getClassLocation(e){let t=localStorage.getItem("loc_"+e);return t?t=JSON.parse(t):(t=await getLocation(),t=[t.latitude,t.longitude],setClassLocation(e,t)),t}function setClassLocation(e,t){localStorage.setItem("loc_"+e,JSON.stringify(t))}async function classLocPrompt(){var e=await getClassLocation(getAttendanceSectionId.innerText);setTimeout((async function(){createMapInDiv($("#setClassLocDiv"),...e,1,(t=>e=t))}),150),await promptF('<div id="setClassLocDiv" class="w300 h300"></div>')&&(setClassLocation(getAttendanceSectionId.innerText,e),$("#classLocation").innerText=await getAddr(...await getClassLocation(getAttendanceSectionId.innerText)),displayAttendanceTable())}async function createAttendanceTable(e=!1){e&&await updateCurrentAttendanceRecords(!0),sortAttendanceCodesAndTimesForCurrentAttendanceRecords();var t=parseInt($("#minLateInput").value);!t||t<1?$("#minLateInput").value=t=parseInt(localStorage.minutesConsideredLate)||20:localStorage.minutesConsideredLate=t;var n=parseInt($("#pointsLateInput").value);let a,o;!n||n<0||n>100?$("#pointsLateInput").value=n=parseInt(localStorage.pointsForLate)||50:localStorage.pointsForLate=n;for(let e of currentAttendanceRecords){e.attendAndAbsentArray=[],e.attendTimeOffsets=[],e[tON_TIME]=0,e.Absent=0,e.Late=0;for(let[n,i]of currentAttendanceRecords.attendanceCodesAndTimes){if(a=e.a[n],a)e.attendAndAbsentArray.push(a);else{a={u:1,code:n},e.a[n]=a,e.attendAndAbsentArray.push(a);let t={u:1,d:db.makeTimestamp(i.split(" ")[0]+" 00:00")};db.updateOne("attend",semesterSectionId(localStorage.semesterSelected,e.Section),{[e.User+".a."+n]:t}),db.updateOne(cUSERS,e.User+DOMAIN,{["e."+localStorage.semesterSelected+"."+e.Section+"."+n]:t})}1===a.u?(e.Absent++,e.attendTimeOffsets.push("absent")):2===a.u?e.attendTimeOffsets.push("excused"):(o=Math.floor((a.d-db.makeTimestamp(i))/60),o>=t?e.Late++:e[tON_TIME]++,e.attendTimeOffsets.push(o))}e[tATTENDANCE_GRADE]=(100*e[tON_TIME]+e.Late*n)/(e[tON_TIME]+e.Late+e.Absent)}(attendanceTable=[]).semester=localStorage.semesterSelected,attendanceTable.id=attendanceTable.semester+"_"+currentAttendanceRecords._sectionIds.join("_"),attendanceTable.attendanceCodes=currentAttendanceRecords.attendanceCodesAndTimes.map((e=>e[0])),attendanceTable.attendanceTimes=currentAttendanceRecords.attendanceCodesAndTimes.map((e=>e[1])),attendanceTable.header=ATTEND_TABLE_ROW_HEADERS.concat(attendanceTable.attendanceTimes);for(let e of currentAttendanceRecords){let t=[];for(let n of ATTEND_TABLE_ROW_HEADERS)t.push(e[n]);t=t.concat(e.attendTimeOffsets),t._fullRecord=e,attendanceTable.push(t)}attendanceTable.sortStack=JSON.parse(localStorage.getItem("sortStack_"+attendanceTable.id)||"[]"),attendanceTable.sortDesc=JSON.parse(localStorage.getItem("sortDesc_"+attendanceTable.id)||"[]"),attendanceTable.hiddenCols=JSON.parse(localStorage.getItem("hiddenCols_"+attendanceTable.id)||"[]"),displayAttendanceTable()}function createAttendanceEditingPrompt(e,t,n,a){return async function(){let o=semesterSectionId(localStorage.semesterSelected,e.Section),i=e.User+".a."+t.code+".",r=n.join(" at "),s=`Record for ${e.Name} (${e.User}) for attendance taken on ${r}:\n\n`;if(2===t.u?s+="Attendance excused.":1===t.u?s+="Absent.":s+=`Attendance marked ${a?"after "+a+"min":"right away"}.\n\nSeat: ${t.s||"missing"}`,t.p&&(s+=`\n\n<img src="${await getLinkFromStoragePath(photoStoragePath(e.User,localStorage.semesterSelected,e.Section,t.code))}" onerror="this.src='user-icon.png';" width="125">`),t.l&&(s+='<div class="locmap"></div>',setTimeout((()=>{createMapInDiv($(".locmap"),...t.l)}),150)),t.nt&&(s+="\n\nNotes:\n"+t.nt),"Edit attendance record"===(await promptF(s+"\n\n",{},["OK","Edit attendance record"])).clicked){let s={Present:{type:"radio",name:"status"},Absent:{type:"radio",name:"status"},Excused:{type:"radio",name:"status"},"Minutes late":{type:"number",value:t.u?"":a},Seat:t.s||"",Notes:t.nt||""};1===t.u?s.Absent.checked=!0:2===t.u?s.Excused.checked=!0:s.Present.checked=!0;let d=await promptF(`Record for ${e.Name} (${e.User}) for attendance taken on ${r}:\n\n`,s,["Save","Cancel"]);if("Save"===d?.clicked){let r={};if(d.Present){let e=parseInt(d["Minutes late"])||0;(t.u||e!==a)&&(r[i+"d"]=db.makeTimestamp(n,e),t.d=r[i+"d"])}else{let e=db.makeTimestamp(n[0]+" 00:00");t.d?.seconds!=e.seconds&&(r[i+"d"]=e,t.d=r[i+"d"])}if(d.Present&&t.u?(r[i+"u"]=0,t.u=r[i+"u"]):d.Absent&&1!==t.u?(r[i+"u"]=1,t.u=r[i+"u"]):d.Excused&&2!==t.u&&(r[i+"u"]=2,t.u=r[i+"u"]),d.Seat!==t.s&&(r[i+"s"]=d.Seat||"",t.s=r[i+"s"]),d.Notes!==t.nt&&(r[i+"nt"]=d.Notes||"",t.nt=r[i+"nt"]),Object.keys(r).length){let n=await db.updateOne("attend",o,r);if(n.error)toastError("Unable to update attendance record.\n"+n.error);else if(i+"u"in r||i+"d"in r){let n="e."+localStorage.semesterSelected+"."+e.Section+"."+t.code+".",a={[n+"nt"]:`updated by ${auth.currentUser.email} on ${getDateTime()[0]}`};i+"u"in r&&(a[n+"u"]=r[i+"u"]),i+"d"in r&&(a[n+"d"]=r[i+"d"]);let o=await db.updateOne(cUSERS,e.User+DOMAIN,a);o.error?toastError("Updated attendance record for instructor, but unable to update student's personal attendance record.\n"+o.error):toast("Record updated.","",1)}else toast("Record updated.","",1);createAttendanceTable()}else toast("Nothing changed. Record not updated.")}}}}function createAttendanceStudentPrompt(e){return async function(){let t=`${e.Name} (${e.User})\n${e.Section}\n\n<img src="${await getLinkFromStoragePath(e.p)||"user-icon.png"}">\n\nAbsent: ${e.Absent}\nLate: ${e.Late}`,n=await promptF(t+"\n\n",{},["OK","Remove student from section"]);if("Remove student from section"===n.clicked&&(n=await promptF(`Are you sure you want to remove ${e.Name} (${e.User}) from section ${e.Section}?\n\nWARNING: This action will permanently DELETE all of the student's attendance records associated with this section.`,{},["DELETE student from section","Cancel"]),"DELETE student from section"===n.clicked)){const t=semesterSectionId(localStorage.semesterSelected,e.Section);let n=await db.updateOne("attend",t,{[e.User]:db.deleteField()});if(n.error)return void toastError("Could not delete student record.\n\n"+n.error);n=await db.updateOne(cUSERS,e.User+DOMAIN,{["e."+localStorage.semesterSelected+"."+e.Section]:db.deleteField()});let a=await deleteFiles(photoStorageFolderPath(e.User,localStorage.semesterSelected,e.Section));n.error&&a.error?toastError("Deleted student from section, but failed to update student's personal record and could not delete student's uploaded photos."):n.error?toastError("Deleted student from section, but failed to update student's personal record."):a.error?toastError("Deleted student from section, but could not delete student's uploaded photos."):toast(`${e.Name} (${e.User}) was deleted from section ${e.Section}.`,"",1),createAttendanceTable(!0)}}}async function displayAttendanceTable(){attendancesDiv.innerHTML="";var e=await getClassLocation(getAttendanceSectionId.innerText),t=parseInt(localStorage.minutesConsideredLate);sortAttendanceTable();for(let o of[attendanceTable.header].concat(attendanceTable)){var n=attendancesDiv.appendChild(document.createElement("row"));for(let i=0;i<attendanceTable.header.length;i++){var a=n.appendChild(document.createElement("div"));if(attendanceTable.hiddenCols[i]&&a.classList.add("hiddenCol"),o===attendanceTable.header)a.innerText=o[i],i>=ATTEND_TABLE_DATA_COL_OFFSET&&(a.title=attendanceTable.attendanceCodes[i-ATTEND_TABLE_DATA_COL_OFFSET]),a.addEventListener("click",(()=>sortAttendanceTableCol(i))),a.addEventListener("contextmenu",attendanceTableHeaderRightClick),a.classList.add("table-header");else if(i>=ATTEND_TABLE_DATA_COL_OFFSET){a.innerHTML="excused"===o[i]?"➖":"absent"===o[i]?"❌":o[i]<t?"✔️":"+"+o[i]+"min";let n=o._fullRecord.attendAndAbsentArray[i-ATTEND_TABLE_DATA_COL_OFFSET];if("excused"!==o[i]&&"absent"!==o[i])if(n.s||a.classList.add("missingSeat"),n.p||a.classList.add("missingPhoto"),n.l){a.classList.add("hasLocation");let t=getDistanceBetweenCoords(n.l,e);a.style.setProperty("--distColor",`rgb(${t/15},${255-t/15},0)`)}else a.classList.add("missingLocation");a.onclick=createAttendanceEditingPrompt(o._fullRecord,n,attendanceTable.header[i].split(" "),o[i]),a.style.textAlign="center"}else a.innerText=o[i],a.onclick=createAttendanceStudentPrompt(o._fullRecord),isNaN(parseFloat(o[i]))||(a.style.textAlign="center",Number.isInteger(o[i])||(a.innerText=o[i].toFixed(1)))}}attendancesDiv.style.setProperty("--colNum",n.children.length)}function showAllAttendanceCols(){if(attendanceTable.showingAttendanceCol){delete attendanceTable.showingAttendanceCol;for(let e=ATTEND_TABLE_DATA_COL_OFFSET;e<attendanceTable.header.length;e++)attendanceTableHideShowCol(e,!0)}else showOneAttendanceCol()}function showOneAttendanceCol(e){e||(e=attendanceTable.showingAttendanceCol=attendanceTable.showingAttendanceCol||attendanceTable.header.length-1);for(let t=ATTEND_TABLE_DATA_COL_OFFSET;t<attendanceTable.header.length;t++)attendanceTableHideShowCol(t,e==t)}function attendanceColFirst(){attendanceTable.showingAttendanceCol=ATTEND_TABLE_DATA_COL_OFFSET,showOneAttendanceCol(attendanceTable.showingAttendanceCol)}function attendanceColLast(){attendanceTable.showingAttendanceCol=attendanceTable.header.length-1,showOneAttendanceCol(attendanceTable.showingAttendanceCol)}function attendanceColLeft(){attendanceTable.showingAttendanceCol=attendanceTable.showingAttendanceCol?attendanceTable.showingAttendanceCol-1:ATTEND_TABLE_DATA_COL_OFFSET,attendanceTable.showingAttendanceCol<ATTEND_TABLE_DATA_COL_OFFSET&&(attendanceTable.showingAttendanceCol=attendanceTable.header.length-1),showOneAttendanceCol(attendanceTable.showingAttendanceCol)}function attendanceColRight(){attendanceTable.showingAttendanceCol=attendanceTable.showingAttendanceCol?attendanceTable.showingAttendanceCol+1:attendanceTable.header.length-1,attendanceTable.showingAttendanceCol>=attendanceTable.header.length&&(attendanceTable.showingAttendanceCol=ATTEND_TABLE_DATA_COL_OFFSET),showOneAttendanceCol(attendanceTable.showingAttendanceCol)}function attendanceTableFitToWidth(){let e=attendanceTable.header.length-attendanceTable.hiddenCols.filter((e=>e)).length;if(e<3&&!attendanceTable.hiddenCols[2]&&attendanceTable.hiddenCols[1])return attendanceTableHideShowCol(2,!1),void attendanceTableHideShowCol(1,!0);const t=$("#attendancesHolder").getBoundingClientRect().width;if(e<3||attendancesDiv.getBoundingClientRect().width<=t){for(let e=0;e<ATTEND_TABLE_DATA_COL_OFFSET;e++)attendanceTableHideShowCol(e,!0);attendancesDiv.getBoundingClientRect().width<t&&showAllAttendanceCols()}else{attendancesDiv.getBoundingClientRect().width>t&&showOneAttendanceCol();for(var n=["User","Section","Attendance-Grade","Absent","Late","On-time"];n.length&&attendancesDiv.getBoundingClientRect().width>t;){let e=n.pop();attendanceTableHideShowCol(attendanceTable.header.indexOf(e),!1)}}}function attendanceTableHideShowCol(e,t=null){let n,a=document.querySelectorAll(`#attendances > row > div:nth-child(${e+1})`);for(n of a)!0===t?n.classList.remove("hiddenCol"):!1===t?n.classList.add("hiddenCol"):n.classList.toggle("hiddenCol");attendanceTable.hiddenCols[e]=n.classList.contains("hiddenCol"),localStorage.setItem("hiddenCols_"+attendanceTable.id,JSON.stringify(attendanceTable.hiddenCols))}function attendanceTableHeaderRightClick(e){e.preventDefault(),attendanceTableHideShowCol([...e.currentTarget.parentElement.children].indexOf(e.currentTarget))}async function attendanceTableSelectCols(){let e=await promptF("Select which columns to show",Object.fromEntries(attendanceTable.header.map(((e,t)=>[e,!attendanceTable.hiddenCols[t]]))));for(let t in e){let n=attendanceTable.header.indexOf(t);n>-1&&attendanceTable.hiddenCols[n]===e[t]&&attendanceTableHideShowCol(n)}}function sortAttendanceTable(){attendanceTable?.sortStack?.length&&attendanceTable.sort(((e,t)=>{let n,a;for(let o of attendanceTable.sortStack){if(n="excused"===e[o]?9e8:"absent"===e[o]?9e9:e[o],a="excused"===t[o]?9e8:"absent"===t[o]?9e9:t[o],n>a)return attendanceTable.sortDesc[o]?-1:1;if(a>n)return attendanceTable.sortDesc[o]?1:-1}}))}function sortAttendanceTableCol(e){attendanceTable.sortStack[0]===e?(attendanceTable.sortDesc[e]=!attendanceTable.sortDesc[e],localStorage.setItem("sortDesc_"+attendanceTable.id,JSON.stringify(attendanceTable.sortDesc))):(attendanceTable.sortStack=[e].concat(attendanceTable.sortStack.filter((t=>t!=e))),localStorage.setItem("sortStack_"+attendanceTable.id,JSON.stringify(attendanceTable.sortStack))),displayAttendanceTable()}function attendanceCSV(){let e="";for(let t of[attendanceTable.header].concat(attendanceTable)){for(let n=0;n<attendanceTable.header.length;n++)e+=t[n]+",";e+="\n"}return e}function downloadAttendanceRecord(){download("attendance-"+attendanceTable.id+".csv",attendanceCSV())}const roomMap=$("#roomMap"),roomMapHolder=$("#roomMapHolder");var roomViewAttendanceIndex;async function showRoom(e=!1){e&&await updateCurrentAttendanceRecords(!0),sortAttendanceCodesAndTimesForCurrentAttendanceRecords();let t=getAttendanceSectionId._sectionDoc;currentAttendanceRecords.roomId=t.r,localStorage["roomMapZoom-"+currentAttendanceRecords.roomId]||(localStorage["roomMapZoom-"+currentAttendanceRecords.roomId]=1),roomViewAttendanceIndex=currentAttendanceRecords.attendanceCodesAndTimes.length-1,displayRoomViewForAttendance()}async function displayRoomViewForAttendance(){let e=currentAttendanceRecords.roomId?await getRoomLayout(currentAttendanceRecords.roomId):[["","","","","","","","","",""]],t=e.flat().filter((e=>e));var n={},a=[],o=[],i=currentAttendanceRecords.attendanceCodesAndTimes[roomViewAttendanceIndex][0];$("#roomViewDate").innerText=currentAttendanceRecords.attendanceCodesAndTimes[roomViewAttendanceIndex][1];for(let e of currentAttendanceRecords){let r=e.a[i];if(r&&2!==r.u&&1!==r.u){let a=formatSeatCode(r.s);e._seat=a,e._notes=r.nt,e._time=r.time,e._photo=r.p?photoStoragePath(e.User,localStorage.semesterSelected,e.Section,i):e.p,t.includes(a)&&!n[a]?n[a]=e:o.push(e)}else a.push(e),r&&(e._notes=r.nt),r&&2===r.u?e._time="excused":e._time="absent",e._photo=e.p}roomMap.innerHTML="",roomMap._cols=0;for(let t=0;t<e.length;t++){let a=e[t];roomMap._cols=Math.max(roomMap._cols,a.length);let o=roomMap.appendChild(document.createElement("div"));for(let i=0;i<a.length;i++){let a=e[t][i],r=o.appendChild(document.createElement("div"));if(a){r.classList.add("seat");let e=n[a];e?addStudentToSeat(r,e):r.innerText=a}}}let r=roomMap.appendChild(document.createElement("div"));r.classList.add("bad-seating");for(let e of o){let t=r.appendChild(document.createElement("div"));t.classList.add("seat"),addStudentToSeat(t,e)}let s=roomMap.appendChild(document.createElement("div"));s.classList.add("absent");for(let e of a){let t=s.appendChild(document.createElement("div"));t.classList.add("seat"),addStudentToSeat(t,e)}attendanceRoomViewZoom(),r.style.maxWidth=`calc(var(--seat-width) * ${roomMap._cols})`,s.style.maxWidth=`calc(var(--seat-width) * ${roomMap._cols})`,showInMain("room"),setTimeout((()=>{roomMapHolder.scrollLeft=(roomMapHolder.scrollWidth-roomMapHolder.offsetWidth)/2}),100)}function addStudentToSeat(e,t){e.classList.add("taken"),getLinkFromStoragePath(t._photo).then((t=>e.style.backgroundImage=`url("${t||"user-icon.png"}"), url(user-icon.png)`)),e.innerHTML=`<span>${t.Name.split(" ")[0]}</span>`,e.onmouseover=()=>{e.innerHTML=`<span>${t.Name}\n<small>${t._time}\n${t._seat||""}\n${t.Section}\n${t._notes||""}</small></span>`},e.onmouseout=()=>{e.innerHTML=`<span>${t.Name.split(" ")[0]}</span>`,e.classList.remove("enlarge")},e.onclick=()=>{e.classList.toggle("enlarge")}}function attendanceRoomViewLeft(){--roomViewAttendanceIndex<0&&(roomViewAttendanceIndex=currentAttendanceRecords.attendanceCodesAndTimes.length-1),displayRoomViewForAttendance()}function attendanceRoomViewRight(){++roomViewAttendanceIndex>=currentAttendanceRecords.attendanceCodesAndTimes.length&&(roomViewAttendanceIndex=0),displayRoomViewForAttendance()}function attendanceRoomViewLast(){roomViewAttendanceIndex=currentAttendanceRecords.attendanceCodesAndTimes.length-1,displayRoomViewForAttendance()}function attendanceRoomViewZoomIn(){localStorage["roomMapZoom-"+currentAttendanceRecords.roomId]=(parseFloat(localStorage["roomMapZoom-"+currentAttendanceRecords.roomId])+.1).toFixed(1),attendanceRoomViewZoom()}function attendanceRoomViewZoomOut(){let e=parseFloat(localStorage["roomMapZoom-"+currentAttendanceRecords.roomId])-.1;e>.1&&(localStorage["roomMapZoom-"+currentAttendanceRecords.roomId]=e.toFixed(1)),attendanceRoomViewZoom()}function attendanceRoomViewZoom(){let e=parseFloat(localStorage["roomMapZoom-"+currentAttendanceRecords.roomId]);roomMap.style.setProperty("--seat-width",25*e+"px"),roomMap.style.setProperty("--seat-height",25*e+"px")}function roomNamesToggle(){roomMap.style.setProperty("--name-visible","hidden"===roomMap.style.getPropertyValue("--name-visible")?"visible":"hidden")}enableDragToScroll(roomMapHolder);let learnNamesSection,learnNamesCurrentPhotos,learnNameRecs={};async function showLearnNames(){let e=[...new Set(currentAttendanceRecords.filter((e=>e.p)).map((e=>e.Section)))];if(e.length>1){let t=await promptF("Please choose section:",{},e.concat(["Cancel"]));if(!t)return;e[0]=t.clicked}learnNamesSection=semesterSectionId(localStorage.semesterSelected,e[0]),learnNameRecs[learnNamesSection]?.length||(learnNameRecs[learnNamesSection]=shuffled(currentAttendanceRecords.filter((t=>t.p&&t.Section===e[0])).map((e=>e.User))),learnNameRecs[learnNamesSection].indx=0),showInMain("learnNames"),show("learnNamesMain"),hide("learnNamesDone"),$("#learnNamesImg").src="user-icon.png",$("#learnNamesName").innerText="",$("#learnNamesName").classList.add("hideName"),0==learnNameRecs[learnNamesSection].indx&&hide("learnNamesPrevBtn"),setTimeout(learnNamesShowUser,100)}function learnNamesShowUser(){learnNamesCurrentPhotos&&clearTimeout(learnNamesCurrentPhotos.nextPhotoTimeout);let e=learnNameRecs[learnNamesSection][learnNameRecs[learnNamesSection].indx],[t,n]=learnNamesSection.split("|"),a=currentAttendanceRecords.find((t=>t.User===e));learnNamesCurrentPhotos=Object.values(a.a).filter((e=>e.p)).map((a=>photoStoragePath(e,t,n,a.code))),learnNamesCurrentPhotos.indx=randInt(learnNamesCurrentPhotos.length),learnNamesImgClick(),$("#learnNamesName").innerText=a.Name,$("#learnNamesName").classList.add("hideName")}async function learnNamesImgClick(){isHidden($("#learnNamesImg"))||(clearTimeout(learnNamesCurrentPhotos.nextPhotoTimeout),learnNamesCurrentPhotos.indx++,learnNamesCurrentPhotos.indx>=learnNamesCurrentPhotos.length&&(learnNamesCurrentPhotos.indx=0),$("#learnNamesImg").src=await getLinkFromStoragePath(learnNamesCurrentPhotos[learnNamesCurrentPhotos.indx]),learnNamesCurrentPhotos.nextPhotoTimeout=setTimeout(learnNamesImgClick,3500))}function learnNamesNextBtnClick(){if(!learnNameRecs[learnNamesSection].length)return hide("learnNamesMain"),void show("learnNamesDone");learnNameRecs[learnNamesSection].indx++,learnNameRecs[learnNamesSection].indx>=learnNameRecs[learnNamesSection].length?(learnNameRecs[learnNamesSection]=shuffled(learnNameRecs[learnNamesSection]),learnNameRecs[learnNamesSection].indx=0,hide("learnNamesPrevBtn")):learnNameRecs[learnNamesSection].indx&&show("learnNamesPrevBtn"),learnNamesShowUser()}function learnNamesPrevBtnClick(){learnNameRecs[learnNamesSection].indx--,0==learnNameRecs[learnNamesSection].indx&&hide("learnNamesPrevBtn"),learnNamesShowUser()}function learnNamesNameClick(){$("#learnNamesName").classList.remove("hideName")}function learnNamesRemoveBtnClick(){learnNameRecs[learnNamesSection].splice(learnNameRecs[learnNamesSection].indx,1),learnNameRecs[learnNamesSection].indx>=learnNameRecs[learnNamesSection].length?learnNamesNextBtnClick():learnNamesShowUser()}const CREATE_SECTION_BUTTON_TEXT="Create New Section",NO_ASSIGNED_ROOM="No assigned room";async function createNewSection(){$("#editSectionSubmitBtn").innerText="Create New Section",hide("editSectionDeleteBtn"),$("#editSectionIdInput").removeAttribute("disabled"),$("#editSectionSemesterSelect").removeAttribute("disabled"),await showEditSectionScreen(),$("#editSectionInstructorEmailsInput").value=auth.currentUser.email,$("#editSectionInstructorNamesInput").value=userDoc.n,$("#editSectionIdInput").value="",$("#editSectionPatternInput").value="",$("#editSectionRoom").innerText=NO_ASSIGNED_ROOM,$("#editSectionCrosslistInput").value="",$("#editSectionLocationYes").checked=!0,$("#editSectionSeatYes").checked=!0,$("#editSectionPhotoYes").checked=!0}async function editSection(e,t){$("#editSectionSubmitBtn").innerText="Save Section",show("editSectionDeleteBtn"),$("#editSectionIdInput").setAttribute("disabled",!0),$("#editSectionSemesterSelect").setAttribute("disabled",!0),await showEditSectionScreen(),$("#editSectionIdInput").value=e,$("#editSectionPatternInput").value=t.pt,$("#editSectionRoom").innerText=t.r||NO_ASSIGNED_ROOM,$("#editSectionCrosslistInput").value=t.x?.join("\n")||"",$("#editSectionInstructorEmailsInput").value=t.i?.join("\n")||"",$("#editSectionInstructorNamesInput").value=t.in||"",-1===t.s?$("#editSectionSeatNo").checked=!0:1===t.s?$("#editSectionSeatWarn").checked=!0:2===t.s?$("#editSectionSeatRequire").checked=!0:$("#editSectionSeatYes").checked=!0,-1===t.p?$("#editSectionPhotoNo").checked=!0:1===t.p?$("#editSectionPhotoWarn").checked=!0:2===t.p?$("#editSectionPhotoRequire").checked=!0:$("#editSectionPhotoYes").checked=!0,-1===t.l?$("#editSectionLocationNo").checked=!0:1===t.l?$("#editSectionLocationWarn").checked=!0:2===t.l?$("#editSectionLocationRequire").checked=!0:$("#editSectionLocationYes").checked=!0}async function showEditSectionScreen(){let e;showInMain("addOrEditSection");let t=$("#editSectionSemesterSelect");if(1==t.children.length){let n=await getSemesters();for(let a of n)e=t.appendChild(document.createElement("option")),e.id=e.value=e.innerText=a}for(let e of t.children)e.innerText==localStorage.semesterSelected?(e.setAttribute("selected",!0),t.value=e.value):e.removeAttribute("selected")}function editSectionResetRoom(){$("#editSectionRoom").innerText=NO_ASSIGNED_ROOM}async function editSectionSaveSection(){let e="Create New Section"===$("#editSectionSubmitBtn").innerText,t=$("#editSectionSemesterSelect").value,n=$("#editSectionIdInput").value,a={i:$("#editSectionInstructorEmailsInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),in:$("#editSectionInstructorNamesInput").value.trim(),pt:$("#editSectionPatternInput").value,x:$("#editSectionCrosslistInput").value?.split("\n")?.map((e=>e.trim()))?.filter((e=>e)),s:$("#editSectionSeatWarn").checked+2*$("#editSectionSeatRequire").checked-$("#editSectionSeatNo").checked,p:$("#editSectionPhotoWarn").checked+2*$("#editSectionPhotoRequire").checked-$("#editSectionPhotoNo").checked,l:$("#editSectionLocationWarn").checked+2*$("#editSectionLocationRequire").checked-$("#editSectionLocationNo").checked};if($("#editSectionRoom").innerText!==NO_ASSIGNED_ROOM&&(a.r=$("#editSectionRoom").innerText),!t)return void toast("Please select semester.","Missing information:",-1);if(!n)return void toast("Please enter section id.","Missing information:",-1);if(e&&n.includes("|"))return void toast('Specified section id includes an invalid character "|".',"Invalid section id:",-1);if(!a.pt)return void toast("Please enter section day/time pattern.","Missing information:",-1);if(!a.i)return void toast("Please enter section instructor email(s).","Missing information:",-1);if(!a.in)return void toast("Please enter section instructor name(s).","Missing information:",-1);if(a.x?.includes(n))return void toast("Please do not enter current section id under cross-listed section ids.","Invalid cross-listed information:",-1);if(!a.r){if(a.s>-1)return void toast('You have not assigned a room to this section.\nEither assign a room to this section or select the "No" option under "Collect seat information".',"Missing information:",-1);if(!await promptF("You have not assigned a room to this section.\nAre you sure you would like to continue without a room assignment?"))return}let o=await getSections(t);for(let t in o)if(t===n){if(e)return void toast(`Section ${n} already exists.`,"Duplicate section id:",-1)}else{let i=o[t];if(e&&i.x?.includes(n))return void toast(`Section ${n} already exists.\nIt is cross-listed with section ${t}.`,"Duplicate section id:",-1);if(a.x?.includes(t))return void toast(`Cannot list ${t} as a cross-listed section because a record for ${t} already exists.`,"Duplicate section id:",-1);let r=a.x?.filter((e=>i.x?.includes(e)));if(r.length)return void toast(`Cannot list ${r} as cross-listed section(s).\n${t} already includes cross-listed section(s):\n ${r}`,"Duplicate section id:",-1);if(a.r&&i.pt===a.pt&&i.r===a.r)return void toast(i.r+" is booked at this time by section "+t+".\n\nIf these sections are cross-listed, please edit information for "+t+" to indicate this, rather than creating a new section.","",-1)}(await db.updateOne(cSECTIONS,t,{[n]:a})).error?toastError("Failed to add section.\n\nPlease try again."):(Object.assign(o[n],a),t===localStorage.semesterSelected&&(e&&addSectionCard(n,a,$("#instructorSections")),showEnrolledAndTeachingSections(localStorage.semesterSelected)),n===getAttendanceSectionId.innerText&&($("#getAttendanceCrossListIds").innerHTML=a.x?"<span>"+a.x.join("</span> <span>")+"</span>":"",$("#getAttendanceSectionInfo").innerText=a.pt+"\n"+(a.r||NO_ASSIGNED_ROOM)+"\n"+(a.in||a.i.join("\n"))),navigateBack())}async function editSectionDeleteSection(){let e=await promptF('Are you sure you want to delete this section?<p>WARNING:<p>All data associated with this section will be lost, including all attendance records.<p>To confirm this action you must type the word "delete" in the the Confirm field below and click OK.',{Confirm:""});if(e){if("delete"!==e.Confirm)return void toastWarn('The section was NOT deleted.\n\nYou clicked OK but did not enter the word "delete" at the Confirm prompt.\nIf you want to delete this section, please try again, and make sure to type the word "delete" at the Confirm prompt.');let t=$("#editSectionSemesterSelect").value,n=$("#editSectionIdInput").value,a=await db.updateOne(cSECTIONS,t,{[n]:db.deleteField()});a.error?toastError("Failed to delete section.\n",a.error):(delete allSections[t][n],a=await db.deleteOne("attend",t+"|"+n),a?.error&&toastError("Deleted section, but failed to delete attendance data.\n",a.error),showEnrolledAndTeachingSections(localStorage.semesterSelected),navigateBack(),navigateBack())}}function editSectionAssignRoom(){showRooms((e=>$("#editSectionRoom").innerText=e))}const editRoomLayoutDiv=$("#editRoomLayout");let editRoomPaintingSeats,editRoomLayoutHistory,campusBuildings={};async function updateCampusesAndBuilding(){let e=await getRooms(),t=[...new Set(Object.values(e).map((e=>e.cm)))];t.sort(),$("#editRoomCampusDataList").innerHTML="",$("#roomsCampusSelect").innerHTML='<option value="">All campuses</option>';for(let n of t)if(n){campusBuildings[n]=[...new Set(Object.values(e).filter((e=>e.cm===n)).map((e=>e.bl)))],campusBuildings[n].sort(),$("#editRoomCampusDataList").appendChild(document.createElement("option")).value=n;let t=$("#roomsCampusSelect").appendChild(document.createElement("option"));t.innerText=t.value=n}1===$("#editRoomCampusDataList").childElementCount?($("#roomsCampusSelect").value=$("#roomsCampusSelect").lastChild.value,$("#roomsCampusSelect").setAttribute("disabled",!0)):localStorage.campusSelected&&($("#roomsCampusSelect").value=localStorage.campusSelected,$("#roomsCampusSelect").removeAttribute("disabled")),$("#editRoomBuildingDataList").innerHTML="";for(let t of new Set(Object.values(e).map((e=>e.bl))))t&&($("#editRoomBuildingDataList").appendChild(document.createElement("option")).value=t);roomsCampusSelected(),roomsBuildingSelected()}function roomsCampusSelected(){if(localStorage.campusSelected=$("#roomsCampusSelect").value,$("#roomsBuildingSelect").innerHTML='<option value="">All buildings</option>',localStorage.campusSelected){for(let e of campusBuildings[localStorage.campusSelected])if(e){let t=$("#roomsBuildingSelect").appendChild(document.createElement("option"));t.innerText=t.value=e}localStorage.buildingSelected&&($("#roomsBuildingSelect").value=localStorage.buildingSelected)}else localStorage.buildingSelected="";roomsBuildingSelected()}async function roomsBuildingSelected(){localStorage.buildingSelected=$("#roomsBuildingSelect").value;let e=await getRooms(),t=Object.keys(allRooms).sort(((e,t)=>e.toLowerCase()>t.toLowerCase()?1:-1));for(;$("#roomList").childElementCount>1;)$("#roomList").removeChild($("#roomList").lastChild);for(let n of t)!e[n].rn||localStorage.campusSelected&&localStorage.campusSelected!==e[n].cm||localStorage.buildingSelected&&localStorage.buildingSelected!==e[n].bl||addRoomCard(n,e[n])}async function showRooms(e){selectingRoomF=e,showInMain("rooms"),$("#roomList").childElementCount<2&&updateCampusesAndBuilding()}var selectingRoomF;function addRoomCard(e,t){let n=t.rm.split("\n").map((e=>e.split("\t"))).flat().filter((e=>e.trim())).length,a=$("#roomList").appendChild(document.createElement("div"));a.innerHTML=`${e}\n${n} seats\n${t.bl}\n${t.rn}\n${t.cm}`,a._editRoomF=function(){$("#editRoomId").setAttribute("disabled",!0),$("#editRoomId").value=e,$("#editRoomCampus").value=t.cm,$("#editRoomBuilding").value=t.bl,$("#editRoomName").value=t.rn,editRoomLayoutHistory=[tsv2arr(t.rm.toUpperCase())],editRoomLayoutHistory.indx=0,createLayoutFromRoom();let n=[];for(let t in allSections)for(let a in allSections[t])allSections[t][a].r===e&&(n.push(a),allSections[t][a].x?.length&&n.push(...allSections[t][a].x));n.length?($("#editRoomUsedIn").innerText=`Room used for sections:\n  ${n.join(", ")}`,show("editRoomUsedIn"),hide("editRoomDeleteBtn")):(hide("editRoomUsedIn"),show("editRoomDeleteBtn")),showInMain("editRoom")},a.onclick=function(){selectingRoomF?(selectingRoomF(e),navigateBack()):a._editRoomF()}}function createNewRoom(){$("#editRoomId").removeAttribute("disabled"),$("#editRoomId").value="",$("#editRoomCampus").value="",$("#editRoomBuilding").value="",$("#editRoomName").value="",hide("editRoomDeleteBtn"),hide("editRoomUsedIn"),editRoomLayoutHistory=[],editRoomLayoutHistory.indx=-1,editRoom123Click(Array(6).fill().map((()=>Array(4).fill(" ")))),showInMain("editRoom")}function pushRoomLayoutToHistory(e){e||(e=[...editRoomLayoutDiv.children].map((e=>[...e.children].map((e=>e.innerText))))),editRoomLayoutHistory.indx++,editRoomLayoutHistory.length=editRoomLayoutHistory.indx,editRoomLayoutHistory.push(e)}function createLayoutFromRoom(e){e?pushRoomLayoutToHistory(e):e=editRoomLayoutHistory[editRoomLayoutHistory.indx],editRoomLayoutDiv.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t],a=editRoomLayoutDiv.appendChild(document.createElement("div"));for(let o=0;o<n.length;o++){let i=a.appendChild(document.createElement("div"));i.setAttribute("contenteditable",!0),e[t][o]&&(i.classList.add("seat"),i.innerText=e[t][o]),i.onmouseover=e=>{editRoomPaintingSeats&&e.buttons&&(e.preventDefault(),1===editRoomPaintingSeats?(i.classList.add("seat"),i.innerText="_"):-1===editRoomPaintingSeats&&(i.classList.remove("seat"),i.innerText=""))},i.onmouseout=e=>{if(!editRoomPaintingSeats&&e.buttons){function t(e){e.buttons||(editRoomPaintingSeats=0,pushRoomLayoutToHistory(),window.removeEventListener("mousemove",t))}e.preventDefault(),editRoomPaintingSeats=i.classList.contains("seat")?-1:1,1===editRoomPaintingSeats?(i.classList.add("seat"),i.innerText="_"):-1===editRoomPaintingSeats&&(i.classList.remove("seat"),i.innerText=""),window.addEventListener("mousemove",t)}},i.oninput=e=>{i.innerText.includes("\n")&&(i.blur(),i.onchange()),i.innerText?i.classList.add("seat"):i.classList.remove("seat")},i.onchange=e=>{i.innerText=formatSeatCode(i.innerText),pushRoomLayoutToHistory()},i.addEventListener("contextmenu",(async r=>{r.preventDefault();let s=await showContextMenu(r.clientX,r.clientY,["Insert left","Insert right","Delete","","Insert row above","Insert row below","Delete row","","Insert col left","Insert col right","Delete col"]);if("Delete"===s)i.remove(),pushRoomLayoutToHistory();else if("Insert left"===s){let n=JSON.parse(JSON.stringify(e));n[t].splice(o,0,""),createLayoutFromRoom(n)}else if("Insert right"===s){let n=JSON.parse(JSON.stringify(e));n[t].splice(o+1,0,""),createLayoutFromRoom(n)}else if("Delete row"===s)a.remove(),pushRoomLayoutToHistory();else if("Insert row above"===s){let a=JSON.parse(JSON.stringify(e));a.splice(t,0,Array(n.length).fill("")),createLayoutFromRoom(a)}else if("Insert row below"===s){let a=JSON.parse(JSON.stringify(e));a.splice(t+1,0,Array(n.length).fill("")),createLayoutFromRoom(a)}else if("Delete col"===s){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,1))),createLayoutFromRoom(t)}else if("Insert col left"===s){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o,0,""))),createLayoutFromRoom(t)}else if("Insert col right"===s){let t=JSON.parse(JSON.stringify(e));t.forEach((e=>e.splice(o+1,0,""))),createLayoutFromRoom(t)}}))}}}async function editRoomGridClick(){let e=await promptF("Select grid size",{Rows:editRoomLayoutHistory[editRoomLayoutHistory.indx].length,Cols:Math.max(...editRoomLayoutHistory[editRoomLayoutHistory.indx].map((e=>e.length)))});e&&editRoom123Click(Array(e.Rows).fill().map((()=>Array(e.Cols).fill(" "))))}function editRoom123Click(e){e||(e=JSON.parse(JSON.stringify(editRoomLayoutHistory[editRoomLayoutHistory.indx])));let t,n=0;for(let a=e.length-1;a>-1;a--){let o=e[a];t=0;for(let i=0;i<o.length;i++)e[a][i]&&e[a][i]&&(e[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[n]+ ++t);t&&n++}createLayoutFromRoom(e)}function editRoomAbcClick(){let e,t=JSON.parse(JSON.stringify(editRoomLayoutHistory[editRoomLayoutHistory.indx])),n=1;for(let a=t.length-1;a>-1;a--){let o=t[a];e=0;for(let i=0;i<o.length;i++)t[a][i]&&t[a][i]&&(t[a][i]="ABCDEFGHIJKLMNOPQRSTUVWXYZ"[e++]+n);e&&n++}createLayoutFromRoom(t)}function editRoomResetClick(){editRoomLayoutHistory.indx>0&&(editRoomLayoutHistory.indx=0,createLayoutFromRoom())}function editRoomUndoClick(){editRoomLayoutHistory.indx>0?(editRoomLayoutHistory.indx--,createLayoutFromRoom()):toast("Nothing to undo.")}function editRoomRedoClick(){editRoomLayoutHistory.indx<editRoomLayoutHistory.length-1?(editRoomLayoutHistory.indx++,createLayoutFromRoom()):toast("Nothing to redo.")}function editRoomSaveClick(){if(null===$("#editRoomId").getAttribute("disabled")){if($("#editRoomId").value=$("#editRoomId").value.trim(),!$("#editRoomId").value)return void toastError("Missing field: Room Id");if($("#editRoomId").value in allRooms)return void toastError(`Room ${$("#editRoomId").value} already exists.`)}if($("#editRoomBuilding").value=$("#editRoomBuilding").value.trim(),$("#editRoomName").value=$("#editRoomName").value.trim(),$("#editRoomCampus").value=$("#editRoomCampus").value.trim(),!$("#editRoomBuilding").value)return void toastError("Missing field: Building");if(!$("#editRoomName").value)return void toastError("Missing field: Room name or number");if(!$("#editRoomCampus").value)return void toastError("Missing field: Campus");let e=[...editRoomLayoutDiv.children].map((e=>[...e.children].map((e=>e.innerText)))),t=e.flat();for(let e=0;e<t.length;e++)if(t[e]){if(t.indexOf(t[e])!==e)return void toastError("Duplicate seat code: "+t[e]);if(!t[e].match(/^[a-z0-9]+$/i))return void toastError(`Invalid seat code: ${t[e]}.\nSeat codes must be combinations of letters and numbers.`)}let n={rn:$("#editRoomName").value,bl:$("#editRoomBuilding").value,cm:$("#editRoomCampus").value,rm:e.map((e=>e.join("\t"))).join("\n")},a=db.insertOne(cROOMS,n,$("#editRoomId").value);a.error?toastError("Could not save changes to room.\n"+a.error):(allRooms[$("#editRoomId").value]=n,n.cm!==localStorage.campusSelected?localStorage.campusSelected="":n.bl!==localStorage.buildingSelected&&(localStorage.buildingSelected=""),navigateBack(),updateCampusesAndBuilding(),selectingRoomF&&(navigateBack(),selectingRoomF($("#editRoomId").value)))}async function editRoomDeleteClick(){if(await promptF("Are you sure you would like to delete this room record?",{},["Delete","Cancel"])){let e=db.deleteOne(cROOMS,$("#editRoomId").value);e.error?toastError("Could not delete room record.\n"+e.error):(delete allRooms[$("#editRoomId").value],navigateBack(),updateCampusesAndBuilding())}}function makeSectionCard(e,t,n,a){var o=document.createElement("div");o._sectionDoc=t,o.id=e,o.className="sectionCard";var i=o.appendChild(document.createElement("div"));return i.class="cardTitle",i.innerText=e,a&&t.x&&(i.innerText+="\n"+t.x.join("\n")),(i=o.appendChild(document.createElement("div"))).innerText=t.pt,(i=o.appendChild(document.createElement("div"))).innerText=t.r||NO_ASSIGNED_ROOM,(i=o.appendChild(document.createElement("div"))).innerText=t.in||t.i,o.addEventListener("click",n),o}async function getAttendanceCardClick(e){showGetAttendance(e.currentTarget.id,e.currentTarget._sectionDoc)}function markAttendanceCardClick(e){showMarkAttendance(e.currentTarget.id,e.currentTarget._sectionDoc)}async function addSectionToStudentClick(e){let t=e.currentTarget.id,n=e.currentTarget._sectionDoc;(await db.updateOne(cUSERS,auth.currentUser.email,{["e."+localStorage.semesterSelected+"."+t]:{}})).error?toastError("Failed to add section.\n\nPlease try again."):(userDoc.e[localStorage.semesterSelected]||(userDoc.e[localStorage.semesterSelected]={}),userDoc.e[localStorage.semesterSelected][t]={},addSectionCard(t,n,$("#studentSections"),markAttendanceCardClick),navigateBack())}function addSectionCard(e,t,n,a,o){var i=makeSectionCard(e,t,a,o);n.insertBefore(i,n.lastElementChild)}async function showAvailableStudentSections(){showInMain("selectStudentSection");var e=await getSections(localStorage.semesterSelected),t=$("#availableStudentSections");t.innerHTML="<span></span>";let n=Object.keys(e).sort(),a=new Set(userDoc.e&&userDoc.e[localStorage.semesterSelected]?Object.keys(userDoc.e[localStorage.semesterSelected]):[]);for(let o of n){let n=e[o];if(!a.has(o)&&!n.x?.filter((e=>a.has(e))).length&&(addSectionCard(o,n,t,addSectionToStudentClick),n.x?.length))for(let e of n.x)addSectionCard(e,n,t,addSectionToStudentClick)}t.innerText||(t.appendChild(document.createElement("div")).innerText="No sections available.")}async function showEnrolledAndTeachingSections(e){var t=$("#studentSections"),n=$("#instructorSections");if(!e)return hide(t),void hide(n);show(t),1&userDoc.rl&&show(n);var a=await getSections(e);for(let e=t.childElementCount-1;e--;)t.children[e].remove();for(let e=n.childElementCount-1;e--;)n.children[e].remove();for(let o of Object.keys(a).sort()){let i=a[o];if(userDoc.e&&userDoc.e[e]&&o in userDoc.e[e])addSectionCard(o,i,t,markAttendanceCardClick);else if(i.x?.length)for(let n of i.x)userDoc.e&&userDoc.e[e]&&n in userDoc.e[e]&&addSectionCard(n,i,t,markAttendanceCardClick);!n.classList.contains("hidden")&&i.i?.includes(auth.currentUser.email)&&addSectionCard(o,i,n,getAttendanceCardClick,!0)}}$("#semesterSelect").addEventListener("change",(e=>{localStorage.semesterSelected=e.target.value,showEnrolledAndTeachingSections(e.target.value)}));const nameInput=$("#nameInput"),saveNameBtn=$("#saveNameBtn");function showContextMenu(e,t,n){return new Promise((function(a,o){const i=$("#contextMenu");window.dispatchEvent(new Event("click")),e<window.innerWidth/2?(i.style.left=e,i.style.removeProperty("right")):(i.style.right=window.innerWidth-e,i.style.removeProperty("left")),t<window.innerHeight/2?(i.style.top=t,i.style.removeProperty("bottom")):(i.style.bottom=window.innerHeight-t,i.style.removeProperty("top")),i.innerHTML="";for(let e of n){let t=i.appendChild(document.createElement("div"));""===e?t.classList.add("separator"):e.startsWith("_")?t.innerText=e.slice(1):(t.innerText=e,t.onclick=()=>a(e),t.classList.add("contextMenuOption"))}show(i),window.addEventListener("click",(()=>{a(!1),hide(i)}),{once:!0})}))}function promptF(e,t={},n){return new Promise((function(a,o){disallowNav(),$("#promptFormTitle").innerHTML=e;let i={};for(let e in t){let n=$("#promptForm").appendChild(document.createElement("label"));if(n.innerText=e,n.setAttribute("for",e),"number"==typeof t[e])i[e]=$("#promptForm").appendChild(document.createElement("input")),i[e].setAttribute("type","number"),i[e].value=t[e],i[e].id=e;else if("boolean"==typeof t[e]){let a=$("#promptForm").appendChild(document.createElement("div"));i[e]=a.appendChild(document.createElement("input")),a.appendChild(n),i[e].setAttribute("type","checkbox"),i[e].checked=t[e],i[e].id=e}else if("string"==typeof t[e])t[e].includes("\n")?i[e]=$("#promptForm").appendChild(document.createElement("textarea")):i[e]=$("#promptForm").appendChild(document.createElement("input")),i[e].value=t[e],i[e].id=e;else if(t[e]?.constructor===Object){if(i[e]=$("#promptForm").appendChild(document.createElement("input")),Object.entries(t[e]).forEach((t=>i[e].setAttribute(t[0],t[1]))),"checkbox"===i[e].type||"radio"===i[e].type){let t=$("#promptForm").appendChild(document.createElement("div"));t.appendChild(i[e]),t.appendChild(n)}i[e].id=e}else{$("#promptForm").appendChild(document.createElement("div")).appendChild(n)}}for(let e of n||["OK","Cancel"]){let t=$("#promptButtons").appendChild(document.createElement("button"));t.innerText=e,t.onclick="cancel"===e.toLowerCase()?()=>{a(!1),hidePrompt()}:()=>{let t=Object.fromEntries(Object.entries(i).map((([e,t])=>[e,"checkbox"===t.type||"radio"===t.type?t.checked:"number"===t.type?parseFloat(t.value):t.value])));t.clicked=e,a(t),hidePrompt()}}show("prompt")}))}function hidePrompt(){$("#promptForm").innerHTML="",$("#promptButtons").innerHTML="",hide("prompt"),allowNav()}nameInput.addEventListener("input",(e=>{let t=nameInput.value.trim();t&&nameInput.lastValue!==t?show(saveNameBtn):hide(saveNameBtn)})),saveNameBtn.addEventListener("click",(async e=>{saveNameBtn.setAttribute("disabled","true");let t=await db.updateOne(cUSERS,auth.currentUser.email,{n:nameInput.value.trim()});t.error?toastError("Unable to update name.\n"+t.error):(hide(saveNameBtn),userDoc.n=nameInput.lastValue=nameInput.value,toast("Name updated.","",1)),saveNameBtn.removeAttribute("disabled"),allowNav()}));const toastDiv=$("#toast"),toastMsg=$("#toastMessage");function toast(e,t,n){if(n?toastDiv.style.setProperty("--toast-accent",n>0?"#4f6":n<-.5?"#f64":"#fe4"):toastDiv.style.setProperty("--toast-accent","gray"),toastMsg.innerHTML=t?t+"\n\n":"","object"==typeof e)for(let t in e)e[t]&&(toastMsg.innerHTML+=t+" : "+e[t]+"\n");else toastMsg.innerHTML+=e;setTimeout((()=>{window.addEventListener("mousedown",closeToast),window.addEventListener("keydown",closeToast),window.addEventListener("popstate",closeToast),mainDiv.addEventListener("scroll",closeToast),show(toastDiv),toastDiv.classList.add("slide-up")}),200)}function toastWarn(e){toast(e,"Warning",-.1)}function toastError(e){toast(e,"Error",-1)}function closeToast(){window.removeEventListener("mousedown",closeToast),window.removeEventListener("keydown",closeToast),window.removeEventListener("popstate",closeToast),mainDiv.removeEventListener("scroll",closeToast),hide(toastDiv),toastDiv.classList.remove("slide-up")}const themeToggle=$("#theme-switch");function toggleDarkMode(){setTheme(themeToggle.innerText.startsWith("dark"))}function setTheme(e){e?(localStorage.theme="dark",document.documentElement.setAttribute("theme","dark"),themeToggle.innerText="light_mode"):(delete localStorage.theme,document.documentElement.removeAttribute("theme"),themeToggle.innerText="dark_mode")}function changeFontSize(e){let t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--main-font-size"))+e+"pt";localStorage.fontSize=t,document.documentElement.style.setProperty("--main-font-size",t)}setTheme(localStorage.theme),localStorage.fontSize&&document.documentElement.style.setProperty("--main-font-size",localStorage.fontSize);